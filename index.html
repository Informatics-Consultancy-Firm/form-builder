<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; }
        .header h1 { font-size: 20px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        
        .main-container { display: none; margin-top: 60px; height: calc(100vh - 90px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        .form-field { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 6px; }
        .field-action-btn:hover { background: #004080; color: white; }
        .field-action-btn.move-up, .field-action-btn.move-down { background: #17a2b8; color: white; border-color: #17a2b8; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; margin-left: 8px; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; }
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 500px; width: 100%; border: 4px double #004080; }
        .modal-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-btn { padding: 10px 20px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; border: 2px solid; }
        .modal-btn.primary { background: #004080; color: white; border-color: #004080; }
        .modal-btn.success { background: #28a745; color: white; border-color: #28a745; }
        
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        
        .viewer-container { display: none; min-height: 100vh; background: #e9ecef; }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; position: sticky; top: 0; z-index: 100; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
        .viewer-nav-btn:hover { transform: translateY(-2px); }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-input.error { border-color: #dc3545 !important; background: #fff5f5 !important; }
        .field-error-msg { color: #dc3545; font-size: 11px; margin-top: 6px; padding: 6px 10px; background: #fff5f5; border-radius: 4px; }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .viewer-radio-option:hover { border-color: #004080; }
        .viewer-section { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 14px 18px; margin: 20px -25px; font-size: 13px; font-weight: 700; }
        .viewer-back-btn { position: fixed; top: 15px; left: 20px; background: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; cursor: pointer; z-index: 200; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; font-size: 10px; position: sticky; top: 0; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e8f4fc; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .stat-value { font-size: 32px; font-weight: 700; }
        .stat-card .stat-label { font-size: 11px; opacity: 0.9; margin-top: 5px; }
        
        .chart-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container h4 { color: #004080; font-size: 14px; margin-bottom: 15px; border-bottom: 2px solid #004080; padding-bottom: 8px; }
        .chart-wrapper { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .chart-box { flex: 1; min-width: 280px; max-width: 400px; }
        
        .progress-bar-container { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; margin-bottom: 20px; }
        .progress-bar { height: 100%; background: #28a745; border-radius: 4px; transition: width 0.3s; }
        .page-header { background: #e8f4fc; margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; }
        .next-btn { background: #004080; color: white; }
        .submit-btn { background: #28a745; color: white; }
        
        /* FULL SCREEN DATA VIEW STYLES */
        .data-tab-fullscreen { padding: 0 !important; }
        .data-fullscreen-container { 
            position: fixed; 
            top: 50px; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: #f5f5f5; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .data-header-bar {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .data-header-bar h2 { margin: 0; font-size: 18px; }
        .data-header-actions { display: flex; gap: 10px; align-items: center; }
        .data-table-wrapper {
            flex: 1;
            overflow: auto;
            padding: 15px;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .data-table-fullscreen { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 12px;
        }
        .data-table-fullscreen th { 
            background: #004080; 
            color: white; 
            font-weight: 700; 
            font-size: 11px; 
            position: sticky; 
            top: 0; 
            padding: 12px 10px;
            text-align: left;
            white-space: nowrap;
            z-index: 10;
        }
        .data-table-fullscreen td { 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            text-align: left;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-table-fullscreen td:hover {
            white-space: normal;
            word-wrap: break-word;
            max-width: none;
        }
        .data-table-fullscreen tr:nth-child(even) { background: #f8f9fa; }
        .data-table-fullscreen tr:hover { background: #e8f4fc; }
        .data-stats-bar {
            background: white;
            padding: 10px 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 2px solid #004080;
        }
        .data-stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        .data-stat-value {
            background: #004080;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 700;
        }
        
        @media (max-width: 900px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .viewer-nav { padding: 10px; }
            .page-navigation { flex-direction: column; }
            .nav-btn { width: 100%; }
            .data-header-bar { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>Form Builder Pro</h1>
                <p>Advanced Data Collection Forms</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn">üîì Login</button>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Organization</label>
                        <input type="text" class="auth-input" id="signupOrg" value="ICF-SL">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Confirm Password</label>
                        <input type="password" class="auth-input" id="signupConfirm" required placeholder="Confirm password">
                    </div>
                    <button type="submit" class="auth-btn">üìù Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>üìã Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser">üë§ User</span>
            <button class="header-btn" onclick="showHome()">üè† Home</button>
            <button class="header-btn success" onclick="newForm()">üìÑ New</button>
            <button class="header-btn" onclick="saveCurrentForm()">üíæ Save</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è Preview</button>
            <button class="header-btn primary" onclick="shareForm()">üîó Share</button>
            <button class="header-btn danger" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic Fields</h3>
                <div class="field-type" data-type="text">üìÑ Text Input</div>
                <div class="field-type" data-type="number">üî¢ Number</div>
                <div class="field-type" data-type="date">üìÖ Date</div>
                <div class="field-type" data-type="time">üïê Time</div>
                <div class="field-type" data-type="email">üìß Email</div>
                <div class="field-type" data-type="phone">üì± Phone</div>
                <div class="field-type" data-type="textarea">üìù Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection Fields</h3>
                <div class="field-type" data-type="select">üìã Dropdown</div>
                <div class="field-type" data-type="radio">üîò Radio Buttons</div>
                <div class="field-type" data-type="checkbox">‚òëÔ∏è Checkboxes</div>
                <div class="field-type" data-type="yesno">‚úÖ Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special Fields</h3>
                <div class="field-type" data-type="gps">üìç GPS Location</div>
                <div class="field-type" data-type="signature">‚úçÔ∏è Signature</div>
                <div class="field-type" data-type="rating">‚≠ê Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section">üìÅ Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount">üìä 0 fields | 1 page</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p id="previewSubtitle">Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:36px;margin-bottom:12px;">üì•</p>
                            <p style="font-weight:600;">Click field types on the left to add them</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title">‚öôÔ∏è Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;">üëÜ</p>
                    <p>Select a field to edit its properties</p>
                </div>
            </div>
        </div>
    </div>

    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    <footer class="footer">¬© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | Form Builder Pro</footer>

    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üîó Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:20px;font-weight:700;color:#004080;" id="shareFormTitle">Form Title</div>
                </div>
                <div class="qr-container">
                    <div class="qr-box"><div id="qrCode"></div></div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;">üì± Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()">üìã Copy URL</button>
                        <button class="modal-btn success" onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwC64Hy4GSaDPuRACNC57Qwdw58yt6F_pnXLrf0mp-hzEyyCDGq3SWHLrK1VS8kPlKFzQ/exec',
            SHEET_ID: '1tmvx7x3Z4ZYNxeaCLHsxtZrpECLqNRE6rCxk3QiFCZ8'
        };

        const state = {
            user: null, fields: [], selectedFieldId: null, fieldCounter: 0, isSharedMode: false,
            settings: {
                title: 'My Data Collection Form', subtitle: 'Data Collection System', organization: 'ICF-SL',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                scriptUrl: CONFIG.SCRIPT_URL, sheetId: CONFIG.SHEET_ID
            }
        };

        const fieldDefs = {
            text: { label: 'Text', icon: 'üìÑ', defaultLabel: 'Text Field', category: 'text' },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field', category: 'numeric' },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field', category: 'date' },
            time: { label: 'Time', icon: 'üïê', defaultLabel: 'Time Field', category: 'time' },
            email: { label: 'Email', icon: 'üìß', defaultLabel: 'Email Address', category: 'text' },
            phone: { label: 'Phone', icon: 'üì±', defaultLabel: 'Phone Number', category: 'text' },
            textarea: { label: 'Long Text', icon: 'üìù', defaultLabel: 'Long Text', category: 'text' },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Choice', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkbox', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question', category: 'categorical' },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location', category: 'special' },
            signature: { label: 'Signature', icon: '‚úçÔ∏è', defaultLabel: 'Signature', category: 'special' },
            rating: { label: 'Rating', icon: '‚≠ê', defaultLabel: 'Rating', category: 'categorical', max: 5 },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section', category: 'structure' }
        };

        let chartInstances = {};

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    state.isSharedMode = true;
                    renderSharedForm(data);
                    return;
                } catch (err) { console.error('Error decoding:', err); }
            }
            
            loadFromStorage();
            setupEventListeners();
            checkAuth();
        }
        
        function renderSharedForm(data) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            state.settings = {
                title: data.s?.t || 'Form', subtitle: data.s?.st || 'Data Collection',
                organization: data.s?.o || 'ICF-SL',
                logo: data.s?.l || 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                scriptUrl: data.s?.u || CONFIG.SCRIPT_URL, sheetId: data.s?.g || CONFIG.SHEET_ID
            };
            
            state.fields = (data.f || []).map(f => ({
                id: f.i, type: f.y, label: f.l, name: f.n, required: f.r || false,
                placeholder: f.p || '', options: f.o || [], max: f.mx || 5, duplicateCheck: f.dc || false
            }));
            
            document.getElementById('viewerContainer').classList.add('show');
            renderSharedFormViewer();
        }
        
        function renderSharedFormViewer() {
            const s = state.settings;
            let pages = [], currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) pages.push(currentPage);
                    currentPage = { title: field.label, fields: [] };
                } else { currentPage.fields.push(field); }
            });
            if (currentPage.fields.length > 0) pages.push(currentPage);
            if (pages.length === 0) pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'text': case 'email': case 'phone': case 'number': case 'date': case 'time':
                            const type = field.type === 'phone' ? 'tel' : field.type;
                            input = `<input type="${type}" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`;
                            break;
                        case 'textarea':
                            input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`; break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`; break;
                        case 'radio': case 'yesno':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'gps':
                            input = `<div style="text-align:center;"><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;">üìç Capture GPS</button><input type="hidden" name="${field.name}_lat"><input type="hidden" name="${field.name}_lng"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`; break;
                        case 'signature':
                            input = `<div style="text-align:center;"><canvas class="sig-canvas" width="280" height="100" style="border:2px solid #004080;border-radius:6px;background:#fff;cursor:crosshair;touch-action:none;"></canvas><input type="hidden" name="${field.name}" class="sig-data"><button type="button" onclick="clearSig(this)" style="margin-top:6px;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;">Clear</button></div>`; break;
                        case 'rating':
                            input = `<div class="rating-container">${Array(field.max || 5).fill().map((_, i) => `<span class="rating-star" onclick="setRating(this,${i+1})" style="font-size:24px;cursor:pointer;opacity:0.3;">‚≠ê</span>`).join('')}<input type="hidden" name="${field.name}"></div>`; break;
                        default: input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0, isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        <div class="page-header">
                            <span class="page-indicator">Page ${pageIndex + 1} of ${pages.length}</span>
                            <h3 class="page-title">${escapeHtml(page.title)}</h3>
                        </div>
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})">‚¨ÖÔ∏è Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next ‚û°Ô∏è</button>` : ''}
                            ${isLast ? `<button type="submit" class="nav-btn submit-btn">‚úÖ Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showViewerTab('form',this)">üìù Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showViewerTab('data',this)">üìä Data</button>
                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showViewerTab('dashboard',this)">üìà Dashboard</button>
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}" id="connectionStatus">
                        <span>${navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                                <p>${escapeHtml(s.subtitle)}</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">
                                    <div class="progress-bar-container"><div class="progress-bar" id="formProgress" style="width: ${100/pages.length}%"></div></div>
                                    ${pagesHtml}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab data-tab-fullscreen">
                    <div id="dataContainer"><p style="text-align:center;color:#868e96;padding:50px;">‚è≥ Loading from Google Sheets...</p></div>
                </div>
                
                <div id="tabDashboard" class="viewer-tab">
                    <div style="max-width:900px;margin:0 auto;">
                        <div class="viewer-form-box" style="margin-bottom:20px;">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);">
                                <h1>üìà Dashboard</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body">
                                <div class="dashboard-stats" id="dashboardStats"></div>
                            </div>
                        </div>
                        <div id="dashboardCharts"></div>
                    </div>
                </div>
            `;
            
            window.totalPages = pages.length;
            window.currentPageIndex = 0;
            initSignaturePads();
            setupFormSubmit();
            loadViewerData();
            loadViewerDashboard();
        }

        function initSignaturePads() {
            document.querySelectorAll('.sig-canvas').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                let drawing = false;
                ctx.strokeStyle = '#004080'; ctx.lineWidth = 2;
                canvas.onmousedown = e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
                canvas.onmousemove = e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
                canvas.onmouseup = () => { drawing = false; const di = canvas.parentElement.querySelector('.sig-data'); if (di) di.value = canvas.toDataURL(); };
                canvas.onmouseleave = () => drawing = false;
                canvas.ontouchstart = e => { e.preventDefault(); drawing = true; const t = e.touches[0], r = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(t.clientX - r.left, t.clientY - r.top); };
                canvas.ontouchmove = e => { e.preventDefault(); if (drawing) { const t = e.touches[0], r = canvas.getBoundingClientRect(); ctx.lineTo(t.clientX - r.left, t.clientY - r.top); ctx.stroke(); } };
                canvas.ontouchend = () => { drawing = false; const di = canvas.parentElement.querySelector('.sig-data'); if (di) di.value = canvas.toDataURL(); };
            });
        }

        function setupFormSubmit() {
            const form = document.getElementById('viewerForm');
            if (!form) return;
            form.onsubmit = async function(e) {
                e.preventDefault();
                const submitBtn = form.querySelector('.submit-btn');
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = '‚è≥ Submitting...'; }
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString() };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                const result = await submitToGoogleSheets(data);
                if (result.success) {
                    form.reset();
                    window.currentPageIndex = 0;
                    goToPage(0);
                    notify(result.offline ? 'üíæ Saved offline' : '‚úÖ Submitted!');
                    setTimeout(() => { loadViewerData(); loadViewerDashboard(); }, 1000);
                } else { notify('‚ö†Ô∏è Saved offline'); }
                
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '‚úÖ Submit'; }
            };
        }

        // UPDATED: Full screen data view with ALL variables
        async function loadViewerData() {
            const container = document.getElementById('dataContainer');
            if (!container) return;
            container.innerHTML = '<p style="text-align:center;color:#868e96;padding:50px;">‚è≥ Loading data from Google Sheets...</p>';
            
            let data = [];
            const scriptUrl = state.settings.scriptUrl || CONFIG.SCRIPT_URL;
            const sheetId = state.settings.sheetId || CONFIG.SHEET_ID;
            
            if (scriptUrl) {
                try {
                    const response = await fetch(`${scriptUrl}?action=getData&formTitle=${encodeURIComponent(state.settings.title)}&limit=500&sheetId=${encodeURIComponent(sheetId)}`);
                    const result = await response.json();
                    if (result.success && result.data) { data = result.data; window.currentViewData = data; }
                } catch (err) {
                    container.innerHTML = '<p style="text-align:center;color:#dc3545;padding:50px;">‚ùå Failed to load data. Check internet connection.</p>';
                    return;
                }
            }
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="data-fullscreen-container">
                        <div class="data-header-bar">
                            <h2>üìä ${escapeHtml(state.settings.title)} - Data View</h2>
                        </div>
                        <div style="flex:1;display:flex;align-items:center;justify-content:center;">
                            <p style="text-align:center;color:#868e96;font-size:18px;">üì≠ No submissions yet</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Get ALL fields (not just first 5)
            const fields = state.fields.filter(f => f.type !== 'section');
            
            // Calculate statistics
            const today = data.filter(d => {
                const ts = d._timestamp || d.timestamp || d.Timestamp;
                return ts && new Date(ts).toDateString() === new Date().toDateString();
            }).length;
            
            const thisWeek = data.filter(d => {
                const ts = d._timestamp || d.timestamp || d.Timestamp;
                if (!ts) return false;
                const date = new Date(ts);
                const now = new Date();
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                return date >= weekAgo;
            }).length;
            
            // Build full-screen data table with ALL columns
            let tableHeaders = `<th style="min-width:50px;">#</th><th style="min-width:150px;">üìÖ Timestamp</th>`;
            fields.forEach(f => {
                tableHeaders += `<th style="min-width:120px;">${escapeHtml(f.label)}</th>`;
            });
            
            let tableRows = '';
            data.forEach((row, i) => {
                const ts = row._timestamp || row.timestamp || row.Timestamp || '';
                let cells = `<td>${i + 1}</td><td>${ts ? new Date(ts).toLocaleString() : '-'}</td>`;
                fields.forEach(f => {
                    const value = row[f.name] || row[f.label] || '-';
                    cells += `<td title="${escapeHtml(String(value))}">${escapeHtml(String(value))}</td>`;
                });
                tableRows += `<tr>${cells}</tr>`;
            });
            
            container.innerHTML = `
                <div class="data-fullscreen-container">
                    <div class="data-header-bar">
                        <h2>üìä ${escapeHtml(state.settings.title)} - Data View</h2>
                        <div class="data-header-actions">
                            <button onclick="refreshData()" style="padding:10px 20px;background:#17a2b8;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-family:'Oswald',sans-serif;">üîÑ Refresh</button>
                            <button onclick="downloadData()" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-family:'Oswald',sans-serif;">üì• Download CSV</button>
                        </div>
                    </div>
                    <div class="data-stats-bar">
                        <div class="data-stat-item">
                            <span>üìä Total Records:</span>
                            <span class="data-stat-value">${data.length}</span>
                        </div>
                        <div class="data-stat-item">
                            <span>üìÖ Today:</span>
                            <span class="data-stat-value" style="background:#28a745;">${today}</span>
                        </div>
                        <div class="data-stat-item">
                            <span>üìÜ This Week:</span>
                            <span class="data-stat-value" style="background:#17a2b8;">${thisWeek}</span>
                        </div>
                        <div class="data-stat-item">
                            <span>üìã Variables:</span>
                            <span class="data-stat-value" style="background:#6f42c1;">${fields.length}</span>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table-fullscreen">
                            <thead><tr>${tableHeaders}</tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        window.refreshData = function() {
            notify('üîÑ Refreshing...');
            loadViewerData();
            loadViewerDashboard();
        };
        
        window.downloadData = function() {
            let data = window.currentViewData || [];
            if (data.length === 0) { notify('No data', 'error'); return; }
            const fields = state.fields.filter(f => f.type !== 'section');
            const headers = ['Timestamp', ...fields.map(f => f.label)];
            const rows = data.map(row => {
                const ts = row._timestamp || row.timestamp || '';
                return [ts, ...fields.map(f => row[f.name] || row[f.label] || '')];
            });
            let csv = headers.join(',') + '\n';
            rows.forEach(row => { csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n'; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `${state.settings.title.replace(/\s+/g, '_')}_data.csv`;
            a.click(); URL.revokeObjectURL(url);
            notify('‚úÖ Downloaded!');
        };
        
        async function loadViewerDashboard() {
            if (!window.currentViewData || window.currentViewData.length === 0) {
                const scriptUrl = state.settings.scriptUrl || CONFIG.SCRIPT_URL;
                const sheetId = state.settings.sheetId || CONFIG.SHEET_ID;
                if (scriptUrl) {
                    try {
                        const response = await fetch(`${scriptUrl}?action=getData&formTitle=${encodeURIComponent(state.settings.title)}&limit=500&sheetId=${encodeURIComponent(sheetId)}`);
                        const result = await response.json();
                        if (result.success && result.data) window.currentViewData = result.data;
                    } catch (err) { console.log('Dashboard load error:', err); }
                }
            }
            
            const data = window.currentViewData || [];
            const container = document.getElementById('dashboardStats');
            const chartsContainer = document.getElementById('dashboardCharts');
            if (!container) return;
            
            const today = data.filter(d => {
                const ts = d._timestamp || d.timestamp || d.Timestamp;
                return ts && new Date(ts).toDateString() === new Date().toDateString();
            }).length;
            
            container.innerHTML = `
                <div class="stat-card"><div class="stat-value">${data.length}</div><div class="stat-label">Total Submissions</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#218838 100%);"><div class="stat-value">${today}</div><div class="stat-label">Today</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);"><div class="stat-value">${state.fields.length}</div><div class="stat-label">Fields</div></div>
            `;
            
            if (chartsContainer) {
                Object.values(chartInstances).forEach(chart => { if (chart) chart.destroy(); });
                chartInstances = {};
                
                if (data.length === 0) {
                    chartsContainer.innerHTML = '<div style="text-align:center;color:#868e96;padding:40px;">üì≠ No data for charts</div>';
                    return;
                }
                
                const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox', 'rating'];
                const categoricalFields = state.fields.filter(f => categoricalTypes.includes(f.type));
                
                if (categoricalFields.length === 0) {
                    chartsContainer.innerHTML = '<div style="text-align:center;color:#868e96;padding:40px;">üìä No categorical fields for charts</div>';
                    return;
                }
                
                let chartsHtml = '';
                categoricalFields.forEach((field, index) => {
                    const valueCounts = {};
                    let total = 0;
                    data.forEach(row => {
                        const value = row[field.name] || row[field.label];
                        if (value && value.toString().trim()) { valueCounts[value] = (valueCounts[value] || 0) + 1; total++; }
                    });
                    
                    if (total > 0) {
                        chartsHtml += `
                            <div class="chart-container">
                                <h4>üìä ${escapeHtml(field.label)}</h4>
                                <div class="chart-wrapper">
                                    <div class="chart-box"><canvas id="barChart_${index}"></canvas></div>
                                    <div class="chart-box"><canvas id="pieChart_${index}"></canvas></div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                chartsContainer.innerHTML = chartsHtml || '<div style="text-align:center;color:#868e96;padding:40px;">üìä No data for categorical fields</div>';
                
                setTimeout(() => {
                    categoricalFields.forEach((field, index) => {
                        const valueCounts = {};
                        let total = 0;
                        data.forEach(row => {
                            const value = row[field.name] || row[field.label];
                            if (value && value.toString().trim()) { valueCounts[value] = (valueCounts[value] || 0) + 1; total++; }
                        });
                        
                        if (total > 0) {
                            const labels = Object.keys(valueCounts);
                            const values = Object.values(valueCounts);
                            const percentages = values.map(v => ((v / total) * 100).toFixed(1));
                            const colors = ['#004080', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'];
                            
                            const barCtx = document.getElementById(`barChart_${index}`);
                            if (barCtx) {
                                chartInstances[`bar_${index}`] = new Chart(barCtx, {
                                    type: 'bar',
                                    data: { labels: labels, datasets: [{ label: 'Count', data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 2 }] },
                                    options: {
                                        responsive: true,
                                        plugins: {
                                            legend: { display: false },
                                            title: { display: true, text: 'Bar Chart - Counts', font: { family: 'Oswald', size: 14, weight: 'bold' } },
                                            tooltip: { callbacks: { label: ctx => `${ctx.raw} (${((ctx.raw / total) * 100).toFixed(1)}%)` } }
                                        },
                                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                                    }
                                });
                            }
                            
                            const pieCtx = document.getElementById(`pieChart_${index}`);
                            if (pieCtx) {
                                chartInstances[`pie_${index}`] = new Chart(pieCtx, {
                                    type: 'pie',
                                    data: { labels: labels.map((l, i) => `${l} (${percentages[i]}%)`), datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderColor: '#fff', borderWidth: 2 }] },
                                    options: {
                                        responsive: true,
                                        plugins: {
                                            legend: { position: 'bottom', labels: { font: { family: 'Oswald', size: 11 } } },
                                            title: { display: true, text: 'Pie Chart - Percentages', font: { family: 'Oswald', size: 14, weight: 'bold' } },
                                            tooltip: { callbacks: { label: ctx => `${ctx.label.split(' (')[0]}: ${ctx.raw} (${((ctx.raw / total) * 100).toFixed(1)}%)` } }
                                        }
                                    }
                                });
                            }
                        }
                    });
                }, 100);
            }
        }

        function goToPage(pageIndex) {
            if (pageIndex > window.currentPageIndex) {
                const currentPageEl = document.querySelector(`.form-page[data-page="${window.currentPageIndex}"]`);
                const allFields = currentPageEl.querySelectorAll('input[required], select[required], textarea[required]');
                let valid = true, firstInvalid = null;
                currentPageEl.querySelectorAll('.field-error-msg').forEach(el => el.remove());
                
                allFields.forEach(field => {
                    if (!field.value.trim()) {
                        valid = false;
                        field.classList.add('error');
                        const container = field.closest('.viewer-field');
                        if (container && !container.querySelector('.field-error-msg')) {
                            const err = document.createElement('div');
                            err.className = 'field-error-msg';
                            err.textContent = '‚ö†Ô∏è This field is required';
                            container.appendChild(err);
                        }
                        if (!firstInvalid) firstInvalid = field;
                    } else { field.classList.remove('error'); }
                });
                
                if (!valid) { notify('‚ö†Ô∏è Please fix errors', 'error'); if (firstInvalid) firstInvalid.focus(); return; }
            }
            
            document.querySelectorAll('.form-page').forEach(p => p.style.display = 'none');
            const targetPage = document.querySelector(`.form-page[data-page="${pageIndex}"]`);
            if (targetPage) {
                targetPage.style.display = 'block';
                window.currentPageIndex = pageIndex;
                document.getElementById('formProgress').style.width = ((pageIndex + 1) / window.totalPages * 100) + '%';
                document.querySelector('.viewer-form-box')?.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function showViewerTab(tab, btn) {
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            if (btn) btn.classList.add('active');
            if (tab === 'data') loadViewerData();
            if (tab === 'dashboard') loadViewerDashboard();
        }

        async function submitToGoogleSheets(data) {
            const scriptUrl = state.settings.scriptUrl || CONFIG.SCRIPT_URL;
            const sheetId = state.settings.sheetId || CONFIG.SHEET_ID;
            if (!scriptUrl) { saveOffline(data); return { success: true, offline: true }; }
            
            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'submit', formTitle: state.settings.title, sheetId: sheetId, data: data })
                });
                const result = await response.json();
                if (result.success) return { success: true };
                saveOffline(data);
                return { success: false, offline: true };
            } catch (err) { saveOffline(data); return { success: false, offline: true }; }
        }
        
        function saveOffline(data) {
            data._offline = true;
            const offlineData = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
            offlineData.push({ formTitle: state.settings.title, data: data });
            localStorage.setItem('offlineSubmissions', JSON.stringify(offlineData));
        }

        window.captureGPS = function(btn) {
            const container = btn.parentElement;
            const status = container.querySelector('.gps-status');
            status.textContent = 'üìç Getting location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        container.querySelector('[name$="_lat"]').value = pos.coords.latitude.toFixed(6);
                        container.querySelector('[name$="_lng"]').value = pos.coords.longitude.toFixed(6);
                        status.textContent = '‚úÖ ' + pos.coords.latitude.toFixed(6) + ', ' + pos.coords.longitude.toFixed(6);
                    },
                    err => { status.textContent = '‚ùå ' + err.message; }
                );
            } else { status.textContent = '‚ùå Not supported'; }
        };
        
        window.clearSig = function(btn) {
            const canvas = btn.parentElement.querySelector('.sig-canvas');
            if (canvas) { canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); const di = btn.parentElement.querySelector('.sig-data'); if (di) di.value = ''; }
        };
        
        window.setRating = function(star, val) {
            const container = star.parentElement;
            container.querySelectorAll('.rating-star').forEach((s, i) => s.style.opacity = i < val ? '1' : '0.3');
            container.querySelector('input').value = val;
        };

        // Builder functions
        function setupEventListeners() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab)));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.querySelectorAll('.field-type').forEach(el => el.addEventListener('click', () => addField(el.dataset.type)));
            document.getElementById('formTitle').addEventListener('input', (e) => {
                state.settings.title = e.target.value;
                document.getElementById('previewTitle').textContent = e.target.value;
                saveToStorage();
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); }));
        }

        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) { state.user = JSON.parse(saved); showBuilder(); }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => (u.email === email || u.username === email) && u.password === password);
            if (user) { state.user = user; localStorage.setItem('formBuilderUser', JSON.stringify(user)); showBuilder(); }
            else { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Invalid credentials'; }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const org = document.getElementById('signupOrg').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            if (password !== confirm) { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Passwords do not match'; return; }
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Email exists'; return; }
            users.push({ id: Date.now().toString(), name, email, org, password, createdAt: new Date().toISOString() });
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            document.getElementById('authSuccess').style.display = 'block'; document.getElementById('authSuccess').textContent = 'Account created! Please login.';
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = `üë§ ${state.user?.name || 'User'}`;
            renderFields();
        }

        function logout() { state.user = null; localStorage.removeItem('formBuilderUser'); document.getElementById('mainContainer').classList.remove('show'); document.getElementById('authContainer').style.display = 'flex'; }

        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;
            state.fieldCounter++;
            const field = { id: 'field_' + state.fieldCounter, type: type, label: def.defaultLabel, name: type + '_' + state.fieldCounter, required: true, options: def.options ? [...def.options] : [], max: def.max || 5, placeholder: '' };
            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
            notify('‚úÖ Field added!');
        }

        function removeField(id) { event?.stopPropagation(); if (!confirm('Delete?')) return; state.fields = state.fields.filter(f => f.id !== id); if (state.selectedFieldId === id) { state.selectedFieldId = null; renderProperties(); } renderFields(); saveToStorage(); notify('üóëÔ∏è Deleted'); }
        function moveField(id, direction) { event?.stopPropagation(); const index = state.fields.findIndex(f => f.id === id); if (index < 0) return; const newIndex = direction === 'up' ? index - 1 : index + 1; if (newIndex < 0 || newIndex >= state.fields.length) return; [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]]; renderFields(); saveToStorage(); }
        function selectField(id) { state.selectedFieldId = id; renderFields(); renderProperties(); }
        function updateField(prop, value) { const field = state.fields.find(f => f.id === state.selectedFieldId); if (field) { field[prop] = value; renderFields(); saveToStorage(); } }

        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const sectionCount = state.fields.filter(f => f.type === 'section').length;
            document.getElementById('fieldCount').textContent = `üìä ${state.fields.length} fields | ${sectionCount + 1} page${sectionCount > 0 ? 's' : ''}`;
            if (state.fields.length === 0) { dropZone.classList.remove('has-fields'); dropZone.innerHTML = '<p style="font-size:36px;margin-bottom:12px;">üì•</p><p style="font-weight:600;">Click field types to add</p>'; return; }
            dropZone.classList.add('has-fields');
            let currentPage = 1;
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') { currentPage++; return `<div class="section-divider ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}"><span>üìÅ ${f.label.toUpperCase()}</span><div style="display:flex;align-items:center;gap:10px;"><span style="background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:10px;">PAGE ${currentPage}</span><div class="form-field-actions"><button class="field-action-btn move-up" onclick="moveField('${f.id}','up')">‚ñ≤</button><button class="field-action-btn move-down" onclick="moveField('${f.id}','down')">‚ñº</button><button class="field-action-btn delete" onclick="removeField('${f.id}')">üóëÔ∏è</button></div></div></div>`; }
                const def = fieldDefs[f.type];
                return `<div class="form-field ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}"><div class="form-field-header"><span class="form-field-label">${def?.icon || 'üìÑ'} ${f.label}</span><div class="form-field-actions"><button class="field-action-btn move-up" onclick="moveField('${f.id}','up')">‚ñ≤</button><button class="field-action-btn move-down" onclick="moveField('${f.id}','down')">‚ñº</button><button class="field-action-btn delete" onclick="removeField('${f.id}')">üóëÔ∏è</button></div></div><div style="font-size:10px;color:#868e96;">${f.name}${f.required ? '<span class="field-badge required">Required</span>' : ''}</div></div>`;
            }).join('');
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => el.addEventListener('click', (e) => { if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id); }));
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) { container.innerHTML = '<div class="no-selection"><p style="font-size:32px;margin-bottom:12px;">üëÜ</p><p>Select a field</p></div>'; return; }
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            let html = `<div class="prop-section"><div class="prop-section-title">üìù Basic Properties</div><div class="property-group"><label class="property-label">Label</label><input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}"></div><div class="property-group"><label class="property-label">Field Name</label><input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}"></div>${field.type !== 'section' ? `<div class="property-group"><label class="property-checkbox"><input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}><span>Required</span></label></div>` : ''}</div>`;
            if (['select', 'radio', 'checkbox'].includes(field.type)) { html += `<div class="prop-section"><div class="prop-section-title">üìã Options</div><div class="property-group"><label class="property-label">Options (one per line)</label><textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea></div></div>`; }
            if (field.type === 'rating') { html += `<div class="prop-section"><div class="prop-section-title">‚≠ê Rating</div><div class="property-group"><label class="property-label">Max Stars</label><select class="property-select" id="propMax">${[3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${field.max === n ? 'selected' : ''}>${n}</option>`).join('')}</select></div></div>`; }
            container.innerHTML = html;
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
            document.getElementById('propMax')?.addEventListener('change', (e) => updateField('max', parseInt(e.target.value) || 5));
        }

        function newForm() { if (state.fields.length > 0 && !confirm('Create new form?')) return; state.fields = []; state.selectedFieldId = null; state.fieldCounter = 0; const title = prompt('Form title:', 'New Form'); if (title) { state.settings.title = title; document.getElementById('formTitle').value = title; document.getElementById('previewTitle').textContent = title; } saveToStorage(); renderFields(); renderProperties(); notify('üìÑ New form!'); }
        function previewForm() { if (state.fields.length === 0) { notify('Add fields first!', 'error'); return; } state.isSharedMode = false; document.querySelector('.header').style.display = 'none'; document.getElementById('mainContainer').classList.remove('show'); document.querySelector('.footer').style.display = 'none'; document.getElementById('viewerContainer').classList.add('show'); renderFormViewer(); }
        function closeViewer() { document.getElementById('viewerContainer').classList.remove('show'); document.querySelector('.header').style.display = ''; document.getElementById('mainContainer').classList.add('show'); document.querySelector('.footer').style.display = ''; }
        
        function renderFormViewer() {
            const s = state.settings;
            let pages = [], currentPage = { title: 'Page 1', fields: [] };
            state.fields.forEach(field => { if (field.type === 'section') { if (currentPage.fields.length > 0) pages.push(currentPage); currentPage = { title: field.label, fields: [] }; } else { currentPage.fields.push(field); } });
            if (currentPage.fields.length > 0) pages.push(currentPage);
            if (pages.length === 0) pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    switch (field.type) {
                        case 'text': case 'email': case 'phone': case 'number': case 'date': case 'time': input = `<input type="${field.type === 'phone' ? 'tel' : field.type}" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                        case 'textarea': input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`; break;
                        case 'select': input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`; break;
                        case 'radio': case 'yesno': const opts = field.type === 'yesno' ? ['Yes','No'] : (field.options||[]); input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'checkbox': input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'gps': input = `<div style="text-align:center;"><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;">üìç Capture GPS</button><input type="hidden" name="${field.name}_lat"><input type="hidden" name="${field.name}_lng"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`; break;
                        case 'signature': input = `<div style="text-align:center;"><canvas class="sig-canvas" width="280" height="100" style="border:2px solid #004080;border-radius:6px;background:#fff;cursor:crosshair;touch-action:none;"></canvas><input type="hidden" name="${field.name}" class="sig-data"><button type="button" onclick="clearSig(this)" style="margin-top:6px;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;">Clear</button></div>`; break;
                        case 'rating': input = `<div class="rating-container">${Array(field.max || 5).fill().map((_, i) => `<span class="rating-star" onclick="setRating(this,${i+1})" style="font-size:24px;cursor:pointer;opacity:0.3;">‚≠ê</span>`).join('')}<input type="hidden" name="${field.name}"></div>`; break;
                        default: input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    return `<div class="viewer-field"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                const isFirst = pageIndex === 0, isLast = pageIndex === pages.length - 1;
                return `<div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}"><div class="page-header"><span class="page-indicator">Page ${pageIndex + 1} of ${pages.length}</span><h3 class="page-title">${escapeHtml(page.title)}</h3></div>${fieldsHtml}<div class="page-navigation">${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})">‚¨ÖÔ∏è Back</button>` : '<div></div>'}${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next ‚û°Ô∏è</button>` : ''}${isLast ? `<button type="submit" class="nav-btn submit-btn">‚úÖ Submit</button>` : ''}</div></div>`;
            }).join('');
            
            document.getElementById('viewerContainer').innerHTML = `
                <button class="viewer-back-btn" onclick="closeViewer()">‚¨ÖÔ∏è Back to Builder</button>
                <div class="viewer-nav">
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showViewerTab('form',this)">üìù Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showViewerTab('data',this)">üìä Data</button>
                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showViewerTab('dashboard',this)">üìà Dashboard</button>
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}" id="connectionStatus"><span>${navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'}</span></div>
                </div>
                <div id="tabForm" class="viewer-tab active"><div class="viewer-form"><div class="viewer-form-box"><div class="viewer-header"><img src="${s.logo}" alt="Logo"><h1>${escapeHtml(s.title)}</h1><p>${escapeHtml(s.subtitle)}</p></div><div class="viewer-body"><form id="viewerForm"><div class="progress-bar-container"><div class="progress-bar" id="formProgress" style="width: ${100/pages.length}%"></div></div>${pagesHtml}</form></div></div></div></div>
                <div id="tabData" class="viewer-tab data-tab-fullscreen"><div id="dataContainer"><p style="text-align:center;color:#868e96;padding:50px;">‚è≥ Loading...</p></div></div>
                <div id="tabDashboard" class="viewer-tab"><div style="max-width:900px;margin:0 auto;"><div class="viewer-form-box" style="margin-bottom:20px;"><div class="viewer-header" style="background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);"><h1>üìà Dashboard</h1></div><div class="viewer-body"><div class="dashboard-stats" id="dashboardStats"></div></div></div><div id="dashboardCharts"></div></div></div>
            `;
            window.totalPages = pages.length; window.currentPageIndex = 0;
            initSignaturePads(); setupFormSubmit(); loadViewerData(); loadViewerDashboard();
        }

        function shareForm() {
            if (state.fields.length === 0) { notify('Add fields first!', 'error'); return; }
            const formData = {
                s: { t: state.settings.title, st: state.settings.subtitle, o: state.settings.organization, l: state.settings.logo, u: CONFIG.SCRIPT_URL, g: CONFIG.SHEET_ID },
                f: state.fields.map(f => { const field = { i: f.id, y: f.type, l: f.label, n: f.name, r: f.required }; if (f.placeholder) field.p = f.placeholder; if (f.options?.length) field.o = f.options; if (f.max !== 5) field.mx = f.max; if (f.duplicateCheck) field.dc = true; return field; })
            };
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                const shareUrl = window.location.origin + window.location.pathname + '?d=' + encodeURIComponent(encoded);
                document.getElementById('shareFormTitle').textContent = state.settings.title;
                document.getElementById('shareUrl').textContent = shareUrl;
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: shareUrl, width: 200, height: 200, colorDark: '#004080', colorLight: '#ffffff' });
                saveFormToList();
                document.getElementById('shareModal').classList.add('show');
            } catch (err) { notify('Error: ' + err.message, 'error'); }
        }
        
        function copyShareUrl() { navigator.clipboard.writeText(document.getElementById('shareUrl').textContent); notify('üìã Copied!'); }
        function downloadQR() { const canvas = document.querySelector('#qrCode canvas'); if (canvas) { const link = document.createElement('a'); link.download = state.settings.title.replace(/[^a-z0-9]/gi, '_') + '_QR.png'; link.href = canvas.toDataURL(); link.click(); notify('‚¨áÔ∏è Downloaded!'); } }

        function saveCurrentForm() { if (state.fields.length === 0) { notify('Add fields first!', 'error'); return; } saveFormToList(); notify('üíæ Saved!'); }
        function saveFormToList() { const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]'); const existingIndex = forms.findIndex(f => f.title === state.settings.title); const formEntry = { id: existingIndex >= 0 ? forms[existingIndex].id : 'form_' + Date.now(), title: state.settings.title, subtitle: state.settings.subtitle, organization: state.settings.organization, logo: state.settings.logo, fieldCount: state.fields.length, updatedAt: new Date().toISOString(), fields: state.fields, settings: state.settings }; if (existingIndex >= 0) forms[existingIndex] = formEntry; else forms.push(formEntry); localStorage.setItem('formBuilderForms', JSON.stringify(forms)); }
        function showHome() { const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]'); let formsHtml = forms.length === 0 ? `<div style="text-align:center;padding:60px;color:#868e96;"><p style="font-size:64px;">üì≠</p><h3 style="color:#004080;">No Forms</h3><button onclick="closeHome()" style="padding:15px 30px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:20px;">‚ûï Create</button></div>` : forms.map((f, i) => `<div style="background:#fff;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);overflow:hidden;"><div style="background:linear-gradient(135deg,#004080,#002855);color:#fff;padding:15px 20px;"><h3 style="margin:0;">üìã ${escapeHtml(f.title)}</h3></div><div style="padding:15px 20px;"><div style="font-size:11px;color:#666;margin-bottom:15px;">üìä ${f.fieldCount} fields</div><div style="display:flex;gap:8px;"><button onclick="editForm(${i})" style="flex:1;padding:10px;background:#004080;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">‚úèÔ∏è Edit</button><button onclick="shareFormFromHome(${i})" style="flex:1;padding:10px;background:#17a2b8;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üîó Share</button><button onclick="deleteForm(${i})" style="padding:10px 15px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üóëÔ∏è</button></div></div></div>`).join(''); document.getElementById('homeContainer').innerHTML = `<div style="max-width:900px;margin:0 auto;padding:20px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;"><h2 style="color:#004080;">üè† My Forms</h2><button onclick="closeHome()" style="padding:12px 25px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">‚ûï New</button></div>${formsHtml}</div>`; document.querySelector('.header').style.display = 'none'; document.getElementById('mainContainer').classList.remove('show'); document.querySelector('.footer').style.display = 'none'; document.getElementById('homeContainer').classList.add('show'); }
        function closeHome() { document.getElementById('homeContainer').classList.remove('show'); document.querySelector('.header').style.display = 'flex'; document.getElementById('mainContainer').classList.add('show'); document.querySelector('.footer').style.display = 'block'; }
        function editForm(index) { const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]'); const form = forms[index]; if (!form) return; state.fields = form.fields || []; state.settings = { ...state.settings, ...form.settings }; state.fieldCounter = Math.max(...state.fields.map(f => parseInt(f.id.replace('field_', '')) || 0), 0) + 1; document.getElementById('formTitle').value = state.settings.title; document.getElementById('previewTitle').textContent = state.settings.title; saveToStorage(); closeHome(); renderFields(); renderProperties(); notify('üìÇ Loaded!'); }
        function shareFormFromHome(index) { const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]'); const form = forms[index]; if (!form) return; const tempFields = state.fields, tempSettings = state.settings; state.fields = form.fields; state.settings = form.settings; shareForm(); state.fields = tempFields; state.settings = tempSettings; }
        function deleteForm(index) { const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]'); if (!confirm(`Delete "${forms[index]?.title}"?`)) return; forms.splice(index, 1); localStorage.setItem('formBuilderForms', JSON.stringify(forms)); showHome(); notify('üóëÔ∏è Deleted'); }
        
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function notify(message, type = 'success') { const el = document.getElementById('notification'); el.textContent = message; el.className = 'notification show' + (type === 'error' ? ' error' : ''); setTimeout(() => el.classList.remove('show'), 3000); }
        function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
        function saveToStorage() { localStorage.setItem('formBuilderProEnhanced', JSON.stringify({ fields: state.fields, settings: state.settings, fieldCounter: state.fieldCounter })); }
        function loadFromStorage() { const saved = localStorage.getItem('formBuilderProEnhanced'); if (saved) { try { const data = JSON.parse(saved); state.fields = data.fields || []; state.settings = { ...state.settings, ...data.settings }; state.fieldCounter = data.fieldCounter || 0; } catch (e) { console.error('Load error:', e); } } }

        init();
    </script>
</body>
</html>
