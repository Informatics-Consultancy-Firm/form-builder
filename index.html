<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Auth Screens */
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-tab:hover { background: #f8f9fa; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; transition: border-color 0.2s; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        .auth-btn:hover { background: #003366; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        /* Header - FIXED */
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); min-height: 60px; }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); }
        .header h1 { font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; margin-right: 8px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .header-btn:hover { background: #f0f0f0; transform: translateY(-1px); }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        
        /* Main Layout */
        .main-container { display: none; margin-top: 60px; height: calc(100vh - 90px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
        .field-type { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .field-type:hover { border-color: #004080; background: linear-gradient(135deg, #e8f4fc 0%, #cce5ff 100%); transform: translateX(3px); box-shadow: 2px 2px 8px rgba(0,64,128,0.15); }
        .field-type-icon { font-size: 16px; }
        
        /* Canvas */
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; transition: all 0.2s; }
        .form-title-input:focus { outline: none; border-color: #004080; background: #f8f9fa; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; box-shadow: 0 4px 20px rgba(0,64,128,0.15); }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-header h2 { font-size: 18px; margin-bottom: 4px; }
        .form-preview-header p { font-size: 11px; opacity: 0.9; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        /* Drop Zone */
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; font-size: 13px; min-height: 180px; display: flex; flex-direction: column; justify-content: center; transition: all 0.3s; }
        .drop-zone.drag-over { border-color: #004080; background: #e8f4fc; }
        .drop-zone.has-fields { border: none; padding: 0; display: block; min-height: auto; }
        
        /* Form Fields - ENHANCED */
        .form-field { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; position: relative; }
        .form-field:hover { border-color: #004080; box-shadow: 0 3px 12px rgba(0,64,128,0.15); }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; display: flex; align-items: center; gap: 6px; }
        .form-field-label .field-icon { font-size: 14px; }
        
        /* BOLD VISIBLE ARROWS & DELETE */
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 6px; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; justify-content: center; min-width: 36px; }
        .field-action-btn:hover { background: #004080; color: white; border-color: #004080; transform: scale(1.1); }
        .field-action-btn.move-up, .field-action-btn.move-down { background: #17a2b8; color: white; border-color: #17a2b8; }
        .field-action-btn.move-up:hover, .field-action-btn.move-down:hover { background: #138496; border-color: #138496; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; font-size: 18px; }
        .field-action-btn.delete:hover { background: #c82333; border-color: #c82333; transform: scale(1.15); }
        
        .form-field-preview { background: white; border: 1px solid #dee2e6; border-radius: 5px; padding: 8px; font-size: 11px; color: #666; }
        .form-field-meta { margin-top: 8px; font-size: 10px; color: #868e96; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .field-badge.skip { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .field-badge.required { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .field-badge.validation { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .field-badge.conditional { background: #e2d5f1; color: #6f42c1; border: 1px solid #c9b8e8; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; font-size: 13px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,64,128,0.3); }
        .section-divider.selected { box-shadow: 0 0 0 4px rgba(0,64,128,0.3); }
        .section-divider .page-badge { background: rgba(255,255,255,0.25); padding: 4px 10px; border-radius: 12px; font-size: 10px; }
        .section-divider .form-field-actions .field-action-btn { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; }
        .section-divider .form-field-actions .field-action-btn:hover { background: rgba(255,255,255,0.4); }
        
        /* Properties Panel - ENHANCED */
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; transition: border-color 0.2s; }
        .property-input:focus, .property-select:focus { outline: none; border-color: #004080; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; resize: vertical; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; cursor: pointer; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; font-size: 12px; }
        
        /* Property Sections - FULL FEATURES */
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; text-transform: uppercase; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .prop-section-title .toggle-icon { transition: transform 0.2s; }
        .prop-section-title.collapsed .toggle-icon { transform: rotate(-90deg); }
        .prop-section-content { display: block; }
        .prop-section-content.hidden { display: none; }
        .prop-section.skip-logic { background: #fff8e1; border-color: #ffca28; }
        .prop-section.validation { background: #e3f2fd; border-color: #42a5f5; }
        .prop-section.conditional { background: #f3e5f5; border-color: #ab47bc; }
        
        .prop-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; flex-wrap: wrap; }
        .prop-row .property-input, .prop-row .property-select { flex: 1; min-width: 80px; }
        .prop-row span { font-size: 10px; color: #666; white-space: nowrap; }
        
        /* Validation Rules Grid */
        .validation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .validation-item { display: flex; align-items: center; gap: 6px; font-size: 10px; padding: 6px 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6; }
        .validation-item input[type="checkbox"] { width: 14px; height: 14px; }
        .validation-item input[type="text"], .validation-item input[type="number"] { width: 60px; padding: 4px; border: 1px solid #dee2e6; border-radius: 3px; font-size: 10px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; border: 4px double #004080; }
        .modal-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 5px; }
        .modal-body { padding: 20px; max-height: 65vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 2px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; }
        .modal-btn { padding: 10px 20px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; text-transform: uppercase; border: 2px solid; transition: all 0.2s; }
        .modal-btn.secondary { background: white; color: #004080; border-color: #004080; }
        .modal-btn.secondary:hover { background: #f0f0f0; }
        .modal-btn.primary { background: #004080; color: white; border-color: #004080; }
        .modal-btn.primary:hover { background: #003366; }
        .modal-btn.success { background: #28a745; color: white; border-color: #28a745; }
        .modal-btn.success:hover { background: #218838; }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 15px; flex-wrap: wrap; }
        .tab { padding: 12px 18px; cursor: pointer; font-weight: 700; font-size: 12px; border-bottom: 3px solid transparent; margin-bottom: -2px; text-transform: uppercase; transition: all 0.2s; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #004080; color: #004080; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Settings */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .settings-group { margin-bottom: 15px; }
        .settings-group.full-width { grid-column: span 2; }
        .settings-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .settings-input { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .settings-input:focus { outline: none; border-color: #004080; }
        .settings-hint { font-size: 10px; color: #868e96; margin-top: 4px; }
        
        /* Table Builder - ENHANCED */
        .table-builder { border: 2px solid #004080; border-radius: 8px; overflow: hidden; margin: 12px 0; }
        .table-builder-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .table-builder-header span { font-size: 12px; font-weight: 700; }
        .table-builder-body { max-height: 250px; overflow: auto; }
        .table-builder table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .table-builder th, .table-builder td { border: 1px solid #dee2e6; padding: 8px 10px; text-align: left; }
        .table-builder th { background: #e9ecef; font-weight: 700; text-transform: uppercase; font-size: 10px; position: sticky; top: 0; }
        .table-builder input, .table-builder select { width: 100%; padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; font-family: 'Oswald', sans-serif; }
        .table-builder input:focus, .table-builder select:focus { outline: none; border-color: #004080; }
        .table-actions { display: flex; gap: 6px; flex-wrap: wrap; padding: 10px; background: #f8f9fa; border-top: 1px solid #dee2e6; }
        .table-action-btn { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 10px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .table-action-btn:hover { opacity: 0.9; }
        .table-action-btn.remove { background: #dc3545; }
        .table-action-btn.secondary { background: #6c757d; }
        
        /* Column Config */
        .column-config { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .column-config-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .column-config-title { font-weight: 700; font-size: 11px; color: #004080; }
        .column-config-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; }
        
        /* QR Code */
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,64,128,0.2); }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCode canvas, #qrCode img { display: block !important; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; border: 2px solid #dee2e6; text-align: left; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        
        /* Notification */
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .notification.show { display: block; animation: slideIn 0.3s ease; }
        .notification.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Info Box */
        .info-box { background: #e8f4fc; border: 2px solid #004080; border-radius: 8px; padding: 12px; font-size: 11px; margin: 12px 0; }
        .info-box h4 { color: #004080; margin-bottom: 6px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .info-box.warning { background: #fff3cd; border-color: #ffc107; }
        .info-box.warning h4 { color: #856404; }
        
        /* Toggle Switch */
        .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .toggle-slider { width: 44px; height: 22px; background: #ccc; border-radius: 11px; position: relative; transition: background 0.3s; }
        .toggle-slider::after { content: ''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle-switch input { display: none; }
        .toggle-switch input:checked + .toggle-slider { background: #28a745; }
        .toggle-switch input:checked + .toggle-slider::after { left: 24px; }
        
        /* Viewer Container */
        .viewer-container { display: none; min-height: 100vh; background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); align-items: center; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; text-decoration: none; text-transform: uppercase; transition: all 0.2s; cursor: pointer; border: none; }
        .viewer-nav-btn:hover { transform: translateY(-2px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .viewer-nav-btn.active { box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; animation: pulse 1.5s infinite; }
        .connection-status .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pending-sync-badge { background: #ffc107; color: #000; padding: 4px 8px; border-radius: 10px; font-size: 9px; font-weight: 700; margin-left: 5px; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,64,128,0.15); }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; border: 2px solid rgba(255,255,255,0.3); }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; transition: all 0.2s; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .viewer-radio-option:hover { border-color: #004080; background: #f8f9fa; }
        .viewer-section { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 14px 18px; margin: 20px -25px; font-size: 13px; font-weight: 700; text-transform: uppercase; }
        .viewer-submit { width: 100%; padding: 16px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; text-transform: uppercase; margin-top: 15px; transition: all 0.2s; }
        .viewer-submit:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(40,167,69,0.4); }
        .viewer-draft-btn { width: 100%; padding: 12px; background: #ffc107; color: #000; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .viewer-draft-btn:hover { background: #e0a800; }
        .viewer-back-btn { position: fixed; top: 15px; left: 20px; background: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; z-index: 200; box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
        .viewer-back-btn:hover { background: #c82333; transform: translateY(-2px); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; text-transform: uppercase; font-size: 10px; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e8f4fc; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .stat-value { font-size: 32px; font-weight: 700; }
        .stat-card .stat-label { font-size: 11px; opacity: 0.9; text-transform: uppercase; margin-top: 5px; }
        .draft-item { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 6px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .draft-item:hover { border-color: #ffc107; }
        .gps-container { text-align: center; }
        .gps-status { font-size: 11px; color: #28a745; margin-top: 6px; }
        .sig-container { text-align: center; }
        .sig-canvas { display: block; margin: 0 auto; cursor: crosshair; }
        
        /* Multi-Page Form Styles */
        .progress-bar-container { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(135deg, #28a745 0%, #218838 100%); border-radius: 4px; transition: width 0.3s ease; }
        .form-page { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .page-header { background: linear-gradient(135deg, #e8f4fc 0%, #d4edfc 100%); margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; text-transform: uppercase; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .back-btn { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; }
        .back-btn:hover { background: linear-gradient(135deg, #5a6268 0%, #495057 100%); }
        .next-btn { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; }
        .next-btn:hover { background: linear-gradient(135deg, #002855 0%, #001a3d 100%); }
        .submit-btn { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; }
        .submit-btn:hover { background: linear-gradient(135deg, #218838 0%, #1e7e34 100%); }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .settings-grid { grid-template-columns: 1fr; }
            .settings-group.full-width { grid-column: span 1; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .viewer-nav { padding: 10px; }
            .viewer-nav-btn { padding: 8px 12px; font-size: 10px; }
            .page-navigation { flex-direction: column; }
            .nav-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>Form Builder Pro</h1>
                <p>Advanced Data Collection Forms</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn" id="loginBtn">Login</button>
                </form>
                
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Organization</label>
                        <input type="text" class="auth-input" id="signupOrg" value="ICF-SL">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Confirm Password</label>
                        <input type="password" class="auth-input" id="signupConfirm" required placeholder="Confirm password">
                    </div>
                    <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Builder -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>üìã Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser">üë§ User</span>
            <button class="header-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è Preview</button>
            <button class="header-btn primary" onclick="shareForm()">üîó Share</button>
            <button class="header-btn success" onclick="generateForm()">‚¨áÔ∏è Generate</button>
            <button class="header-btn danger" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic Fields</h3>
                <div class="field-type" data-type="text"><span class="field-type-icon">üìÑ</span>Text Input</div>
                <div class="field-type" data-type="number"><span class="field-type-icon">üî¢</span>Number</div>
                <div class="field-type" data-type="date"><span class="field-type-icon">üìÖ</span>Date</div>
                <div class="field-type" data-type="time"><span class="field-type-icon">üïê</span>Time</div>
                <div class="field-type" data-type="email"><span class="field-type-icon">üìß</span>Email</div>
                <div class="field-type" data-type="phone"><span class="field-type-icon">üì±</span>Phone</div>
                <div class="field-type" data-type="textarea"><span class="field-type-icon">üìù</span>Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection Fields</h3>
                <div class="field-type" data-type="select"><span class="field-type-icon">üìã</span>Dropdown</div>
                <div class="field-type" data-type="radio"><span class="field-type-icon">üîò</span>Radio Buttons</div>
                <div class="field-type" data-type="checkbox"><span class="field-type-icon">‚òëÔ∏è</span>Checkboxes</div>
                <div class="field-type" data-type="yesno"><span class="field-type-icon">‚úÖ</span>Yes / No</div>
                <div class="field-type" data-type="yesnona"><span class="field-type-icon">‚ùì</span>Yes / No / NA</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìä Table Fields</h3>
                <div class="field-type" data-type="table"><span class="field-type-icon">üìã</span>Static Table</div>
                <div class="field-type" data-type="dynamicTable"><span class="field-type-icon">‚ûï</span>Dynamic Table</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìç Location</h3>
                <div class="field-type" data-type="cascading"><span class="field-type-icon">üè¢</span>Cascading Select</div>
                <div class="field-type" data-type="gps"><span class="field-type-icon">üìç</span>GPS Location</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special Fields</h3>
                <div class="field-type" data-type="camera"><span class="field-type-icon">üì∑</span>Camera</div>
                <div class="field-type" data-type="qrscanner"><span class="field-type-icon">üì±</span>QR Scanner</div>
                <div class="field-type" data-type="signature"><span class="field-type-icon">‚úçÔ∏è</span>Signature</div>
                <div class="field-type" data-type="rating"><span class="field-type-icon">‚≠ê</span>Rating</div>
                <div class="field-type" data-type="file"><span class="field-type-icon">üìé</span>File Upload</div>
                <div class="field-type" data-type="calculated"><span class="field-type-icon">üî¢</span>Calculated</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section"><span class="field-type-icon">üìÅ</span>Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount">üìä 0 fields | 1 page</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p id="previewSubtitle">Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:36px;margin-bottom:12px;">üì•</p>
                            <p style="font-weight:600;">Click field types on the left to add them</p>
                            <p style="margin-top:8px;font-size:11px;color:#adb5bd;">Or drag and drop here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title">‚öôÔ∏è Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;">üëÜ</p>
                    <p>Select a field to edit its properties</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>

    <footer class="footer">¬© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | Form Builder Pro</footer>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è Form Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="cascading">Cascading</div>
                    <div class="tab" data-tab="google">Google Sheets</div>
                </div>

                <div class="tab-content active" id="tab-general">
                    <div class="settings-grid">
                        <div class="settings-group">
                            <label class="settings-label">Form Title</label>
                            <input type="text" class="settings-input" id="settingsTitle">
                        </div>
                        <div class="settings-group">
                            <label class="settings-label">Subtitle</label>
                            <input type="text" class="settings-input" id="settingsSubtitle">
                        </div>
                        <div class="settings-group full-width">
                            <label class="settings-label">Organization</label>
                            <input type="text" class="settings-input" id="settingsOrg">
                        </div>
                        <div class="settings-group full-width">
                            <label class="settings-label">Logo URL</label>
                            <input type="text" class="settings-input" id="settingsLogo">
                        </div>
                        <div class="settings-group full-width">
                            <label class="toggle-switch">
                                <input type="checkbox" id="settingsMultiPage" checked>
                                <span class="toggle-slider"></span>
                                <span style="font-size:12px;">Enable Multi-Page Navigation</span>
                            </label>
                            <div class="settings-hint">Each section becomes a separate page</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-cascading">
                    <div class="info-box">
                        <h4>üè¢ Cascading Select Data</h4>
                        <p>Enter location hierarchy data. Format: Parent||Child or Parent||Child||UID</p>
                    </div>
                    <div class="settings-group" style="margin-top:12px;">
                        <label class="settings-label">Hierarchy Data (one per line)</label>
                        <textarea class="property-textarea" id="cascadingData" style="height:150px;font-family:monospace;font-size:10px;" placeholder="Eastern Region||Kailahun District&#10;Kailahun District||Luawa Chiefdom&#10;Luawa Chiefdom||Kailahun Hospital||abc123"></textarea>
                    </div>
                </div>

                <div class="tab-content" id="tab-google">
                    <div class="settings-group">
                        <label class="settings-label">Apps Script Web App URL</label>
                        <input type="text" class="settings-input" id="settingsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <div class="settings-hint">Deploy your Apps Script and paste the URL here</div>
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">Google Sheet ID</label>
                        <input type="text" class="settings-input" id="settingsSheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                        <div class="settings-hint">From your Google Sheet URL (between /d/ and /edit)</div>
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">Duplicate Check Field</label>
                        <select class="settings-input" id="settingsDuplicateField">
                            <option value="">-- No duplicate check --</option>
                        </select>
                        <div class="settings-hint">Prevent duplicate submissions based on this field</div>
                    </div>
                    <div class="info-box warning">
                        <h4>üìã Setup Instructions:</h4>
                        <ol style="margin-left:15px;font-size:10px;line-height:1.8;">
                            <li>Create a Google Sheet</li>
                            <li>Go to Extensions ‚Üí Apps Script</li>
                            <li>Click "Generate" button to get the Apps Script code</li>
                            <li>Paste the code in Apps Script editor</li>
                            <li>Deploy ‚Üí New deployment ‚Üí Web app</li>
                            <li>Set "Who has access" to "Anyone"</li>
                            <li>Copy the Web App URL and paste above</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>üîó Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:20px;font-weight:700;color:#004080;" id="shareFormTitle">Form Title</div>
                    <div style="font-size:11px;color:#666;">Share this form with anyone</div>
                </div>
                <div class="qr-container">
                    <div class="qr-box">
                        <div id="qrCode"></div>
                    </div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;">üì± Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()">üìã Copy URL</button>
                        <button class="modal-btn success" onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Modal -->
    <div class="modal-overlay" id="generateModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h3>üì• Generated Form</h3>
                <button class="modal-close" onclick="closeModal('generateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="html-code">HTML Form</div>
                    <div class="tab" data-tab="apps-script">Apps Script</div>
                </div>
                
                <div class="tab-content active" id="tab-html-code">
                    <div style="margin-bottom:12px;display:flex;gap:8px;">
                        <button class="modal-btn primary" onclick="downloadHTML()">‚¨áÔ∏è Download HTML</button>
                        <button class="modal-btn secondary" onclick="copyCode('htmlCode')">üìã Copy Code</button>
                    </div>
                    <pre id="htmlCode" style="background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:8px;font-size:10px;max-height:350px;overflow:auto;white-space:pre-wrap;"></pre>
                </div>
                
                <div class="tab-content" id="tab-apps-script">
                    <div style="margin-bottom:12px;display:flex;gap:8px;">
                        <button class="modal-btn primary" onclick="downloadScript()">‚¨áÔ∏è Download .gs</button>
                        <button class="modal-btn secondary" onclick="copyCode('scriptCode')">üìã Copy Code</button>
                    </div>
                    <pre id="scriptCode" style="background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:8px;font-size:10px;max-height:350px;overflow:auto;white-space:pre-wrap;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('generateModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Table Config Modal -->
    <div class="modal-overlay" id="tableConfigModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>üìä Configure Table Columns</h3>
                <button class="modal-close" onclick="closeModal('tableConfigModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="tableColumnsConfig"></div>
                <button class="table-action-btn" onclick="addTableColumn()" style="margin-top:12px;">‚ûï Add Column</button>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('tableConfigModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveTableConfig()">üíæ Save</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            editingTableFieldId: null,
            settings: {
                title: 'My Data Collection Form',
                subtitle: 'Data Collection System',
                organization: 'ICF-SL',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                scriptUrl: '',
                sheetId: '',
                multiPage: true,
                cascadingData: '',
                duplicateCheckField: ''
            }
        };

        // Field definitions with all options
        const fieldDefs = {
            text: { label: 'Text Input', icon: 'üìÑ', defaultLabel: 'Text Field', validations: ['required', 'minLength', 'maxLength', 'pattern', 'noSpaces', 'alphanumeric', 'uppercase', 'lowercase'] },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field', validations: ['required', 'min', 'max', 'integer', 'positive', 'negative', 'decimal'] },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field', validations: ['required', 'minDate', 'maxDate', 'notFuture', 'notPast', 'weekdaysOnly'] },
            time: { label: 'Time', icon: 'üïê', defaultLabel: 'Time Field', validations: ['required', 'minTime', 'maxTime'] },
            email: { label: 'Email', icon: 'üìß', defaultLabel: 'Email Address', validations: ['required', 'domain'] },
            phone: { label: 'Phone', icon: 'üì±', defaultLabel: 'Phone Number', validations: ['required', 'format'] },
            textarea: { label: 'Long Text', icon: 'üìù', defaultLabel: 'Long Text', validations: ['required', 'minLength', 'maxLength', 'minWords', 'maxWords'] },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', options: ['Option 1', 'Option 2', 'Option 3'], validations: ['required'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Choice', options: ['Option 1', 'Option 2', 'Option 3'], validations: ['required'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkbox', options: ['Option 1', 'Option 2', 'Option 3'], validations: ['required', 'minSelect', 'maxSelect'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question', validations: ['required'] },
            yesnona: { label: 'Yes/No/NA', icon: '‚ùì', defaultLabel: 'Yes/No/NA', validations: ['required'] },
            camera: { label: 'Camera', icon: 'üì∑', defaultLabel: 'Take Photo', validations: ['required'] },
            qrscanner: { label: 'QR Scanner', icon: 'üì±', defaultLabel: 'Scan QR Code', validations: ['required'] },
            table: { label: 'Static Table', icon: 'üìã', defaultLabel: 'Data Table', columns: [{ name: 'Column 1', type: 'text', width: 'auto' }, { name: 'Column 2', type: 'text', width: 'auto' }], rows: 3 },
            dynamicTable: { label: 'Dynamic Table', icon: '‚ûï', defaultLabel: 'Dynamic Table', columns: [{ name: 'Item', type: 'text', width: 'auto' }, { name: 'Quantity', type: 'number', width: '80px' }, { name: 'Notes', type: 'text', width: 'auto' }], minRows: 1, maxRows: 20 },
            cascading: { label: 'Cascading', icon: 'üè¢', defaultLabel: 'Location', levels: ['Region', 'District', 'Chiefdom', 'Facility'], validations: ['required'] },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location', validations: ['required', 'accuracy'] },
            signature: { label: 'Signature', icon: '‚úçÔ∏è', defaultLabel: 'Signature', validations: ['required'] },
            rating: { label: 'Rating', icon: '‚≠ê', defaultLabel: 'Rating', max: 5, validations: ['required', 'min'] },
            file: { label: 'File', icon: 'üìé', defaultLabel: 'File Upload', accept: '.pdf,.jpg,.png,.doc,.docx', validations: ['required', 'maxSize', 'fileTypes'] },
            calculated: { label: 'Calculated', icon: 'üî¢', defaultLabel: 'Calculated Field', formula: '' },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section' }
        };

        let currentShareUrl = '';
        let offlineSubmissions = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('c');
            
            // Show offline indicator if needed
            if (!navigator.onLine) {
                showOfflineIndicator();
            }
            window.addEventListener('online', hideOfflineIndicator);
            window.addEventListener('offline', showOfflineIndicator);
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    renderSharedForm(data);
                    return;
                } catch (err) {
                    console.error('Error decoding shared form:', err);
                    // Try to load from cache if offline
                    if (!navigator.onLine) {
                        loadCachedForm();
                        return;
                    }
                }
            }
            
            // Check for cached form parameter
            const cachedFormName = urlParams.get('form');
            if (cachedFormName && !navigator.onLine) {
                loadCachedForm(cachedFormName);
                return;
            }
            
            loadFromStorage();
            setupEventListeners();
            checkAuth();
            
            // Try to sync offline data when online
            if (navigator.onLine) {
                syncOfflineData();
            }
        }
        
        function showOfflineIndicator() {
            updateConnectionStatus(false);
        }
        
        function hideOfflineIndicator() {
            updateConnectionStatus(true);
            // Try to sync when back online
            syncOfflineData();
        }
        
        function updateConnectionStatus(isOnline) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.className = 'connection-status ' + (isOnline ? 'online' : 'offline');
                statusEl.querySelector('.status-text').textContent = isOnline ? 'üü¢ Online' : 'üî¥ Offline';
            }
            updatePendingSyncBadge();
        }
        
        function updatePendingSyncBadge() {
            const badge = document.getElementById('pendingSyncBadge');
            if (badge) {
                const offlineData = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
                if (offlineData.length > 0) {
                    badge.textContent = offlineData.length;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Update status on page load and when online/offline
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));
        setInterval(updatePendingSyncBadge, 5000); // Update badge every 5 seconds
        
        function loadCachedForm(formName) {
            // Find cached forms
            const cacheKeys = Object.keys(localStorage).filter(k => k.startsWith('cachedForm_'));
            
            if (cacheKeys.length === 0) {
                notify('No cached forms available offline', 'error');
                return;
            }
            
            // If specific form requested
            if (formName) {
                const cached = localStorage.getItem('cachedForm_' + formName);
                if (cached) {
                    const data = JSON.parse(cached);
                    state.settings = data.settings;
                    state.fields = data.fields;
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContainer').classList.remove('show');
                    document.querySelector('.header').style.display = 'none';
                    document.querySelector('.footer').style.display = 'none';
                    document.getElementById('viewerContainer').classList.add('show');
                    renderSharedFormViewer();
                    return;
                }
            }
            
            // Load most recent cached form
            let mostRecent = null;
            let mostRecentTime = 0;
            cacheKeys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const cachedTime = new Date(data.cachedAt).getTime();
                    if (cachedTime > mostRecentTime) {
                        mostRecentTime = cachedTime;
                        mostRecent = data;
                    }
                } catch(e) {}
            });
            
            if (mostRecent) {
                state.settings = mostRecent.settings;
                state.fields = mostRecent.fields;
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').classList.remove('show');
                document.querySelector('.header').style.display = 'none';
                document.querySelector('.footer').style.display = 'none';
                document.getElementById('viewerContainer').classList.add('show');
                renderSharedFormViewer();
                notify('üì¥ Loaded cached form (offline mode)');
            }
        }
        
        function renderSharedForm(data) {
            // Hide auth and main containers
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            // Set state from shared data
            state.settings = {
                title: data.t || 'Form',
                subtitle: data.s || 'Data Collection',
                organization: data.o || 'ICF-SL',
                logo: data.l || 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                multiPage: true,
                cascadingData: '',
                scriptUrl: data.u || '',           // Apps Script URL
                sheetId: data.g || '',             // Google Sheet ID
                duplicateCheckField: data.df || '' // Duplicate check field
            };
            
            state.fields = (data.f || []).map(f => ({
                id: f.i, type: f.y, label: f.l, name: f.n, required: f.r || false,
                placeholder: f.p || '', helpText: f.h || '',
                options: f.o || [], levels: f.v || [], columns: f.c || [],
                rows: f.rw || 3, max: f.mx || 5, accept: f.a || '', formula: f.fm || '',
                skipLogic: f.k || { enabled: false },
                validation: f.d || { enabled: false, rules: {} },
                conditional: f.cn || { enabled: false }
            }));
            
            // Cache form data for offline use
            try {
                localStorage.setItem('cachedForm_' + state.settings.title, JSON.stringify({
                    settings: state.settings,
                    fields: state.fields,
                    cachedAt: new Date().toISOString()
                }));
            } catch(e) { console.log('Cache error:', e); }
            
            // Show viewer container and render form
            document.getElementById('viewerContainer').classList.add('show');
            renderSharedFormViewer();
        }
        
        function renderSharedFormViewer() {
            const s = state.settings;
            
            // Group fields by sections (pages)
            let pages = [];
            let currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) {
                        pages.push(currentPage);
                    }
                    currentPage = { title: field.label, fields: [] };
                } else {
                    currentPage.fields.push(field);
                }
            });
            if (currentPage.fields.length > 0) {
                pages.push(currentPage);
            }
            
            // If no sections, put all fields on one page
            if (pages.length === 0) {
                pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            }
            
            // Generate pages HTML
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span class="required" style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'text': input = `<input type="text" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`; break;
                        case 'email': input = `<input type="email" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`; break;
                        case 'phone': input = `<input type="tel" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || 'Enter 9 digits')}" pattern="[0-9]{9}" maxlength="9" minlength="9" title="Please enter exactly 9 digits" oninput="this.value=this.value.replace(/[^0-9]/g,'')" ${reqAttr}>`; break;
                        case 'number': input = `<input type="number" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`; break;
                        case 'date': input = `<input type="date" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                        case 'time': input = `<input type="time" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                        case 'textarea': input = `<textarea name="${field.name}" class="viewer-input" rows="3" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}></textarea>`; break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`; break;
                        case 'radio': case 'yesno': case 'yesnona':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : field.type === 'yesnona' ? ['Yes','No','N/A'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'gps':
                            input = `<div class="gps-container"><button type="button" class="viewer-draft-btn" onclick="captureGPS(this)" style="width:auto;padding:10px 20px;">üìç Capture GPS</button><input type="hidden" name="${field.name}_lat"><input type="hidden" name="${field.name}_lng"><div class="gps-status"></div></div>`; break;
                        case 'camera':
                            input = `<div class="camera-container"><button type="button" class="viewer-draft-btn" onclick="openCamera(this, '${field.name}')" style="width:auto;padding:10px 20px;background:#17a2b8;">üì∑ Take Photo</button><input type="hidden" name="${field.name}" class="camera-data"><div class="camera-preview" style="margin-top:10px;"></div></div>`; break;
                        case 'qrscanner':
                            input = `<div class="qr-container"><button type="button" class="viewer-draft-btn" onclick="openQRScanner(this, '${field.name}')" style="width:auto;padding:10px 20px;background:#6f42c1;">üì± Scan QR Code</button><input type="text" name="${field.name}" class="viewer-input qr-result" placeholder="QR code value will appear here" readonly style="margin-top:10px;"></div>`; break;
                        case 'signature':
                            input = `<div class="sig-container"><canvas class="sig-canvas" width="280" height="100" style="border:2px solid #004080;border-radius:6px;background:#fff;touch-action:none;"></canvas><input type="hidden" name="${field.name}" class="sig-data"><button type="button" onclick="clearSig(this)" style="margin-top:6px;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;font-size:10px;cursor:pointer;">Clear</button></div>`; break;
                        case 'rating':
                            input = `<div class="rating-container">${Array(field.max || 5).fill().map((_, i) => `<span class="rating-star" onclick="setRating(this,${i+1})" style="font-size:24px;cursor:pointer;opacity:0.3;">‚≠ê</span>`).join('')}<input type="hidden" name="${field.name}"></div>`; break;
                        case 'file':
                            input = `<input type="file" name="${field.name}" class="viewer-input" accept="${field.accept || ''}" ${reqAttr}>`; break;
                        default: input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field" data-field-id="${field.id}"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0;
                const isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        <div class="page-header">
                            <span class="page-indicator">Page ${pageIndex + 1} of ${pages.length}</span>
                            <h3 class="page-title">${escapeHtml(page.title)}</h3>
                        </div>
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})">‚¨ÖÔ∏è Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next ‚û°Ô∏è</button>` : ''}
                            ${isLast ? `<button type="button" class="viewer-draft-btn" onclick="saveDraft()" style="width:auto;margin:0 10px;">üíæ Save Draft</button><button type="submit" class="nav-btn submit-btn">‚úÖ Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showViewerTab('form',this)">üìù Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showViewerTab('data',this)">üìä Data</button>
                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showViewerTab('dashboard',this)">üìà Dashboard</button>
                    <button class="viewer-nav-btn" style="background:#6c757d;color:#fff;" onclick="showViewerTab('report',this)">üìÑ Report</button>
                    <button class="viewer-nav-btn" style="background:#ffc107;color:#000;" onclick="showViewerTab('drafts',this)">üíæ Drafts</button>
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}" id="connectionStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">${navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                        <span class="pending-sync-badge" id="pendingSyncBadge" style="display:none;">0</span>
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                                <p>${escapeHtml(s.subtitle)}</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="formProgress" style="width: ${100/pages.length}%"></div>
                                    </div>
                                    ${pagesHtml}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#28a745 0%,#218838 100%);">
                                <h1>üìä Submitted Data</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body" id="dataContainer">
                                <p style="text-align:center;color:#868e96;">üì≠ No submissions yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDashboard" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);">
                                <h1>üìà Dashboard</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body" id="dashboardContainer">
                                <div class="dashboard-stats" id="dashboardStats"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabReport" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%);">
                                <h1>üìÑ Report</h1>
                                <button onclick="window.print()" style="background:#fff;color:#6c757d;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:700;margin-top:10px;font-family:Oswald;">üñ®Ô∏è Print</button>
                            </div>
                            <div class="viewer-body" id="reportContainer"></div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDrafts" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#ffc107 0%,#e0a800 100%);color:#000;">
                                <h1>üíæ Saved Drafts</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body" id="draftsContainer">
                                <p style="text-align:center;color:#868e96;">No drafts saved</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Store total pages
            window.totalPages = pages.length;
            window.currentPageIndex = 0;
            
            // Initialize signature pads
            document.querySelectorAll('.sig-canvas').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                let drawing = false;
                ctx.strokeStyle = '#004080';
                ctx.lineWidth = 2;
                canvas.onmousedown = e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
                canvas.onmousemove = e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
                canvas.onmouseup = () => { drawing = false; const dataInput = canvas.parentElement.querySelector('.sig-data'); if (dataInput) dataInput.value = canvas.toDataURL(); };
                canvas.onmouseleave = () => drawing = false;
                // Touch
                canvas.ontouchstart = e => { e.preventDefault(); drawing = true; const t = e.touches[0]; const r = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(t.clientX - r.left, t.clientY - r.top); };
                canvas.ontouchmove = e => { e.preventDefault(); if (drawing) { const t = e.touches[0]; const r = canvas.getBoundingClientRect(); ctx.lineTo(t.clientX - r.left, t.clientY - r.top); ctx.stroke(); } };
                canvas.ontouchend = () => { drawing = false; const dataInput = canvas.parentElement.querySelector('.sig-data'); if (dataInput) dataInput.value = canvas.toDataURL(); };
            });
            
            // Form submit
            document.getElementById('viewerForm').onsubmit = async function(e) {
                e.preventDefault();
                const form = this;
                const submitBtn = form.querySelector('.submit-btn, .viewer-submit');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚è≥ Submitting...';
                }
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString() };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                // Check for duplicates
                const dupField = state.settings.duplicateCheckField;
                if (dupField && data[dupField]) {
                    const isDuplicate = await checkDuplicate(dupField, data[dupField]);
                    if (isDuplicate) {
                        notify(`‚ùå Duplicate entry! "${data[dupField]}" already exists.`, 'error');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = '‚úÖ Submit';
                        }
                        return;
                    }
                }
                
                // Submit to Google Sheets
                const result = await submitToGoogleSheets(data);
                
                if (result.success) {
                    saveLocally(data);
                    form.reset();
                    window.currentPageIndex = 0;
                    goToPage(0);
                    
                    if (result.offline) {
                        notify('üíæ Saved offline. Will sync when online.');
                    } else {
                        notify('‚úÖ Submitted successfully!');
                    }
                } else {
                    notify('‚ö†Ô∏è Saved offline. Will sync when online.');
                }
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úÖ Submit';
                }
            };
            
            // Load initial data
            loadViewerData();
            loadViewerDashboard();
            loadViewerReport();
            loadViewerDrafts();
        }

        function setupEventListeners() {
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab));
            });

            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);

            // Field types - click to add
            document.querySelectorAll('.field-type').forEach(el => {
                el.addEventListener('click', () => addField(el.dataset.type));
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('fieldType', el.dataset.type);
                    el.style.opacity = '0.5';
                });
                el.addEventListener('dragend', () => el.style.opacity = '1');
            });

            // Drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const type = e.dataTransfer.getData('fieldType');
                if (type) addField(type);
            });

            // Title sync
            const titleInput = document.getElementById('formTitle');
            titleInput.value = state.settings.title;
            titleInput.addEventListener('input', () => {
                state.settings.title = titleInput.value;
                document.getElementById('previewTitle').textContent = titleInput.value;
                saveToStorage();
            });

            // Setup tabs
            setupTabs();

            // Modal close on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        function setupTabs() {
            document.querySelectorAll('.tabs').forEach(tabContainer => {
                tabContainer.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const parent = this.closest('.modal-body') || this.closest('.modal');
                        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        const tabContent = document.getElementById('tab-' + this.dataset.tab);
                        if (tabContent) tabContent.classList.add('active');
                    });
                });
            });
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) {
                state.user = JSON.parse(saved);
                showBuilder();
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
            hideAuthMessages();
        }

        function hideAuthMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function showAuthSuccess(msg) {
            const el = document.getElementById('authSuccess');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function handleLogin(e) {
            e.preventDefault();
            hideAuthMessages();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                state.user = user;
                localStorage.setItem('formBuilderUser', JSON.stringify(user));
                showBuilder();
            } else {
                showAuthError('Invalid email or password');
            }
        }

        function handleSignup(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const org = document.getElementById('signupOrg').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            
            if (password !== confirm) { showAuthError('Passwords do not match'); return; }
            if (password.length < 6) { showAuthError('Password must be at least 6 characters'); return; }
            
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) { showAuthError('Email already registered'); return; }
            
            const newUser = { id: Date.now().toString(), name, email, org, password, createdAt: new Date().toISOString() };
            users.push(newUser);
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            showAuthSuccess('Account created! Please login.');
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = `üë§ ${state.user?.name || 'User'}`;
            renderFields();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('formBuilderUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ============================================
        // FIELD MANAGEMENT
        // ============================================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;

            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                levels: def.levels ? [...def.levels] : [],
                columns: def.columns ? JSON.parse(JSON.stringify(def.columns)) : [],
                rows: def.rows || 3,
                minRows: def.minRows || 1,
                maxRows: def.maxRows || 20,
                max: def.max || 5,
                accept: def.accept || '',
                formula: def.formula || '',
                placeholder: '',
                helpText: '',
                defaultValue: '',
                validation: { 
                    enabled: false, 
                    rules: {},
                    customMessage: ''
                },
                skipLogic: { 
                    enabled: false, 
                    action: 'show', 
                    conditions: [{ field: '', operator: 'equals', value: '' }],
                    logic: 'all'
                },
                conditional: {
                    enabled: false,
                    statements: [{ if: '', operator: 'equals', value: '', then: '', result: '' }]
                }
            };

            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
            notify('‚úÖ Field added!');
        }

        function removeField(id) {
            event?.stopPropagation();
            if (!confirm('Delete this field?')) return;
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) {
                state.selectedFieldId = null;
                renderProperties();
            }
            renderFields();
            saveToStorage();
            notify('üóëÔ∏è Field deleted');
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                const parts = prop.split('.');
                let obj = field;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!obj[parts[i]]) obj[parts[i]] = {};
                    obj = obj[parts[i]];
                }
                obj[parts[parts.length - 1]] = value;
                renderFields();
                saveToStorage();
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const sectionCount = state.fields.filter(f => f.type === 'section').length;
            const pageCount = sectionCount + 1;
            
            document.getElementById('fieldCount').textContent = `üìä ${state.fields.length} fields | ${pageCount} page${pageCount > 1 ? 's' : ''}`;
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:36px;margin-bottom:12px;">üì•</p><p style="font-weight:600;">Click field types on the left to add them</p><p style="margin-top:8px;font-size:11px;color:#adb5bd;">Or drag and drop here</p>';
                return;
            }
            
            dropZone.classList.add('has-fields');
            let currentPage = 1;
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') { currentPage++; return renderSectionHTML(f, currentPage); }
                return renderFieldHTML(f);
            }).join('');
            
            // Attach click handlers
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id);
                });
            });
        }

        function renderSectionHTML(field, pageNum) {
            const selected = field.id === state.selectedFieldId;
            return `<div class="section-divider ${selected ? 'selected' : ''}" data-id="${field.id}">
                <span>üìÅ ${field.label.toUpperCase()}</span>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span class="page-badge">PAGE ${pageNum}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn move-up" onclick="moveField('${field.id}','up')" title="Move Up">‚ñ≤</button>
                        <button class="field-action-btn move-down" onclick="moveField('${field.id}','down')" title="Move Down">‚ñº</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            </div>`;
        }

        function renderFieldHTML(field) {
            const def = fieldDefs[field.type];
            const selected = field.id === state.selectedFieldId;
            let badges = '';
            if (field.required) badges += '<span class="field-badge required">Required</span>';
            if (field.skipLogic?.enabled) badges += '<span class="field-badge skip">Skip Logic</span>';
            if (field.validation?.enabled) badges += '<span class="field-badge validation">Validation</span>';
            if (field.conditional?.enabled) badges += '<span class="field-badge conditional">Conditional</span>';
            
            return `<div class="form-field ${selected ? 'selected' : ''}" data-id="${field.id}">
                <div class="form-field-header">
                    <span class="form-field-label"><span class="field-icon">${def?.icon || 'üìÑ'}</span> ${field.label}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn move-up" onclick="moveField('${field.id}','up')" title="Move Up">‚ñ≤</button>
                        <button class="field-action-btn move-down" onclick="moveField('${field.id}','down')" title="Move Down">‚ñº</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="form-field-preview">${renderFieldPreview(field)}</div>
                <div class="form-field-meta">${field.name} ${badges}</div>
            </div>`;
        }

        function renderFieldPreview(field) {
            const inputStyle = 'width:100%;padding:6px;border:1px solid #dee2e6;border-radius:4px;font-size:11px;';
            switch (field.type) {
                case 'text': case 'email': case 'phone': 
                    return `<input type="text" style="${inputStyle}" placeholder="${field.placeholder || field.label}" disabled>`;
                case 'number': 
                    return `<input type="number" style="${inputStyle}" placeholder="0" disabled>`;
                case 'date': 
                    return `<input type="date" style="${inputStyle}" disabled>`;
                case 'time': 
                    return `<input type="time" style="${inputStyle}" disabled>`;
                case 'textarea': 
                    return `<textarea style="${inputStyle}height:50px;" disabled></textarea>`;
                case 'select': 
                    return `<select style="${inputStyle}" disabled><option>-- Select ${field.label} --</option></select>`;
                case 'radio': case 'yesno': case 'yesnona':
                    const opts = field.type === 'yesno' ? ['Yes', 'No'] : field.type === 'yesnona' ? ['Yes', 'No', 'N/A'] : field.options;
                    return opts.slice(0, 4).map(o => `<label style="margin-right:10px;font-size:10px;"><input type="radio" disabled> ${o}</label>`).join('') + (opts.length > 4 ? '...' : '');
                case 'checkbox':
                    return field.options.slice(0, 3).map(o => `<label style="display:inline;margin-right:10px;font-size:10px;"><input type="checkbox" disabled> ${o}</label>`).join('') + (field.options.length > 3 ? '...' : '');
                case 'table':
                    return `<div style="border:1px solid #dee2e6;border-radius:4px;padding:6px;font-size:9px;background:#f8f9fa;">üìã Static Table: ${field.columns.length} columns √ó ${field.rows} rows</div>`;
                case 'dynamicTable':
                    return `<div style="border:1px solid #dee2e6;border-radius:4px;padding:6px;font-size:9px;background:#e8f5e9;">‚ûï Dynamic Table: ${field.columns.length} columns (${field.minRows}-${field.maxRows} rows)</div>`;
                case 'cascading':
                    return field.levels.map(l => `<select style="width:auto;padding:3px;font-size:9px;margin-right:4px;" disabled><option>${l}</option></select>`).join('');
                case 'gps': 
                    return `<button style="padding:6px 12px;background:#004080;color:white;border:none;border-radius:4px;font-size:10px;" disabled>üìç Capture GPS</button>`;
                case 'camera': 
                    return `<button style="padding:6px 12px;background:#17a2b8;color:white;border:none;border-radius:4px;font-size:10px;" disabled>üì∑ Take Photo</button>`;
                case 'qrscanner': 
                    return `<button style="padding:6px 12px;background:#6f42c1;color:white;border:none;border-radius:4px;font-size:10px;" disabled>üì± Scan QR Code</button>`;
                case 'signature': 
                    return `<div style="border:2px dashed #dee2e6;height:50px;display:flex;align-items:center;justify-content:center;color:#adb5bd;font-size:10px;border-radius:4px;">‚úçÔ∏è Signature Pad</div>`;
                case 'rating': 
                    return '<span style="font-size:16px;">' + '‚≠ê'.repeat(field.max || 5) + '</span>';
                case 'file': 
                    return `<input type="file" style="${inputStyle}" disabled>`;
                case 'calculated': 
                    return `<div style="background:#e9ecef;padding:6px;border-radius:4px;font-size:10px;">üî¢ = ${field.formula || 'formula'}</div>`;
                default: return '';
            }
        }

        // ============================================
        // PROPERTIES PANEL - FULL FEATURES
        // ============================================
        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:32px;margin-bottom:12px;">üëÜ</p><p>Select a field to edit its properties</p></div>';
                return;
            }
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            const def = fieldDefs[field.type];
            
            let html = `
                <!-- Basic Properties -->
                <div class="prop-section">
                    <div class="prop-section-title">üìù Basic Properties</div>
                    <div class="property-group">
                        <label class="property-label">Label</label>
                        <input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Field Name (ID)</label>
                        <input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}">
                    </div>
                    ${field.type !== 'section' ? `
                    <div class="property-group">
                        <label class="property-label">Placeholder</label>
                        <input type="text" class="property-input" id="propPlaceholder" value="${escapeHtml(field.placeholder || '')}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Help Text</label>
                        <input type="text" class="property-input" id="propHelpText" value="${escapeHtml(field.helpText || '')}">
                    </div>
                    <div class="property-group">
                        <label class="property-checkbox">
                            <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                            <span>Required Field</span>
                        </label>
                    </div>
                    ` : ''}
                </div>`;
            
            // Options for select/radio/checkbox
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `
                <div class="prop-section">
                    <div class="prop-section-title">üìã Options</div>
                    <div class="property-group">
                        <label class="property-label">Options (one per line)</label>
                        <textarea class="property-textarea" id="propOptions" style="height:100px;">${(field.options || []).join('\n')}</textarea>
                    </div>
                </div>`;
            }
            
            // Table configuration
            if (field.type === 'table' || field.type === 'dynamicTable') {
                html += `
                <div class="prop-section">
                    <div class="prop-section-title">üìä Table Configuration</div>
                    <button class="modal-btn primary" onclick="openTableConfig('${field.id}')" style="width:100%;">‚öôÔ∏è Configure Columns</button>
                    ${field.type === 'table' ? `
                    <div class="property-group" style="margin-top:10px;">
                        <label class="property-label">Number of Rows</label>
                        <input type="number" class="property-input" id="propRows" value="${field.rows}" min="1" max="50">
                    </div>
                    ` : `
                    <div class="prop-row" style="margin-top:10px;">
                        <div class="property-group" style="flex:1;">
                            <label class="property-label">Min Rows</label>
                            <input type="number" class="property-input" id="propMinRows" value="${field.minRows}" min="0">
                        </div>
                        <div class="property-group" style="flex:1;">
                            <label class="property-label">Max Rows</label>
                            <input type="number" class="property-input" id="propMaxRows" value="${field.maxRows}" min="1">
                        </div>
                    </div>
                    `}
                </div>`;
            }
            
            // Rating max
            if (field.type === 'rating') {
                html += `
                <div class="prop-section">
                    <div class="prop-section-title">‚≠ê Rating Options</div>
                    <div class="property-group">
                        <label class="property-label">Maximum Stars</label>
                        <select class="property-select" id="propMax">
                            ${[3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${field.max === n ? 'selected' : ''}>${n} Stars</option>`).join('')}
                        </select>
                    </div>
                </div>`;
            }
            
            // Cascading levels
            if (field.type === 'cascading') {
                html += `
                <div class="prop-section">
                    <div class="prop-section-title">üè¢ Cascading Levels</div>
                    <div class="property-group">
                        <label class="property-label">Level Names (one per line)</label>
                        <textarea class="property-textarea" id="propLevels">${(field.levels || []).join('\n')}</textarea>
                    </div>
                </div>`;
            }
            
            // Calculated formula
            if (field.type === 'calculated') {
                html += `
                <div class="prop-section">
                    <div class="prop-section-title">üî¢ Calculation</div>
                    <div class="property-group">
                        <label class="property-label">Formula</label>
                        <input type="text" class="property-input" id="propFormula" value="${escapeHtml(field.formula || '')}" placeholder="e.g., {field1} + {field2}">
                    </div>
                    <div style="font-size:9px;color:#868e96;margin-top:4px;">Use {fieldname} to reference other fields</div>
                </div>`;
            }
            
            // File accept
            if (field.type === 'file') {
                html += `
                <div class="prop-section">
                    <div class="prop-section-title">üìé File Options</div>
                    <div class="property-group">
                        <label class="property-label">Accepted File Types</label>
                        <input type="text" class="property-input" id="propAccept" value="${escapeHtml(field.accept || '')}" placeholder=".pdf,.jpg,.png">
                    </div>
                </div>`;
            }
            
            // VALIDATION SECTION
            if (field.type !== 'section' && def?.validations) {
                html += `
                <div class="prop-section validation">
                    <div class="prop-section-title" onclick="toggleSection(this)">
                        <span class="toggle-icon">‚ñº</span> ‚úì Validation Rules
                    </div>
                    <div class="prop-section-content">
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propValidationEnabled" ${field.validation?.enabled ? 'checked' : ''}>
                                <span>Enable Validation</span>
                            </label>
                        </div>
                        <div id="validationRules" style="${field.validation?.enabled ? '' : 'display:none;'}">
                            ${renderValidationRules(field, def.validations)}
                        </div>
                    </div>
                </div>`;
            }
            
            // SKIP LOGIC SECTION
            if (field.type !== 'section') {
                html += `
                <div class="prop-section skip-logic">
                    <div class="prop-section-title" onclick="toggleSection(this)">
                        <span class="toggle-icon">‚ñº</span> üîÄ Skip Logic
                    </div>
                    <div class="prop-section-content">
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propSkipEnabled" ${field.skipLogic?.enabled ? 'checked' : ''}>
                                <span>Enable Skip Logic</span>
                            </label>
                        </div>
                        <div id="skipLogicConfig" style="${field.skipLogic?.enabled ? '' : 'display:none;'}">
                            <div class="property-group">
                                <label class="property-label">Action</label>
                                <select class="property-select" id="propSkipAction">
                                    <option value="show" ${field.skipLogic?.action === 'show' ? 'selected' : ''}>Show this field when...</option>
                                    <option value="hide" ${field.skipLogic?.action === 'hide' ? 'selected' : ''}>Hide this field when...</option>
                                    <option value="require" ${field.skipLogic?.action === 'require' ? 'selected' : ''}>Require this field when...</option>
                                </select>
                            </div>
                            <div class="property-group">
                                <label class="property-label">Match</label>
                                <select class="property-select" id="propSkipLogic">
                                    <option value="all" ${field.skipLogic?.logic === 'all' ? 'selected' : ''}>ALL conditions (AND)</option>
                                    <option value="any" ${field.skipLogic?.logic === 'any' ? 'selected' : ''}>ANY condition (OR)</option>
                                </select>
                            </div>
                            <div id="skipConditions">
                                ${renderSkipConditions(field)}
                            </div>
                            <button class="table-action-btn" onclick="addSkipCondition()" style="margin-top:8px;">‚ûï Add Condition</button>
                        </div>
                    </div>
                </div>`;
            }
            
            // CONDITIONAL/IF STATEMENTS
            if (field.type !== 'section') {
                html += `
                <div class="prop-section conditional">
                    <div class="prop-section-title" onclick="toggleSection(this)">
                        <span class="toggle-icon">‚ñº</span> üîÑ IF Statements
                    </div>
                    <div class="prop-section-content">
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propConditionalEnabled" ${field.conditional?.enabled ? 'checked' : ''}>
                                <span>Enable Conditional Logic</span>
                            </label>
                        </div>
                        <div id="conditionalConfig" style="${field.conditional?.enabled ? '' : 'display:none;'}">
                            <div id="conditionalStatements">
                                ${renderConditionalStatements(field)}
                            </div>
                            <button class="table-action-btn" onclick="addConditionalStatement()" style="margin-top:8px;">‚ûï Add IF Statement</button>
                        </div>
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
            attachPropertyListeners(field);
        }

        function renderValidationRules(field, availableRules) {
            const rules = field.validation?.rules || {};
            let html = '<div class="validation-grid">';
            
            const ruleLabels = {
                required: 'Required',
                minLength: 'Min Length',
                maxLength: 'Max Length',
                min: 'Min Value',
                max: 'Max Value',
                pattern: 'Pattern (Regex)',
                noSpaces: 'No Spaces',
                alphanumeric: 'Alphanumeric Only',
                uppercase: 'Uppercase Only',
                lowercase: 'Lowercase Only',
                integer: 'Integer Only',
                positive: 'Positive Only',
                negative: 'Negative Only',
                decimal: 'Allow Decimals',
                minDate: 'Min Date',
                maxDate: 'Max Date',
                notFuture: 'Not Future',
                notPast: 'Not Past',
                weekdaysOnly: 'Weekdays Only',
                minTime: 'Min Time',
                maxTime: 'Max Time',
                domain: 'Domain',
                format: 'Format',
                minSelect: 'Min Select',
                maxSelect: 'Max Select',
                minWords: 'Min Words',
                maxWords: 'Max Words',
                maxSize: 'Max Size (MB)',
                fileTypes: 'File Types',
                accuracy: 'GPS Accuracy (m)'
            };
            
            const needsValue = ['minLength', 'maxLength', 'min', 'max', 'pattern', 'minDate', 'maxDate', 'minTime', 'maxTime', 'domain', 'format', 'minSelect', 'maxSelect', 'minWords', 'maxWords', 'maxSize', 'fileTypes', 'accuracy'];
            
            availableRules.forEach(rule => {
                if (needsValue.includes(rule)) {
                    html += `
                    <div class="validation-item" style="grid-column: span 2;">
                        <input type="checkbox" id="valRule_${rule}" ${rules[rule] !== undefined ? 'checked' : ''} onchange="updateValidationRule('${rule}', this.checked, document.getElementById('valValue_${rule}').value)">
                        <span style="min-width:80px;">${ruleLabels[rule] || rule}</span>
                        <input type="${rule.includes('Date') ? 'date' : rule.includes('Time') ? 'time' : 'text'}" id="valValue_${rule}" value="${rules[rule] || ''}" placeholder="Value" onchange="updateValidationRule('${rule}', document.getElementById('valRule_${rule}').checked, this.value)">
                    </div>`;
                } else {
                    html += `
                    <div class="validation-item">
                        <input type="checkbox" id="valRule_${rule}" ${rules[rule] ? 'checked' : ''} onchange="updateValidationRule('${rule}', this.checked)">
                        <span>${ruleLabels[rule] || rule}</span>
                    </div>`;
                }
            });
            
            html += '</div>';
            html += `
            <div class="property-group" style="margin-top:10px;">
                <label class="property-label">Custom Error Message</label>
                <input type="text" class="property-input" id="propValidationMessage" value="${escapeHtml(field.validation?.customMessage || '')}" placeholder="Please enter a valid value">
            </div>`;
            
            return html;
        }

        function renderSkipConditions(field) {
            const conditions = field.skipLogic?.conditions || [{ field: '', operator: 'equals', value: '' }];
            const otherFields = state.fields.filter(f => f.id !== field.id && f.type !== 'section');
            
            return conditions.map((cond, i) => `
                <div class="prop-row" style="background:#fff;padding:8px;border-radius:4px;margin-bottom:6px;">
                    <select class="property-select" onchange="updateSkipCondition(${i}, 'field', this.value)" style="flex:2;">
                        <option value="">Select Field</option>
                        ${otherFields.map(f => `<option value="${f.id}" ${cond.field === f.id ? 'selected' : ''}>${f.label}</option>`).join('')}
                    </select>
                    <select class="property-select" onchange="updateSkipCondition(${i}, 'operator', this.value)" style="flex:1;">
                        <option value="equals" ${cond.operator === 'equals' ? 'selected' : ''}>=</option>
                        <option value="not_equals" ${cond.operator === 'not_equals' ? 'selected' : ''}>‚â†</option>
                        <option value="contains" ${cond.operator === 'contains' ? 'selected' : ''}>contains</option>
                        <option value="not_contains" ${cond.operator === 'not_contains' ? 'selected' : ''}>!contains</option>
                        <option value="greater" ${cond.operator === 'greater' ? 'selected' : ''}>></option>
                        <option value="less" ${cond.operator === 'less' ? 'selected' : ''}><</option>
                        <option value="empty" ${cond.operator === 'empty' ? 'selected' : ''}>empty</option>
                        <option value="not_empty" ${cond.operator === 'not_empty' ? 'selected' : ''}>!empty</option>
                    </select>
                    <input type="text" class="property-input" value="${escapeHtml(cond.value)}" placeholder="Value" onchange="updateSkipCondition(${i}, 'value', this.value)" style="flex:2;">
                    ${conditions.length > 1 ? `<button class="table-action-btn remove" onclick="removeSkipCondition(${i})" style="padding:4px 8px;">‚úï</button>` : ''}
                </div>
            `).join('');
        }

        function renderConditionalStatements(field) {
            const statements = field.conditional?.statements || [{ if: '', operator: 'equals', value: '', then: '', result: '' }];
            const otherFields = state.fields.filter(f => f.id !== field.id && f.type !== 'section');
            
            return statements.map((stmt, i) => `
                <div style="background:#fff;padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid #e9ecef;">
                    <div style="font-size:10px;font-weight:700;color:#6f42c1;margin-bottom:6px;">IF Statement ${i + 1}</div>
                    <div class="prop-row">
                        <span style="font-weight:700;">IF</span>
                        <select class="property-select" onchange="updateConditional(${i}, 'if', this.value)">
                            <option value="">Select Field</option>
                            ${otherFields.map(f => `<option value="${f.id}" ${stmt.if === f.id ? 'selected' : ''}>${f.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="prop-row">
                        <select class="property-select" onchange="updateConditional(${i}, 'operator', this.value)">
                            <option value="equals" ${stmt.operator === 'equals' ? 'selected' : ''}>equals</option>
                            <option value="not_equals" ${stmt.operator === 'not_equals' ? 'selected' : ''}>not equals</option>
                            <option value="contains" ${stmt.operator === 'contains' ? 'selected' : ''}>contains</option>
                            <option value="greater" ${stmt.operator === 'greater' ? 'selected' : ''}>greater than</option>
                            <option value="less" ${stmt.operator === 'less' ? 'selected' : ''}>less than</option>
                        </select>
                        <input type="text" class="property-input" value="${escapeHtml(stmt.value)}" placeholder="Value" onchange="updateConditional(${i}, 'value', this.value)">
                    </div>
                    <div class="prop-row">
                        <span style="font-weight:700;">THEN</span>
                        <select class="property-select" onchange="updateConditional(${i}, 'then', this.value)">
                            <option value="setValue" ${stmt.then === 'setValue' ? 'selected' : ''}>Set Value</option>
                            <option value="showMessage" ${stmt.then === 'showMessage' ? 'selected' : ''}>Show Message</option>
                            <option value="setRequired" ${stmt.then === 'setRequired' ? 'selected' : ''}>Make Required</option>
                            <option value="setOptional" ${stmt.then === 'setOptional' ? 'selected' : ''}>Make Optional</option>
                        </select>
                        <input type="text" class="property-input" value="${escapeHtml(stmt.result)}" placeholder="Result" onchange="updateConditional(${i}, 'result', this.value)">
                    </div>
                    ${statements.length > 1 ? `<button class="table-action-btn remove" onclick="removeConditional(${i})" style="margin-top:6px;">üóëÔ∏è Remove</button>` : ''}
                </div>
            `).join('');
        }

        function toggleSection(el) {
            el.classList.toggle('collapsed');
            const content = el.nextElementSibling;
            content.classList.toggle('hidden');
        }

        function attachPropertyListeners(field) {
            // Basic
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propPlaceholder')?.addEventListener('change', (e) => updateField('placeholder', e.target.value));
            document.getElementById('propHelpText')?.addEventListener('change', (e) => updateField('helpText', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            
            // Options
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
            
            // Table
            document.getElementById('propRows')?.addEventListener('change', (e) => updateField('rows', parseInt(e.target.value) || 3));
            document.getElementById('propMinRows')?.addEventListener('change', (e) => updateField('minRows', parseInt(e.target.value) || 1));
            document.getElementById('propMaxRows')?.addEventListener('change', (e) => updateField('maxRows', parseInt(e.target.value) || 20));
            
            // Rating
            document.getElementById('propMax')?.addEventListener('change', (e) => updateField('max', parseInt(e.target.value) || 5));
            
            // Cascading
            document.getElementById('propLevels')?.addEventListener('change', (e) => updateField('levels', e.target.value.split('\n').filter(l => l.trim())));
            
            // Calculated
            document.getElementById('propFormula')?.addEventListener('change', (e) => updateField('formula', e.target.value));
            
            // File
            document.getElementById('propAccept')?.addEventListener('change', (e) => updateField('accept', e.target.value));
            
            // Validation
            document.getElementById('propValidationEnabled')?.addEventListener('change', (e) => {
                updateField('validation.enabled', e.target.checked);
                document.getElementById('validationRules').style.display = e.target.checked ? '' : 'none';
            });
            document.getElementById('propValidationMessage')?.addEventListener('change', (e) => updateField('validation.customMessage', e.target.value));
            
            // Skip Logic
            document.getElementById('propSkipEnabled')?.addEventListener('change', (e) => {
                updateField('skipLogic.enabled', e.target.checked);
                document.getElementById('skipLogicConfig').style.display = e.target.checked ? '' : 'none';
            });
            document.getElementById('propSkipAction')?.addEventListener('change', (e) => updateField('skipLogic.action', e.target.value));
            document.getElementById('propSkipLogic')?.addEventListener('change', (e) => updateField('skipLogic.logic', e.target.value));
            
            // Conditional
            document.getElementById('propConditionalEnabled')?.addEventListener('change', (e) => {
                updateField('conditional.enabled', e.target.checked);
                document.getElementById('conditionalConfig').style.display = e.target.checked ? '' : 'none';
            });
        }

        // Skip Logic functions
        window.updateSkipCondition = function(index, prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field && field.skipLogic?.conditions) {
                field.skipLogic.conditions[index][prop] = value;
                saveToStorage();
            }
        };

        window.addSkipCondition = function() {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (!field.skipLogic.conditions) field.skipLogic.conditions = [];
                field.skipLogic.conditions.push({ field: '', operator: 'equals', value: '' });
                saveToStorage();
                renderProperties();
            }
        };

        window.removeSkipCondition = function(index) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field && field.skipLogic?.conditions?.length > 1) {
                field.skipLogic.conditions.splice(index, 1);
                saveToStorage();
                renderProperties();
            }
        };

        // Conditional functions
        window.updateConditional = function(index, prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field && field.conditional?.statements) {
                field.conditional.statements[index][prop] = value;
                saveToStorage();
            }
        };

        window.addConditionalStatement = function() {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (!field.conditional.statements) field.conditional.statements = [];
                field.conditional.statements.push({ if: '', operator: 'equals', value: '', then: '', result: '' });
                saveToStorage();
                renderProperties();
            }
        };

        window.removeConditional = function(index) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field && field.conditional?.statements?.length > 1) {
                field.conditional.statements.splice(index, 1);
                saveToStorage();
                renderProperties();
            }
        };

        // Validation rule update
        window.updateValidationRule = function(rule, enabled, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (!field.validation.rules) field.validation.rules = {};
                if (enabled) {
                    field.validation.rules[rule] = value !== undefined ? value : true;
                } else {
                    delete field.validation.rules[rule];
                }
                saveToStorage();
            }
        };

        // ============================================
        // TABLE CONFIGURATION
        // ============================================
        window.openTableConfig = function(fieldId) {
            state.editingTableFieldId = fieldId;
            const field = state.fields.find(f => f.id === fieldId);
            if (!field) return;
            
            renderTableColumnsConfig(field);
            document.getElementById('tableConfigModal').classList.add('show');
        };

        function renderTableColumnsConfig(field) {
            const container = document.getElementById('tableColumnsConfig');
            const colTypes = [
                { value: 'text', label: 'Text' },
                { value: 'number', label: 'Number' },
                { value: 'date', label: 'Date' },
                { value: 'select', label: 'Dropdown' },
                { value: 'checkbox', label: 'Checkbox' }
            ];
            
            container.innerHTML = field.columns.map((col, i) => `
                <div class="column-config">
                    <div class="column-config-header">
                        <span class="column-config-title">Column ${i + 1}</span>
                        ${field.columns.length > 1 ? `<button class="table-action-btn remove" onclick="removeTableColumn(${i})">üóëÔ∏è Remove</button>` : ''}
                    </div>
                    <div class="column-config-grid">
                        <div class="property-group">
                            <label class="property-label">Name</label>
                            <input type="text" class="property-input" value="${escapeHtml(col.name)}" onchange="updateTableColumn(${i}, 'name', this.value)">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Type</label>
                            <select class="property-select" onchange="updateTableColumn(${i}, 'type', this.value)">
                                ${colTypes.map(t => `<option value="${t.value}" ${col.type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                            </select>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Width</label>
                            <input type="text" class="property-input" value="${col.width || 'auto'}" placeholder="auto, 100px, 20%" onchange="updateTableColumn(${i}, 'width', this.value)">
                        </div>
                    </div>
                    ${col.type === 'select' ? `
                    <div class="property-group" style="margin-top:8px;">
                        <label class="property-label">Options (comma separated)</label>
                        <input type="text" class="property-input" value="${(col.options || []).join(', ')}" onchange="updateTableColumn(${i}, 'options', this.value.split(',').map(s=>s.trim()).filter(s=>s))">
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        window.updateTableColumn = function(index, prop, value) {
            const field = state.fields.find(f => f.id === state.editingTableFieldId);
            if (field && field.columns[index]) {
                field.columns[index][prop] = value;
                renderTableColumnsConfig(field);
                saveToStorage();
            }
        };

        window.addTableColumn = function() {
            const field = state.fields.find(f => f.id === state.editingTableFieldId);
            if (field) {
                field.columns.push({ name: `Column ${field.columns.length + 1}`, type: 'text', width: 'auto' });
                renderTableColumnsConfig(field);
                saveToStorage();
            }
        };

        window.removeTableColumn = function(index) {
            const field = state.fields.find(f => f.id === state.editingTableFieldId);
            if (field && field.columns.length > 1) {
                field.columns.splice(index, 1);
                renderTableColumnsConfig(field);
                saveToStorage();
            }
        };

        window.saveTableConfig = function() {
            closeModal('tableConfigModal');
            renderFields();
            renderProperties();
            notify('‚úÖ Table configuration saved!');
        };

        // ============================================
        // SETTINGS
        // ============================================
        function openSettings() {
            document.getElementById('settingsTitle').value = state.settings.title;
            document.getElementById('settingsSubtitle').value = state.settings.subtitle;
            document.getElementById('settingsOrg').value = state.settings.organization;
            document.getElementById('settingsLogo').value = state.settings.logo;
            document.getElementById('settingsMultiPage').checked = state.settings.multiPage;
            document.getElementById('settingsScriptUrl').value = state.settings.scriptUrl || '';
            document.getElementById('settingsSheetId').value = state.settings.sheetId || '';
            document.getElementById('cascadingData').value = state.settings.cascadingData || '';
            
            // Populate duplicate check field dropdown
            const dupSelect = document.getElementById('settingsDuplicateField');
            dupSelect.innerHTML = '<option value="">-- No duplicate check --</option>';
            state.fields.filter(f => f.type !== 'section').forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.name;
                opt.textContent = f.label;
                if (state.settings.duplicateCheckField === f.name) opt.selected = true;
                dupSelect.appendChild(opt);
            });
            
            document.getElementById('settingsModal').classList.add('show');
        }

        function saveSettings() {
            state.settings.title = document.getElementById('settingsTitle').value;
            state.settings.subtitle = document.getElementById('settingsSubtitle').value;
            state.settings.organization = document.getElementById('settingsOrg').value;
            state.settings.logo = document.getElementById('settingsLogo').value;
            state.settings.multiPage = document.getElementById('settingsMultiPage').checked;
            state.settings.scriptUrl = document.getElementById('settingsScriptUrl').value;
            state.settings.sheetId = document.getElementById('settingsSheetId').value;
            state.settings.duplicateCheckField = document.getElementById('settingsDuplicateField').value;
            state.settings.cascadingData = document.getElementById('cascadingData').value;
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            document.getElementById('previewSubtitle').textContent = state.settings.subtitle;
            
            saveToStorage();
            closeModal('settingsModal');
            notify('‚úÖ Settings saved!');
        }

        // ============================================
        // PREVIEW - OPENS WITHIN PAGE
        // ============================================
        function previewForm() {
            if (state.fields.length === 0) { notify('Add some fields first!', 'error'); return; }
            
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('viewerContainer').classList.add('show');
            
            renderFormViewer();
        }
        
        function closeViewer() {
            document.getElementById('viewerContainer').classList.remove('show');
            document.querySelector('.header').style.display = '';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = '';
        }
        
        function renderFormViewer() {
            const s = state.settings;
            
            // Group fields by sections (pages)
            let pages = [];
            let currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) {
                        pages.push(currentPage);
                    }
                    currentPage = { title: field.label, fields: [] };
                } else {
                    currentPage.fields.push(field);
                }
            });
            if (currentPage.fields.length > 0) {
                pages.push(currentPage);
            }
            
            // If no sections, put all fields on one page
            if (pages.length === 0) {
                pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            }
            
            // Generate pages HTML
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span class="required" style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'text': input = `<input type="text" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`; break;
                        case 'email': input = `<input type="email" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`; break;
                        case 'phone': input = `<input type="tel" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || 'Enter 9 digits')}" pattern="[0-9]{9}" maxlength="9" minlength="9" title="Please enter exactly 9 digits" oninput="this.value=this.value.replace(/[^0-9]/g,'')" ${reqAttr}>`; break;
                        case 'number': input = `<input type="number" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`; break;
                        case 'date': input = `<input type="date" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                        case 'time': input = `<input type="time" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                        case 'textarea': input = `<textarea name="${field.name}" class="viewer-input" rows="3" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}></textarea>`; break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`; break;
                        case 'radio': case 'yesno': case 'yesnona':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : field.type === 'yesnona' ? ['Yes','No','N/A'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                        case 'gps':
                            input = `<div class="gps-container"><button type="button" class="viewer-draft-btn" onclick="captureGPS(this)" style="width:auto;padding:10px 20px;">üìç Capture GPS</button><input type="hidden" name="${field.name}_lat"><input type="hidden" name="${field.name}_lng"><div class="gps-status"></div></div>`; break;
                        case 'camera':
                            input = `<div class="camera-container"><button type="button" class="viewer-draft-btn" onclick="openCamera(this, '${field.name}')" style="width:auto;padding:10px 20px;background:#17a2b8;">üì∑ Take Photo</button><input type="hidden" name="${field.name}" class="camera-data"><div class="camera-preview" style="margin-top:10px;"></div></div>`; break;
                        case 'qrscanner':
                            input = `<div class="qr-container"><button type="button" class="viewer-draft-btn" onclick="openQRScanner(this, '${field.name}')" style="width:auto;padding:10px 20px;background:#6f42c1;">üì± Scan QR Code</button><input type="text" name="${field.name}" class="viewer-input qr-result" placeholder="QR code value will appear here" readonly style="margin-top:10px;"></div>`; break;
                        case 'signature':
                            input = `<div class="sig-container"><canvas class="sig-canvas" width="280" height="100" style="border:2px solid #004080;border-radius:6px;background:#fff;touch-action:none;"></canvas><input type="hidden" name="${field.name}" class="sig-data"><button type="button" onclick="clearSig(this)" style="margin-top:6px;padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;font-size:10px;cursor:pointer;">Clear</button></div>`; break;
                        case 'rating':
                            input = `<div class="rating-container">${Array(field.max || 5).fill().map((_, i) => `<span class="rating-star" onclick="setRating(this,${i+1})" style="font-size:24px;cursor:pointer;opacity:0.3;">‚≠ê</span>`).join('')}<input type="hidden" name="${field.name}"></div>`; break;
                        case 'file':
                            input = `<input type="file" name="${field.name}" class="viewer-input" accept="${field.accept || ''}" ${reqAttr}>`; break;
                        default: input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field" data-field-id="${field.id}"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0;
                const isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        <div class="page-header">
                            <span class="page-indicator">Page ${pageIndex + 1} of ${pages.length}</span>
                            <h3 class="page-title">${escapeHtml(page.title)}</h3>
                        </div>
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})">‚¨ÖÔ∏è Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next ‚û°Ô∏è</button>` : ''}
                            ${isLast ? `<button type="button" class="viewer-draft-btn" onclick="saveDraft()" style="width:auto;margin:0 10px;">üíæ Save Draft</button><button type="submit" class="nav-btn submit-btn">‚úÖ Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('viewerContainer').innerHTML = `
                <button class="viewer-back-btn" onclick="closeViewer()">‚¨ÖÔ∏è Back to Builder</button>
                
                <div class="viewer-nav">
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showViewerTab('form',this)">üìù Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showViewerTab('data',this)">üìä Data</button>
                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showViewerTab('dashboard',this)">üìà Dashboard</button>
                    <button class="viewer-nav-btn" style="background:#6c757d;color:#fff;" onclick="showViewerTab('report',this)">üìÑ Report</button>
                    <button class="viewer-nav-btn" style="background:#ffc107;color:#000;" onclick="showViewerTab('drafts',this)">üíæ Drafts</button>
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}" id="connectionStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">${navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                        <span class="pending-sync-badge" id="pendingSyncBadge" style="display:none;">0</span>
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                                <p>${escapeHtml(s.subtitle)}</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" id="formProgress" style="width: ${100/pages.length}%"></div>
                                    </div>
                                    ${pagesHtml}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#28a745 0%,#218838 100%);">
                                <h1>üìä Submitted Data</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body" id="dataContainer">
                                <p style="text-align:center;color:#868e96;">üì≠ No submissions yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDashboard" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);">
                                <h1>üìà Dashboard</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body" id="dashboardContainer">
                                <div class="dashboard-stats" id="dashboardStats"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabReport" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%);">
                                <h1>üìÑ Report</h1>
                                <button onclick="window.print()" style="background:#fff;color:#6c757d;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:700;margin-top:10px;font-family:Oswald;">üñ®Ô∏è Print</button>
                            </div>
                            <div class="viewer-body" id="reportContainer"></div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDrafts" class="viewer-tab">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:linear-gradient(135deg,#ffc107 0%,#e0a800 100%);color:#000;">
                                <h1>üíæ Saved Drafts</h1>
                                <p>${escapeHtml(s.title)}</p>
                            </div>
                            <div class="viewer-body" id="draftsContainer">
                                <p style="text-align:center;color:#868e96;">No drafts saved</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Store total pages
            window.totalPages = pages.length;
            window.currentPageIndex = 0;
            
            // Initialize signature pads
            document.querySelectorAll('.sig-canvas').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                let drawing = false;
                ctx.strokeStyle = '#004080';
                ctx.lineWidth = 2;
                canvas.onmousedown = e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
                canvas.onmousemove = e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
                canvas.onmouseup = () => { drawing = false; const dataInput = canvas.parentElement.querySelector('.sig-data'); if (dataInput) dataInput.value = canvas.toDataURL(); };
                canvas.onmouseleave = () => drawing = false;
                // Touch
                canvas.ontouchstart = e => { e.preventDefault(); drawing = true; const t = e.touches[0]; const r = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(t.clientX - r.left, t.clientY - r.top); };
                canvas.ontouchmove = e => { e.preventDefault(); if (drawing) { const t = e.touches[0]; const r = canvas.getBoundingClientRect(); ctx.lineTo(t.clientX - r.left, t.clientY - r.top); ctx.stroke(); } };
                canvas.ontouchend = () => { drawing = false; const dataInput = canvas.parentElement.querySelector('.sig-data'); if (dataInput) dataInput.value = canvas.toDataURL(); };
            });
            
            // Form submit
            document.getElementById('viewerForm').onsubmit = async function(e) {
                e.preventDefault();
                const form = this;
                const submitBtn = form.querySelector('.submit-btn, .viewer-submit');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚è≥ Submitting...';
                }
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString() };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                // Check for duplicates
                const dupField = state.settings.duplicateCheckField;
                if (dupField && data[dupField]) {
                    const isDuplicate = await checkDuplicate(dupField, data[dupField]);
                    if (isDuplicate) {
                        notify(`‚ùå Duplicate entry! "${data[dupField]}" already exists.`, 'error');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = '‚úÖ Submit';
                        }
                        return;
                    }
                }
                
                // Submit to Google Sheets
                const result = await submitToGoogleSheets(data);
                
                if (result.success) {
                    saveLocally(data);
                    form.reset();
                    window.currentPageIndex = 0;
                    goToPage(0);
                    
                    if (result.offline) {
                        notify('üíæ Saved offline. Will sync when online.');
                    } else {
                        notify('‚úÖ Submitted successfully!');
                    }
                } else {
                    notify('‚ö†Ô∏è Saved offline. Will sync when online.');
                }
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úÖ Submit';
                }
            };
            
            // Load initial data
            loadViewerData();
            loadViewerDashboard();
            loadViewerReport();
            loadViewerDrafts();
        }
        
        function goToPage(pageIndex) {
            // Validate current page before moving forward
            if (pageIndex > window.currentPageIndex) {
                const currentPageEl = document.querySelector(`.form-page[data-page="${window.currentPageIndex}"]`);
                const requiredFields = currentPageEl.querySelectorAll('[required]');
                let valid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value) {
                        field.style.borderColor = '#dc3545';
                        valid = false;
                    } else {
                        field.style.borderColor = '#004080';
                    }
                });
                
                if (!valid) {
                    notify('Please fill all required fields', 'error');
                    return;
                }
            }
            
            // Hide all pages
            document.querySelectorAll('.form-page').forEach(p => p.style.display = 'none');
            
            // Show target page
            const targetPage = document.querySelector(`.form-page[data-page="${pageIndex}"]`);
            if (targetPage) {
                targetPage.style.display = 'block';
                window.currentPageIndex = pageIndex;
                
                // Update progress bar
                const progress = ((pageIndex + 1) / window.totalPages) * 100;
                document.getElementById('formProgress').style.width = progress + '%';
                
                // Scroll to top of form
                document.querySelector('.viewer-form-box').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function showViewerTab(tab, btn) {
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if (btn) btn.classList.add('active');
            
            if (tab === 'data') loadViewerData();
            if (tab === 'dashboard') loadViewerDashboard();
            if (tab === 'report') loadViewerReport();
            if (tab === 'drafts') loadViewerDrafts();
        }
        
        function getStorageKey() { return 'formData_' + state.settings.title.replace(/\s+/g, '_'); }
        
        async function loadViewerData() {
            const container = document.getElementById('dataContainer');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align:center;color:#868e96;padding:30px;">‚è≥ Loading data...</p>';
            
            let data = [];
            const scriptUrl = state.settings.scriptUrl;
            
            // Try to fetch from Google Sheets first
            if (scriptUrl) {
                try {
                    const response = await fetch(`${scriptUrl}?action=getData&formTitle=${encodeURIComponent(state.settings.title)}&limit=200`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        data = result.data;
                    }
                } catch (err) {
                    console.log('Fetching from local storage instead');
                }
            }
            
            // Fallback to local storage
            if (data.length === 0) {
                data = JSON.parse(localStorage.getItem(getStorageKey()) || '[]');
            }
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#868e96;padding:30px;">üì≠ No submissions yet</p>';
                return;
            }
            
            const fields = state.fields.filter(f => f.type !== 'section');
            let html = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                    <p style="font-weight:600;">üìä ${data.length} submission(s) ${data.length >= 200 ? '(showing first 200)' : ''}</p>
                    <button onclick="downloadData()" style="padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:12px;">üì• Download CSV</button>
                </div>
            `;
            html += `<div style="overflow-x:auto;"><table class="data-table"><tr><th>#</th><th>Time</th>${fields.slice(0,5).map(f => `<th>${escapeHtml(f.label)}</th>`).join('')}</tr>`;
            data.forEach((row, i) => {
                const timestamp = row._timestamp || row.timestamp || '';
                html += `<tr><td>${i+1}</td><td>${timestamp ? new Date(timestamp).toLocaleString() : '-'}</td>${fields.slice(0,5).map(f => `<td>${row[f.name] || '-'}</td>`).join('')}</tr>`;
            });
            html += `</table></div>`;
            container.innerHTML = html;
            
            // Store data for download
            window.currentViewData = data;
        }
        
        window.downloadData = async function() {
            let data = window.currentViewData || [];
            
            if (data.length === 0) {
                notify('No data to download', 'error');
                return;
            }
            
            const fields = state.fields.filter(f => f.type !== 'section');
            const headers = ['Timestamp', ...fields.map(f => f.label)];
            const rows = data.map(row => {
                const timestamp = row._timestamp || row.timestamp || '';
                return [timestamp, ...fields.map(f => row[f.name] || '')];
            });
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.settings.title.replace(/\s+/g, '_')}_data.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            notify('‚úÖ Data downloaded!');
        };
        
        function loadViewerDashboard() {
            const data = window.currentViewData || JSON.parse(localStorage.getItem(getStorageKey()) || '[]');
            const container = document.getElementById('dashboardStats');
            if (!container) return;
            
            const today = data.filter(d => {
                const ts = d._timestamp || d.timestamp;
                return ts && new Date(ts).toDateString() === new Date().toDateString();
            }).length;
            
            const offlineCount = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]').length;
            
            container.innerHTML = `
                <div class="stat-card"><div class="stat-value">${data.length}</div><div class="stat-label">Total</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#218838 100%);"><div class="stat-value">${today}</div><div class="stat-label">Today</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);"><div class="stat-value">${state.fields.length}</div><div class="stat-label">Fields</div></div>
                ${offlineCount > 0 ? `<div class="stat-card" style="background:linear-gradient(135deg,#ffc107 0%,#e0a800 100%);color:#000;"><div class="stat-value">${offlineCount}</div><div class="stat-label">Pending Sync</div></div>` : ''}
            `;
        }
        
        function loadViewerReport() {
            const data = JSON.parse(localStorage.getItem(getStorageKey()) || '[]');
            const container = document.getElementById('reportContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <img src="${state.settings.logo}" style="width:60px;border-radius:8px;margin-bottom:10px;">
                    <h2 style="color:#004080;">${escapeHtml(state.settings.title)}</h2>
                    <p style="color:#868e96;">Generated: ${new Date().toLocaleString()}</p>
                </div>
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;">
                    <h3 style="font-size:14px;margin-bottom:10px;">üìä Summary</h3>
                    <p>Total Submissions: <strong>${data.length}</strong></p>
                    <p>Total Fields: <strong>${state.fields.length}</strong></p>
                </div>
            `;
        }
        
        function loadViewerDrafts() {
            const drafts = JSON.parse(localStorage.getItem(getStorageKey() + '_drafts') || '[]');
            const container = document.getElementById('draftsContainer');
            if (!container) return;
            
            if (drafts.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#868e96;">No drafts saved</p>';
                return;
            }
            
            container.innerHTML = drafts.map((d, i) => `
                <div class="draft-item">
                    <div><strong>Draft ${i+1}</strong><br><small style="color:#868e96;">${new Date(d._timestamp).toLocaleString()}</small></div>
                    <div>
                        <button onclick="loadDraft(${i})" style="padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;font-size:10px;cursor:pointer;margin-right:5px;">Load</button>
                        <button onclick="deleteDraft(${i})" style="padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;font-size:10px;cursor:pointer;">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function saveDraft() {
            const form = document.getElementById('viewerForm');
            const data = { _id: Date.now(), _timestamp: new Date().toISOString() };
            new FormData(form).forEach((v, k) => data[k] = v);
            const key = getStorageKey() + '_drafts';
            const drafts = JSON.parse(localStorage.getItem(key) || '[]');
            drafts.push(data);
            localStorage.setItem(key, JSON.stringify(drafts));
            notify('üíæ Draft saved!');
            loadViewerDrafts();
        }
        
        window.loadDraft = function(i) {
            const drafts = JSON.parse(localStorage.getItem(getStorageKey() + '_drafts') || '[]');
            const draft = drafts[i];
            if (!draft) return;
            const form = document.getElementById('viewerForm');
            Object.keys(draft).forEach(k => {
                if (k.startsWith('_')) return;
                const el = form.querySelector(`[name="${k}"]`);
                if (el) el.value = draft[k];
            });
            showViewerTab('form', document.querySelector('.viewer-nav-btn'));
            notify('üìÇ Draft loaded!');
        };
        
        window.deleteDraft = function(i) {
            if (!confirm('Delete this draft?')) return;
            const key = getStorageKey() + '_drafts';
            const drafts = JSON.parse(localStorage.getItem(key) || '[]');
            drafts.splice(i, 1);
            localStorage.setItem(key, JSON.stringify(drafts));
            loadViewerDrafts();
            notify('üóëÔ∏è Draft deleted');
        };
        
        window.captureGPS = function(btn) {
            const container = btn.closest('.gps-container');
            const status = container.querySelector('.gps-status');
            status.textContent = 'üìç Getting location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const lat = pos.coords.latitude.toFixed(6);
                        const lng = pos.coords.longitude.toFixed(6);
                        container.querySelector('[name$="_lat"]').value = lat;
                        container.querySelector('[name$="_lng"]').value = lng;
                        status.textContent = '‚úÖ ' + lat + ', ' + lng;
                    },
                    err => { status.textContent = '‚ùå ' + err.message; }
                );
            } else { status.textContent = '‚ùå Not supported'; }
        };
        
        window.clearSig = function(btn) {
            const canvas = btn.parentElement.querySelector('.sig-canvas');
            if (canvas) {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                const dataInput = btn.parentElement.querySelector('.sig-data');
                if (dataInput) dataInput.value = '';
            }
        };
        
        window.setRating = function(star, val) {
            const container = star.parentElement;
            container.querySelectorAll('.rating-star').forEach((s, i) => s.style.opacity = i < val ? '1' : '0.3');
            container.querySelector('input').value = val;
        };

        // ============================================
        // CAMERA FUNCTIONS
        // ============================================
        window.openCamera = function(btn, fieldName) {
            const container = btn.closest('.camera-container');
            const preview = container.querySelector('.camera-preview');
            const dataInput = container.querySelector('.camera-data');
            
            // Create video element for camera
            const video = document.createElement('video');
            video.setAttribute('autoplay', '');
            video.setAttribute('playsinline', '');
            video.style.cssText = 'width:100%;max-width:300px;border-radius:8px;border:2px solid #17a2b8;';
            
            const captureBtn = document.createElement('button');
            captureBtn.type = 'button';
            captureBtn.textContent = 'üì∏ Capture';
            captureBtn.style.cssText = 'margin:10px 5px;padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = '‚ùå Cancel';
            cancelBtn.style.cssText = 'margin:10px 5px;padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;';
            
            preview.innerHTML = '';
            preview.appendChild(video);
            preview.appendChild(captureBtn);
            preview.appendChild(cancelBtn);
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    
                    captureBtn.onclick = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);
                        const imageData = canvas.toDataURL('image/jpeg', 0.8);
                        dataInput.value = imageData;
                        
                        stream.getTracks().forEach(track => track.stop());
                        
                        const img = document.createElement('img');
                        img.src = imageData;
                        img.style.cssText = 'width:100%;max-width:200px;border-radius:8px;border:2px solid #28a745;';
                        
                        const retakeBtn = document.createElement('button');
                        retakeBtn.type = 'button';
                        retakeBtn.textContent = 'üîÑ Retake';
                        retakeBtn.style.cssText = 'display:block;margin-top:10px;padding:8px 16px;background:#ffc107;color:#000;border:none;border-radius:4px;cursor:pointer;';
                        retakeBtn.onclick = () => openCamera(btn, fieldName);
                        
                        preview.innerHTML = '';
                        preview.appendChild(img);
                        preview.appendChild(retakeBtn);
                    };
                    
                    cancelBtn.onclick = () => {
                        stream.getTracks().forEach(track => track.stop());
                        preview.innerHTML = '';
                    };
                })
                .catch(err => {
                    preview.innerHTML = `<p style="color:#dc3545;">‚ùå Camera error: ${err.message}</p>`;
                });
        };

        // ============================================
        // QR SCANNER FUNCTIONS
        // ============================================
        window.openQRScanner = function(btn, fieldName) {
            const container = btn.closest('.qr-container');
            const resultInput = container.querySelector('.qr-result');
            
            const scannerDiv = document.createElement('div');
            scannerDiv.style.cssText = 'margin-top:10px;';
            
            const video = document.createElement('video');
            video.setAttribute('autoplay', '');
            video.setAttribute('playsinline', '');
            video.style.cssText = 'width:100%;max-width:300px;border-radius:8px;border:2px solid #6f42c1;';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = '‚ùå Cancel';
            cancelBtn.style.cssText = 'display:block;margin-top:10px;padding:8px 16px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;';
            
            const status = document.createElement('p');
            status.textContent = 'üì± Point camera at QR code...';
            status.style.cssText = 'font-size:12px;color:#6f42c1;margin-top:8px;';
            
            scannerDiv.appendChild(video);
            scannerDiv.appendChild(status);
            scannerDiv.appendChild(cancelBtn);
            
            container.appendChild(scannerDiv);
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    
                    // Simple QR detection using canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const scanInterval = setInterval(() => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            ctx.drawImage(video, 0, 0);
                            
                            // Check if BarcodeDetector is available
                            if ('BarcodeDetector' in window) {
                                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                                detector.detect(canvas)
                                    .then(barcodes => {
                                        if (barcodes.length > 0) {
                                            resultInput.value = barcodes[0].rawValue;
                                            clearInterval(scanInterval);
                                            stream.getTracks().forEach(track => track.stop());
                                            scannerDiv.remove();
                                            notify('‚úÖ QR Code scanned!');
                                        }
                                    })
                                    .catch(err => console.log('Scan error:', err));
                            }
                        }
                    }, 500);
                    
                    cancelBtn.onclick = () => {
                        clearInterval(scanInterval);
                        stream.getTracks().forEach(track => track.stop());
                        scannerDiv.remove();
                    };
                })
                .catch(err => {
                    status.textContent = `‚ùå Camera error: ${err.message}`;
                    status.style.color = '#dc3545';
                });
        };

        // ============================================
        // GOOGLE SHEETS INTEGRATION
        // ============================================
        async function submitToGoogleSheets(data) {
            const scriptUrl = state.settings.scriptUrl;
            const sheetId = state.settings.sheetId;
            
            if (!scriptUrl) {
                // Save locally if no script URL
                saveLocally(data);
                return { success: true, offline: true };
            }
            
            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'submit',
                        formTitle: state.settings.title,
                        sheetId: sheetId,
                        data: data
                    })
                });
                return { success: true };
            } catch (err) {
                // Save offline if network fails
                saveOffline(data);
                return { success: false, offline: true, error: err.message };
            }
        }
        
        async function checkDuplicate(fieldName, value) {
            const scriptUrl = state.settings.scriptUrl;
            if (!scriptUrl || !fieldName || !value) return false;
            
            try {
                const response = await fetch(`${scriptUrl}?action=checkDuplicate&formTitle=${encodeURIComponent(state.settings.title)}&field=${encodeURIComponent(fieldName)}&value=${encodeURIComponent(value)}`);
                const result = await response.json();
                return result.isDuplicate;
            } catch (err) {
                // Check local storage for duplicates
                const key = getStorageKey();
                const localData = JSON.parse(localStorage.getItem(key) || '[]');
                return localData.some(d => d[fieldName] === value);
            }
        }
        
        async function fetchDataFromGoogleSheets() {
            const scriptUrl = state.settings.scriptUrl;
            if (!scriptUrl) return null;
            
            try {
                const response = await fetch(`${scriptUrl}?action=getData&formTitle=${encodeURIComponent(state.settings.title)}&limit=200`);
                const result = await response.json();
                return result.data || [];
            } catch (err) {
                console.error('Error fetching data:', err);
                return null;
            }
        }
        
        function saveOffline(data) {
            data._offline = true;
            data._pendingSync = true;
            const offlineData = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
            offlineData.push({ formTitle: state.settings.title, data: data });
            localStorage.setItem('offlineSubmissions', JSON.stringify(offlineData));
        }
        
        function saveLocally(data) {
            const key = getStorageKey();
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            existing.push(data);
            localStorage.setItem(key, JSON.stringify(existing));
        }
        
        async function syncOfflineData() {
            const offlineData = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
            if (offlineData.length === 0) return;
            
            const scriptUrl = state.settings.scriptUrl;
            if (!scriptUrl) return;
            
            const synced = [];
            for (const item of offlineData) {
                try {
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'submit',
                            formTitle: item.formTitle,
                            data: item.data
                        })
                    });
                    synced.push(item);
                } catch (err) {
                    break;
                }
            }
            
            if (synced.length > 0) {
                const remaining = offlineData.filter(d => !synced.includes(d));
                localStorage.setItem('offlineSubmissions', JSON.stringify(remaining));
                notify(`‚úÖ Synced ${synced.length} offline submission(s)`);
            }
        }
        
        // Sync when online
        window.addEventListener('online', syncOfflineData);
        
        // Check connection status
        function isOnline() {
            return navigator.onLine;
        }

        // ============================================
        // GENERATE FORM
        // ============================================
        function generateForm() {
            if (state.fields.length === 0) { notify('Add some fields first!', 'error'); return; }
            document.getElementById('htmlCode').textContent = generateHTMLCode();
            document.getElementById('scriptCode').textContent = generateAppsScriptCode();
            document.getElementById('generateModal').classList.add('show');
        }

        function generateHTMLCode() {
            const s = state.settings;
            let fieldsHTML = state.fields.map(f => {
                if (f.type === 'section') return `<div class="section-header">${f.label.toUpperCase()}</div>`;
                return generateFieldHTML(f);
            }).join('\n');
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${s.title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Oswald',sans-serif;background:#f5f5f5;padding:20px}
        .container{max-width:700px;margin:0 auto}
        .form-card{border:4px double #004080;border-radius:12px;background:#fff;overflow:hidden}
        .header{background:linear-gradient(135deg,#004080 0%,#002855 100%);color:#fff;padding:25px;text-align:center}
        .header img{width:80px;border-radius:10px;margin-bottom:12px}
        .header h1{font-size:22px;margin-bottom:5px}
        .header p{font-size:12px;opacity:0.9}
        .form-body{padding:25px}
        .form-group{margin-bottom:20px}
        .form-label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;text-transform:uppercase}
        .required{color:#dc3545}
        .form-input,.form-select,.form-textarea{width:100%;padding:12px;border:2px solid #004080;border-radius:6px;font-family:'Oswald',sans-serif;font-size:13px}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(0,64,128,0.2)}
        .radio-group,.checkbox-group{display:flex;flex-wrap:wrap;gap:10px}
        .radio-option,.checkbox-option{display:flex;align-items:center;gap:6px;padding:10px 14px;border:2px solid #dee2e6;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s}
        .radio-option:hover,.checkbox-option:hover{border-color:#004080}
        .section-header{background:#004080;color:#fff;padding:14px 18px;margin:25px -25px;font-size:14px;font-weight:700}
        .btn-submit{width:100%;padding:16px;background:#28a745;color:#fff;border:none;border-radius:6px;font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;cursor:pointer;text-transform:uppercase;margin-top:10px}
        .btn-submit:hover{background:#218838}
        .help-text{font-size:10px;color:#868e96;margin-top:4px}
        .footer{text-align:center;padding:20px;font-size:11px;color:#868e96}
    </style>
</head>
<body>
    <div class="container">
        <div class="form-card">
            <div class="header">
                <img src="${s.logo}" alt="Logo">
                <h1>${s.title}</h1>
                <p>${s.subtitle}</p>
            </div>
            <div class="form-body">
                <form id="dataForm">
${fieldsHTML}
                    <button type="submit" class="btn-submit">‚úÖ SUBMIT</button>
                </form>
            </div>
        </div>
        <div class="footer">¬© 2025 ${s.organization}</div>
    </div>
    <script>
        document.getElementById('dataForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {};
            new FormData(this).forEach((v, k) => data[k] = v);
            data._timestamp = new Date().toISOString();
            console.log('Form data:', data);
            alert('‚úÖ Form submitted successfully!');
            this.reset();
        });
    <\/script>
</body>
</html>`;
        }

        function generateFieldHTML(field) {
            const req = field.required ? '<span class="required">*</span>' : '';
            const reqAttr = field.required ? 'required' : '';
            const help = field.helpText ? `<div class="help-text">${escapeHtml(field.helpText)}</div>` : '';
            let inner = '';
            
            switch (field.type) {
                case 'text': inner = `<input type="text" class="form-input" name="${field.name}" placeholder="${field.placeholder || ''}" ${reqAttr}>`; break;
                case 'email': inner = `<input type="email" class="form-input" name="${field.name}" placeholder="${field.placeholder || ''}" ${reqAttr}>`; break;
                case 'phone': inner = `<input type="tel" class="form-input" name="${field.name}" placeholder="${field.placeholder || 'Enter 9 digits'}" pattern="[0-9]{9}" maxlength="9" minlength="9" title="Please enter exactly 9 digits" oninput="this.value=this.value.replace(/[^0-9]/g,'')" ${reqAttr}>`; break;
                case 'number': inner = `<input type="number" class="form-input" name="${field.name}" placeholder="${field.placeholder || ''}" ${reqAttr}>`; break;
                case 'date': inner = `<input type="date" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'time': inner = `<input type="time" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'textarea': inner = `<textarea class="form-textarea" name="${field.name}" rows="4" placeholder="${field.placeholder || ''}" ${reqAttr}></textarea>`; break;
                case 'select': 
                    inner = `<select class="form-select" name="${field.name}" ${reqAttr}><option value="">-- Select --</option>${(field.options || []).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`; 
                    break;
                case 'radio': case 'yesno': case 'yesnona':
                    const opts = field.type === 'yesno' ? ['Yes', 'No'] : field.type === 'yesnona' ? ['Yes', 'No', 'N/A'] : (field.options || []);
                    inner = `<div class="radio-group">${opts.map(o => `<label class="radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; 
                    break;
                case 'checkbox':
                    inner = `<div class="checkbox-group">${(field.options || []).map(o => `<label class="checkbox-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; 
                    break;
                default: return '';
            }
            
            return `                    <div class="form-group"><label class="form-label">${escapeHtml(field.label)} ${req}</label>${inner}${help}</div>`;
        }

        function generateAppsScriptCode() {
            const fields = state.fields.filter(f => f.type !== 'section');
            const headers = ['_timestamp', ...fields.map(f => f.name)];
            
            return `// ============================================
// Google Apps Script for Form Builder Pro
// Form: ${state.settings.title}
// ============================================
// INSTRUCTIONS:
// 1. Create a new Google Sheet
// 2. Go to Extensions ‚Üí Apps Script
// 3. Delete any existing code and paste this entire script
// 4. Click Deploy ‚Üí New deployment
// 5. Select "Web app" as type
// 6. Set "Who has access" to "Anyone"
// 7. Click Deploy and copy the URL
// 8. Paste the URL in Form Builder Settings ‚Üí Google Sheets ‚Üí Apps Script URL

const SPREADSHEET_ID = '${state.settings.sheetId || 'YOUR_SPREADSHEET_ID_HERE'}';

function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action || 'submit';
    
    if (action === 'submit') {
      return handleSubmit(payload);
    }
    
    return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.message });
  }
}

function doGet(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'getData') {
      return handleGetData(e.parameter);
    }
    
    if (action === 'checkDuplicate') {
      return handleCheckDuplicate(e.parameter);
    }
    
    return jsonResponse({ success: true, message: 'Form API ready' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.message });
  }
}

function handleSubmit(payload) {
  const formTitle = payload.formTitle || 'Form Data';
  const data = payload.data || {};
  const sheetId = payload.sheetId || SPREADSHEET_ID;
  
  const ss = sheetId ? SpreadsheetApp.openById(sheetId) : SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(formTitle);
  
  // Create sheet if it doesn't exist
  if (!sheet) {
    sheet = ss.insertSheet(formTitle);
    // Add headers
    const headers = ${JSON.stringify(headers)};
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#004080').setFontColor('#ffffff');
  }
  
  // Get headers from first row
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Check for new fields and add columns if needed
  Object.keys(data).forEach(key => {
    if (!key.startsWith('_') && !headers.includes(key)) {
      const newCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, newCol).setValue(key).setFontWeight('bold').setBackground('#004080').setFontColor('#ffffff');
      headers.push(key);
    }
  });
  
  // Build row data
  const rowData = headers.map(h => {
    const val = data[h];
    if (val && typeof val === 'string' && val.startsWith('data:image')) {
      return '[Image Data]'; // Don't store base64 images directly
    }
    return val || '';
  });
  
  sheet.appendRow(rowData);
  
  return jsonResponse({ success: true });
}

function handleGetData(params) {
  const formTitle = params.formTitle || 'Form Data';
  const limit = parseInt(params.limit) || 200;
  const sheetId = params.sheetId || SPREADSHEET_ID;
  
  const ss = sheetId ? SpreadsheetApp.openById(sheetId) : SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(formTitle);
  
  if (!sheet) {
    return jsonResponse({ success: true, data: [] });
  }
  
  const lastRow = Math.min(sheet.getLastRow(), limit + 1);
  if (lastRow < 2) {
    return jsonResponse({ success: true, data: [] });
  }
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());
  const values = dataRange.getValues();
  
  const data = values.map(row => {
    const obj = {};
    headers.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });
  
  return jsonResponse({ success: true, data: data });
}

function handleCheckDuplicate(params) {
  const formTitle = params.formTitle || 'Form Data';
  const field = params.field;
  const value = params.value;
  const sheetId = params.sheetId || SPREADSHEET_ID;
  
  if (!field || !value) {
    return jsonResponse({ success: true, isDuplicate: false });
  }
  
  const ss = sheetId ? SpreadsheetApp.openById(sheetId) : SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(formTitle);
  
  if (!sheet || sheet.getLastRow() < 2) {
    return jsonResponse({ success: true, isDuplicate: false });
  }
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const fieldIndex = headers.indexOf(field);
  
  if (fieldIndex === -1) {
    return jsonResponse({ success: true, isDuplicate: false });
  }
  
  const values = sheet.getRange(2, fieldIndex + 1, sheet.getLastRow() - 1, 1).getValues();
  const isDuplicate = values.some(row => String(row[0]).toLowerCase() === String(value).toLowerCase());
  
  return jsonResponse({ success: true, isDuplicate: isDuplicate });
}

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================
// UTILITY: Test the script
// ============================================
function testScript() {
  Logger.log('Script is working!');
  Logger.log('Spreadsheet ID: ' + SPREADSHEET_ID);
}`;
        }

        // ============================================
        // SHARE & QR CODE
        // ============================================
        function shareForm() {
            if (state.fields.length === 0) { notify('Add some fields first!', 'error'); return; }
            
            document.getElementById('shareFormTitle').textContent = state.settings.title;
            
            // Simplified data for smaller URL - includes settings for Google Sheets
            const formData = {
                t: state.settings.title,
                s: state.settings.subtitle,
                o: state.settings.organization,
                l: state.settings.logo,
                u: state.settings.scriptUrl || '',  // Apps Script URL
                g: state.settings.sheetId || '',    // Sheet ID
                df: state.settings.duplicateCheckField || '', // Duplicate check field
                f: state.fields.map(f => {
                    const field = { i: f.id, y: f.type, l: f.label, n: f.name, r: f.required };
                    if (f.placeholder) field.p = f.placeholder;
                    if (f.helpText) field.h = f.helpText;
                    if (f.options?.length) field.o = f.options;
                    if (f.levels?.length) field.v = f.levels;
                    if (f.columns?.length) field.c = f.columns;
                    if (f.rows && f.rows !== 3) field.rw = f.rows;
                    if (f.max && f.max !== 5) field.mx = f.max;
                    if (f.accept) field.a = f.accept;
                    if (f.formula) field.fm = f.formula;
                    if (f.skipLogic?.enabled) field.k = f.skipLogic;
                    if (f.validation?.enabled) field.d = f.validation;
                    if (f.conditional?.enabled) field.cn = f.conditional;
                    return field;
                })
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                
                const baseUrl = window.location.protocol === 'file:' 
                    ? 'https://yourdomain.com/form.html'
                    : window.location.origin + window.location.pathname;
                
                currentShareUrl = baseUrl + '?c=' + encodeURIComponent(encoded);
                document.getElementById('shareUrl').textContent = currentShareUrl;
                
                // Generate QR code
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: currentShareUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#004080',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                document.getElementById('shareModal').classList.add('show');
            } catch (err) {
                console.error('Share error:', err);
                notify('Error creating share link', 'error');
            }
        }

        function copyShareUrl() {
            navigator.clipboard.writeText(currentShareUrl).then(() => notify('üìã URL copied!'));
        }

        function downloadQR() {
            const qrContainer = document.getElementById('qrCode');
            const canvas = qrContainer.querySelector('canvas');
            const img = qrContainer.querySelector('img');
            
            if (!canvas && !img) { notify('No QR code to download', 'error'); return; }
            
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            const padding = 30;
            const titleHeight = 50;
            const qrSize = 200;
            
            newCanvas.width = qrSize + padding * 2;
            newCanvas.height = qrSize + padding * 2 + titleHeight;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            
            ctx.fillStyle = '#004080';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(state.settings.title, newCanvas.width / 2, 28);
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Scan to open form', newCanvas.width / 2, 45);
            
            if (canvas) {
                ctx.drawImage(canvas, padding, titleHeight + 10, qrSize, qrSize);
                downloadImage();
            } else if (img) {
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.onload = function() {
                    ctx.drawImage(tempImg, padding, titleHeight + 10, qrSize, qrSize);
                    downloadImage();
                };
                tempImg.src = img.src;
            }
            
            function downloadImage() {
                const link = document.createElement('a');
                link.download = state.settings.title.replace(/[^a-z0-9]/gi, '-') + '-QR.png';
                link.href = newCanvas.toDataURL('image/png');
                link.click();
                notify('‚¨áÔ∏è QR Code downloaded!');
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function downloadHTML() {
            const code = document.getElementById('htmlCode').textContent;
            const blob = new Blob([code], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.html';
            a.click();
            notify('‚¨áÔ∏è HTML downloaded!');
        }

        function downloadScript() {
            const code = document.getElementById('scriptCode').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'apps-script.gs';
            a.click();
            notify('‚¨áÔ∏è Script downloaded!');
        }

        function copyCode(id) {
            const code = document.getElementById(id).textContent;
            navigator.clipboard.writeText(code);
            notify('üìã Code copied!');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : '');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function saveToStorage() {
            localStorage.setItem('formBuilderProEnhanced', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderProEnhanced');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                } catch (e) { console.error('Error loading state:', e); }
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
