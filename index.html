<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder - ICF-SL</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .header { background: #004080; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 40px; height: 40px; border-radius: 6px; }
        .header h1 { font-size: 18px; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { background: white; color: #004080; border: none; padding: 8px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; text-transform: uppercase; }
        .header-btn:hover { background: #f0f0f0; }
        .header-btn.primary { background: #ffc107; color: #000; }
        
        .main-container { display: flex; margin-top: 60px; height: calc(100vh - 90px); }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        .sidebar { width: 220px; background: white; border-right: 2px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 500; transition: all 0.2s; user-select: none; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; transform: translateX(3px); }
        .field-type:active { transform: scale(0.98); }
        .field-type-icon { font-size: 16px; }
        
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 10px 20px; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .form-title-input { font-size: 15px; font-weight: 700; border: 2px solid transparent; padding: 6px 10px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .form-title-input:focus { outline: none; border-color: #004080; background: #f8f9fa; }
        
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 600px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 300px; }
        .form-preview-header { background: #004080; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-header h2 { font-size: 16px; margin-bottom: 3px; }
        .form-preview-header p { font-size: 10px; opacity: 0.9; }
        .form-preview-body { padding: 15px; min-height: 200px; }
        
        .drop-zone { border: 3px dashed #ccc; border-radius: 8px; padding: 30px; text-align: center; color: #999; font-size: 12px; transition: all 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .drop-zone.drag-over { border-color: #004080; background: #e8f4fc; color: #004080; }
        .drop-zone.has-fields { border: none; padding: 0; display: block; min-height: auto; }
        
        .form-field { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .form-field-label { font-weight: 700; font-size: 11px; color: #333; text-transform: uppercase; }
        .form-field-actions { display: flex; gap: 3px; }
        .field-action-btn { background: #e9ecef; border: none; cursor: pointer; font-size: 12px; padding: 4px 6px; border-radius: 4px; }
        .field-action-btn:hover { background: #dee2e6; }
        .field-action-btn.delete:hover { background: #ffebee; color: #dc3545; }
        .form-field-preview { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 6px; font-size: 11px; color: #666; }
        .form-field-meta { margin-top: 5px; font-size: 9px; color: #999; }
        .form-field-meta .skip-badge { background: #fff3cd; color: #856404; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        
        .section-divider { background: #004080; color: white; padding: 8px 12px; margin: 10px 0; border-radius: 5px; font-weight: 700; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-divider.selected { box-shadow: 0 0 0 3px rgba(0,64,128,0.3); }
        
        .properties-panel { width: 280px; background: white; border-left: 2px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-input:focus, .property-select:focus { outline: none; border-color: #004080; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; }
        .property-checkbox input { width: 16px; height: 16px; cursor: pointer; }
        .property-textarea { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; resize: vertical; }
        .no-selection { text-align: center; color: #999; padding: 30px 15px; font-size: 12px; }
        
        .skip-logic-box { background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 10px; margin-top: 12px; }
        .skip-logic-title { font-size: 10px; font-weight: 700; color: #856404; margin-bottom: 8px; text-transform: uppercase; }
        .skip-row { display: flex; gap: 5px; margin-bottom: 6px; align-items: center; flex-wrap: wrap; }
        .skip-row select, .skip-row input { padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 10px; font-family: 'Oswald', sans-serif; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 700px; width: 95%; max-height: 85vh; overflow: hidden; border: 4px double #004080; }
        .modal-header { background: #004080; color: white; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 15px; }
        .modal-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        .modal-body { padding: 18px; max-height: 55vh; overflow-y: auto; }
        .modal-footer { padding: 12px 18px; border-top: 2px solid #ddd; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 8px 18px; border-radius: 5px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; border: 2px solid #004080; }
        .modal-btn.secondary { background: white; color: #004080; }
        .modal-btn.primary { background: #004080; color: white; }
        
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab { padding: 10px 18px; cursor: pointer; font-weight: 700; font-size: 11px; border-bottom: 3px solid transparent; margin-bottom: -2px; text-transform: uppercase; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #004080; color: #004080; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .settings-group { margin-bottom: 12px; }
        .settings-group.full-width { grid-column: span 2; }
        
        .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .toggle-slider { width: 44px; height: 22px; background: #ccc; border-radius: 11px; position: relative; transition: background 0.3s; }
        .toggle-slider::after { content: ''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle-switch input { display: none; }
        .toggle-switch input:checked + .toggle-slider { background: #28a745; }
        .toggle-switch input:checked + .toggle-slider::after { left: 24px; }
        
        .file-upload-area { border: 3px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 12px; }
        .file-upload-area:hover { border-color: #004080; background: #f8f9fa; }
        .file-upload-area.has-file { border-color: #28a745; background: #d4edda; }
        .download-sample { display: inline-block; padding: 8px 14px; background: #004080; color: white; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: 700; border: none; margin-top: 8px; }
        
        .info-box { background: #e8f4fc; border: 2px solid #004080; border-radius: 6px; padding: 10px; font-size: 11px; margin-top: 10px; }
        .info-box h4 { color: #004080; margin-bottom: 5px; font-size: 11px; }
        .info-box code { background: #fff; padding: 2px 5px; border-radius: 3px; font-size: 10px; }
        
        .code-preview { background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 10px; white-space: pre-wrap; max-height: 280px; overflow: auto; }
        
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        
        .api-status { padding: 8px 12px; border-radius: 6px; font-size: 11px; margin-bottom: 12px; }
        .api-status.connected { background: #d4edda; color: #155724; }
        .api-status.disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>üìã FORM BUILDER</h1>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="openSettings()">‚öôÔ∏è SETTINGS</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è PREVIEW</button>
            <button class="header-btn" onclick="shareForm()">üîó SHARE</button>
            <button class="header-btn primary" onclick="generateForm()">‚¨áÔ∏è GENERATE</button>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic</h3>
                <div class="field-type" data-type="text"><span class="field-type-icon">üìÑ</span><span>Text</span></div>
                <div class="field-type" data-type="number"><span class="field-type-icon">üî¢</span><span>Number</span></div>
                <div class="field-type" data-type="date"><span class="field-type-icon">üìÖ</span><span>Date</span></div>
                <div class="field-type" data-type="textarea"><span class="field-type-icon">üìù</span><span>Text Area</span></div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection</h3>
                <div class="field-type" data-type="select"><span class="field-type-icon">üìã</span><span>Dropdown</span></div>
                <div class="field-type" data-type="radio"><span class="field-type-icon">üîò</span><span>Radio</span></div>
                <div class="field-type" data-type="checkbox"><span class="field-type-icon">‚òëÔ∏è</span><span>Checkbox</span></div>
                <div class="field-type" data-type="yesno"><span class="field-type-icon">‚úÖ</span><span>Yes/No</span></div>
                <div class="field-type" data-type="yesnona"><span class="field-type-icon">‚ùì</span><span>Yes/No/NA</span></div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üîó Location</h3>
                <div class="field-type" data-type="cascading"><span class="field-type-icon">üè¢</span><span>Cascading</span></div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special</h3>
                <div class="field-type" data-type="signature"><span class="field-type-icon">‚úçÔ∏è</span><span>Signature</span></div>
                <div class="field-type" data-type="gps"><span class="field-type-icon">üìç</span><span>GPS</span></div>
                <div class="field-type" data-type="quality"><span class="field-type-icon">‚≠ê</span><span>Quality</span></div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section"><span class="field-type-icon">üìÅ</span><span>Section</span></div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:11px;" id="fieldCount">0 fields</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p id="previewSubtitle">Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size: 24px; margin-bottom: 10px;">üì•</p>
                            <p>Click field types on the left to add them</p>
                            <p style="margin-top: 5px; font-size: 10px; color: #aaa;">Or drag and drop here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel">
            <h3 class="properties-title">‚öôÔ∏è Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size: 24px; margin-bottom: 10px;">üëÜ</p>
                    <p>Select a field to edit its properties</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">¬© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL)</footer>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs" id="settingsTabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="cascading">Cascading</div>
                    <div class="tab" data-tab="google">Google Sheets</div>
                </div>

                <div class="tab-content active" id="tab-general">
                    <div class="settings-group">
                        <label class="property-label">Form Title</label>
                        <input type="text" class="property-input" id="settingsTitle">
                    </div>
                    <div class="settings-group">
                        <label class="property-label">Subtitle</label>
                        <input type="text" class="property-input" id="settingsSubtitle">
                    </div>
                    <div class="settings-group">
                        <label class="property-label">Organization</label>
                        <input type="text" class="property-input" id="settingsOrg">
                    </div>
                    <div class="settings-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableLogin" checked>
                            <span class="toggle-slider"></span>
                            <span style="font-size: 12px;">Enable Login</span>
                        </label>
                    </div>
                </div>

                <div class="tab-content" id="tab-cascading">
                    <div class="file-upload-area" id="fileUploadArea">
                        <div style="font-size: 28px; margin-bottom: 8px;">üìÅ</div>
                        <div id="fileUploadText" style="font-size: 12px;">Upload Excel or CSV</div>
                        <input type="file" id="cascadingFile" accept=".xlsx,.xls,.csv" style="display:none;">
                    </div>
                    <button class="download-sample" onclick="downloadSampleFile()">‚¨áÔ∏è Sample Template</button>
                    <div class="settings-group" style="margin-top: 12px;">
                        <label class="property-label">Or Enter Manually</label>
                        <textarea class="property-textarea" id="cascadingData" style="height: 80px; font-family: monospace; font-size: 10px;"></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-google">
                    <div class="settings-group">
                        <label class="property-label">Apps Script Web URL</label>
                        <input type="text" class="property-input" id="settingsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                    </div>
                    <div style="background:#e8f4fc;padding:12px;border-radius:6px;margin-top:10px;font-size:11px;">
                        <strong>üìã One Script for ALL Forms!</strong><br>
                        Each form auto-creates its own sheet/tab based on form title.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Generate Modal -->
    <div class="modal-overlay" id="generateModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üì• Generated Form</h3>
                <button class="modal-close" onclick="closeModal('generateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="sheetCreatedMsg" style="display: none; background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #28a745;"></div>
                
                <div class="tabs" id="generateTabs">
                    <div class="tab active" data-tab="html-code">HTML Form</div>
                    <div class="tab" data-tab="apps-script">Apps Script</div>
                </div>
                
                <div class="tab-content active" id="tab-html-code">
                    <div style="margin-bottom: 10px;">
                        <button class="modal-btn primary" onclick="downloadHTML()">‚¨áÔ∏è Download HTML</button>
                        <button class="modal-btn secondary" onclick="copyCode('htmlCode')" style="margin-left: 5px;">üìã Copy</button>
                    </div>
                    <div class="code-preview" id="htmlCode"></div>
                </div>
                
                <div class="tab-content" id="tab-apps-script">
                    <div style="margin-bottom: 10px;">
                        <button class="modal-btn primary" onclick="downloadScript()">‚¨áÔ∏è Download .gs</button>
                        <button class="modal-btn secondary" onclick="copyCode('scriptCode')" style="margin-left: 5px;">üìã Copy</button>
                    </div>
                    <div class="code-preview" id="scriptCode"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('generateModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal" style="max-width: 650px;">
            <div class="modal-header">
                <h3>üëÅÔ∏è Form Preview</h3>
                <button class="modal-close" onclick="closeModal('previewModal')">&times;</button>
            </div>
            <div class="modal-body" id="previewBody" style="padding: 0;"></div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('previewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal" style="max-width: 350px;">
            <div class="modal-header">
                <h3>üì± QR Code</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 25px;">
                <div id="qrcodeContainer" style="display: inline-block; padding: 15px; background: white; border: 3px solid #004080; border-radius: 12px;"></div>
                <p style="margin-top: 12px; font-size: 10px; color: #004080; word-break: break-all; cursor: pointer;" id="qrUrlDisplay" title="Click to copy"></p>
                <div style="margin-top: 15px;">
                    <button class="modal-btn primary" onclick="copyFormUrl()">üìã Copy URL</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="modal-btn secondary" onclick="downloadQRCode()">‚¨áÔ∏è Download</button>
                    <button class="modal-btn secondary" onclick="printQRCode()" style="margin-left: 8px;">üñ®Ô∏è Print</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ========================================
        // STATE
        // ========================================
        const BASE_URL = 'https://informatics-consultancy-firm.github.io/form-builder';
        
        const state = {
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            settings: {
                title: 'My Data Collection Form',
                subtitle: 'Data Collection System',
                organization: 'National Malaria Control Programme',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                enableLogin: true,
                username: 'admin',
                password: 'admin',
                scriptUrl: 'YOUR_SCRIPT_URL',
                cascadingData: ''
            }
        };

        const fieldDefs = {
            text: { label: 'Text', icon: 'üìÑ', defaultLabel: 'Text Field' },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field' },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field' },
            textarea: { label: 'Text Area', icon: 'üìù', defaultLabel: 'Text Area' },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', options: ['Option 1', 'Option 2'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Buttons', options: ['Option 1', 'Option 2'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkboxes', options: ['Option 1', 'Option 2'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question' },
            yesnona: { label: 'Yes/No/NA', icon: '‚ùì', defaultLabel: 'Yes/No/NA Question' },
            cascading: { label: 'Cascading', icon: 'üè¢', defaultLabel: 'Location', levels: ['Region', 'District', 'Chiefdom', 'Facility'] },
            signature: { label: 'Signature', icon: '‚úçÔ∏è', defaultLabel: 'Signature' },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location' },
            quality: { label: 'Quality', icon: '‚≠ê', defaultLabel: 'Quality Rating', options: ['Excellent', 'Acceptable', 'Needs Improvement'] },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section' }
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            loadFromStorage();
            setupFieldTypes();
            setupDropZone();
            setupTabs();
            setupFormTitle();
            setupFileUpload();
            renderFields();
        }

        function setupFieldTypes() {
            document.querySelectorAll('.field-type').forEach(el => {
                el.addEventListener('click', function() {
                    const type = this.dataset.type;
                    addField(type);
                });
                
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('fieldType', this.dataset.type);
                    this.style.opacity = '0.5';
                });
                el.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                });
            });
        }

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                const type = e.dataTransfer.getData('fieldType');
                if (type) addField(type);
            });
        }

        function setupTabs() {
            document.querySelectorAll('.tabs').forEach(tabContainer => {
                tabContainer.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const parent = this.closest('.modal-body') || document;
                        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        const tabId = 'tab-' + this.dataset.tab;
                        document.getElementById(tabId).classList.add('active');
                    });
                });
            });
        }

        function setupFormTitle() {
            const input = document.getElementById('formTitle');
            input.value = state.settings.title;
            input.addEventListener('input', function() {
                state.settings.title = this.value;
                document.getElementById('previewTitle').textContent = this.value;
                saveToStorage();
            });
        }

        function setupFileUpload() {
            const area = document.getElementById('fileUploadArea');
            const input = document.getElementById('cascadingFile');
            
            area.addEventListener('click', () => input.click());
            input.addEventListener('change', handleFileUpload);
        }

        // ========================================
        // FIELD MANAGEMENT
        // ========================================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;

            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                levels: def.levels ? [...def.levels] : [],
                skipLogic: { enabled: false, action: 'show', sourceField: '', condition: 'equals', sourceValue: '' },
                validation: { 
                    enabled: false, 
                    type: 'none',  // none, minmax, minlength, maxlength, pattern, email, phone, custom
                    min: '',
                    max: '',
                    minLength: '',
                    maxLength: '',
                    pattern: '',
                    customRegex: '',
                    errorMessage: ''
                }
            };

            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
            notify('Field added!');
        }

        function removeField(id) {
            event.stopPropagation();
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) {
                state.selectedFieldId = null;
                renderProperties();
            }
            renderFields();
            saveToStorage();
            notify('Field removed');
        }

        function moveField(id, direction) {
            event.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        // ========================================
        // RENDERING
        // ========================================
        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:24px;margin-bottom:10px;">üì•</p><p>Click field types on the left to add them</p><p style="margin-top:5px;font-size:10px;color:#aaa;">Or drag and drop here</p>';
            } else {
                dropZone.classList.add('has-fields');
                dropZone.innerHTML = state.fields.map(f => renderFieldHTML(f)).join('');
                
                // Attach click listeners
                dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                    el.addEventListener('click', function(e) {
                        if (!e.target.closest('.field-action-btn')) {
                            selectField(this.dataset.id);
                        }
                    });
                });
            }
            
            document.getElementById('fieldCount').textContent = state.fields.length + ' field' + (state.fields.length !== 1 ? 's' : '');
        }

        function renderFieldHTML(field) {
            const def = fieldDefs[field.type];
            const selected = field.id === state.selectedFieldId;
            
            if (field.type === 'section') {
                return `<div class="section-divider ${selected ? 'selected' : ''}" data-id="${field.id}">
                    <span>${def.icon} ${field.label.toUpperCase()}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn" onclick="moveField('${field.id}','up')">‚¨ÜÔ∏è</button>
                        <button class="field-action-btn" onclick="moveField('${field.id}','down')">‚¨áÔ∏è</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')">üóëÔ∏è</button>
                    </div>
                </div>`;
            }
            
            const skipBadge = field.skipLogic && field.skipLogic.enabled ? '<span class="skip-badge">‚ö° Skip</span>' : '';
            
            return `<div class="form-field ${selected ? 'selected' : ''}" data-id="${field.id}">
                <div class="form-field-header">
                    <span class="form-field-label">${def.icon} ${field.label} ${field.required ? '<span style="color:red;">*</span>' : ''}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn" onclick="moveField('${field.id}','up')">‚¨ÜÔ∏è</button>
                        <button class="field-action-btn" onclick="moveField('${field.id}','down')">‚¨áÔ∏è</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="form-field-preview">${renderFieldPreview(field)}</div>
                <div class="form-field-meta">${field.name} ${skipBadge}</div>
            </div>`;
        }

        function renderFieldPreview(field) {
            switch (field.type) {
                case 'text':
                case 'number':
                case 'date':
                    return `<input type="${field.type}" style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;" disabled>`;
                case 'textarea':
                    return `<textarea style="width:100%;height:40px;padding:5px;border:1px solid #ddd;border-radius:3px;" disabled></textarea>`;
                case 'select':
                    return `<select style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;" disabled><option>-- Select --</option></select>`;
                case 'radio':
                case 'yesno':
                case 'yesnona':
                    const opts = field.type === 'yesno' ? ['Yes', 'No'] : field.type === 'yesnona' ? ['Yes', 'No', 'N/A'] : field.options;
                    return opts.map(o => `<label style="margin-right:8px;font-size:10px;"><input type="radio" disabled> ${o}</label>`).join('');
                case 'checkbox':
                    return field.options.map(o => `<label style="display:block;font-size:10px;"><input type="checkbox" disabled> ${o}</label>`).join('');
                case 'cascading':
                    return field.levels.map(l => `<select style="width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;margin-bottom:3px;font-size:9px;" disabled><option>-- ${l} --</option></select>`).join('');
                case 'signature':
                    return `<div style="border:2px dashed #ddd;height:50px;display:flex;align-items:center;justify-content:center;color:#999;font-size:10px;">‚úçÔ∏è Signature Pad</div>`;
                case 'gps':
                    return `<button style="padding:5px 10px;background:#004080;color:white;border:none;border-radius:3px;font-size:9px;" disabled>üìç Capture GPS</button>`;
                case 'quality':
                    return field.options.map(o => `<button style="padding:3px 8px;margin-right:3px;border:1px solid #ddd;border-radius:3px;font-size:9px;" disabled>${o}</button>`).join('');
                default:
                    return '';
            }
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:24px;margin-bottom:10px;">üëÜ</p><p>Select a field to edit</p></div>';
                return;
            }
            
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `
                <div class="property-group">
                    <label class="property-label">Label</label>
                    <input type="text" class="property-input" id="propLabel" value="${field.label}">
                </div>
                <div class="property-group">
                    <label class="property-label">Field Name</label>
                    <input type="text" class="property-input" id="propName" value="${field.name}">
                </div>`;
            
            if (field.type !== 'section') {
                html += `<div class="property-group">
                    <label class="property-checkbox">
                        <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                        <span>Required</span>
                    </label>
                </div>`;
            }
            
            if (['select', 'radio', 'checkbox', 'quality'].includes(field.type)) {
                html += `<div class="property-group">
                    <label class="property-label">Options (one per line)</label>
                    <textarea class="property-textarea" id="propOptions">${field.options.join('\n')}</textarea>
                </div>`;
            }
            
            if (field.type === 'cascading') {
                html += `<div class="property-group">
                    <label class="property-label">Levels (one per line)</label>
                    <textarea class="property-textarea" id="propLevels">${field.levels.join('\n')}</textarea>
                </div>`;
            }
            
            // Skip Logic
            if (field.type !== 'section') {
                const sourceFields = state.fields.filter(f => f.id !== field.id && ['yesno', 'yesnona', 'radio', 'select'].includes(f.type));
                
                html += `<div class="skip-logic-box">
                    <div class="skip-logic-title">‚ö° Skip Logic</div>
                    <div class="property-group">
                        <label class="property-checkbox">
                            <input type="checkbox" id="skipEnabled" ${field.skipLogic?.enabled ? 'checked' : ''}>
                            <span>Enable Skip Logic</span>
                        </label>
                    </div>
                    <div id="skipOptions" style="display:${field.skipLogic?.enabled ? 'block' : 'none'};">
                        <div class="skip-row">
                            <select id="skipAction">
                                <option value="show" ${field.skipLogic?.action === 'show' ? 'selected' : ''}>Show</option>
                                <option value="hide" ${field.skipLogic?.action === 'hide' ? 'selected' : ''}>Hide</option>
                            </select>
                            <span style="font-size:10px;">this field when</span>
                        </div>
                        <div class="skip-row">
                            <select id="skipSourceField" style="flex:1;">
                                <option value="">-- Select field --</option>
                                ${sourceFields.map(f => `<option value="${f.id}" ${field.skipLogic?.sourceField === f.id ? 'selected' : ''}>${f.label}</option>`).join('')}
                            </select>
                        </div>
                        <div class="skip-row">
                            <select id="skipCondition">
                                <option value="equals" ${field.skipLogic?.condition === 'equals' ? 'selected' : ''}>equals</option>
                                <option value="not_equals" ${field.skipLogic?.condition === 'not_equals' ? 'selected' : ''}>not equals</option>
                            </select>
                            <input type="text" id="skipValue" placeholder="Value (e.g., Yes)" value="${field.skipLogic?.sourceValue || ''}" style="flex:1;">
                        </div>
                    </div>
                </div>`;
                
                // Validation Rules
                if (['text', 'number', 'textarea'].includes(field.type)) {
                    const v = field.validation || {};
                    html += `<div class="skip-logic-box" style="background:#fff8e6;border-color:#ffc107;">
                        <div class="skip-logic-title" style="color:#856404;">‚úì Validation</div>
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="validEnabled" ${v.enabled ? 'checked' : ''}>
                                <span>Enable Validation</span>
                            </label>
                        </div>
                        <div id="validOptions" style="display:${v.enabled ? 'block' : 'none'};">
                            <div class="property-group">
                                <label class="property-label">Validation Type</label>
                                <select id="validType" class="property-input">
                                    <option value="none" ${v.type === 'none' ? 'selected' : ''}>None</option>
                                    ${field.type === 'number' ? `
                                        <option value="minmax" ${v.type === 'minmax' ? 'selected' : ''}>Min/Max Value</option>
                                    ` : `
                                        <option value="minlength" ${v.type === 'minlength' ? 'selected' : ''}>Min Length</option>
                                        <option value="maxlength" ${v.type === 'maxlength' ? 'selected' : ''}>Max Length</option>
                                        <option value="email" ${v.type === 'email' ? 'selected' : ''}>Email</option>
                                        <option value="phone" ${v.type === 'phone' ? 'selected' : ''}>Phone Number</option>
                                        <option value="custom" ${v.type === 'custom' ? 'selected' : ''}>Custom Pattern</option>
                                    `}
                                </select>
                            </div>
                            <div id="validMinMax" style="display:${v.type === 'minmax' ? 'flex' : 'none'};gap:8px;">
                                <div class="property-group" style="flex:1;">
                                    <label class="property-label">Min</label>
                                    <input type="number" class="property-input" id="validMin" value="${v.min || ''}">
                                </div>
                                <div class="property-group" style="flex:1;">
                                    <label class="property-label">Max</label>
                                    <input type="number" class="property-input" id="validMax" value="${v.max || ''}">
                                </div>
                            </div>
                            <div id="validLength" style="display:${['minlength', 'maxlength'].includes(v.type) ? 'block' : 'none'};">
                                <div class="property-group">
                                    <label class="property-label">${v.type === 'minlength' ? 'Minimum' : 'Maximum'} Characters</label>
                                    <input type="number" class="property-input" id="validLengthVal" value="${v.minLength || v.maxLength || ''}">
                                </div>
                            </div>
                            <div id="validCustom" style="display:${v.type === 'custom' ? 'block' : 'none'};">
                                <div class="property-group">
                                    <label class="property-label">Regex Pattern</label>
                                    <input type="text" class="property-input" id="validPattern" value="${v.customRegex || ''}" placeholder="e.g., ^[A-Z]{2}[0-9]{4}$">
                                </div>
                            </div>
                            <div class="property-group">
                                <label class="property-label">Error Message</label>
                                <input type="text" class="property-input" id="validError" value="${v.errorMessage || ''}" placeholder="Custom error message">
                            </div>
                        </div>
                    </div>`;
                }
            }
            
            container.innerHTML = html;
            
            // Attach event listeners
            document.getElementById('propLabel').addEventListener('change', e => updateField('label', e.target.value));
            document.getElementById('propName').addEventListener('change', e => updateField('name', e.target.value));
            
            const reqEl = document.getElementById('propRequired');
            if (reqEl) reqEl.addEventListener('change', e => updateField('required', e.target.checked));
            
            const optEl = document.getElementById('propOptions');
            if (optEl) optEl.addEventListener('change', e => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
            
            const levEl = document.getElementById('propLevels');
            if (levEl) levEl.addEventListener('change', e => updateField('levels', e.target.value.split('\n').filter(l => l.trim())));
            
            const skipEn = document.getElementById('skipEnabled');
            if (skipEn) {
                skipEn.addEventListener('change', e => {
                    updateSkipLogic('enabled', e.target.checked);
                    document.getElementById('skipOptions').style.display = e.target.checked ? 'block' : 'none';
                });
            }
            
            const skipAct = document.getElementById('skipAction');
            if (skipAct) skipAct.addEventListener('change', e => updateSkipLogic('action', e.target.value));
            
            const skipSrc = document.getElementById('skipSourceField');
            if (skipSrc) skipSrc.addEventListener('change', e => updateSkipLogic('sourceField', e.target.value));
            
            const skipCond = document.getElementById('skipCondition');
            if (skipCond) skipCond.addEventListener('change', e => updateSkipLogic('condition', e.target.value));
            
            const skipVal = document.getElementById('skipValue');
            if (skipVal) skipVal.addEventListener('change', e => updateSkipLogic('sourceValue', e.target.value));
            
            // Validation event listeners
            const validEn = document.getElementById('validEnabled');
            if (validEn) {
                validEn.addEventListener('change', e => {
                    updateValidation('enabled', e.target.checked);
                    document.getElementById('validOptions').style.display = e.target.checked ? 'block' : 'none';
                });
            }
            
            const validType = document.getElementById('validType');
            if (validType) {
                validType.addEventListener('change', e => {
                    updateValidation('type', e.target.value);
                    const minmax = document.getElementById('validMinMax');
                    const length = document.getElementById('validLength');
                    const custom = document.getElementById('validCustom');
                    if (minmax) minmax.style.display = e.target.value === 'minmax' ? 'flex' : 'none';
                    if (length) length.style.display = ['minlength', 'maxlength'].includes(e.target.value) ? 'block' : 'none';
                    if (custom) custom.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
            }
            
            const validMin = document.getElementById('validMin');
            if (validMin) validMin.addEventListener('change', e => updateValidation('min', e.target.value));
            
            const validMax = document.getElementById('validMax');
            if (validMax) validMax.addEventListener('change', e => updateValidation('max', e.target.value));
            
            const validLengthVal = document.getElementById('validLengthVal');
            if (validLengthVal) {
                validLengthVal.addEventListener('change', e => {
                    const field = state.fields.find(f => f.id === state.selectedFieldId);
                    if (field && field.validation) {
                        if (field.validation.type === 'minlength') {
                            updateValidation('minLength', e.target.value);
                        } else {
                            updateValidation('maxLength', e.target.value);
                        }
                    }
                });
            }
            
            const validPattern = document.getElementById('validPattern');
            if (validPattern) validPattern.addEventListener('change', e => updateValidation('customRegex', e.target.value));
            
            const validError = document.getElementById('validError');
            if (validError) validError.addEventListener('change', e => updateValidation('errorMessage', e.target.value));
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                field[prop] = value;
                renderFields();
                saveToStorage();
            }
        }

        function updateSkipLogic(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (!field.skipLogic) field.skipLogic = { enabled: false, action: 'show', sourceField: '', condition: 'equals', sourceValue: '' };
                field.skipLogic[prop] = value;
                renderFields();
                saveToStorage();
            }
        }
        
        function updateValidation(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (!field.validation) field.validation = { enabled: false, type: 'none', min: '', max: '', minLength: '', maxLength: '', pattern: '', customRegex: '', errorMessage: '' };
                field.validation[prop] = value;
                saveToStorage();
            }
        }

        // ========================================
        // FILE UPLOAD
        // ========================================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    const lines = [];
                    const rd = new Set(), dc = new Set(), cf = new Map();
                    
                    json.forEach(row => {
                        const reg = row.Region || row.region || '';
                        const dis = row.District || row.district || '';
                        const chi = row.Chiefdom || row.chiefdom || '';
                        const fac = row.Facility || row.facility || row.PHU || '';
                        const uid = row.UID || row.uid || '';
                        
                        if (reg && dis) rd.add(reg + '||' + dis);
                        if (dis && chi) dc.add(dis + '||' + chi);
                        if (chi && fac) cf.set(uid ? chi + '||' + fac + '||' + uid : chi + '||' + fac, true);
                    });
                    
                    rd.forEach(l => lines.push(l));
                    dc.forEach(l => lines.push(l));
                    cf.forEach((_, k) => lines.push(k));
                    
                    document.getElementById('cascadingData').value = lines.join('\n');
                    state.settings.cascadingData = lines.join('\n');
                    
                    document.getElementById('fileUploadArea').classList.add('has-file');
                    document.getElementById('fileUploadText').textContent = '‚úÖ Loaded ' + json.length + ' rows from ' + file.name;
                    
                    notify('Loaded ' + json.length + ' facilities!');
                } catch (err) {
                    notify('Error: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadSampleFile() {
            const data = [
                { Region: 'Eastern Region', District: 'Kailahun District', Chiefdom: 'Luawa Chiefdom', Facility: 'Kailahun Hospital', UID: 'abc123' },
                { Region: 'Southern Region', District: 'Bo District', Chiefdom: 'Badjia Chiefdom', Facility: 'Ngelehun CHC', UID: 'xxAfuLUYASs' }
            ];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Locations');
            XLSX.writeFile(wb, 'cascading-template.xlsx');
            notify('Template downloaded!');
        }

        // ========================================
        // SETTINGS
        // ========================================
        function openSettings() {
            document.getElementById('settingsTitle').value = state.settings.title;
            document.getElementById('settingsSubtitle').value = state.settings.subtitle;
            document.getElementById('settingsOrg').value = state.settings.organization;
            document.getElementById('enableLogin').checked = state.settings.enableLogin;
            document.getElementById('cascadingData').value = state.settings.cascadingData;
            document.getElementById('settingsScriptUrl').value = state.settings.scriptUrl || '';
            document.getElementById('settingsModal').classList.add('show');
        }
        
        function getFormUrl() {
            const formData = {
                s: {
                    t: state.settings.title,
                    st: state.settings.subtitle,
                    o: state.settings.organization,
                    l: state.settings.logo,
                    el: state.settings.enableLogin ? 1 : 0,
                    u: state.settings.username,
                    p: state.settings.password,
                    su: state.settings.scriptUrl
                },
                f: state.fields.map(f => ({
                    t: f.type,
                    n: f.name,
                    l: f.label,
                    r: f.required ? 1 : 0,
                    o: f.options?.length ? f.options : undefined,
                    v: f.validation?.enabled ? f.validation : undefined
                }))
            };
            const json = JSON.stringify(formData);
            const encoded = btoa(unescape(encodeURIComponent(json)));
            return `${BASE_URL}/?d=${encoded}`;
        }

        function saveSettings() {
            state.settings.title = document.getElementById('settingsTitle').value;
            state.settings.subtitle = document.getElementById('settingsSubtitle').value;
            state.settings.organization = document.getElementById('settingsOrg').value;
            state.settings.enableLogin = document.getElementById('enableLogin').checked;
            state.settings.cascadingData = document.getElementById('cascadingData').value;
            state.settings.scriptUrl = document.getElementById('settingsScriptUrl').value;
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            document.getElementById('previewSubtitle').textContent = state.settings.subtitle;
            
            saveToStorage();
            closeModal('settingsModal');
            notify('Settings saved!');
        }

        // ========================================
        // GENERATE FORM
        // ========================================
        function generateForm() {
            if (state.fields.length === 0) {
                notify('Add some fields first!', 'error');
                return;
            }
            
            const htmlCode = generateHTMLCode();
            const scriptCode = generateAppsScriptCode();
            
            document.getElementById('htmlCode').textContent = htmlCode;
            document.getElementById('scriptCode').textContent = scriptCode;
            
            // Show form URL
            const formUrl = getFormUrl();
            document.getElementById('sheetCreatedMsg').style.display = 'block';
            document.getElementById('sheetCreatedMsg').innerHTML = `
                <strong>üåê Share URL:</strong><br>
                <a href="${formUrl}" target="_blank" style="color:#004080;word-break:break-all;font-size:11px;">${formUrl.length > 100 ? formUrl.substring(0, 100) + '...' : formUrl}</a>
                <br><small style="color:#666;">URL contains form data - just share it!</small>
            `;
            
            document.getElementById('generateModal').classList.add('show');
        }

        function generateHTMLCode() {
            const fields = state.fields;
            const s = state.settings;
            
            let fieldsHTML = fields.map(f => generateFieldHTMLCode(f)).join('\n');
            let skipLogicJS = generateSkipLogicJS();
            let loginHTML = s.enableLogin ? generateLoginHTML() : '';
            let mainClass = s.enableLogin ? 'main-content' : 'main-content show';
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${s.title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"><\/script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Oswald',sans-serif;background:#fff;padding:20px;font-weight:700}
        .container{max-width:650px;margin:0 auto}
        .header{background:#004080;color:#fff;padding:20px;text-align:center;border-radius:12px 12px 0 0}
        .header img{width:70px;border-radius:8px;margin-bottom:8px}
        .header h1{font-size:17px;margin-bottom:3px}
        .header p{font-size:10px;opacity:0.9}
        .form-card{border:4px double #004080;border-radius:12px}
        .form-body{padding:20px}
        .form-group{margin-bottom:16px}
        .form-group.hidden{display:none}
        .form-label{display:block;font-size:11px;margin-bottom:5px;text-transform:uppercase}
        .required{color:red}
        .form-input,.form-select,.form-textarea{width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px;background:#f8f9fa}
        .radio-group,.checkbox-group{display:flex;flex-wrap:wrap;gap:10px}
        .radio-option,.checkbox-option{display:flex;align-items:center;gap:5px;padding:8px 12px;border:2px solid #ddd;border-radius:6px;cursor:pointer;font-size:11px}
        .radio-option:hover,.checkbox-option:hover{border-color:#004080}
        .quality-btns{display:flex;gap:8px;flex-wrap:wrap}
        .quality-btn{padding:8px 14px;border:2px solid #004080;border-radius:6px;background:#fff;cursor:pointer;font-family:'Oswald',sans-serif;font-weight:700;font-size:11px}
        .quality-btn.selected{background:#004080;color:#fff}
        .signature-container{border:2px solid #004080;border-radius:6px;overflow:hidden}
        .signature-canvas{width:100%;height:100px;background:#fff}
        .signature-controls{padding:6px;background:#f8f9fa;text-align:right}
        .signature-btn{padding:5px 10px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:10px}
        .gps-btn{padding:10px 14px;background:#004080;color:#fff;border:none;border-radius:6px;cursor:pointer;font-family:'Oswald',sans-serif;font-weight:700;font-size:11px}
        .section-header{background:#004080;color:#fff;padding:10px 14px;margin:18px -20px;font-size:13px}
        .btn-submit{width:100%;padding:12px;background:#28a745;color:#fff;border:none;border-radius:6px;font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;cursor:pointer;text-transform:uppercase}
        .footer{text-align:center;padding:12px;font-size:10px;color:#666;margin-top:12px}
        .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh}
        .login-box{max-width:360px;width:100%}
        .login-body{border:4px double #004080;border-radius:12px;padding:22px;background:#fff;margin-top:10px}
        .login-btn{width:100%;padding:10px;background:#004080;color:#fff;border:none;border-radius:6px;font-family:'Oswald',sans-serif;font-weight:700;cursor:pointer;text-transform:uppercase;margin-top:10px}
        .login-error{background:#ffebee;color:#dc3545;padding:8px;border-radius:6px;margin-bottom:10px;display:none;text-align:center;font-size:11px}
        .login-error.show{display:block}
        .main-content{display:none}
        .main-content.show{display:block}
        .notification{position:fixed;top:20px;right:20px;padding:10px 18px;border-radius:6px;color:#fff;font-weight:700;display:none;z-index:1000;font-size:12px}
        .notification.show{display:block}
        .notification.success{background:#28a745}
        .notification.error{background:#dc3545}
    </style>
</head>
<body>
${loginHTML}
    <div class="${mainClass}" id="mainContent">
        <div class="container">
            <div class="form-card">
                <div class="header">
                    <img src="${s.logo}" alt="Logo">
                    <h1>${s.title}</h1>
                    <p>${s.subtitle}</p>
                </div>
                <div class="form-body">
                    <form id="dataForm">
${fieldsHTML}
                        <button type="submit" class="btn-submit">SUBMIT</button>
                    </form>
                </div>
            </div>
            <div class="footer">¬© 2025 ${s.organization}</div>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    <script>
        const CONFIG = {
            SCRIPT_URL: '${s.scriptUrl || 'YOUR_SCRIPT_URL'}',
            USERNAME: '${s.username}',
            PASSWORD: '${s.password}'
        };
        const CASCADING_DATA = \`${s.cascadingData}\`;
        const signaturePads = {};

        document.addEventListener('DOMContentLoaded', () => {
            ${s.enableLogin ? "document.getElementById('loginForm').addEventListener('submit', handleLogin);" : "document.getElementById('mainContent').classList.add('show');"}
            document.getElementById('dataForm').addEventListener('submit', handleSubmit);
            setupCascading();
            setupSignatures();
            setupQualityButtons();
            setupSkipLogic();
        });

        ${s.enableLogin ? `function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === CONFIG.USERNAME && p === CONFIG.PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContent').classList.add('show');
            } else {
                document.getElementById('loginError').classList.add('show');
            }
        }` : ''}

        function handleSubmit(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = { timestamp: new Date().toISOString() };
            fd.forEach((v, k) => { data[k] = v; });
            Object.keys(signaturePads).forEach(k => {
                if (!signaturePads[k].isEmpty()) data[k] = signaturePads[k].toDataURL();
            });
            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                showNotification('Submitted!', 'success');
                e.target.reset();
            }).catch(() => showNotification('Error', 'error'));
        }

        function parseCascading() {
            const m = { r: {}, d: {}, c: {}, u: {} };
            CASCADING_DATA.trim().split('\\n').forEach(l => {
                const p = l.split('||').map(s => s.trim());
                if (p.length === 2) {
                    if (p[0].includes('Region') || p[0] === 'Western Area') {
                        if (!m.r[p[0]]) m.r[p[0]] = [];
                        m.r[p[0]].push(p[1]);
                    } else if (p[0].includes('District')) {
                        if (!m.d[p[0]]) m.d[p[0]] = [];
                        m.d[p[0]].push(p[1]);
                    } else {
                        if (!m.c[p[0]]) m.c[p[0]] = [];
                        m.c[p[0]].push(p[1]);
                    }
                } else if (p.length === 3) {
                    if (!m.c[p[0]]) m.c[p[0]] = [];
                    m.c[p[0]].push(p[1]);
                    m.u[p[1]] = p[2];
                }
            });
            return m;
        }

        function setupCascading() {
            const m = parseCascading();
            document.querySelectorAll('.cascading-region').forEach(s => {
                Object.keys(m.r).sort().forEach(r => s.innerHTML += '<option value="' + r + '">' + r + '</option>');
                s.addEventListener('change', function() {
                    const d = this.closest('.cascading-group').querySelector('.cascading-district');
                    d.innerHTML = '<option value="">-- District --</option>';
                    if (this.value && m.r[this.value]) m.r[this.value].forEach(x => d.innerHTML += '<option value="' + x + '">' + x + '</option>');
                    d.dispatchEvent(new Event('change'));
                });
            });
            document.querySelectorAll('.cascading-district').forEach(s => {
                s.addEventListener('change', function() {
                    const c = this.closest('.cascading-group').querySelector('.cascading-chiefdom');
                    if (c) {
                        c.innerHTML = '<option value="">-- Chiefdom --</option>';
                        if (this.value && m.d[this.value]) m.d[this.value].forEach(x => c.innerHTML += '<option value="' + x + '">' + x + '</option>');
                        c.dispatchEvent(new Event('change'));
                    }
                });
            });
            document.querySelectorAll('.cascading-chiefdom').forEach(s => {
                s.addEventListener('change', function() {
                    const f = this.closest('.cascading-group').querySelector('.cascading-facility');
                    if (f) {
                        f.innerHTML = '<option value="">-- Facility --</option>';
                        if (this.value && m.c[this.value]) m.c[this.value].forEach(x => f.innerHTML += '<option value="' + x + '">' + x + '</option>');
                    }
                });
            });
            document.querySelectorAll('.cascading-facility').forEach(s => {
                s.addEventListener('change', function() {
                    const u = this.closest('.cascading-group').querySelector('.facility-uid');
                    if (u && this.value && m.u[this.value]) u.value = m.u[this.value];
                });
            });
        }

        function setupSignatures() {
            document.querySelectorAll('.signature-canvas').forEach(c => {
                signaturePads[c.dataset.field] = new SignaturePad(c);
            });
        }

        function setupQualityButtons() {
            document.querySelectorAll('.quality-btn').forEach(b => {
                b.addEventListener('click', function() {
                    this.closest('.quality-btns').querySelectorAll('.quality-btn').forEach(x => x.classList.remove('selected'));
                    this.classList.add('selected');
                    this.closest('.quality-btns').querySelector('input[type="hidden"]').value = this.dataset.value;
                });
            });
        }

        function clearSignature(f) { if (signaturePads[f]) signaturePads[f].clear(); }

        function captureGPS(btn) {
            const c = btn.closest('.gps-container');
            const s = c.querySelector('.gps-status');
            s.textContent = 'Capturing...';
            navigator.geolocation.getCurrentPosition(
                p => {
                    c.querySelector('.gps-lat').value = p.coords.latitude;
                    c.querySelector('.gps-lng').value = p.coords.longitude;
                    s.textContent = '‚úÖ ' + p.coords.latitude.toFixed(5) + ', ' + p.coords.longitude.toFixed(5);
                },
                err => { s.textContent = '‚ùå ' + err.message; },
                { enableHighAccuracy: true, timeout: 60000 }
            );
        }

        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = 'notification show ' + type;
            setTimeout(() => n.classList.remove('show'), 3000);
        }

${skipLogicJS}
    <\/script>
</body>
</html>`;
        }

        function generateLoginHTML() {
            const s = state.settings;
            return `    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="header">
                <img src="${s.logo}" alt="Logo">
                <h1>${s.organization}</h1>
            </div>
            <div class="login-body">
                <h2 style="text-align:center;margin-bottom:12px;font-size:15px;">${s.title}</h2>
                <div class="login-error" id="loginError">Invalid credentials</div>
                <form id="loginForm">
                    <div class="form-group"><label class="form-label">USERNAME</label><input type="text" class="form-input" id="username" required></div>
                    <div class="form-group"><label class="form-label">PASSWORD</label><input type="password" class="form-input" id="password" required></div>
                    <button type="submit" class="login-btn">LOGIN</button>
                </form>
            </div>
        </div>
    </div>
`;
        }

        function generateFieldHTMLCode(field) {
            if (field.type === 'section') {
                return `                        <div class="section-header">${field.label.toUpperCase()}</div>`;
            }
            
            const req = field.required ? '<span class="required">*</span>' : '';
            const reqAttr = field.required ? 'required' : '';
            const hiddenClass = field.skipLogic?.enabled ? ' hidden' : '';
            
            let inner = '';
            switch (field.type) {
                case 'text':
                case 'number':
                case 'date':
                    inner = `<input type="${field.type}" class="form-input" name="${field.name}" ${reqAttr}>`;
                    break;
                case 'textarea':
                    inner = `<textarea class="form-textarea" name="${field.name}" rows="3" ${reqAttr}></textarea>`;
                    break;
                case 'select':
                    inner = `<select class="form-select" name="${field.name}" ${reqAttr}><option value="">-- Select --</option>${field.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
                    break;
                case 'radio':
                    inner = `<div class="radio-group">${field.options.map(o => `<label class="radio-option"><input type="radio" name="${field.name}" value="${o}" ${reqAttr}><span>${o}</span></label>`).join('')}</div>`;
                    break;
                case 'yesno':
                    inner = `<div class="radio-group"><label class="radio-option"><input type="radio" name="${field.name}" value="Yes" ${reqAttr}><span>Yes</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="No" ${reqAttr}><span>No</span></label></div>`;
                    break;
                case 'yesnona':
                    inner = `<div class="radio-group"><label class="radio-option"><input type="radio" name="${field.name}" value="Yes" ${reqAttr}><span>Yes</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="No" ${reqAttr}><span>No</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="N/A" ${reqAttr}><span>N/A</span></label></div>`;
                    break;
                case 'checkbox':
                    inner = `<div class="checkbox-group">${field.options.map(o => `<label class="checkbox-option"><input type="checkbox" name="${field.name}" value="${o}"><span>${o}</span></label>`).join('')}</div>`;
                    break;
                case 'cascading':
                    inner = `<div class="cascading-group">${field.levels.map((l, i) => `<select class="form-select cascading-${i === 0 ? 'region' : i === 1 ? 'district' : i === 2 ? 'chiefdom' : 'facility'}" name="${field.name}_${l.toLowerCase()}" ${reqAttr} style="margin-bottom:6px;"><option value="">-- ${l} --</option></select>`).join('')}<input type="hidden" class="facility-uid" name="${field.name}_uid"></div>`;
                    break;
                case 'signature':
                    inner = `<div class="signature-container"><canvas class="signature-canvas" data-field="${field.name}"></canvas><div class="signature-controls"><button type="button" class="signature-btn" onclick="clearSignature('${field.name}')">Clear</button></div></div>`;
                    break;
                case 'gps':
                    inner = `<div class="gps-container"><input type="hidden" class="gps-lat" name="${field.name}_lat"><input type="hidden" class="gps-lng" name="${field.name}_lng"><button type="button" class="gps-btn" onclick="captureGPS(this)">üìç Capture GPS</button><div class="gps-status" style="margin-top:6px;font-size:10px;"></div></div>`;
                    break;
                case 'quality':
                    inner = `<div class="quality-btns">${field.options.map(o => `<button type="button" class="quality-btn" data-value="${o}">${o}</button>`).join('')}<input type="hidden" name="${field.name}"></div>`;
                    break;
            }
            
            return `                        <div class="form-group${hiddenClass}" id="group_${field.id}">
                            <label class="form-label">${field.label} ${req}</label>
                            ${inner}
                        </div>`;
        }

        function generateSkipLogicJS() {
            const fieldsWithSkip = state.fields.filter(f => f.skipLogic?.enabled && f.skipLogic?.sourceField);
            if (fieldsWithSkip.length === 0) return '        function setupSkipLogic() {}';
            
            let js = '        function setupSkipLogic() {\n';
            fieldsWithSkip.forEach(f => {
                const src = state.fields.find(x => x.id === f.skipLogic.sourceField);
                if (!src) return;
                js += `            document.querySelectorAll('[name="${src.name}"]').forEach(el => {
                el.addEventListener('change', function() {
                    const container = document.getElementById('group_${f.id}');
                    const val = this.type === 'radio' ? document.querySelector('[name="${src.name}"]:checked')?.value : this.value;
                    const cond = ${f.skipLogic.condition === 'equals' ? `val === '${f.skipLogic.sourceValue}'` : `val !== '${f.skipLogic.sourceValue}'`};
                    container.classList.toggle('hidden', ${f.skipLogic.action === 'show' ? '!cond' : 'cond'});
                });
            });\n`;
            });
            js += '        }';
            return js;
        }

        function generateAppsScriptCode() {
            const fields = state.fields.filter(f => f.type !== 'section');
            const headers = ['Timestamp', ...fields.map(f => f.label)];
            const s = state.settings;
            
            return `// ============================================
// AUTO-GENERATED APPS SCRIPT
// Form: ${s.title}
// Generated: ${new Date().toLocaleString()}
// ============================================
// 
// SETUP INSTRUCTIONS:
// 1. Create a new Google Sheet
// 2. Go to Extensions > Apps Script
// 3. Paste this entire code
// 4. Click Deploy > New deployment
// 5. Select "Web app", set "Anyone" access
// 6. Copy the URL and paste in Form Builder settings
//
// Each form creates its own tab/sheet automatically!
// ============================================

function doPost(e) {
    try {
        const data = JSON.parse(e.postData.contents);
        
        // Get form title from submission (each form has its own sheet)
        const formTitle = data._formTitle || '${s.title}';
        const sheetName = formTitle.substring(0, 100); // Sheet names max 100 chars
        
        const sheet = getOrCreateSheet(sheetName, ${JSON.stringify(headers)});
        
        // Build row data
        const row = [
            new Date().toISOString(),
${fields.map(f => `            data['${f.name}'] || ''`).join(',\n')}
        ];
        
        sheet.appendRow(row);
        
        return ContentService.createTextOutput(JSON.stringify({ 
            success: true, 
            sheet: sheetName,
            row: sheet.getLastRow() 
        })).setMimeType(ContentService.MimeType.JSON);
        
    } catch (err) {
        Logger.log('Error: ' + err.toString());
        return ContentService.createTextOutput(JSON.stringify({ 
            success: false, 
            error: err.toString() 
        })).setMimeType(ContentService.MimeType.JSON);
    }
}

function doGet(e) {
    const action = e.parameter.action;
    const formTitle = e.parameter.form || '${s.title}';
    
    if (action === 'getData') {
        const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(formTitle);
        if (!sheet) {
            return ContentService.createTextOutput(JSON.stringify({ 
                error: 'Form not found: ' + formTitle 
            })).setMimeType(ContentService.MimeType.JSON);
        }
        
        const data = sheet.getDataRange().getValues();
        const headers = data[0];
        const result = data.slice(1).map(row => {
            const obj = {};
            headers.forEach((h, i) => obj[h] = row[i]);
            return obj;
        });
        
        return ContentService.createTextOutput(JSON.stringify({ 
            form: formTitle,
            count: result.length,
            data: result 
        })).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'listForms') {
        const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
        const forms = sheets.map(s => ({
            name: s.getName(),
            rows: s.getLastRow() - 1
        }));
        return ContentService.createTextOutput(JSON.stringify({ forms }))
            .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ 
        status: 'OK',
        message: 'Form Data Collection API',
        endpoints: {
            'GET ?action=listForms': 'List all form sheets',
            'GET ?action=getData&form=FormName': 'Get submissions for a form',
            'POST': 'Submit form data'
        }
    })).setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateSheet(sheetName, headers) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
        // Create new sheet for this form
        sheet = ss.insertSheet(sheetName);
        sheet.appendRow(headers);
        
        // Style header row
        const headerRange = sheet.getRange(1, 1, 1, headers.length);
        headerRange.setFontWeight('bold')
            .setBackground('#004080')
            .setFontColor('#ffffff')
            .setHorizontalAlignment('center');
        
        // Freeze header row
        sheet.setFrozenRows(1);
        
        // Auto-resize columns
        for (let i = 1; i <= headers.length; i++) {
            sheet.autoResizeColumn(i);
        }
        
        Logger.log('Created new sheet: ' + sheetName);
    }
    
    return sheet;
}

function onOpen() {
    SpreadsheetApp.getUi()
        .createMenu('üìã Form Manager')
        .addItem('üìä View All Stats', 'viewAllStats')
        .addItem('üìà Export Summary', 'exportSummary')
        .addSeparator()
        .addItem('üóëÔ∏è Clear Current Sheet', 'clearCurrentSheet')
        .addToUi();
}

function viewAllStats() {
    const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
    let msg = 'Form Submissions Summary:\\n\\n';
    
    sheets.forEach(sheet => {
        const rows = sheet.getLastRow() - 1;
        if (rows >= 0) {
            msg += 'üìã ' + sheet.getName() + ': ' + rows + ' submissions\\n';
        }
    });
    
    SpreadsheetApp.getUi().alert(msg);
}

function exportSummary() {
    const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
    const summary = sheets.map(s => [s.getName(), s.getLastRow() - 1, new Date()]);
    
    let summarySheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('_Summary');
    if (!summarySheet) {
        summarySheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet('_Summary');
        summarySheet.appendRow(['Form Name', 'Submissions', 'Last Updated']);
    } else {
        summarySheet.clear();
        summarySheet.appendRow(['Form Name', 'Submissions', 'Last Updated']);
    }
    
    summary.forEach(row => summarySheet.appendRow(row));
    SpreadsheetApp.getUi().alert('Summary exported to _Summary sheet');
}

function clearCurrentSheet() {
    const ui = SpreadsheetApp.getUi();
    const sheet = SpreadsheetApp.getActiveSheet();
    
    if (ui.alert('Clear all data from "' + sheet.getName() + '"?', ui.ButtonSet.YES_NO) === ui.Button.YES) {
        if (sheet.getLastRow() > 1) {
            sheet.deleteRows(2, sheet.getLastRow() - 1);
        }
        ui.alert('Data cleared!');
    }
}`;
        }

        function downloadHTML() {
            const code = document.getElementById('htmlCode').textContent;
            const blob = new Blob([code], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const filename = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.html';
            a.download = filename;
            a.click();
            notify(`Downloaded "${filename}"`);
        }

        function downloadScript() {
            const code = document.getElementById('scriptCode').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'apps-script.gs';
            a.click();
            notify('Script downloaded!');
        }

        function copyCode(id) {
            const code = document.getElementById(id).textContent;
            navigator.clipboard.writeText(code);
            notify('Copied to clipboard!');
        }

        // ========================================
        // PREVIEW
        // ========================================
        function previewForm() {
            if (state.fields.length === 0) {
                notify('Add some fields first!', 'error');
                return;
            }
            
            const html = generateHTMLCode();
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '<iframe style="width:100%;height:400px;border:none;"></iframe>';
            const iframe = previewBody.querySelector('iframe');
            const doc = iframe.contentDocument;
            doc.open();
            doc.write(html);
            doc.close();
            
            document.getElementById('previewModal').classList.add('show');
        }

        // ========================================
        // MODAL HELPERS
        // ========================================
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ========================================
        // STORAGE
        // ========================================
        function saveToStorage() {
            localStorage.setItem('formBuilderState', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderState');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        // ========================================
        // NOTIFICATIONS
        // ========================================
        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : '');
            setTimeout(() => el.classList.remove('show'), 2500);
        }

        // ========================================
        // SHARE & QR CODE
        // ========================================
        function shareForm() {
            if (state.fields.length === 0) {
                notify('Add some fields first!', 'error');
                return;
            }
            
            const formUrl = getFormUrl();
            generateQRCodeFromUrl(formUrl);
            
            // Show truncated URL for display
            const displayUrl = formUrl.length > 60 ? formUrl.substring(0, 60) + '...' : formUrl;
            document.getElementById('qrUrlDisplay').textContent = displayUrl;
            document.getElementById('qrUrlDisplay').title = formUrl; // Full URL on hover
            
            document.getElementById('shareModal').classList.add('show');
        }
        
        function copyFormUrl() {
            const formUrl = getFormUrl();
            navigator.clipboard.writeText(formUrl).then(() => {
                notify('URL copied to clipboard!');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = formUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                notify('URL copied!');
            });
        }

        function generateQRCodeFromUrl(url) {
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}&color=004080" alt="QR Code" style="width: 200px; height: 200px;">`;
        }

        function downloadQRCode() {
            const container = document.getElementById('qrcodeContainer');
            const img = container.querySelector('img') || container.querySelector('canvas');
            
            if (!img) {
                notify('Generate QR code first', 'error');
                return;
            }

            let dataUrl;
            if (img.tagName === 'CANVAS') {
                dataUrl = img.toDataURL('image/png');
            } else {
                // For img element, we need to draw it to canvas first
                const canvas = document.createElement('canvas');
                canvas.width = 250;
                canvas.height = 250;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 250, 250);
                
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.onload = function() {
                    ctx.drawImage(tempImg, 25, 25, 200, 200);
                    dataUrl = canvas.toDataURL('image/png');
                    downloadImage(dataUrl);
                };
                tempImg.src = img.src;
                return;
            }
            
            downloadImage(dataUrl);
        }

        function downloadImage(dataUrl) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '-qrcode.png';
            a.click();
            notify('QR Code downloaded!');
        }

        function printQRCode() {
            const container = document.getElementById('qrcodeContainer');
            const img = container.querySelector('img') || container.querySelector('canvas');
            
            if (!img) {
                notify('Generate QR code first', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            const imgSrc = img.tagName === 'CANVAS' ? img.toDataURL() : img.src;
            const formUrl = getFormUrl();
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code - ${state.settings.title}</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; text-align: center; padding: 40px; }
                        .qr-container { display: inline-block; padding: 20px; border: 3px solid #004080; border-radius: 12px; }
                        h1 { color: #004080; font-size: 24px; margin-bottom: 10px; }
                        p { color: #666; font-size: 14px; margin-bottom: 20px; }
                        .url { font-size: 12px; color: #004080; margin-top: 15px; word-break: break-all; font-weight: bold; }
                        img { width: 200px; height: 200px; }
                    </style>
                </head>
                <body>
                    <h1>${state.settings.title}</h1>
                    <p>${state.settings.subtitle}</p>
                    <div class="qr-container">
                        <img src="${imgSrc}" alt="QR Code">
                    </div>
                    <p class="url">${formUrl}</p>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Initialize
        init();
        
        // Check if viewing a form (data encoded in URL)
        (function checkFormView() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('d');
            if (encodedData) {
                try {
                    const json = decodeURIComponent(escape(atob(encodedData)));
                    const formData = JSON.parse(json);
                    renderFormForViewing(formData);
                } catch (err) {
                    console.error('Error loading form:', err);
                    document.body.innerHTML = `
                        <div style="text-align:center;padding:50px;font-family:Oswald,sans-serif;">
                            <h1 style="color:#dc3545;">Invalid Form Link</h1>
                            <p>This form link is invalid or corrupted.</p>
                            <a href="./" style="color:#004080;">Go to Form Builder</a>
                        </div>`;
                }
            }
        })();
        
        function renderFormForViewing(data) {
            const s = data.s;
            const fields = data.f;
            const formKey = 'form_' + s.t.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            
            // Build login screen if enabled
            let loginHTML = '';
            if (s.el) {
                loginHTML = `
                    <div id="loginScreen" style="max-width:400px;margin:50px auto;font-family:Oswald,sans-serif;">
                        <div style="border:4px double #004080;border-radius:12px;overflow:hidden;">
                            <div style="background:#004080;color:#fff;padding:20px;text-align:center;">
                                <img src="${s.l}" style="width:70px;border-radius:8px;margin-bottom:8px;">
                                <h1 style="font-size:17px;margin:0;">${s.t}</h1>
                            </div>
                            <div style="padding:20px;">
                                <div style="margin-bottom:12px;">
                                    <label style="display:block;font-size:11px;font-weight:700;margin-bottom:5px;">USERNAME</label>
                                    <input type="text" id="loginUser" style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:Oswald;">
                                </div>
                                <div style="margin-bottom:12px;">
                                    <label style="display:block;font-size:11px;font-weight:700;margin-bottom:5px;">PASSWORD</label>
                                    <input type="password" id="loginPass" style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:Oswald;">
                                </div>
                                <button onclick="doLogin('${s.u}','${s.p}')" style="width:100%;padding:12px;background:#004080;color:#fff;border:none;border-radius:6px;font-family:Oswald;font-weight:700;cursor:pointer;">LOGIN</button>
                                <p id="loginError" style="color:red;font-size:11px;margin-top:8px;display:none;">Invalid credentials</p>
                            </div>
                        </div>
                    </div>`;
            }
            
            let fieldsHTML = fields.map(f => {
                if (f.t === 'section') {
                    return `<div style="background:#004080;color:#fff;padding:10px 14px;margin:18px -20px;font-size:13px;font-weight:700;">${f.l.toUpperCase()}</div>`;
                }
                const req = f.r ? '<span style="color:red;">*</span>' : '';
                const reqAttr = f.r ? 'required' : '';
                let inner = '';
                switch (f.t) {
                    case 'text': case 'date':
                        inner = `<input type="${f.t}" name="${f.n}" ${reqAttr} style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:Oswald;">`;
                        break;
                    case 'number':
                        let numAttrs = reqAttr;
                        if (f.v && f.v.enabled && f.v.type === 'minmax') {
                            if (f.v.min) numAttrs += ` min="${f.v.min}"`;
                            if (f.v.max) numAttrs += ` max="${f.v.max}"`;
                        }
                        inner = `<input type="number" name="${f.n}" ${numAttrs} style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:Oswald;">`;
                        break;
                    case 'textarea':
                        inner = `<textarea name="${f.n}" rows="3" ${reqAttr} style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:Oswald;"></textarea>`;
                        break;
                    case 'select':
                        inner = `<select name="${f.n}" ${reqAttr} style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:Oswald;"><option value="">-- Select --</option>${(f.o||[]).map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
                        break;
                    case 'radio': case 'yesno': case 'yesnona':
                        const opts = f.t === 'yesno' ? ['Yes','No'] : f.t === 'yesnona' ? ['Yes','No','N/A'] : (f.o||[]);
                        inner = `<div style="display:flex;flex-wrap:wrap;gap:10px;">${opts.map(o=>`<label style="display:flex;align-items:center;gap:5px;padding:8px 12px;border:2px solid #ddd;border-radius:6px;cursor:pointer;"><input type="radio" name="${f.n}" value="${o}" ${reqAttr}><span>${o}</span></label>`).join('')}</div>`;
                        break;
                    case 'checkbox':
                        inner = `<div style="display:flex;flex-wrap:wrap;gap:10px;">${(f.o||[]).map(o=>`<label style="display:flex;align-items:center;gap:5px;padding:8px 12px;border:2px solid #ddd;border-radius:6px;cursor:pointer;"><input type="checkbox" name="${f.n}" value="${o}"><span>${o}</span></label>`).join('')}</div>`;
                        break;
                    case 'gps':
                        inner = `<div class="gps-container" data-name="${f.n}">
                            <input type="hidden" name="${f.n}_lat" class="gps-lat">
                            <input type="hidden" name="${f.n}_lng" class="gps-lng">
                            <button type="button" onclick="captureGPS(this)" style="padding:10px 14px;background:#004080;color:#fff;border:none;border-radius:6px;cursor:pointer;font-family:Oswald;font-weight:700;">üìç Capture GPS</button>
                            <div class="gps-status" style="margin-top:8px;font-size:11px;color:#666;"></div>
                        </div>`;
                        break;
                    case 'signature':
                        inner = `<div class="sig-container" data-name="${f.n}">
                            <canvas class="sig-canvas" width="300" height="150" style="border:2px solid #004080;border-radius:6px;touch-action:none;background:#fff;"></canvas>
                            <input type="hidden" name="${f.n}" class="sig-data">
                            <div style="margin-top:8px;">
                                <button type="button" onclick="clearSignature(this)" style="padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;font-size:11px;cursor:pointer;">Clear</button>
                            </div>
                        </div>`;
                        break;
                    case 'quality':
                        const qopts = f.o || ['Excellent', 'Acceptable', 'Needs Improvement'];
                        inner = `<div style="display:flex;flex-wrap:wrap;gap:10px;">${qopts.map(o=>`<label style="display:flex;align-items:center;gap:5px;padding:8px 12px;border:2px solid #ddd;border-radius:6px;cursor:pointer;"><input type="radio" name="${f.n}" value="${o}" ${reqAttr}><span>${o}</span></label>`).join('')}</div>`;
                        break;
                    default:
                        inner = `<input type="text" name="${f.n}" style="width:100%;padding:10px;border:2px solid #004080;border-radius:6px;">`;
                }
                return `<div style="margin-bottom:16px;"><label style="display:block;font-size:11px;font-weight:700;margin-bottom:5px;text-transform:uppercase;">${f.l} ${req}</label>${inner}</div>`;
            }).join('');
            
            const formHTML = `
                <style>
                    .nav-btn{padding:8px 12px;margin:3px;border:none;border-radius:6px;cursor:pointer;font-family:Oswald;font-size:11px;font-weight:700;}
                    .nav-btn:hover{opacity:0.9;}
                    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;overflow:auto;}
                    .modal-overlay.show{display:flex;align-items:flex-start;justify-content:center;padding:20px;}
                    .modal-box{background:#fff;border-radius:12px;max-width:95%;width:900px;margin:20px auto;max-height:90vh;overflow:auto;}
                    .modal-header{background:#004080;color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;}
                    .modal-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;}
                    .data-table{width:100%;border-collapse:collapse;font-size:11px;}
                    .data-table th,.data-table td{border:1px solid #ddd;padding:8px;text-align:left;}
                    .data-table th{background:#004080;color:#fff;}
                    .data-table tr:nth-child(even){background:#f9f9f9;}
                    .stat-card{background:#f8f9fa;border:2px solid #004080;border-radius:8px;padding:15px;text-align:center;margin:10px;}
                    .stat-value{font-size:28px;font-weight:700;color:#004080;}
                    .stat-label{font-size:11px;color:#666;margin-top:5px;}
                    .chart-bar{height:20px;background:#004080;border-radius:4px;margin:5px 0;}
                    .draft-item{background:#fff8e6;border:2px solid #ffc107;border-radius:8px;padding:12px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
                </style>
                
                <div id="formScreen" style="max-width:650px;margin:20px auto;font-family:Oswald,sans-serif;${s.el ? 'display:none;' : ''}">
                    <!-- Navigation Bar -->
                    <div style="background:#f8f9fa;border-radius:8px;padding:10px;margin-bottom:15px;text-align:center;">
                        <button class="nav-btn" style="background:#004080;color:#fff;" onclick="showView('form')">üìù Form</button>
                        <button class="nav-btn" style="background:#28a745;color:#fff;" onclick="showView('data')">üìä View Data</button>
                        <button class="nav-btn" style="background:#17a2b8;color:#fff;" onclick="showView('dashboard')">üìà Dashboard</button>
                        <button class="nav-btn" style="background:#6c757d;color:#fff;" onclick="showView('report')">üìÑ Report</button>
                        <button class="nav-btn" style="background:#ffc107;color:#000;" onclick="showView('drafts')">üíæ Drafts</button>
                    </div>
                    
                    <!-- Form View -->
                    <div id="formView" style="border:4px double #004080;border-radius:12px;overflow:hidden;">
                        <div style="background:#004080;color:#fff;padding:20px;text-align:center;">
                            <img src="${s.l}" style="width:70px;border-radius:8px;margin-bottom:8px;">
                            <h1 style="font-size:17px;margin:0 0 3px 0;">${s.t}</h1>
                            <p style="font-size:10px;margin:0;opacity:0.9;">${s.st}</p>
                        </div>
                        <div style="padding:20px;">
                            <form id="dataForm">${fieldsHTML}
                                <div style="display:flex;gap:10px;margin-top:15px;">
                                    <button type="button" onclick="saveDraft()" style="flex:1;padding:12px;background:#ffc107;color:#000;border:none;border-radius:6px;font-family:Oswald;font-size:13px;font-weight:700;cursor:pointer;">üíæ SAVE DRAFT</button>
                                    <button type="submit" style="flex:2;padding:12px;background:#28a745;color:#fff;border:none;border-radius:6px;font-family:Oswald;font-size:14px;font-weight:700;cursor:pointer;">‚úÖ SUBMIT</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Data View -->
                    <div id="dataView" style="display:none;border:4px double #004080;border-radius:12px;overflow:hidden;">
                        <div style="background:#28a745;color:#fff;padding:15px 20px;">
                            <h2 style="margin:0;font-size:16px;">üìä Submitted Data</h2>
                        </div>
                        <div style="padding:15px;overflow-x:auto;" id="dataTableContainer">
                            <p style="text-align:center;color:#666;">Loading data...</p>
                        </div>
                    </div>
                    
                    <!-- Dashboard View -->
                    <div id="dashboardView" style="display:none;border:4px double #004080;border-radius:12px;overflow:hidden;">
                        <div style="background:#17a2b8;color:#fff;padding:15px 20px;">
                            <h2 style="margin:0;font-size:16px;">üìà Dashboard</h2>
                        </div>
                        <div style="padding:15px;" id="dashboardContainer">
                            <p style="text-align:center;color:#666;">Loading dashboard...</p>
                        </div>
                    </div>
                    
                    <!-- Report View -->
                    <div id="reportView" style="display:none;border:4px double #004080;border-radius:12px;overflow:hidden;">
                        <div style="background:#6c757d;color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;">
                            <h2 style="margin:0;font-size:16px;">üìÑ Report</h2>
                            <button onclick="printReport()" style="padding:8px 15px;background:#fff;color:#6c757d;border:none;border-radius:6px;cursor:pointer;font-family:Oswald;font-weight:700;">üñ®Ô∏è Print</button>
                        </div>
                        <div style="padding:15px;" id="reportContainer">
                            <p style="text-align:center;color:#666;">Loading report...</p>
                        </div>
                    </div>
                    
                    <!-- Drafts View -->
                    <div id="draftsView" style="display:none;border:4px double #004080;border-radius:12px;overflow:hidden;">
                        <div style="background:#ffc107;color:#000;padding:15px 20px;">
                            <h2 style="margin:0;font-size:16px;">üíæ Saved Drafts</h2>
                        </div>
                        <div style="padding:15px;" id="draftsContainer">
                            <p style="text-align:center;color:#666;">No drafts saved</p>
                        </div>
                    </div>
                    
                    <div style="text-align:center;padding:12px;font-size:10px;color:#666;">¬© 2025 ${s.o}</div>
                </div>`;
            
            document.body.innerHTML = loginHTML + formHTML;
            
            // Store form config globally
            window.formConfig = { s, fields, formKey };
            
            // View switching
            window.showView = function(view) {
                ['formView', 'dataView', 'dashboardView', 'reportView', 'draftsView'].forEach(v => {
                    document.getElementById(v).style.display = 'none';
                });
                document.getElementById(view + 'View').style.display = 'block';
                
                if (view === 'data') loadDataView();
                if (view === 'dashboard') loadDashboard();
                if (view === 'report') loadReport();
                if (view === 'drafts') loadDrafts();
            };
            
            // Load Data View
            window.loadDataView = function() {
                const container = document.getElementById('dataTableContainer');
                if (!s.su || s.su === 'YOUR_SCRIPT_URL') {
                    container.innerHTML = '<p style="text-align:center;color:#dc3545;">‚ö†Ô∏è Configure Apps Script URL to view data</p>';
                    return;
                }
                
                container.innerHTML = '<p style="text-align:center;">‚è≥ Loading...</p>';
                
                fetch(s.su + '?action=getData&form=' + encodeURIComponent(s.t))
                    .then(r => r.json())
                    .then(result => {
                        if (!result.data || result.data.length === 0) {
                            container.innerHTML = '<p style="text-align:center;color:#666;">No submissions yet</p>';
                            return;
                        }
                        
                        const headers = Object.keys(result.data[0]);
                        let html = '<table class="data-table"><thead><tr>';
                        headers.forEach(h => html += '<th>' + h + '</th>');
                        html += '</tr></thead><tbody>';
                        
                        result.data.forEach(row => {
                            html += '<tr>';
                            headers.forEach(h => html += '<td>' + (row[h] || '') + '</td>');
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                        html += '<p style="margin-top:10px;font-size:11px;color:#666;">Total: ' + result.data.length + ' submissions</p>';
                        container.innerHTML = html;
                    })
                    .catch(() => {
                        container.innerHTML = '<p style="text-align:center;color:#dc3545;">‚ùå Failed to load data</p>';
                    });
            };
            
            // Load Dashboard
            window.loadDashboard = function() {
                const container = document.getElementById('dashboardContainer');
                if (!s.su || s.su === 'YOUR_SCRIPT_URL') {
                    container.innerHTML = '<p style="text-align:center;color:#dc3545;">‚ö†Ô∏è Configure Apps Script URL</p>';
                    return;
                }
                
                container.innerHTML = '<p style="text-align:center;">‚è≥ Loading...</p>';
                
                fetch(s.su + '?action=getData&form=' + encodeURIComponent(s.t))
                    .then(r => r.json())
                    .then(result => {
                        if (!result.data || result.data.length === 0) {
                            container.innerHTML = '<p style="text-align:center;">No data for dashboard</p>';
                            return;
                        }
                        
                        const data = result.data;
                        let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">';
                        
                        // Total submissions
                        html += '<div class="stat-card"><div class="stat-value">' + data.length + '</div><div class="stat-label">Total Submissions</div></div>';
                        
                        // Today's submissions
                        const today = new Date().toDateString();
                        const todayCount = data.filter(r => new Date(r.Timestamp).toDateString() === today).length;
                        html += '<div class="stat-card"><div class="stat-value">' + todayCount + '</div><div class="stat-label">Today</div></div>';
                        
                        html += '</div>';
                        
                        // Charts for radio/select fields
                        fields.filter(f => ['radio', 'yesno', 'yesnona', 'select', 'quality'].includes(f.t)).forEach(field => {
                            const counts = {};
                            data.forEach(row => {
                                const val = row[field.l] || 'Empty';
                                counts[val] = (counts[val] || 0) + 1;
                            });
                            
                            html += '<div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;">';
                            html += '<h4 style="margin:0 0 10px 0;font-size:13px;">' + field.l + '</h4>';
                            
                            const max = Math.max(...Object.values(counts));
                            Object.entries(counts).forEach(([key, val]) => {
                                const pct = (val / max * 100).toFixed(0);
                                html += '<div style="margin:8px 0;"><div style="display:flex;justify-content:space-between;font-size:11px;"><span>' + key + '</span><span>' + val + '</span></div>';
                                html += '<div class="chart-bar" style="width:' + pct + '%;"></div></div>';
                            });
                            
                            html += '</div>';
                        });
                        
                        container.innerHTML = html;
                    })
                    .catch(() => {
                        container.innerHTML = '<p style="text-align:center;color:#dc3545;">‚ùå Failed to load dashboard</p>';
                    });
            };
            
            // Load Report
            window.loadReport = function() {
                const container = document.getElementById('reportContainer');
                if (!s.su || s.su === 'YOUR_SCRIPT_URL') {
                    container.innerHTML = '<p style="text-align:center;color:#dc3545;">‚ö†Ô∏è Configure Apps Script URL</p>';
                    return;
                }
                
                container.innerHTML = '<p style="text-align:center;">‚è≥ Loading...</p>';
                
                fetch(s.su + '?action=getData&form=' + encodeURIComponent(s.t))
                    .then(r => r.json())
                    .then(result => {
                        if (!result.data || result.data.length === 0) {
                            container.innerHTML = '<p style="text-align:center;">No data for report</p>';
                            return;
                        }
                        
                        const data = result.data;
                        const now = new Date().toLocaleString();
                        
                        let html = '<div id="printableReport">';
                        html += '<div style="text-align:center;margin-bottom:20px;">';
                        html += '<img src="' + s.l + '" style="width:60px;margin-bottom:10px;">';
                        html += '<h2 style="margin:0;color:#004080;">' + s.t + '</h2>';
                        html += '<p style="font-size:11px;color:#666;">Generated: ' + now + '</p>';
                        html += '</div>';
                        
                        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">';
                        html += '<div style="background:#e8f4fc;padding:12px;border-radius:8px;"><strong>Total Submissions:</strong> ' + data.length + '</div>';
                        
                        const today = new Date().toDateString();
                        const todayCount = data.filter(r => new Date(r.Timestamp).toDateString() === today).length;
                        html += '<div style="background:#e8f4fc;padding:12px;border-radius:8px;"><strong>Today:</strong> ' + todayCount + '</div>';
                        html += '</div>';
                        
                        // Summary for each field
                        html += '<h3 style="color:#004080;border-bottom:2px solid #004080;padding-bottom:5px;">Summary by Field</h3>';
                        
                        fields.filter(f => f.t !== 'section').forEach(field => {
                            html += '<div style="margin:15px 0;padding:12px;background:#f8f9fa;border-radius:8px;">';
                            html += '<h4 style="margin:0 0 8px 0;font-size:12px;color:#004080;">' + field.l + '</h4>';
                            
                            if (['radio', 'yesno', 'yesnona', 'select', 'quality'].includes(field.t)) {
                                const counts = {};
                                data.forEach(row => {
                                    const val = row[field.l] || 'Empty';
                                    counts[val] = (counts[val] || 0) + 1;
                                });
                                
                                html += '<table style="width:100%;font-size:11px;"><tbody>';
                                Object.entries(counts).forEach(([key, val]) => {
                                    const pct = (val / data.length * 100).toFixed(1);
                                    html += '<tr><td>' + key + '</td><td style="text-align:right;">' + val + ' (' + pct + '%)</td></tr>';
                                });
                                html += '</tbody></table>';
                            } else if (field.t === 'number') {
                                const nums = data.map(r => parseFloat(r[field.l])).filter(n => !isNaN(n));
                                if (nums.length > 0) {
                                    const avg = (nums.reduce((a, b) => a + b, 0) / nums.length).toFixed(2);
                                    const min = Math.min(...nums);
                                    const max = Math.max(...nums);
                                    html += '<p style="font-size:11px;margin:0;">Avg: ' + avg + ' | Min: ' + min + ' | Max: ' + max + '</p>';
                                }
                            } else {
                                const filled = data.filter(r => r[field.l]).length;
                                html += '<p style="font-size:11px;margin:0;">Responses: ' + filled + ' / ' + data.length + '</p>';
                            }
                            
                            html += '</div>';
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    })
                    .catch(() => {
                        container.innerHTML = '<p style="text-align:center;color:#dc3545;">‚ùå Failed to load report</p>';
                    });
            };
            
            // Print Report
            window.printReport = function() {
                const content = document.getElementById('printableReport');
                if (!content) return;
                
                const win = window.open('', '_blank');
                win.document.write('<html><head><title>Report - ' + s.t + '</title>');
                win.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}</style></head><body>');
                win.document.write(content.innerHTML);
                win.document.write('</body></html>');
                win.document.close();
                win.print();
            };
            
            // Save Draft
            window.saveDraft = function() {
                const form = document.getElementById('dataForm');
                const formData = new FormData(form);
                const draft = { timestamp: new Date().toISOString(), data: {} };
                formData.forEach((v, k) => draft.data[k] = v);
                
                const drafts = JSON.parse(localStorage.getItem(formKey + '_drafts') || '[]');
                drafts.unshift(draft);
                if (drafts.length > 10) drafts.pop(); // Keep max 10 drafts
                localStorage.setItem(formKey + '_drafts', JSON.stringify(drafts));
                
                alert('‚úÖ Draft saved!');
            };
            
            // Load Drafts
            window.loadDrafts = function() {
                const container = document.getElementById('draftsContainer');
                const drafts = JSON.parse(localStorage.getItem(formKey + '_drafts') || '[]');
                
                if (drafts.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;">No drafts saved</p>';
                    return;
                }
                
                let html = '';
                drafts.forEach((draft, i) => {
                    const date = new Date(draft.timestamp).toLocaleString();
                    html += '<div class="draft-item">';
                    html += '<div><strong>Draft ' + (i + 1) + '</strong><br><small>' + date + '</small></div>';
                    html += '<div>';
                    html += '<button onclick="loadDraft(' + i + ')" style="padding:6px 12px;background:#004080;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;">Load</button>';
                    html += '<button onclick="deleteDraft(' + i + ')" style="padding:6px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;">Delete</button>';
                    html += '</div></div>';
                });
                
                container.innerHTML = html;
            };
            
            // Load Draft into form
            window.loadDraft = function(index) {
                const drafts = JSON.parse(localStorage.getItem(formKey + '_drafts') || '[]');
                if (!drafts[index]) return;
                
                const draft = drafts[index];
                const form = document.getElementById('dataForm');
                
                Object.entries(draft.data).forEach(([name, value]) => {
                    const el = form.querySelector('[name="' + name + '"]');
                    if (el) {
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            const inputs = form.querySelectorAll('[name="' + name + '"]');
                            inputs.forEach(inp => inp.checked = inp.value === value);
                        } else {
                            el.value = value;
                        }
                    }
                });
                
                showView('form');
                alert('‚úÖ Draft loaded!');
            };
            
            // Delete Draft
            window.deleteDraft = function(index) {
                if (!confirm('Delete this draft?')) return;
                
                const drafts = JSON.parse(localStorage.getItem(formKey + '_drafts') || '[]');
                drafts.splice(index, 1);
                localStorage.setItem(formKey + '_drafts', JSON.stringify(drafts));
                loadDrafts();
            };
            
            // Login function
            window.doLogin = function(u, p) {
                const user = document.getElementById('loginUser').value;
                const pass = document.getElementById('loginPass').value;
                if (user === u && pass === p) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('formScreen').style.display = 'block';
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            };
            
            // GPS capture function
            window.captureGPS = function(btn) {
                const container = btn.closest('.gps-container');
                const status = container.querySelector('.gps-status');
                const latInput = container.querySelector('.gps-lat');
                const lngInput = container.querySelector('.gps-lng');
                
                status.textContent = 'üì° Getting location...';
                status.style.color = '#004080';
                
                if (!navigator.geolocation) {
                    status.textContent = '‚ùå Geolocation not supported';
                    status.style.color = '#dc3545';
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        latInput.value = lat;
                        lngInput.value = lng;
                        status.innerHTML = '‚úÖ <strong>' + lat + ', ' + lng + '</strong>';
                        status.style.color = '#28a745';
                        btn.textContent = 'üìç Update GPS';
                    },
                    function(error) {
                        let msg = '‚ùå ';
                        if (error.code === 1) msg += 'Permission denied';
                        else if (error.code === 2) msg += 'Location unavailable';
                        else if (error.code === 3) msg += 'Timeout';
                        else msg += 'Error getting location';
                        status.textContent = msg;
                        status.style.color = '#dc3545';
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            };
            
            // Signature functions
            window.clearSignature = function(btn) {
                const container = btn.closest('.sig-container');
                const canvas = container.querySelector('.sig-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                container.querySelector('.sig-data').value = '';
            };
            
            // Initialize signatures
            document.querySelectorAll('.sig-container').forEach(container => {
                const canvas = container.querySelector('.sig-canvas');
                const ctx = canvas.getContext('2d');
                const dataInput = container.querySelector('.sig-data');
                let drawing = false;
                
                function getPos(e) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches ? e.touches[0] : e;
                    return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
                }
                
                function start(e) { e.preventDefault(); drawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
                function draw(e) { if (!drawing) return; e.preventDefault(); const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
                function stop() { drawing = false; dataInput.value = canvas.toDataURL(); }
                
                canvas.addEventListener('mousedown', start);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stop);
                canvas.addEventListener('mouseleave', stop);
                canvas.addEventListener('touchstart', start);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stop);
                
                ctx.strokeStyle = '#004080';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
            });
            
            // Form submit
            const formTitle = s.t;
            document.getElementById('dataForm').onsubmit = function(e) {
                e.preventDefault();
                const form = e.target;
                const data = new FormData(form);
                const obj = { _formTitle: formTitle };
                data.forEach((v, k) => obj[k] = v);
                
                if (s.su && s.su !== 'YOUR_SCRIPT_URL') {
                    const btn = form.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    btn.textContent = '‚è≥ Submitting...';
                    
                    fetch(s.su, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(obj)
                    }).then(() => {
                        alert('‚úÖ Form submitted successfully!');
                        form.reset();
                        document.querySelectorAll('.gps-status').forEach(s => s.textContent = '');
                        document.querySelectorAll('.sig-container').forEach(c => {
                            const canvas = c.querySelector('.sig-canvas');
                            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                        });
                        btn.disabled = false;
                        btn.textContent = '‚úÖ SUBMIT';
                    }).catch(() => {
                        alert('‚ùå Submission failed. Try again.');
                        btn.disabled = false;
                        btn.textContent = '‚úÖ SUBMIT';
                    });
                } else {
                    alert('‚úÖ Form captured! (Configure Apps Script URL for Google Sheets)');
                    console.log('Form data:', obj);
                }
            };
        }
    </script>
</body>
</html>
