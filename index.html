<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF Collect | DHIS2 & Google Sheets Integration</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Auth Styles */
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; }
        .header h1 { font-size: 20px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        .header-btn.dhis2 { background: #17a2b8; color: white; }
        .header-btn.sheets { background: #0f9d58; color: white; }
        
        /* Main Layout */
        .main-container { display: none; margin-top: 70px; height: calc(100vh - 100px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        .field-type.special { background: #e8f4fc; border-color: #17a2b8; }
        
        /* Canvas */
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        /* Form Fields */
        .form-field { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field.dhis2-field { background: #e8f4fc; border-color: #17a2b8; }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 14px; padding: 6px 10px; border-radius: 6px; }
        .field-action-btn:hover { background: #004080; color: white; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; margin-left: 8px; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        .field-badge.dhis2 { background: #d1ecf1; color: #0c5460; }
        .field-badge.aggregate { background: #d4edda; color: #155724; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        /* Properties Panel */
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; }
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 750px; width: 100%; border: 4px double #004080; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-header.sheets { background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%); }
        .modal-header.primary { background: linear-gradient(135deg, #004080 0%, #002855 100%); }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-btn { padding: 12px 24px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; border: none; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; }
        .modal-btn.danger { background: #dc3545; color: white; }
        .modal-btn.dhis2 { background: #17a2b8; color: white; }
        .modal-btn.sheets { background: #0f9d58; color: white; }
        .modal-btn.purple { background: #6f42c1; color: white; }
        .modal-btn.orange { background: #fd7e14; color: white; }
        
        /* Config Sections */
        .config-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .config-section.dhis2 { background: #e8f4fc; border-color: #17a2b8; }
        .config-section.sheets { background: #e6f4ea; border-color: #0f9d58; }
        .config-title { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .config-title.dhis2 { color: #17a2b8; }
        .config-title.sheets { color: #0f9d58; }
        .config-input { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; margin-bottom: 10px; }
        .config-input:focus { outline: none; border-color: #004080; }
        .config-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .help-text { font-size: 10px; color: #666; margin-top: 3px; font-style: italic; }
        
        /* Status */
        .status-badge { padding: 12px 15px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .status-badge.connected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .status-badge.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .status-badge.syncing { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        
        /* Sync Log */
        .sync-log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; margin-top: 15px; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        .log-entry.warning { color: #ffd43b; }
        .log-entry.info { color: #74c0fc; }
        
        /* Share Modal */
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        
        /* Notification */
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; max-width: 350px; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        
        /* Viewer */
        .viewer-container { display: none; min-height: 100vh; background: #e9ecef; }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 100; }
        .viewer-back-btn { background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; margin-right: 10px; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
        .viewer-nav-btn.active { box-shadow: 0 0 0 3px rgba(255,255,255,0.5); }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        
        /* Form Viewer */
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .viewer-radio-option:hover { border-color: #004080; background: #e8f4fc; }
        
        /* Page Navigation */
        .page-header { background: #e8f4fc; margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; }
        .next-btn { background: #004080; color: white; }
        .submit-btn { background: #28a745; color: white; }
        
        /* Data Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; font-size: 10px; position: sticky; top: 0; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e8f4fc; }
        
        .sync-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .sync-badge.synced { background: #d4edda; color: #155724; }
        .sync-badge.pending { background: #fff3cd; color: #856404; }
        .sync-badge.failed { background: #f8d7da; color: #721c24; }
        
        /* Filter Panel */
        .filter-panel { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .filter-title { color: white; font-size: 14px; font-weight: 700; }
        .filter-toggle { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; min-width: 140px; }
        .filter-label { color: rgba(255,255,255,0.9); font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .filter-select, .filter-input { padding: 8px 10px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .filter-btn { padding: 8px 16px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; }
        .filter-btn.apply { background: #28a745; color: white; }
        .filter-btn.clear { background: #dc3545; color: white; }
        .filter-count { background: #ffc107; color: #000; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; margin-left: 8px; }
        
        /* Data View Tabs */
        .data-view-tabs { display: flex; gap: 0; margin-bottom: 20px; }
        .data-view-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border: 2px solid #dee2e6; background: #f8f9fa; }
        .data-view-tab:first-child { border-radius: 8px 0 0 8px; }
        .data-view-tab:last-child { border-radius: 0 8px 8px 0; }
        .data-view-tab.active { background: #004080; color: white; border-color: #004080; }
        .data-view-tab.active.aggregate { background: #28a745; border-color: #28a745; }
        
        /* Dashboard */
        .dashboard-container { max-width: 1100px; margin: 0 auto; }
        .dashboard-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .dashboard-header img { width: 60px; border-radius: 8px; margin-bottom: 10px; }
        .dashboard-header h2 { font-size: 18px; margin-bottom: 5px; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #000; }
        .stat-card.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%); }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; }
        .stat-card .stat-label { font-size: 10px; opacity: 0.9; margin-top: 5px; }
        .chart-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #e9ecef; }
        .chart-container h4 { color: #004080; font-size: 14px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .chart-wrapper { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .chart-box { flex: 1; min-width: 280px; max-width: 400px; }
        
        /* Aggregate Table */
        .aggregate-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .aggregate-table th { background: #28a745; color: white; padding: 12px; text-align: left; font-size: 11px; }
        .aggregate-table td { border: 1px solid #dee2e6; padding: 10px; }
        .aggregate-table tr:nth-child(even) { background: #f8f9fa; }
        .aggregate-table tr:hover { background: #e8f4fc; }
        
        /* Inline Icons */
        .inline-icon { display: inline-flex; align-items: center; vertical-align: middle; margin-right: 4px; }
        .inline-icon svg { display: block; }
        
        /* Auth Loading Spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #004080; border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .aggregate-value { font-weight: 700; color: #004080; }
        
        /* Sync Mode Selector */
        .sync-mode-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .sync-mode-option { flex: 1; padding: 15px; border: 3px solid #dee2e6; border-radius: 8px; cursor: pointer; text-align: center; }
        .sync-mode-option:hover { border-color: #004080; }
        .sync-mode-option.selected { border-color: #004080; background: #e8f4fc; }
        .sync-mode-option.selected.tracker { border-color: #6f42c1; background: #f3e8ff; }
        .sync-mode-option h4 { font-size: 13px; margin-bottom: 5px; }
        .sync-mode-option p { font-size: 10px; color: #666; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .form-title-input { width: 100%; }
            .config-row { grid-template-columns: 1fr; }
            .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
            .chart-box { min-width: 100%; }
            .filter-controls { flex-direction: column; }
            .filter-group { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>ICF Collect</h1>
                <p>DHIS2 & Google Sheets Integration</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <div class="auth-loading" id="authLoading" style="display:none;text-align:center;padding:10px;color:#004080;">
                    <span class="spinner"></span> Please wait...
                </div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email / Username</label>
                        <input type="text" class="auth-input" id="loginEmail" required placeholder="your@email.com or username">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn"><span data-icon="unlock" data-size="14"></span> Login</button>
                    <div style="text-align:center;margin-top:12px;">
                        <a href="#" onclick="showForgotPassword()" style="color:#004080;font-size:12px;text-decoration:none;">Forgot Password?</a>
                    </div>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email / Username</label>
                        <input type="text" class="auth-input" id="signupEmail" required placeholder="your@email.com or username">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <button type="submit" class="auth-btn"><span data-icon="user-plus" data-size="14"></span> Create Account</button>
                </form>
                <form class="auth-form" id="forgotForm">
                    <div class="auth-group">
                        <label class="auth-label">Enter your email/username</label>
                        <input type="text" class="auth-input" id="forgotEmail" required placeholder="your@email.com or username">
                    </div>
                    <button type="submit" class="auth-btn" style="background:#28a745;"><span data-icon="mail" data-size="14"></span> Send Password</button>
                    <div style="text-align:center;margin-top:12px;">
                        <a href="#" onclick="switchAuthTab('login')" style="color:#004080;font-size:12px;text-decoration:none;">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1><span data-icon="clipboard-list" data-size="24"></span> ICF Collect</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser"><span data-icon="user" data-size="14"></span> User</span>
            <button class="header-btn" onclick="showHome()"><span data-icon="home" data-size="14"></span> Home</button>
            <button class="header-btn success" onclick="newForm()"><span data-icon="file-plus" data-size="14"></span> New</button>
            <button class="header-btn" onclick="saveCurrentForm()"><span data-icon="save" data-size="14"></span> Save</button>
            <button class="header-btn" onclick="previewForm()"><span data-icon="eye" data-size="14"></span> Preview</button>
            <button class="header-btn dhis2" onclick="openDhis2Config()"><span data-icon="link" data-size="14"></span> DHIS2</button>
            <button class="header-btn primary" onclick="shareForm()"><span data-icon="share-2" data-size="14"></span> Share</button>
            <button class="header-btn danger" onclick="logout()"><span data-icon="log-out" data-size="14"></span> Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="link" data-size="14"></span> DHIS2 Fields</h3>
                <div class="field-type special" data-type="period"><span data-icon="calendar-days" data-size="14"></span> Period (YYYYMM)</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="edit-3" data-size="14"></span> Basic Fields</h3>
                <div class="field-type" data-type="text"><span data-icon="type" data-size="14"></span> Text Input</div>
                <div class="field-type" data-type="number"><span data-icon="hash" data-size="14"></span> Number</div>
                <div class="field-type" data-type="date"><span data-icon="calendar" data-size="14"></span> Date</div>
                <div class="field-type" data-type="time"><span data-icon="clock" data-size="14"></span> Time</div>
                <div class="field-type" data-type="email"><span data-icon="mail" data-size="14"></span> Email</div>
                <div class="field-type" data-type="phone"><span data-icon="phone" data-size="14"></span> Phone</div>
                <div class="field-type" data-type="textarea"><span data-icon="align-left" data-size="14"></span> Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="check-square" data-size="14"></span> Selection Fields</h3>
                <div class="field-type" data-type="select"><span data-icon="chevron-down-square" data-size="14"></span> Dropdown</div>
                <div class="field-type" data-type="radio"><span data-icon="circle-dot" data-size="14"></span> Radio Buttons</div>
                <div class="field-type" data-type="checkbox"><span data-icon="check-square" data-size="14"></span> Checkboxes</div>
                <div class="field-type" data-type="yesno"><span data-icon="toggle-left" data-size="14"></span> Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="sparkles" data-size="14"></span> Special Fields</h3>
                <div class="field-type" data-type="gps"><span data-icon="map-pin" data-size="14"></span> GPS Location</div>
                <div class="field-type" data-type="rating"><span data-icon="star" data-size="14"></span> Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="layout" data-size="14"></span> Structure</h3>
                <div class="field-type" data-type="section"><span data-icon="folder" data-size="14"></span> Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount"><span data-icon="bar-chart-3" data-size="12"></span> 0 fields</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p>ICF-SL Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:48px;margin-bottom:12px;"><span data-icon="mouse-pointer-click" data-size="48"></span></p>
                            <p style="font-weight:600;">Click field types to add them</p>
                            <p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period + Org Unit fields for DHIS2 sync</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title"><span data-icon="settings" data-size="16"></span> Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;"><span data-icon="mouse-pointer-click" data-size="32"></span></p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    
    <!-- Footer -->
    <footer class="footer">© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | ICF Collect v3</footer>

    <!-- DHIS2 Configuration Modal -->
    <div class="modal-overlay" id="dhis2Modal">
        <div class="modal">
            <div class="modal-header">
                <h3><span data-icon="link" data-size="18"></span> DHIS2 Configuration</h3>
                <button class="modal-close" onclick="closeModal('dhis2Modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dhis2Status" class="status-badge disconnected">
                    <span data-icon="x-circle" data-size="14"></span> <span>Not Connected</span>
                </div>
                
                <div class="config-section dhis2">
                    <div class="config-title dhis2"><span data-icon="globe" data-size="14"></span> Server Connection</div>
                    <label class="config-label">DHIS2 Server URL</label>
                    <input type="url" class="config-input" id="dhis2Url" placeholder="https://your-dhis2-instance.org">
                    
                    <div class="config-row">
                        <div>
                            <label class="config-label">Username</label>
                            <input type="text" class="config-input" id="dhis2Username" placeholder="Username">
                        </div>
                        <div>
                            <label class="config-label">Password</label>
                            <input type="password" class="config-input" id="dhis2Password" placeholder="Password">
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-title"><span data-icon="refresh-cw" data-size="14"></span> Sync Mode</div>
                    <div class="sync-mode-selector">
                        <div class="sync-mode-option selected" data-mode="aggregate" onclick="selectSyncMode('aggregate')">
                            <h4><span data-icon="bar-chart-3" data-size="16"></span> Aggregate</h4>
                            <p>Creates Dataset + Data Elements</p>
                            <p style="font-size:9px;color:#004080;margin-top:4px;">Syncs summarized data by Facility/Period</p>
                        </div>
                        <div class="sync-mode-option" data-mode="tracker" onclick="selectSyncMode('tracker')">
                            <h4><span data-icon="clipboard-list" data-size="16"></span> Event Program</h4>
                            <p>Creates Program + Data Elements</p>
                            <p style="font-size:9px;color:#6f42c1;margin-top:4px;">Syncs each record as individual event</p>
                        </div>
                    </div>
                    
                    <div id="aggregateConfig">
                        <div class="config-row">
                            <div>
                                <label class="config-label">Period Column</label>
                                <select class="config-input" id="dhis2PeriodColumn">
                                    <option value="">-- Select field --</option>
                                </select>
                                <p class="help-text" style="font-size:10px;color:#666;margin-top:4px;">Field with period (YYYYMM)</p>
                            </div>
                            <div>
                                <label class="config-label">Org Unit Column</label>
                                <select class="config-input" id="dhis2OrgUnitColumn">
                                    <option value="">-- Select field --</option>
                                </select>
                                <p class="help-text" style="font-size:10px;color:#666;margin-top:4px;">Field with facility/org unit name</p>
                            </div>
                        </div>
                        <div class="config-row">
                            <div>
                                <label class="config-label">Org Unit Level</label>
                                <select class="config-input" id="dhis2OrgLevel">
                                    <option value="1">Level 1 (National)</option>
                                    <option value="2">Level 2 (Region)</option>
                                    <option value="3">Level 3 (District)</option>
                                    <option value="4">Level 4 (Chiefdom)</option>
                                    <option value="5" selected>Level 5 (Facility)</option>
                                    <option value="6">Level 6</option>
                                </select>
                            </div>
                            <div>
                                <label class="config-label">Period Type</label>
                                <select class="config-input" id="dhis2PeriodType">
                                    <option value="Monthly" selected>Monthly</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Daily">Daily</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="trackerConfig" style="display:none;">
                        <label class="config-label">Program ID</label>
                        <input type="text" class="config-input" id="dhis2ProgramId" placeholder="Leave empty to auto-create, or enter existing Program ID">
                        <p class="help-text">Leave empty: Setup will create a new Event Program. Or enter an existing Program UID to use it.</p>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="modal-btn dhis2" onclick="testDhis2Connection()"><span data-icon="search" data-size="14"></span> Test Connection</button>
                    <button class="modal-btn primary" onclick="saveDhis2Config()"><span data-icon="save" data-size="14"></span> Save Config</button>
                </div>
                
                <div class="config-section">
                    <div class="config-title"><span data-icon="rocket" data-size="14"></span> Setup & Sync Actions</div>
                    <p style="font-size:11px;color:#666;margin-bottom:15px;">
                        <strong>Setup DHIS2:</strong> Creates Dataset/Program and Data Elements<br>
                        <strong>Sync Data:</strong> Pushes data to DHIS2 based on selected mode
                    </p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="modal-btn success" onclick="setupDhis2()" style="flex:1;"><span data-icon="settings" data-size="14"></span> Setup DHIS2</button>
                        <button class="modal-btn purple" onclick="syncToDhis2()" style="flex:1;"><span data-icon="refresh-cw" data-size="14"></span> Sync to DHIS2</button>
                    </div>
                </div>
                
                <div class="sync-log" id="syncLog">
                    <div class="log-entry info">Ready...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header primary">
                <h3><span data-icon="share-2" data-size="18"></span> Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div class="qr-box"><div id="qrCode"></div></div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;"><span data-icon="smartphone" data-size="14"></span> Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()"><span data-icon="copy" data-size="14"></span> Copy URL</button>
                    </div>
                </div>
                
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-top:20px;">
                    <h4 style="color:#1565c0;margin:0 0 10px 0;"><span data-icon="info" data-size="14"></span> What's included in the shared link</h4>
                    <ul style="margin:0;padding-left:20px;font-size:12px;color:#333;">
                        <li>✓ Form fields and configuration</li>
                        <li>✓ Automatic Google Sheets sync (sheet = form name)</li>
                        <li>✓ DHIS2 connection & credentials (if configured)</li>
                        <li>✓ Full sync capability to DHIS2</li>
                    </ul>
                </div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:10px;">
                    <h4 style="color:#856404;margin:0 0 5px 0;"><span data-icon="alert-triangle" data-size="14"></span> Security Note</h4>
                    <p style="margin:0;font-size:12px;color:#856404;">DHIS2 credentials are embedded in the link. Only share with trusted users.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // Inline SVG Icons (no external dependency)
        const icons = {
            'clipboard-list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',
            'home': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
            'file-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>',
            'save': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
            'eye': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
            'link': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
            'share-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
            'log-out': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
            'user': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            'user-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            'unlock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
            'calendar': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            'calendar-days': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',
            'type': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',
            'hash': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',
            'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'mail': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
            'phone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
            'align-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>',
            'chevron-down-square': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><polyline points="8 10 12 14 16 10"/></svg>',
            'circle-dot': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg>',
            'check-square': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
            'toggle-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="8" cy="12" r="3"/></svg>',
            'map-pin': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
            'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'folder': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
            'text-cursor-input': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h1a3 3 0 0 1 3 3 3 3 0 0 1 3-3h1"/><path d="M13 20h-1a3 3 0 0 1-3-3 3 3 0 0 1-3 3H5"/><path d="M5 16H4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1"/><path d="M13 8h7a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-7"/><path d="M9 7v10"/></svg>',
            'sparkles': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
            'layout': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>',
            'download': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
            'settings': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            'mouse-pointer-click': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 9 5 12 1.8-5.2L21 14Z"/><path d="M7.2 2.2 8 5.1"/><path d="m5.1 8-2.9-.8"/><path d="M14 4.1 12 6"/><path d="m6 12-1.9 2"/></svg>',
            'chevron-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',
            'chevron-down': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
            'trash-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
            'globe': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
            'git-branch': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>',
            'flask-conical': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>',
            'rocket': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
            'refresh-cw': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',
            'smartphone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
            'copy': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
            'check-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            'cloud': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',
            'info': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
            'alert-triangle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
            'x-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            'loader': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>',
            'database': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
            'building-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>',
            'bar-chart-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>',
            'inbox': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>',
            'plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            'pencil': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
            'file-text': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            'arrow-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>',
            'arrow-right': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
            'table': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',
            'bar-chart-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
            'wifi': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
            'wifi-off': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
            'check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
            'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
            'search': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
            'trending-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
            'edit-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',
            'list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
            'upload': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
            'filter': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
            'layers': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',
            'activity': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
            'file-spreadsheet': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>',
            'code': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>'
        };
        
        function getIcon(name, size = 16) {
            const svg = icons[name] || icons['file-text'];
            return svg.replace(/width="24"/g, `width="${size}"`).replace(/height="24"/g, `height="${size}"`);
        }
        
        function initIcons() {
            document.querySelectorAll('[data-icon]').forEach(el => {
                const name = el.getAttribute('data-icon');
                const size = el.getAttribute('data-size') || 16;
                el.innerHTML = getIcon(name, size);
            });
        }
    </script>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            PROXY_URL: 'https://script.google.com/macros/s/AKfycbyAmO9wZ-wMWmIG0NBwW4wMvOyl9YtKSxARTixJBI-x4UA58hORYrpK7wG-Qhujl26RQQ/exec',
            AUTH_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyAmO9wZ-wMWmIG0NBwW4wMvOyl9YtKSxARTixJBI-x4UA58hORYrpK7wG-Qhujl26RQQ/exec',
            LOGO_URL: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg'
        };

        // ==================== PROXY CONFIGURATION ====================
        // For DHIS2 POST/PUT requests, only GAS proxy works (CORS proxies block POST)
        const PROXIES = [
            { 
                name: 'Direct',
                url: '',
                type: 'direct'  // Try direct connection first (works if DHIS2 has CORS enabled)
            },
            { 
                name: 'GAS Proxy',
                url: 'https://script.google.com/macros/s/AKfycbyAmO9wZ-wMWmIG0NBwW4wMvOyl9YtKSxARTixJBI-x4UA58hORYrpK7wG-Qhujl26RQQ/exec',
                type: 'gas'
            }
        ];

        function buildProxyUrl(proxy, targetUrl, auth, method) {
            if (proxy.type === 'direct') {
                return targetUrl; // Direct connection
            } else if (proxy.type === 'gas') {
                let proxyUrl = proxy.url + '?url=' + encodeURIComponent(targetUrl);
                if (auth) {
                    proxyUrl += '&auth=' + encodeURIComponent(auth);
                }
                if (method && method !== 'GET') {
                    proxyUrl += '&method=' + method;
                }
                return proxyUrl;
            } else {
                return proxy.url + encodeURIComponent(targetUrl);
            }
        }

        // ==================== GLOBAL STATE ====================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            isSharedMode: false,
            settings: {
                title: 'My Data Collection Form',
                logo: CONFIG.LOGO_URL
            },
            sheets: {
                scriptUrl: CONFIG.AUTH_SCRIPT_URL,
                sheetId: '',
                connected: true
            },
            dhis2: {
                url: '',
                username: '',
                password: '',
                syncMode: 'aggregate', // 'aggregate' or 'tracker'
                orgUnitLevel: 5,
                periodType: 'Monthly',
                periodColumn: '',
                orgUnitColumn: '',
                programId: '',
                connected: false,
                datasetId: null,
                dataElements: {},
                orgUnits: [],
                orgUnitMap: {}
            },
            collectedData: [],
            filters: {},
            dateFilter: { start: '', end: '' },
            currentDataView: 'case', // 'case' or 'aggregate'
            chartInstances: {}
        };

        const fieldDefs = {
            period: { label: 'Period', icon: 'calendar-days', defaultLabel: 'Reporting Period', valueType: 'TEXT', isDhis2: true, category: 'dhis2' },
            text: { label: 'Text', icon: 'type', defaultLabel: 'Text Field', valueType: 'TEXT', category: 'text' },
            number: { label: 'Number', icon: 'hash', defaultLabel: 'Number Field', valueType: 'NUMBER', category: 'numeric' },
            date: { label: 'Date', icon: 'calendar', defaultLabel: 'Date Field', valueType: 'DATE', category: 'date' },
            time: { label: 'Time', icon: 'clock', defaultLabel: 'Time Field', valueType: 'TIME', category: 'time' },
            email: { label: 'Email', icon: 'mail', defaultLabel: 'Email Address', valueType: 'TEXT', category: 'text' },
            phone: { label: 'Phone', icon: 'phone', defaultLabel: 'Phone Number', valueType: 'PHONE_NUMBER', category: 'text' },
            textarea: { label: 'Long Text', icon: 'align-left', defaultLabel: 'Long Text', valueType: 'LONG_TEXT', category: 'text' },
            select: { label: 'Dropdown', icon: 'chevron-down-square', defaultLabel: 'Dropdown', valueType: 'TEXT', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'circle-dot', defaultLabel: 'Radio Choice', valueType: 'TEXT', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: 'check-square', defaultLabel: 'Checkbox', valueType: 'TRUE_ONLY', category: 'categorical', options: ['Option 1', 'Option 2'] },
            yesno: { label: 'Yes/No', icon: 'toggle-left', defaultLabel: 'Yes/No Question', valueType: 'BOOLEAN', category: 'categorical' },
            gps: { label: 'GPS', icon: 'map-pin', defaultLabel: 'GPS Location', valueType: 'COORDINATE', category: 'special' },
            rating: { label: 'Rating', icon: 'star', defaultLabel: 'Rating', valueType: 'INTEGER', category: 'categorical', max: 5 },
            section: { label: 'Section', icon: 'folder', defaultLabel: 'New Section', valueType: null, category: 'structure' }
        };

        // ==================== PERIODS ====================
        function generatePeriods() {
            const periods = [];
            for (let year = 2020; year <= 2026; year++) {
                for (let month = 1; month <= 12; month++) {
                    periods.push(`${year}${String(month).padStart(2, '0')}`);
                }
            }
            return periods;
        }
        const PERIODS = generatePeriods();

        // ==================== INITIALIZATION ====================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    state.isSharedMode = true;
                    renderSharedForm(data);
                    return;
                } catch (err) { console.error('Decode error:', err); }
            }
            
            loadFromStorage();
            loadConfigs();
            setupEventListeners();
            checkAuth();
        }

        function setupEventListeners() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab)));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('forgotForm').addEventListener('submit', handleForgotPassword);
            document.querySelectorAll('.field-type').forEach(el => el.addEventListener('click', () => addField(el.dataset.type)));
            document.getElementById('formTitle').addEventListener('input', (e) => {
                state.settings.title = e.target.value;
                document.getElementById('previewTitle').textContent = e.target.value;
                saveToStorage();
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        // ==================== GOOGLE SHEETS ====================
        // Automatic sheet creation based on form name
        // Row 1 = Labels, Row 2 = Variable Names, Row 3+ = Data
        
        async function submitToGoogleSheets(data) {
            const scriptUrl = CONFIG.AUTH_SCRIPT_URL;
            if (!scriptUrl) {
                console.log('No script URL configured');
                saveOffline(data);
                return { success: false, offline: true };
            }
            
            // Check if online
            if (!navigator.onLine) {
                console.log('Browser reports offline');
                saveOffline(data);
                return { success: false, offline: true };
            }
            
            console.log('Submitting to Google Sheets...', { formTitle: state.settings.title });
            
            // Build field definitions (labels and names)
            const fieldDefs = state.fields
                .filter(f => f.type !== 'section')
                .map(f => ({ label: f.label, name: f.name }));
            
            // Add system fields
            fieldDefs.unshift(
                { label: 'Record ID', name: '_id' },
                { label: 'Timestamp', name: '_timestamp' },
                { label: 'Synced', name: '_synced' }
            );
            
            try {
                const payload = {
                    action: 'submit',
                    formTitle: state.settings.title,
                    fields: fieldDefs,
                    data: data
                };
                
                console.log('Payload:', payload);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                
                const text = await response.text();
                console.log('Response text:', text);
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch(e) {
                    console.error('Failed to parse response:', text);
                    saveOffline(data);
                    return { success: false, offline: true, error: 'Invalid response from server' };
                }
                
                console.log('Parsed result:', result);
                
                if (result.success) {
                    // Mark as synced
                    data._synced = true;
                    data._syncedAt = new Date().toISOString();
                    console.log('✓ Submitted successfully');
                    return { success: true, offline: false };
                } else {
                    console.error('Sheets submission failed:', result.error);
                    saveOffline(data);
                    return { success: false, offline: true, error: result.error };
                }
            } catch (err) {
                console.error('Sheets submission error:', err);
                saveOffline(data);
                return { success: false, offline: true, error: err.message };
            }
        }

        async function loadFromGoogleSheets() {
            const scriptUrl = CONFIG.AUTH_SCRIPT_URL;
            if (!scriptUrl) {
                console.log('No script URL configured');
                return [];
            }
            
            const url = `${scriptUrl}?action=getData&formTitle=${encodeURIComponent(state.settings.title)}&limit=1000`;
            console.log('Fetching from:', url);
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                console.log('Response:', text.substring(0, 200));
                
                const result = JSON.parse(text);
                
                if (result.success && result.data) {
                    console.log('✓ Loaded', result.data.length, 'records from Google Sheets');
                    return result.data;
                } else {
                    console.log('No data or error:', result.error || result.message);
                    return [];
                }
            } catch (err) {
                console.error('Load error:', err);
                return [];
            }
        }

        function saveOffline(data) {
            data._offline = true;
            
            // Include field definitions for syncing later
            const fieldDefs = state.fields
                .filter(f => f.type !== 'section')
                .map(f => ({ label: f.label, name: f.name }));
            
            fieldDefs.unshift(
                { label: 'Record ID', name: '_id' },
                { label: 'Timestamp', name: '_timestamp' },
                { label: 'Synced', name: '_synced' }
            );
            
            const offlineData = JSON.parse(localStorage.getItem('icfOfflineData') || '[]');
            offlineData.push({ 
                formTitle: state.settings.title, 
                fields: fieldDefs,
                data: data 
            });
            localStorage.setItem('icfOfflineData', JSON.stringify(offlineData));
        }

        async function syncOfflineData() {
            if (!navigator.onLine) {
                notify('No internet connection', 'error');
                return;
            }
            
            const offlineData = JSON.parse(localStorage.getItem('icfOfflineData') || '[]');
            if (offlineData.length === 0) {
                notify('No offline data to sync', 'info');
                return;
            }
            
            notify(`Syncing ${offlineData.length} offline records...`, 'info');
            
            let synced = 0;
            let failed = 0;
            const remaining = [];
            
            for (const item of offlineData) {
                try {
                    const response = await fetch(CONFIG.AUTH_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'submit',
                            formTitle: item.formTitle,
                            fields: item.fields,
                            data: item.data
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        synced++;
                        // Update local data
                        const localRecord = state.collectedData.find(d => d._id === item.data._id);
                        if (localRecord) {
                            localRecord._synced = true;
                            localRecord._syncedAt = new Date().toISOString();
                            delete localRecord._offline;
                        }
                    } else {
                        failed++;
                        remaining.push(item);
                    }
                } catch (err) {
                    failed++;
                    remaining.push(item);
                }
            }
            
            // Save remaining offline data
            localStorage.setItem('icfOfflineData', JSON.stringify(remaining));
            saveToStorage();
            
            if (synced > 0) {
                notify(`Synced ${synced} records to Google Sheets!`, 'success');
            }
            if (failed > 0) {
                notify(`${failed} records failed to sync`, 'error');
            }
            
            loadViewerData();
        }

        // Auto-sync when coming online
        window.addEventListener('online', () => {
            const offlineData = JSON.parse(localStorage.getItem('icfOfflineData') || '[]');
            if (offlineData.length > 0) {
                notify('Back online! Syncing offline data...', 'info');
                setTimeout(syncOfflineData, 1000);
            }
        });

        function getOfflineCount() {
            const offlineData = JSON.parse(localStorage.getItem('icfOfflineData') || '[]');
            return offlineData.length;
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;
            
            const offlineCount = getOfflineCount();
            const isOnline = navigator.onLine;
            
            statusEl.className = 'connection-status ' + (isOnline ? 'online' : 'offline');
            
            if (isOnline) {
                if (offlineCount > 0) {
                    statusEl.innerHTML = `<span class="inline-icon" style="color:#ffc107;">${getIcon('wifi', 14)}</span> Online (${offlineCount} pending)`;
                    statusEl.style.background = '#ffc107';
                    statusEl.style.color = '#000';
                } else {
                    statusEl.innerHTML = `<span class="inline-icon">${getIcon('wifi', 14)}</span> Online`;
                    statusEl.style.background = '#28a745';
                    statusEl.style.color = '#fff';
                }
            } else {
                statusEl.innerHTML = `<span class="inline-icon">${getIcon('wifi-off', 14)}</span> Offline`;
                statusEl.style.background = '#dc3545';
                statusEl.style.color = '#fff';
            }
        }

        // Update connection status on network changes
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // ==================== DHIS2 ====================
        async function dhis2Request(endpoint, method = 'GET', payload = null) {
            const { url, username, password } = state.dhis2;
            if (!url || !username || !password) {
                throw new Error('DHIS2 not configured');
            }

            const serverUrl = url.replace(/\/$/, '');
            const apiUrl = `${serverUrl}/api/${endpoint}`;
            const auth = btoa(`${username}:${password}`);
            
            let lastError = null;
            
            // Try each proxy in order
            for (let i = 0; i < PROXIES.length; i++) {
                const proxy = PROXIES[i];
                const proxiedUrl = buildProxyUrl(proxy, apiUrl, auth, method);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };
                
                // Add auth header for direct and CORS connections
                if (proxy.type === 'direct' || proxy.type === 'cors') {
                    options.headers['Authorization'] = 'Basic ' + auth;
                }
                
                // For GAS proxy, use POST for non-GET methods
                if (proxy.type === 'gas' && method !== 'GET') {
                    options.method = 'POST';
                }
                
                if (payload && method !== 'GET') {
                    options.body = JSON.stringify(payload);
                }
                
                try {
                    const response = await fetch(proxiedUrl, options);
                    const text = await response.text();
                    
                    let data;
                    try { data = JSON.parse(text); } catch (e) { data = text; }
                    
                    // Check for proxy errors - try next proxy
                    // GAS proxy error format: {"error": {"status": 502, "message": "..."}}
                    // or {"error": "Exception: ..."}
                    if (data && data.error) {
                        if (typeof data.error === 'object' && (data.error.status === 502 || data.error.status === 500)) {
                            lastError = `${proxy.name}: ${data.error.message || 'Proxy error'}`;
                            continue; // Try next proxy
                        }
                        if (typeof data.error === 'string' && (data.error.includes('Exception') || data.error.includes('fetch'))) {
                            lastError = `${proxy.name}: ${data.error}`;
                            continue; // Try next proxy
                        }
                    }
                    
                    // Check for CORS error (direct connection blocked)
                    if (proxy.type === 'direct' && typeof data === 'string' && data === '') {
                        lastError = 'Direct: CORS blocked';
                        continue;
                    }
                    
                    // Check for DHIS2 error responses
                    if (data && (data.httpStatus === 'Unauthorized' || data.httpStatusCode === 401)) {
                        return { success: false, status: 401, error: 'Unauthorized - check credentials', data: data };
                    }
                    if (data && (data.httpStatus === 'Not Found' || data.httpStatusCode === 404)) {
                        return { success: false, status: 404, error: 'Not found', data: data };
                    }
                    if (data && data.httpStatusCode && data.httpStatusCode >= 400) {
                        return { success: false, status: data.httpStatusCode, error: data.message || 'Request failed', data: data };
                    }
                    
                    // Success check - include 201 Created and other success patterns
                    const isSuccess = data && (
                        data.httpStatus === 'Created' ||
                        data.httpStatus === 'OK' ||
                        data.httpStatusCode === 200 ||
                        data.httpStatusCode === 201 ||
                        data.response?.uid ||
                        data.status === 'OK' ||
                        data.status === 'SUCCESS' ||
                        (typeof data === 'object' && !data.error && !data.httpStatus) ||
                        Array.isArray(data) ||
                        (data.organisationUnits !== undefined) ||
                        (data.dataSets !== undefined) ||
                        (data.dataElements !== undefined) ||
                        (data.programs !== undefined) ||
                        (data.systemName !== undefined)
                    );
                    
                    if (isSuccess) {
                        return { success: true, status: data.httpStatusCode || 200, data: data };
                    }
                    
                    // If we got data but it's not clearly success, still return it (let caller decide)
                    if (data && typeof data === 'object') {
                        return { success: true, status: 200, data: data };
                    }
                    
                    // Not successful, try next proxy
                    lastError = `${proxy.name}: Invalid response`;
                    
                } catch (error) {
                    // Network error - try next proxy
                    lastError = `${proxy.name}: ${error.message}`;
                    continue;
                }
            }
            
            // All proxies failed
            return { success: false, status: 0, error: 'All proxies failed: ' + lastError };
        }

        async function testDhis2Connection() {
            const url = document.getElementById('dhis2Url').value.trim();
            const username = document.getElementById('dhis2Username').value.trim();
            const password = document.getElementById('dhis2Password').value;
            
            if (!url || !username || !password) {
                notify('Please fill server URL, username and password', 'error');
                return;
            }
            
            state.dhis2.url = url;
            state.dhis2.username = username;
            state.dhis2.password = password;
            
            updateDhis2Status('syncing', 'Testing connection...');
            addLog('info', 'Connecting to DHIS2...');
            
            try {
                const result = await dhis2Request('system/info.json');
                
                if (result.success && result.data?.systemName) {
                    state.dhis2.connected = true;
                    updateDhis2Status('connected', `Connected to ${result.data.systemName}`);
                    addLog('success', `✓ Connected: ${result.data.systemName} v${result.data.version || ''}`);
                    
                    if (state.dhis2.syncMode === 'aggregate') {
                        await fetchOrgUnits();
                    }
                    
                    saveDhis2Config();
                    notify('Connected to DHIS2!');
                } else {
                    state.dhis2.connected = false;
                    updateDhis2Status('disconnected', 'Connection failed');
                    addLog('error', `✗ Failed: ${result.error || 'Could not connect'}`);
                    notify('Connection failed. Check URL and credentials.', 'error');
                }
            } catch (error) {
                state.dhis2.connected = false;
                updateDhis2Status('disconnected', 'Connection error');
                addLog('error', `✗ Error: ${error.message}`);
                notify('Connection error: ' + error.message, 'error');
            }
        }

        async function fetchOrgUnits() {
            const level = state.dhis2.orgUnitLevel;
            addLog('info', `Fetching org units at level ${level}...`);
            
            const result = await dhis2Request(`organisationUnits.json?fields=id,name,displayName,code&filter=level:eq:${level}&paging=false`);
            
            if (result.success && result.data?.organisationUnits) {
                state.dhis2.orgUnits = result.data.organisationUnits;
                state.dhis2.orgUnitMap = {};
                
                result.data.organisationUnits.forEach(ou => {
                    const names = [
                        ou.displayName?.toLowerCase().trim(),
                        ou.name?.toLowerCase().trim(),
                        ou.code?.toLowerCase().trim()
                    ].filter(Boolean);
                    
                    names.forEach(name => {
                        state.dhis2.orgUnitMap[name] = ou.id;
                    });
                });
                
                addLog('success', `✓ Loaded ${state.dhis2.orgUnits.length} org units at level ${level}`);
            } else {
                addLog('warning', `⚠ Could not load org units: ${result.error || 'Unknown error'}`);
            }
        }

        function selectSyncMode(mode) {
            state.dhis2.syncMode = mode;
            document.querySelectorAll('.sync-mode-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.mode === mode) el.classList.add('selected');
            });
            
            document.getElementById('aggregateConfig').style.display = mode === 'aggregate' ? 'block' : 'none';
            document.getElementById('trackerConfig').style.display = mode === 'tracker' ? 'block' : 'none';
        }

        function saveDhis2Config() {
            state.dhis2.url = document.getElementById('dhis2Url').value.trim();
            state.dhis2.username = document.getElementById('dhis2Username').value.trim();
            state.dhis2.password = document.getElementById('dhis2Password').value;
            state.dhis2.orgUnitLevel = parseInt(document.getElementById('dhis2OrgLevel').value);
            state.dhis2.periodType = document.getElementById('dhis2PeriodType').value;
            state.dhis2.programId = document.getElementById('dhis2ProgramId').value.trim();
            state.dhis2.periodColumn = document.getElementById('dhis2PeriodColumn').value;
            state.dhis2.orgUnitColumn = document.getElementById('dhis2OrgUnitColumn').value;
            
            localStorage.setItem('icfDhis2Config', JSON.stringify({
                url: state.dhis2.url,
                username: state.dhis2.username,
                password: state.dhis2.password,
                syncMode: state.dhis2.syncMode,
                orgUnitLevel: state.dhis2.orgUnitLevel,
                periodType: state.dhis2.periodType,
                periodColumn: state.dhis2.periodColumn,
                orgUnitColumn: state.dhis2.orgUnitColumn,
                programId: state.dhis2.programId
            }));
            
            notify('DHIS2 config saved!');
        }

        function updateDhis2Status(type, message) {
            const el = document.getElementById('dhis2Status');
            if (!el) return; // Safe for shared mode where element doesn't exist
            el.className = `status-badge ${type}`;
            const icon = type === 'connected' ? '✓' : type === 'syncing' ? '⋯' : '✗';
            el.innerHTML = `${icon} <span>${message}</span>`;
        }

        function addLog(type, message) {
            const log = document.getElementById('syncLog');
            if (!log) return;
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="log-entry ${type}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            const log = document.getElementById('syncLog');
            if (log) log.innerHTML = '';
        }

        async function setupDhis2() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            const periodColumn = state.dhis2.periodColumn;
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            
            clearLog();
            addLog('info', `Setting up DHIS2 (${state.dhis2.syncMode} mode)...`);
            updateDhis2Status('syncing', 'Setting up...');
            
            const dataFields = state.fields.filter(f => 
                f.type !== 'section' && f.name !== periodColumn && f.name !== orgUnitColumn
            );
            
            if (dataFields.length === 0) {
                notify('Add data fields first', 'error');
                return;
            }
            
            // Ensure org units are loaded
            if (state.dhis2.orgUnits.length === 0) {
                await fetchOrgUnits();
            }
            
            try {
                // Create Data Elements
                addLog('info', 'Creating Data Elements...');
                const createdElements = [];
                const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox'];
                
                for (const field of dataFields) {
                    const def = fieldDefs[field.type];
                    
                    if (categoricalTypes.includes(field.type)) {
                        // For categorical fields, create a data element for each option
                        const options = field.type === 'yesno' ? ['Yes', 'No'] : (field.options || []);
                        
                        for (const opt of options) {
                            const colName = `${field.name}_${opt}`;
                            const code = colName.toUpperCase().replace(/[^A-Z0-9_]/g, '_');
                            const label = `${field.label} (${opt})`;
                            
                            const checkResult = await dhis2Request(`dataElements.json?filter=code:eq:${code}&fields=id,name`);
                            
                            if (checkResult.success && checkResult.data?.dataElements?.length > 0) {
                                const existing = checkResult.data.dataElements[0];
                                state.dhis2.dataElements[colName] = existing.id;
                                createdElements.push({ id: existing.id, name: label });
                                addLog('info', `  ↳ Exists: ${label}`);
                            } else {
                                const payload = {
                                    name: label,
                                    shortName: label.substring(0, 50),
                                    code: code,
                                    domainType: state.dhis2.syncMode === 'tracker' ? 'TRACKER' : 'AGGREGATE',
                                    valueType: 'INTEGER',
                                    aggregationType: 'SUM'
                                };
                                
                                const createResult = await dhis2Request('dataElements', 'POST', payload);
                                
                                // Check various success response formats
                                const newId = createResult.data?.response?.uid || 
                                             createResult.data?.uid ||
                                             (createResult.data?.status === 'OK' && createResult.data?.response?.uid);
                                
                                if (createResult.success && newId) {
                                    state.dhis2.dataElements[colName] = newId;
                                    createdElements.push({ id: newId, name: label });
                                    addLog('success', `  ✓ Created: ${label}`);
                                } else {
                                    const errorMsg = createResult.data?.message || 
                                                    createResult.data?.response?.errorReports?.[0]?.message ||
                                                    createResult.error || 
                                                    JSON.stringify(createResult.data);
                                    addLog('error', `  ✗ Failed: ${label} - ${errorMsg}`);
                                }
                            }
                            await sleep(200);
                        }
                    } else {
                        // For numeric and other fields
                        const code = field.name.toUpperCase().replace(/[^A-Z0-9_]/g, '_');
                        
                        const checkResult = await dhis2Request(`dataElements.json?filter=code:eq:${code}&fields=id,name`);
                        
                        if (checkResult.success && checkResult.data?.dataElements?.length > 0) {
                            const existing = checkResult.data.dataElements[0];
                            state.dhis2.dataElements[field.id] = existing.id;
                            createdElements.push({ id: existing.id, name: field.label });
                            addLog('info', `  ↳ Exists: ${field.label}`);
                        } else {
                            const payload = {
                                name: field.label,
                                shortName: field.label.substring(0, 50),
                                code: code,
                                domainType: state.dhis2.syncMode === 'tracker' ? 'TRACKER' : 'AGGREGATE',
                                valueType: def?.valueType || 'TEXT',
                                aggregationType: field.type === 'number' ? 'SUM' : 'NONE'
                            };
                            
                            const createResult = await dhis2Request('dataElements', 'POST', payload);
                            
                            // Check various success response formats
                            const newId = createResult.data?.response?.uid || 
                                         createResult.data?.uid ||
                                         (createResult.data?.status === 'OK' && createResult.data?.response?.uid);
                            
                            if (createResult.success && newId) {
                                state.dhis2.dataElements[field.id] = newId;
                                createdElements.push({ id: newId, name: field.label });
                                addLog('success', `  ✓ Created: ${field.label}`);
                            } else {
                                const errorMsg = createResult.data?.message || 
                                                createResult.data?.response?.errorReports?.[0]?.message ||
                                                createResult.error || 
                                                JSON.stringify(createResult.data);
                                addLog('error', `  ✗ Failed: ${field.label} - ${errorMsg}`);
                            }
                        }
                        await sleep(200);
                    }
                }
                
                addLog('success', `✓ ${createdElements.length} data elements ready`);
                
                if (state.dhis2.syncMode === 'aggregate') {
                    await setupAggregateDataset(createdElements);
                } else {
                    await setupTrackerProgram(createdElements);
                }
                
                updateDhis2Status('connected', 'Setup complete!');
                addLog('success', 'DHIS2 SETUP COMPLETE!');
                saveToStorage();
                notify('DHIS2 setup complete!');
                
            } catch (error) {
                updateDhis2Status('disconnected', 'Setup failed');
                addLog('error', '✗ Error: ' + error.message);
                notify('Setup failed', 'error');
            }
        }

        async function setupTrackerProgram(createdElements) {
            // Ensure org units are loaded
            if (state.dhis2.orgUnits.length === 0) {
                await fetchOrgUnits();
            }
            
            const programName = state.settings.title;
            const programCode = programName.toUpperCase().replace(/[^A-Z0-9]/g, '_').substring(0, 30);
            
            // Check if user provided an existing Program ID
            const userProvidedProgramId = document.getElementById('dhis2ProgramId').value.trim();
            
            let programId = null;
            let programStageId = null;
            
            if (userProvidedProgramId) {
                // User provided a Program ID - verify it exists
                addLog('info', `Checking existing Program: ${userProvidedProgramId}...`);
                const existingProgResult = await dhis2Request(`programs/${userProvidedProgramId}.json?fields=id,name,programStages[id]`);
                
                if (existingProgResult.success && existingProgResult.data?.id) {
                    programId = existingProgResult.data.id;
                    programStageId = existingProgResult.data.programStages?.[0]?.id;
                    state.dhis2.programId = programId;
                    addLog('success', `  ✓ Using existing Program: ${existingProgResult.data.name}`);
                } else {
                    addLog('error', `  ✗ Program not found: ${userProvidedProgramId}`);
                    addLog('info', 'Creating new Program instead...');
                }
            }
            
            if (!programId) {
                addLog('info', `Setting up Event Program: ${programName}...`);
                
                // Check if program exists by code
                const progCheckResult = await dhis2Request(`programs.json?filter=code:eq:${programCode}&fields=id,name,programStages[id]`);
                
                if (progCheckResult.success && progCheckResult.data?.programs?.length > 0) {
                    const existingProg = progCheckResult.data.programs[0];
                    programId = existingProg.id;
                    programStageId = existingProg.programStages?.[0]?.id;
                    state.dhis2.programId = programId;
                    addLog('info', `  ↳ Program exists: ${programId}`);
                } else {
                    // Create new Event Program (WITHOUT_REGISTRATION = Event Program)
                    const programPayload = {
                        name: programName,
                        shortName: programName.substring(0, 50),
                        code: programCode,
                        programType: 'WITHOUT_REGISTRATION', // Event Program for case-based data
                        organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                    };
                    
                    const createProgResult = await dhis2Request('programs', 'POST', programPayload);
                    
                    if (createProgResult.success && createProgResult.data?.response?.uid) {
                        programId = createProgResult.data.response.uid;
                        state.dhis2.programId = programId;
                        addLog('success', `  ✓ Program created: ${programId}`);
                        
                        // Create Program Stage
                        await sleep(300);
                        const stagePayload = {
                            name: programName + ' - Data Entry',
                            program: { id: programId },
                            sortOrder: 1
                        };
                        
                        const createStageResult = await dhis2Request('programStages', 'POST', stagePayload);
                        
                        if (createStageResult.success && createStageResult.data?.response?.uid) {
                            programStageId = createStageResult.data.response.uid;
                            addLog('success', `  ✓ Program Stage created: ${programStageId}`);
                        } else {
                            addLog('error', '  ✗ Failed to create Program Stage');
                        }
                    } else {
                        addLog('error', '  ✗ Failed to create Program');
                        return;
                    }
                }
            }
            
            // Assign Data Elements to Program Stage
            if (programStageId && createdElements.length > 0) {
                addLog('info', 'Assigning Data Elements to Program Stage...');
                
                // Get current program stage to update it
                const stageResult = await dhis2Request(`programStages/${programStageId}.json?fields=:owner`);
                
                if (stageResult.success && stageResult.data) {
                    const stageData = stageResult.data;
                    
                    // Build programStageDataElements array
                    const programStageDataElements = createdElements.map((el, idx) => ({
                        dataElement: { id: el.id },
                        compulsory: el.field?.required || false,
                        sortOrder: idx + 1
                    }));
                    
                    stageData.programStageDataElements = programStageDataElements;
                    
                    const updateResult = await dhis2Request(`programStages/${programStageId}`, 'PUT', stageData);
                    
                    if (updateResult.success) {
                        addLog('success', `  ✓ Assigned ${createdElements.length} data elements to stage`);
                    } else {
                        addLog('warning', '  ⚠ Could not assign all data elements');
                    }
                }
            }
            
            // Update Program ID in the UI
            document.getElementById('dhis2ProgramId').value = programId;
            addLog('success', `Event Program ready: ${programId}`);
        }

        async function setupAggregateDataset(createdElements) {
            if (state.dhis2.orgUnits.length === 0) {
                await fetchOrgUnits();
            }
            
            if (createdElements.length === 0) {
                addLog('warning', '⚠ No data elements to add to dataset');
                return;
            }
            
            const datasetName = state.settings.title;
            const datasetCode = datasetName.toUpperCase().replace(/[^A-Z0-9]/g, '_').substring(0, 30);
            
            addLog('info', `Setting up Dataset: ${datasetName}...`);
            
            const dsCheckResult = await dhis2Request(`dataSets.json?filter=code:eq:${datasetCode}&fields=id,name`);
            
            if (dsCheckResult.success && dsCheckResult.data?.dataSets?.length > 0) {
                state.dhis2.datasetId = dsCheckResult.data.dataSets[0].id;
                addLog('info', `  ↳ Dataset exists: ${state.dhis2.datasetId}`);
                
                // Update existing dataset with elements and org units
                addLog('info', '  Updating dataset with data elements...');
                const fullDs = await dhis2Request(`dataSets/${state.dhis2.datasetId}.json?fields=:owner`);
                if (fullDs.success && fullDs.data) {
                    const merged = {
                        ...fullDs.data,
                        dataSetElements: createdElements.map(de => ({ 
                            dataSet: { id: state.dhis2.datasetId },
                            dataElement: { id: de.id } 
                        })),
                        organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                    };
                    
                    const updateResult = await dhis2Request(`dataSets/${state.dhis2.datasetId}`, 'PUT', merged);
                    if (updateResult.success) {
                        addLog('success', `  ✓ Dataset updated with ${createdElements.length} elements and ${state.dhis2.orgUnits.length} org units`);
                    } else {
                        const errorMsg = updateResult.data?.message || updateResult.error || JSON.stringify(updateResult.data);
                        addLog('warning', `  ⚠ Could not update dataset: ${errorMsg}`);
                    }
                }
            } else {
                const createPayload = {
                    name: datasetName,
                    shortName: datasetName.substring(0, 50),
                    code: datasetCode,
                    periodType: state.dhis2.periodType,
                    dataSetElements: createdElements.map(de => ({ dataElement: { id: de.id } })),
                    organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                };
                
                addLog('info', `  Creating dataset with ${createdElements.length} elements and ${state.dhis2.orgUnits.length} org units...`);
                
                const createResult = await dhis2Request('dataSets', 'POST', createPayload);
                
                // Check various success response formats
                const newId = createResult.data?.response?.uid || createResult.data?.uid;
                
                if (createResult.success && newId) {
                    state.dhis2.datasetId = newId;
                    addLog('success', `  ✓ Dataset created: ${state.dhis2.datasetId}`);
                } else {
                    const errorMsg = createResult.data?.message || 
                                    createResult.data?.response?.errorReports?.[0]?.message ||
                                    createResult.error || 
                                    JSON.stringify(createResult.data);
                    addLog('error', `  ✗ Failed to create dataset: ${errorMsg}`);
                }
            }
        }

        async function syncToDhis2() {
            if (!state.dhis2.url || !state.dhis2.username) {
                notify('DHIS2 not configured', 'error');
                return;
            }
            
            // Ensure connected flag is set
            state.dhis2.connected = true;
            
            clearLog();
            
            if (state.dhis2.syncMode === 'aggregate') {
                await syncAggregateData();
            } else {
                await syncTrackerData();
            }
        }

        async function syncAggregateData() {
            addLog('info', 'Syncing AGGREGATE data to DHIS2...');
            updateDhis2Status('syncing', 'Syncing...');
            
            // Get aggregate data
            const aggregateData = calculateAggregateData();
            
            if (aggregateData.length === 0) {
                notify('No data to sync', 'info');
                addLog('info', 'No aggregate data to sync');
                return;
            }
            
            const periodColumn = state.dhis2.periodColumn;
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            
            let success = 0, failed = 0;
            
            for (const record of aggregateData) {
                const period = record._period;
                const orgUnitName = record._orgUnit;
                const orgUnitId = state.dhis2.orgUnitMap[orgUnitName?.toLowerCase().trim()];
                
                if (!orgUnitId) {
                    addLog('error', `  ✗ No org unit match: ${orgUnitName}`);
                    failed++;
                    continue;
                }
                
            const dataValues = [];
                const dataFields = state.fields.filter(f => 
                    f.type !== 'section' && f.name !== periodColumn && f.name !== orgUnitColumn
                );
                
                const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox'];
                
                dataFields.forEach(field => {
                    const def = fieldDefs[field.type];
                    
                    if (categoricalTypes.includes(field.type)) {
                        // For categorical fields, send each option as separate value
                        const options = field.type === 'yesno' ? ['Yes', 'No'] : (field.options || []);
                        options.forEach(opt => {
                            const colName = `${field.name}_${opt}`;
                            const deId = state.dhis2.dataElements[colName];
                            const value = record[colName];
                            
                            if (deId && value !== undefined && value !== null) {
                                dataValues.push({
                                    dataElement: deId,
                                    value: String(value),
                                    period: period,
                                    orgUnit: orgUnitId
                                });
                            }
                        });
                    } else {
                        // For numeric and other fields
                        const deId = state.dhis2.dataElements[field.id];
                        const value = record[field.name];
                        
                        if (deId && value !== undefined && value !== null && value !== '') {
                            dataValues.push({
                                dataElement: deId,
                                value: String(value),
                                period: period,
                                orgUnit: orgUnitId
                            });
                        }
                    }
                });
                
                if (dataValues.length === 0) continue;
                
                const result = await dhis2Request('dataValueSets', 'POST', { dataValues });
                
                if (result.success) {
                    success++;
                    addLog('success', `  ✓ Synced: ${orgUnitName} / ${period}`);
                } else {
                    failed++;
                    addLog('error', `  ✗ Failed: ${orgUnitName} / ${period}`);
                }
                
                await sleep(300);
            }
            
            updateDhis2Status('connected', 'Sync complete');
            addLog('info', `Sync complete: ${success} success, ${failed} failed`);
            notify(`Synced ${success} records to DHIS2!`);
        }

        async function syncTrackerData() {
            addLog('info', 'Syncing TRACKER/EVENT data to DHIS2...');
            updateDhis2Status('syncing', 'Syncing...');
            
            const programId = state.dhis2.programId;
            if (!programId) {
                notify('Run Setup DHIS2 first to create the Program', 'error');
                addLog('error', 'No Program ID - run Setup first');
                return;
            }
            
            // Ensure org units are loaded
            if (state.dhis2.orgUnits.length === 0) {
                await fetchOrgUnits();
            }
            
            const pendingData = state.collectedData.filter(d => !d._synced);
            
            if (pendingData.length === 0) {
                notify('No pending data to sync', 'info');
                addLog('info', 'No pending data to sync');
                return;
            }
            
            const periodColumn = state.dhis2.periodColumn;
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            
            addLog('info', `Syncing ${pendingData.length} events...`);
            
            let success = 0, failed = 0;
            
            for (const record of pendingData) {
                // Get org unit
                const orgUnitName = orgUnitColumn ? record[orgUnitColumn] : '';
                let orgUnitId = state.dhis2.orgUnitMap[orgUnitName?.toLowerCase().trim()];
                
                // Try partial match if exact match fails
                if (!orgUnitId && orgUnitName) {
                    const searchKey = orgUnitName.toLowerCase().trim();
                    for (const [name, id] of Object.entries(state.dhis2.orgUnitMap)) {
                        if (name.includes(searchKey) || searchKey.includes(name)) {
                            orgUnitId = id;
                            break;
                        }
                    }
                }
                
                if (!orgUnitId) {
                    // Use first org unit as fallback
                    orgUnitId = state.dhis2.orgUnits[0]?.id;
                    if (!orgUnitId) {
                        addLog('error', `  ✗ No org unit: ${orgUnitName}`);
                        failed++;
                        continue;
                    }
                    addLog('warning', `  ⚠ Using default org unit for: ${orgUnitName}`);
                }
                
                // Get event date from period or timestamp
                let eventDate = record._timestamp?.split('T')[0] || new Date().toISOString().split('T')[0];
                if (periodColumn && record[periodColumn]) {
                    // Convert YYYYMM to YYYY-MM-01
                    const period = record[periodColumn];
                    if (period.length === 6) {
                        eventDate = `${period.substring(0, 4)}-${period.substring(4, 6)}-01`;
                    }
                }
                
                // Build data values (excluding period and orgunit columns)
                const dataValues = [];
                const dataFields = state.fields.filter(f => 
                    f.type !== 'section' && f.name !== periodColumn && f.name !== orgUnitColumn
                );
                
                dataFields.forEach(field => {
                    const deId = state.dhis2.dataElements[field.id];
                    const value = record[field.name];
                    
                    if (deId && value !== undefined && value !== null && value !== '') {
                        dataValues.push({
                            dataElement: deId,
                            value: String(value)
                        });
                    }
                });
                
                if (dataValues.length === 0) {
                    addLog('warning', '  ⚠ No data values in record');
                    failed++;
                    continue;
                }
                
                // Create event payload
                const event = {
                    program: programId,
                    orgUnit: orgUnitId,
                    eventDate: eventDate,
                    status: 'COMPLETED',
                    dataValues: dataValues
                };
                
                const result = await dhis2Request('events', 'POST', event);
                
                if (result.success && (result.data?.response?.imported > 0 || result.data?.response?.importSummaries)) {
                    record._synced = true;
                    record._syncedAt = new Date().toISOString();
                    delete record._syncError;
                    success++;
                    addLog('success', `  ✓ Event synced: ${orgUnitName || 'record'}`);
                } else {
                    record._syncError = result.error || JSON.stringify(result.data?.message || result.data?.response?.importSummaries?.[0]?.description) || 'Unknown error';
                    failed++;
                    addLog('error', `  ✗ Event failed: ${record._syncError}`);
                }
                
                await sleep(300);
            }
            
            updateDhis2Status('connected', 'Sync complete');
            addLog('info', `Sync complete: ${success} success, ${failed} failed`);
            saveToStorage();
            saveFormToList();
            
            if (success > 0) notify(`Synced ${success} events to DHIS2!`);
            if (failed > 0) notify(`${failed} events failed`, 'error');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== DATA AGGREGATION ====================
        function calculateAggregateData() {
            const periodColumn = state.dhis2.periodColumn;
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            
            if (!periodColumn || !orgUnitColumn) {
                notify('Select Period Column and Org Unit Column in DHIS2 settings', 'error');
                return [];
            }
            
            const grouped = {};
            const data = getFilteredData();
            
            data.forEach(record => {
                const period = record[periodColumn] || 'Unknown';
                const orgUnit = record[orgUnitColumn] || 'Unknown';
                const key = `${orgUnit}|||${period}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        _orgUnit: orgUnit,
                        _period: period,
                        _count: 0
                    };
                }
                
                grouped[key]._count++;
                
                // Aggregate other fields (excluding the period and orgunit columns)
                state.fields.forEach(field => {
                    if (field.type === 'section') return;
                    if (field.name === periodColumn || field.name === orgUnitColumn) return;
                    
                    const value = record[field.name];
                    const def = fieldDefs[field.type];
                    
                    if (def?.category === 'numeric' || field.type === 'number') {
                        // Sum numbers
                        const numVal = parseFloat(value) || 0;
                        grouped[key][field.name] = (grouped[key][field.name] || 0) + numVal;
                    } else if (def?.category === 'categorical' || field.type === 'yesno') {
                        // Get options for this field
                        const options = field.type === 'yesno' ? ['Yes', 'No'] : (field.options || []);
                        
                        // Initialize all option columns to 0 if not exists
                        options.forEach(opt => {
                            const colName = `${field.name}_${opt}`;
                            if (grouped[key][colName] === undefined) {
                                grouped[key][colName] = 0;
                            }
                        });
                        
                        // Increment the matching option column
                        if (value && options.includes(value)) {
                            const colName = `${field.name}_${value}`;
                            grouped[key][colName] = (grouped[key][colName] || 0) + 1;
                        }
                    }
                });
            });
            
            return Object.values(grouped);
        }

        // ==================== FILTERING ====================
        function getFilterableFields() {
            const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox', 'rating'];
            return state.fields.filter(f => categoricalTypes.includes(f.type));
        }

        function getFilteredData() {
            let data = [...state.collectedData];
            
            // Date filter
            if (state.dateFilter.start || state.dateFilter.end) {
                data = data.filter(row => {
                    const ts = row._timestamp;
                    if (!ts) return true;
                    const rowDate = new Date(ts);
                    
                    if (state.dateFilter.start && rowDate < new Date(state.dateFilter.start)) return false;
                    if (state.dateFilter.end) {
                        const endDate = new Date(state.dateFilter.end);
                        endDate.setHours(23, 59, 59, 999);
                        if (rowDate > endDate) return false;
                    }
                    return true;
                });
            }
            
            // Field filters
            Object.keys(state.filters).forEach(fieldName => {
                const filterValue = state.filters[fieldName];
                if (filterValue) {
                    data = data.filter(row => {
                        const rowValue = row[fieldName];
                        return rowValue && rowValue.toString().trim() === filterValue;
                    });
                }
            });
            
            return data;
        }

        window.updateFilter = function(fieldName, value) {
            if (value) {
                state.filters[fieldName] = value;
            } else {
                delete state.filters[fieldName];
            }
            applyFilters();
        };

        window.updateDateFilter = function(type, value) {
            state.dateFilter[type] = value;
            applyFilters();
        };

        window.clearAllFilters = function() {
            state.filters = {};
            state.dateFilter = { start: '', end: '' };
            document.querySelectorAll('.filter-select, .filter-input').forEach(el => el.value = '');
            applyFilters();
            notify('Filters cleared');
        };

        function applyFilters() {
            renderDataContent();
            renderDashboard();
        }

        // ==================== UI HELPERS ====================
        function openDhis2Config() {
            document.getElementById('dhis2Url').value = state.dhis2.url || '';
            document.getElementById('dhis2Username').value = state.dhis2.username || '';
            document.getElementById('dhis2Password').value = state.dhis2.password || '';
            document.getElementById('dhis2OrgLevel').value = state.dhis2.orgUnitLevel || 5;
            document.getElementById('dhis2PeriodType').value = state.dhis2.periodType || 'Monthly';
            document.getElementById('dhis2ProgramId').value = state.dhis2.programId || '';
            selectSyncMode(state.dhis2.syncMode || 'aggregate');
            
            // Populate Period Column and Org Unit Column dropdowns
            const periodSelect = document.getElementById('dhis2PeriodColumn');
            const orgUnitSelect = document.getElementById('dhis2OrgUnitColumn');
            
            // Clear existing options except first
            periodSelect.innerHTML = '<option value="">-- Select field --</option>';
            orgUnitSelect.innerHTML = '<option value="">-- Select field --</option>';
            
            // Add form fields as options (exclude section)
            state.fields.filter(f => f.type !== 'section').forEach(f => {
                const periodOpt = document.createElement('option');
                periodOpt.value = f.name;
                periodOpt.textContent = f.label;
                periodSelect.appendChild(periodOpt);
                
                const orgOpt = document.createElement('option');
                orgOpt.value = f.name;
                orgOpt.textContent = f.label;
                orgUnitSelect.appendChild(orgOpt);
            });
            
            // Set selected values
            if (state.dhis2.periodColumn) periodSelect.value = state.dhis2.periodColumn;
            if (state.dhis2.orgUnitColumn) orgUnitSelect.value = state.dhis2.orgUnitColumn;
            
            document.getElementById('dhis2Modal').classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : type === 'info' ? ' info' : '');
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ==================== AUTH ====================
        function checkAuth() {
            const saved = localStorage.getItem('icfCollectUser');
            if (saved) { state.user = JSON.parse(saved); showBuilder(); }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
        }

        function showForgotPassword() {
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('forgotForm').classList.add('active');
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthLoading(show) {
            document.getElementById('authLoading').style.display = show ? 'block' : 'none';
            document.querySelectorAll('.auth-btn').forEach(btn => btn.disabled = show);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            document.getElementById('authError').style.display = 'none';
            showAuthLoading(true);
            
            try {
                const response = await fetch(CONFIG.AUTH_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'login',
                        email: email,
                        password: password
                    })
                });
                const result = await response.json();
                
                showAuthLoading(false);
                
                if (result.success && result.user) {
                    state.user = result.user;
                    localStorage.setItem('icfCollectUser', JSON.stringify(result.user));
                    showBuilder();
                } else {
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = result.error || 'Invalid credentials';
                }
            } catch (error) {
                showAuthLoading(false);
                // Fallback to local storage if offline
                const users = JSON.parse(localStorage.getItem('icfCollectUsers') || '[]');
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    state.user = user;
                    localStorage.setItem('icfCollectUser', JSON.stringify(user));
                    showBuilder();
                } else {
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = 'Connection error. Please try again.';
                }
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
            showAuthLoading(true);
            
            try {
                const response = await fetch(CONFIG.AUTH_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'signup',
                        name: name,
                        email: email,
                        password: password
                    })
                });
                const result = await response.json();
                
                showAuthLoading(false);
                
                if (result.success) {
                    // Also save locally for offline
                    const users = JSON.parse(localStorage.getItem('icfCollectUsers') || '[]');
                    if (!users.find(u => u.email === email)) {
                        users.push({ id: result.user?.id || Date.now().toString(), name, email, password });
                        localStorage.setItem('icfCollectUsers', JSON.stringify(users));
                    }
                    
                    document.getElementById('authSuccess').style.display = 'block';
                    document.getElementById('authSuccess').textContent = 'Account created! Please login.';
                    setTimeout(() => switchAuthTab('login'), 1500);
                } else {
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = result.error || 'Registration failed';
                }
            } catch (error) {
                showAuthLoading(false);
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authError').textContent = 'Connection error. Please try again.';
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value.trim();
            
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
            showAuthLoading(true);
            
            try {
                const response = await fetch(CONFIG.AUTH_SCRIPT_URL + '?action=forgotPassword&email=' + encodeURIComponent(email));
                const result = await response.json();
                
                showAuthLoading(false);
                
                if (result.success) {
                    document.getElementById('authSuccess').style.display = 'block';
                    document.getElementById('authSuccess').textContent = 'Password sent to your email!';
                    setTimeout(() => switchAuthTab('login'), 2000);
                } else {
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = result.message || 'Email not found';
                }
            } catch (error) {
                showAuthLoading(false);
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authError').textContent = 'Connection error. Please try again.';
            }
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').innerHTML = '<span data-icon="user" data-size="14"></span> ' + (state.user?.name || 'User');
            renderFields();
            initIcons();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('icfCollectUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ==================== FORM BUILDER ====================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;
            
            // Check for duplicate period field
            if (type === 'period' && state.fields.find(f => f.type === 'period')) {
                notify('Period field already exists', 'error');
                return;
            }
            
            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                max: def.max || 5
            };
            
            // Special naming for period field
            if (type === 'period') {
                field.name = 'period';
                field.label = 'Reporting Period';
            }
            
            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
        }

        function removeField(id) {
            event?.stopPropagation();
            if (!confirm('Delete field?')) return;
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) { state.selectedFieldId = null; renderProperties(); }
            renderFields();
            saveToStorage();
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) { field[prop] = value; renderFields(); saveToStorage(); }
        }

        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const dataFieldCount = state.fields.filter(f => f.type !== 'section').length;
            document.getElementById('fieldCount').innerHTML = `<span data-icon="bar-chart-3" data-size="12"></span> ${dataFieldCount} fields`;
            initIcons();
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:48px;margin-bottom:12px;"><span class="inline-icon">' + getIcon('inbox', 48) + '</span></p><p style="font-weight:600;">Click field types to add them</p><p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period + Org Unit fields for DHIS2 sync</p>';
                return;
            }
            
            dropZone.classList.add('has-fields');
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') {
                    return `<div class="section-divider ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}">
                        <span><span class="inline-icon">${getIcon('folder', 14)}</span> ${f.label.toUpperCase()}</span>
                        <div style="display:flex;gap:5px;">
                            <button class="field-action-btn" onclick="moveField('${f.id}','up')"><span class="inline-icon">${getIcon('chevron-up', 12)}</span></button>
                            <button class="field-action-btn" onclick="moveField('${f.id}','down')"><span class="inline-icon">${getIcon('chevron-down', 12)}</span></button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')"><span class="inline-icon">${getIcon('trash-2', 12)}</span></button>
                        </div>
                    </div>`;
                }
                
                const def = fieldDefs[f.type];
                const isDhis2Field = f.type === 'period';
                const isNumeric = f.type === 'number';
                
                return `<div class="form-field ${f.id === state.selectedFieldId ? 'selected' : ''} ${isDhis2Field ? 'dhis2-field' : ''}" data-id="${f.id}">
                    <div class="form-field-header">
                        <span class="form-field-label"><span class="inline-icon">${getIcon(def?.icon || 'file-text', 14)}</span> ${f.label}</span>
                        <div class="form-field-actions">
                            <button class="field-action-btn" onclick="moveField('${f.id}','up')"><span class="inline-icon">${getIcon('chevron-up', 12)}</span></button>
                            <button class="field-action-btn" onclick="moveField('${f.id}','down')"><span class="inline-icon">${getIcon('chevron-down', 12)}</span></button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')"><span class="inline-icon">${getIcon('trash-2', 12)}</span></button>
                        </div>
                    </div>
                    <div style="font-size:10px;color:#868e96;">
                        Code: <code>${f.name}</code>
                        ${f.required ? '<span class="field-badge required">Required</span>' : ''}
                        ${isDhis2Field ? '<span class="field-badge dhis2">DHIS2</span>' : ''}
                        ${isNumeric ? '<span class="field-badge aggregate">SUM</span>' : ''}
                    </div>
                </div>`;
            }).join('');
            
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id);
                });
            });
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:32px;margin-bottom:12px;"><span data-icon="chevron-up" data-size="32"></span></p><p>Select a field to edit</p></div>';
                return;
            }
            
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `
                <div class="prop-section">
                    <div class="prop-section-title"><span data-icon="edit-3" data-size="12"></span> Field Settings</div>
                    <div class="property-group">
                        <label class="property-label">Label</label>
                        <input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Code / Name</label>
                        <input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}">
                    </div>
                    ${field.type !== 'section' ? `
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                                <span>Required Field</span>
                            </label>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `
                    <div class="prop-section">
                        <div class="prop-section-title"><span data-icon="list" data-size="12"></span> Options (one per line)</div>
                        <textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
        }

        // ==================== STORAGE ====================
        function saveToStorage() {
            localStorage.setItem('icfCollectForm', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter,
                collectedData: state.collectedData,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    dataElements: state.dhis2.dataElements
                }
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('icfCollectForm');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                    state.collectedData = data.collectedData || [];
                    if (data.dhis2) {
                        state.dhis2.datasetId = data.dhis2.datasetId;
                        state.dhis2.dataElements = data.dhis2.dataElements || {};
                    }
                    
                    document.getElementById('formTitle').value = state.settings.title;
                    document.getElementById('previewTitle').textContent = state.settings.title;
                } catch (e) {}
            }
        }

        function loadConfigs() {
            // Load Sheets config
            const sheetsConfig = localStorage.getItem('icfSheetsConfig');
            if (sheetsConfig) {
                try {
                    const config = JSON.parse(sheetsConfig);
                    state.sheets = { ...state.sheets, ...config };
                } catch (e) {}
            }
            
            // Load DHIS2 config
            const dhis2Config = localStorage.getItem('icfDhis2Config');
            if (dhis2Config) {
                try {
                    const config = JSON.parse(dhis2Config);
                    state.dhis2 = { ...state.dhis2, ...config };
                } catch (e) {}
            }
        }

        // ==================== FORM OPERATIONS ====================
        function newForm() {
            if (state.fields.length > 0 && !confirm('Create new form?')) return;
            state.fields = [];
            state.selectedFieldId = null;
            state.fieldCounter = 0;
            state.dhis2.dataElements = {};
            state.dhis2.datasetId = null;
            state.collectedData = [];
            
            const title = prompt('Form Name:', 'New Form');
            if (title) {
                state.settings.title = title;
                document.getElementById('formTitle').value = title;
                document.getElementById('previewTitle').textContent = title;
            }
            saveToStorage();
            renderFields();
            renderProperties();
            notify('New form created!');
        }

        function saveCurrentForm() {
            if (state.fields.length === 0) { notify('Add fields first!', 'error'); return; }
            saveToStorage();
            saveFormToList();
            notify('Form saved!');
        }

        function saveFormToList() {
            const forms = JSON.parse(localStorage.getItem('icfCollectForms') || '[]');
            const existingIndex = forms.findIndex(f => f.title === state.settings.title);
            const formEntry = {
                id: existingIndex >= 0 ? forms[existingIndex].id : 'form_' + Date.now(),
                title: state.settings.title,
                fieldCount: state.fields.filter(f => f.type !== 'section').length,
                updatedAt: new Date().toISOString(),
                fields: state.fields,
                settings: state.settings,
                collectedData: state.collectedData,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    dataElements: state.dhis2.dataElements
                }
            };
            if (existingIndex >= 0) forms[existingIndex] = formEntry;
            else forms.push(formEntry);
            localStorage.setItem('icfCollectForms', JSON.stringify(forms));
        }

        function previewForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            state.isSharedMode = false;
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('viewerContainer').classList.add('show');
            renderFormViewer();
        }

        function closeViewer() {
            document.getElementById('viewerContainer').classList.remove('show');
            document.querySelector('.header').style.display = '';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = '';
        }

        function shareForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            
            const formData = {
                s: { t: state.settings.title, l: state.settings.logo },
                f: state.fields.map(f => ({ i: f.id, y: f.type, l: f.label, n: f.name, r: f.required, o: f.options, mx: f.max })),
                d: state.dhis2.datasetId || state.dhis2.programId ? { 
                    id: state.dhis2.datasetId,
                    pid: state.dhis2.programId,
                    de: state.dhis2.dataElements 
                } : null,
                // Include DHIS2 credentials for sync
                h: state.dhis2.url ? {
                    u: state.dhis2.url,
                    n: state.dhis2.username,
                    p: btoa(state.dhis2.password), // Encode password
                    m: state.dhis2.syncMode,
                    ol: state.dhis2.orgUnitLevel,
                    pt: state.dhis2.periodType,
                    pc: state.dhis2.periodColumn,
                    oc: state.dhis2.orgUnitColumn
                } : null
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                const shareUrl = window.location.origin + window.location.pathname + '?d=' + encodeURIComponent(encoded);
                
                document.getElementById('shareUrl').textContent = shareUrl;
                
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: shareUrl, width: 200, height: 200, colorDark: '#004080' });
                
                saveFormToList();
                document.getElementById('shareModal').classList.add('show');
            } catch (err) { notify('Error: ' + err.message, 'error'); }
        }

        function copyShareUrl() {
            navigator.clipboard.writeText(document.getElementById('shareUrl').textContent)
                .then(() => notify('Copied to clipboard!'))
                .catch(() => notify('Copy failed', 'error'));
        }

        // ==================== HOME ====================
        function showHome() {
            const forms = JSON.parse(localStorage.getItem('icfCollectForms') || '[]');
            let formsHtml = forms.length === 0 ? `
                <div style="text-align:center;padding:60px;color:#868e96;">
                    <p style="font-size:64px;margin-bottom:12px;"><span class="inline-icon">${getIcon('inbox', 64)}</span></p>
                    <h3 style="color:#004080;">No Forms Yet</h3>
                    <button onclick="closeHome()" style="padding:15px 30px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:20px;font-weight:bold;"><span class="inline-icon">${getIcon('plus', 14)}</span> Create Form</button>
                </div>
            ` : forms.map((f, i) => `
                <div style="background:#fff;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#004080,#002855);color:#fff;padding:12px 15px;">
                        <h3 style="margin:0;font-size:14px;"><span class="inline-icon">${getIcon('clipboard-list', 14)}</span> ${escapeHtml(f.title)}</h3>
                    </div>
                    <div style="padding:12px 15px;">
                        <div style="font-size:11px;color:#666;margin-bottom:10px;">
                            <span class="inline-icon">${getIcon('bar-chart-3', 12)}</span> ${f.fieldCount} fields | <span class="inline-icon">${getIcon('edit-3', 12)}</span> ${(f.collectedData || []).length} records
                            ${f.dhis2?.datasetId ? '<span style="color:#17a2b8;margin-left:8px;"><span class="inline-icon">' + getIcon('link', 12) + '</span> DHIS2</span>' : ''}
                        </div>
                        <div style="display:flex;gap:6px;">
                            <button onclick="editForm(${i})" style="flex:1;padding:8px;background:#004080;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;"><span class="inline-icon">${getIcon('pencil', 12)}</span> Edit</button>
                            <button onclick="deleteForm(${i})" style="padding:8px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;"><span class="inline-icon">${getIcon('trash-2', 12)}</span></button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('homeContainer').innerHTML = `
                <div style="max-width:600px;margin:0 auto;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="color:#004080;"><span class="inline-icon">${getIcon('home', 20)}</span> My Forms</h2>
                        <button onclick="closeHome()" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;"><span class="inline-icon">${getIcon('plus', 14)}</span> New</button>
                    </div>
                    ${formsHtml}
                </div>
            `;
            
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('homeContainer').classList.add('show');
            initIcons();
        }

        function closeHome() {
            document.getElementById('homeContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'flex';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = 'block';
        }

        function editForm(index) {
            const forms = JSON.parse(localStorage.getItem('icfCollectForms') || '[]');
            const form = forms[index];
            if (!form) return;
            
            state.fields = form.fields || [];
            state.settings = { ...state.settings, ...form.settings };
            state.fieldCounter = Math.max(...state.fields.map(f => parseInt(f.id.replace('field_', '')) || 0), 0) + 1;
            state.collectedData = form.collectedData || [];
            
            if (form.dhis2) {
                state.dhis2.datasetId = form.dhis2.datasetId;
                state.dhis2.dataElements = form.dhis2.dataElements || {};
            }
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            saveToStorage();
            closeHome();
            renderFields();
            renderProperties();
            notify('Form loaded!');
        }

        function deleteForm(index) {
            const forms = JSON.parse(localStorage.getItem('icfCollectForms') || '[]');
            if (!confirm(`Delete "${forms[index]?.title}"?`)) return;
            forms.splice(index, 1);
            localStorage.setItem('icfCollectForms', JSON.stringify(forms));
            showHome();
            notify('Deleted');
        }

        // ==================== FORM VIEWER ====================
        function renderSharedForm(data) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            state.settings = { title: data.s?.t || 'Form', logo: data.s?.l || state.settings.logo };
            state.fields = (data.f || []).map(f => ({
                id: f.i, type: f.y, label: f.l, name: f.n, required: f.r || false, options: f.o || [], max: f.mx || 5
            }));
            
            // Load DHIS2 dataset/program info
            if (data.d) {
                state.dhis2.datasetId = data.d.id || '';
                state.dhis2.programId = data.d.pid || '';
                state.dhis2.dataElements = data.d.de || {};
            }
            
            // Load DHIS2 credentials from shared link
            if (data.h) {
                state.dhis2.url = data.h.u || '';
                state.dhis2.username = data.h.n || '';
                state.dhis2.password = data.h.p ? atob(data.h.p) : ''; // Decode password
                state.dhis2.syncMode = data.h.m || 'aggregate';
                state.dhis2.orgUnitLevel = data.h.ol || 5;
                state.dhis2.periodType = data.h.pt || 'Monthly';
                state.dhis2.periodColumn = data.h.pc || '';
                state.dhis2.orgUnitColumn = data.h.oc || '';
                state.dhis2.connected = true; // Mark as configured
                
                // Fetch org units in background
                if (state.dhis2.url) {
                    fetchOrgUnits().catch(err => console.log('Could not fetch org units:', err));
                }
            }
            
            document.getElementById('viewerContainer').classList.add('show');
            renderFormViewer();
        }

        function renderFormViewer() {
            const s = state.settings;
            let pages = [], currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) pages.push(currentPage);
                    currentPage = { title: field.label, fields: [] };
                } else {
                    currentPage.fields.push(field);
                }
            });
            if (currentPage.fields.length > 0) pages.push(currentPage);
            if (pages.length === 0) pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'period':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}>
                                <option value="">-- Select Period --</option>
                                ${PERIODS.map(p => `<option value="${p}">${p.substring(0,4)}-${p.substring(4)}</option>`).join('')}
                            </select>`;
                            break;
                        case 'text': case 'email': case 'phone': case 'date': case 'time':
                            const type = field.type === 'phone' ? 'tel' : field.type;
                            input = `<input type="${type}" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                            break;
                        case 'number':
                            input = `<input type="number" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                            break;
                        case 'textarea':
                            input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`;
                            break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                            break;
                        case 'radio': case 'yesno':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'gps':
                            input = `<div><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;"><span data-icon="map-pin" data-size="14"></span> Get Location</button><input type="hidden" name="${field.name}"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`;
                            break;
                        case 'rating':
                            input = `<div>${Array(field.max || 5).fill().map((_, i) => `<span onclick="setRating(this,${i+1})" class="rating-star" style="font-size:24px;cursor:pointer;opacity:0.3;color:#ffc107;">★</span>`).join('')}<input type="hidden" name="${field.name}"></div>`;
                            break;
                        default:
                            input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0, isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        ${pages.length > 1 ? `<div class="page-header"><span class="page-indicator">Page ${pageIndex + 1}/${pages.length}</span><h3 class="page-title">${escapeHtml(page.title)}</h3></div>` : ''}
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})"><span class="inline-icon">${getIcon('arrow-left', 14)}</span> Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next <span class="inline-icon">${getIcon('arrow-right', 14)}</span></button>` : ''}
                            ${isLast ? `<button type="submit" class="nav-btn submit-btn"><span data-icon="check" data-size="14"></span> Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            const backBtn = state.isSharedMode ? '' : '<button class="viewer-back-btn" onclick="closeViewer()"><span class="inline-icon">' + getIcon('arrow-left', 14) + '</span> Back</button>';
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    ${backBtn}
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showTab('form',this)"><span data-icon="edit-3" data-size="14"></span> Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showTab('data',this)"><span data-icon="table" data-size="14"></span> Data</button>
                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showTab('dashboard',this)"><span data-icon="bar-chart-2" data-size="14"></span> Dashboard</button>
                    ${state.dhis2.url ? `<div class="connection-status" style="background:#17a2b8;"><span class="inline-icon">${getIcon('link', 14)}</span> DHIS2</div>` : ''}
                    <div id="connectionStatus" class="connection-status ${navigator.onLine ? 'online' : 'offline'}">
                        ${navigator.onLine ? '<span class="inline-icon" style="color:#28a745;">' + getIcon('wifi', 14) + '</span> Online' : '<span class="inline-icon" style="color:#dc3545;">' + getIcon('wifi-off', 14) + '</span> Offline'}
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                                <p>ICF-SL Data Collection System</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">${pagesHtml}</form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab">
                    <div style="max-width:1100px;margin:0 auto;" id="dataContent">
                        <p style="text-align:center;padding:40px;"><span data-icon="loader" data-size="14"></span> Loading...</p>
                    </div>
                </div>
                
                <div id="tabDashboard" class="viewer-tab">
                    <div class="dashboard-container" id="dashboardContent">
                        <p style="text-align:center;padding:40px;"><span data-icon="loader" data-size="14"></span> Loading...</p>
                    </div>
                </div>
            `;
            
            window.totalPages = pages.length;
            setupFormSubmit();
            loadViewerData();
            initIcons();
        }

        function setupFormSubmit() {
            const form = document.getElementById('viewerForm');
            if (!form) return;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString(), _synced: false };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                // Show submitting state
                const submitBtn = form.querySelector('.submit-btn');
                const originalText = submitBtn ? submitBtn.innerHTML : '';
                if (submitBtn) {
                    submitBtn.innerHTML = '<span class="spin" style="display:inline-block;">' + getIcon('loader', 14) + '</span> Submitting...';
                    submitBtn.disabled = true;
                }
                
                // Submit to Google Sheets first (if online)
                const result = await submitToGoogleSheets(data);
                
                // Update sync status based on result
                if (result.success && !result.offline) {
                    data._synced = true;
                }
                
                // Save locally
                state.collectedData.push(data);
                saveToStorage();
                saveFormToList();
                
                // Reset form
                form.reset();
                goToPage(0);
                
                // Restore button
                if (submitBtn) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
                
                // Show appropriate notification
                if (result.success && !result.offline) {
                    notify('Submitted to Google Sheets!', 'success');
                } else if (result.offline) {
                    notify('Saved offline (will sync when online)', 'info');
                } else {
                    notify('Saved locally', 'info');
                }
                
                loadViewerData();
            };
        }

        async function loadViewerData() {
            // Show loading state
            const dataContainer = document.getElementById('dataContent');
            const dashContainer = document.getElementById('dashboardContent');
            
            if (dataContainer) {
                dataContainer.innerHTML = `<p style="text-align:center;padding:40px;"><span class="spin" style="display:inline-block;">${getIcon('loader', 20)}</span> Loading data from Google Sheets...</p>`;
            }
            if (dashContainer) {
                dashContainer.innerHTML = `<p style="text-align:center;padding:40px;"><span class="spin" style="display:inline-block;">${getIcon('loader', 20)}</span> Loading dashboard...</p>`;
            }
            
            // Try to load from Google Sheets
            try {
                console.log('Loading data from Google Sheets...');
                const sheetsData = await loadFromGoogleSheets();
                console.log('Loaded from Sheets:', sheetsData.length, 'records');
                
                if (sheetsData && sheetsData.length > 0) {
                    // Use Google Sheets as primary data source
                    // Convert _id to number if it's a string (Sheets may return as string)
                    state.collectedData = sheetsData.map(d => ({
                        ...d,
                        _id: d._id ? (typeof d._id === 'string' ? parseInt(d._id) || d._id : d._id) : Date.now(),
                        _synced: true
                    }));
                    console.log('✓ Data loaded from Google Sheets');
                } else {
                    // No data in Sheets, use whatever is in state.collectedData (from local storage)
                    console.log('No data in Sheets, using local data:', state.collectedData.length, 'records');
                }
            } catch (err) {
                console.error('Could not load from Sheets:', err.message);
                // Keep using whatever is in state.collectedData
                console.log('Fallback to local data:', state.collectedData.length, 'records');
            }
            
            renderDataContent();
            renderDashboard();
            updateConnectionStatus();
        }

        function renderDataContent() {
            const container = document.getElementById('dataContent');
            if (!container) return;
            
            const filterableFields = getFilterableFields();
            const filteredData = getFilteredData();
            const aggregateData = calculateAggregateData();
            const activeFilterCount = Object.keys(state.filters).filter(k => state.filters[k]).length + 
                                     (state.dateFilter.start || state.dateFilter.end ? 1 : 0);
            
            // Build filter panel
            let filtersHtml = `
                <div class="filter-group">
                    <label class="filter-label"><span class="inline-icon">${getIcon('calendar', 12)}</span> From</label>
                    <input type="date" class="filter-input" value="${state.dateFilter.start}" onchange="updateDateFilter('start', this.value)">
                </div>
                <div class="filter-group">
                    <label class="filter-label"><span class="inline-icon">${getIcon('calendar', 12)}</span> To</label>
                    <input type="date" class="filter-input" value="${state.dateFilter.end}" onchange="updateDateFilter('end', this.value)">
                </div>
            `;
            
            filterableFields.forEach(field => {
                const uniqueValues = [...new Set(state.collectedData.map(d => d[field.name]).filter(Boolean))];
                filtersHtml += `
                    <div class="filter-group">
                        <label class="filter-label">${escapeHtml(field.label)}</label>
                        <select class="filter-select" onchange="updateFilter('${field.name}', this.value)">
                            <option value="">All</option>
                            ${uniqueValues.map(v => `<option value="${escapeHtml(v)}" ${state.filters[field.name] === v ? 'selected' : ''}>${escapeHtml(v)}</option>`).join('')}
                        </select>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="filter-panel">
                    <div class="filter-header">
                        <div class="filter-title"><span class="inline-icon">${getIcon('filter', 14)}</span> Filters ${activeFilterCount > 0 ? `<span class="filter-count">${activeFilterCount} active</span>` : ''}</div>
                        <button class="filter-btn clear" onclick="clearAllFilters()"><span class="inline-icon">${getIcon('trash-2', 12)}</span> Clear</button>
                    </div>
                    <div class="filter-controls">${filtersHtml}</div>
                </div>
                
                <div class="data-view-tabs">
                    <div class="data-view-tab ${state.currentDataView === 'case' ? 'active' : ''}" onclick="switchDataView('case')"><span class="inline-icon">${getIcon('list', 14)}</span> Case-Based (${filteredData.length})</div>
                    <div class="data-view-tab ${state.currentDataView === 'aggregate' ? 'active aggregate' : ''}" onclick="switchDataView('aggregate')"><span class="inline-icon">${getIcon('bar-chart-3', 14)}</span> Aggregate (${aggregateData.length})</div>
                </div>
                
                <div id="dataTableContainer">${state.currentDataView === 'case' ? renderCaseTable(filteredData) : renderAggregateTable(aggregateData)}</div>
                
                <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="modal-btn primary" onclick="refreshData()"><span class="inline-icon">${getIcon('refresh-cw', 14)}</span> Refresh</button>
                    <button class="modal-btn success" onclick="downloadCSV()"><span class="inline-icon">${getIcon('download', 14)}</span> Download CSV</button>
                    ${getOfflineCount() > 0 ? `<button class="modal-btn" style="background:#ffc107;color:#000;" onclick="syncOfflineData()"><span class="inline-icon">${getIcon('upload', 14)}</span> Sync Offline (${getOfflineCount()})</button>` : ''}
                    ${state.dhis2.url && state.dhis2.connected ? `<button class="modal-btn" style="background:#17a2b8;color:#fff;" onclick="syncToDhis2()"><span class="inline-icon">${getIcon('link', 14)}</span> Sync to DHIS2</button>` : ''}
                </div>
            `;
            initIcons();
        }

        window.switchDataView = function(view) {
            state.currentDataView = view;
            renderDataContent();
        };

        function renderCaseTable(data) {
            if (data.length === 0) {
                return '<p style="text-align:center;padding:40px;color:#868e96;"><span data-icon="inbox" data-size="20"></span> No records found</p>';
            }
            
            const fields = state.fields.filter(f => f.type !== 'section');
            
            let html = '<div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>#</th><th><span data-icon="calendar" data-size="12"></span> Timestamp</th>';
            fields.slice(0, 8).forEach(f => html += `<th>${escapeHtml(f.label)}</th>`);
            html += '<th>Status</th></tr></thead><tbody>';
            
            data.slice().reverse().forEach((row, i) => {
                const syncStatus = row._synced ? 
                    '<span class="sync-badge synced"><span data-icon="check" data-size="10"></span> Synced</span>' : 
                    (row._syncError ? '<span class="sync-badge failed"><span data-icon="x" data-size="10"></span> Failed</span>' : '<span class="sync-badge pending"><span data-icon="clock" data-size="10"></span> Pending</span>');
                    
                html += `<tr><td>${data.length - i}</td><td style="font-size:10px;">${new Date(row._timestamp).toLocaleString()}</td>`;
                fields.slice(0, 8).forEach(f => html += `<td>${escapeHtml(String(row[f.name] || '-').substring(0, 25))}</td>`);
                html += `<td>${syncStatus}</td></tr>`;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function renderAggregateTable(data) {
            if (data.length === 0) {
                return '<p style="text-align:center;padding:40px;color:#868e96;"><span data-icon="inbox" data-size="20"></span> No aggregate data (select Period Column and Org Unit Column in DHIS2 settings)</p>';
            }
            
            const periodColumn = state.dhis2.periodColumn;
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            
            const dataFields = state.fields.filter(f => 
                f.type !== 'section' && f.name !== periodColumn && f.name !== orgUnitColumn
            );
            
            // Build column definitions - expand categorical fields into multiple columns
            const columns = [];
            const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox'];
            
            dataFields.forEach(f => {
                const def = fieldDefs[f.type];
                if (categoricalTypes.includes(f.type)) {
                    // Expand categorical field into option columns
                    const options = f.type === 'yesno' ? ['Yes', 'No'] : (f.options || []);
                    options.forEach(opt => {
                        columns.push({
                            key: `${f.name}_${opt}`,
                            label: `${f.label} (${opt})`,
                            type: 'categorical'
                        });
                    });
                } else if (def?.category === 'numeric' || f.type === 'number') {
                    columns.push({
                        key: f.name,
                        label: `${f.label} (SUM)`,
                        type: 'numeric'
                    });
                } else {
                    columns.push({
                        key: f.name,
                        label: f.label,
                        type: 'other'
                    });
                }
            });
            
            // Build table
            let html = '<div style="overflow-x:auto;"><table class="aggregate-table"><thead><tr>';
            html += '<th style="position:sticky;left:0;background:#004080;z-index:2;"><span class="inline-icon">' + getIcon('building-2', 14) + '</span> Facility</th>';
            html += '<th><span class="inline-icon">' + getIcon('calendar', 14) + '</span> Period</th>';
            html += '<th><span class="inline-icon">' + getIcon('bar-chart-3', 14) + '</span> N</th>';
            
            columns.forEach(col => {
                const bgColor = col.type === 'categorical' ? '#0066cc' : '#004080';
                html += `<th style="background:${bgColor};white-space:nowrap;font-size:11px;">${escapeHtml(col.label)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += `<tr>`;
                html += `<td style="position:sticky;left:0;background:#fff;z-index:1;font-weight:600;">${escapeHtml(row._orgUnit)}</td>`;
                html += `<td>${escapeHtml(row._period)}</td>`;
                html += `<td class="aggregate-value" style="font-weight:600;">${row._count}</td>`;
                
                columns.forEach(col => {
                    const value = row[col.key];
                    const displayVal = value !== undefined && value !== null ? value : 0;
                    html += `<td class="aggregate-value">${displayVal}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        window.refreshData = async function() {
            notify('Refreshing...');
            await loadViewerData();
            notify('Refreshed!');
        };

        window.downloadCSV = function() {
            const isAggregate = state.currentDataView === 'aggregate';
            const data = isAggregate ? calculateAggregateData() : getFilteredData();
            if (data.length === 0) { notify('No data', 'error'); return; }
            
            // For aggregate data, include _orgUnit, _period, _count; for case data, include _timestamp
            const headers = Object.keys(data[0]).filter(k => {
                if (isAggregate) {
                    return k === '_orgUnit' || k === '_period' || k === '_count' || !k.startsWith('_');
                }
                return !k.startsWith('_') || k === '_timestamp';
            });
            
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                csv += headers.map(h => `"${String(row[h] || '').replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.settings.title}_${state.currentDataView}_data.csv`;
            a.click();
            URL.revokeObjectURL(url);
            notify('Downloaded!');
        };

        function renderDashboard() {
            const container = document.getElementById('dashboardContent');
            if (!container) return;
            
            const filteredData = getFilteredData();
            const aggregateData = calculateAggregateData();
            
            // Destroy old charts
            Object.values(state.chartInstances).forEach(chart => { if (chart) chart.destroy(); });
            state.chartInstances = {};
            
            // Stats
            const synced = state.collectedData.filter(d => d._synced).length;
            const pending = state.collectedData.filter(d => !d._synced && !d._syncError).length;
            const periodColumn = state.dhis2.periodColumn;
            const uniquePeriods = periodColumn ? [...new Set(filteredData.map(d => d[periodColumn]).filter(Boolean))].length : 0;
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            const uniqueOrgUnits = orgUnitColumn ? [...new Set(filteredData.map(d => d[orgUnitColumn]).filter(Boolean))].length : 0;
            
            // Build charts
            const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox'];
            const categoricalFields = state.fields.filter(f => categoricalTypes.includes(f.type));
            const numericFields = state.fields.filter(f => f.type === 'number');
            
            let chartsHtml = '';
            
            categoricalFields.forEach((field, idx) => {
                const valueCounts = {};
                filteredData.forEach(row => {
                    const value = row[field.name];
                    if (value) valueCounts[value] = (valueCounts[value] || 0) + 1;
                });
                
                if (Object.keys(valueCounts).length > 0) {
                    chartsHtml += `
                        <div class="chart-container">
                            <h4><span class="inline-icon">${getIcon('bar-chart-3', 16)}</span> ${escapeHtml(field.label)}</h4>
                            <div class="chart-wrapper">
                                <div class="chart-box"><canvas id="barChart_${idx}"></canvas></div>
                                <div class="chart-box"><canvas id="pieChart_${idx}"></canvas></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (numericFields.length > 0 && aggregateData.length > 0) {
                chartsHtml += `
                    <div class="chart-container">
                        <h4><span data-icon="hash" data-size="14"></span> Numeric Summary (Aggregate)</h4>
                        <div style="overflow-x:auto;">
                            <table class="data-table">
                                <thead><tr><th>Field</th><th>Total Sum</th><th>Average per Location</th><th>Min</th><th>Max</th></tr></thead>
                                <tbody>
                                    ${numericFields.map(field => {
                                        const values = aggregateData.map(d => d[field.name] || 0);
                                        const sum = values.reduce((a, b) => a + b, 0);
                                        const avg = values.length > 0 ? (sum / values.length).toFixed(2) : 0;
                                        const min = values.length > 0 ? Math.min(...values) : 0;
                                        const max = values.length > 0 ? Math.max(...values) : 0;
                                        return `<tr><td><strong>${escapeHtml(field.label)}</strong></td><td>${sum}</td><td>${avg}</td><td>${min}</td><td>${max}</td></tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="dashboard-header">
                    <img src="${state.settings.logo}" alt="Logo">
                    <h2><span class="inline-icon">${getIcon('bar-chart-2', 20)}</span> ${escapeHtml(state.settings.title)} - Dashboard</h2>
                    <p>ICF-SL Data Analytics</p>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card"><div class="stat-value">${filteredData.length}</div><div class="stat-label">Total Records</div></div>
                    <div class="stat-card success"><div class="stat-value">${synced}</div><div class="stat-label">Synced</div></div>
                    <div class="stat-card warning"><div class="stat-value">${pending}</div><div class="stat-label">Pending</div></div>
                    <div class="stat-card info"><div class="stat-value">${uniquePeriods}</div><div class="stat-label">Periods</div></div>
                    <div class="stat-card purple"><div class="stat-value">${uniqueOrgUnits}</div><div class="stat-label">Facilities</div></div>
                    <div class="stat-card"><div class="stat-value">${aggregateData.length}</div><div class="stat-label">Aggregate Rows</div></div>
                </div>
                
                ${chartsHtml || '<div class="chart-container"><p style="text-align:center;color:#868e96;padding:30px;"><span class="inline-icon">' + getIcon('bar-chart-3', 18) + '</span> Add categorical fields for charts</p></div>'}
            `;
            
            // Render charts
            setTimeout(() => {
                const colors = ['#004080', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'];
                
                categoricalFields.forEach((field, idx) => {
                    const valueCounts = {};
                    filteredData.forEach(row => {
                        const value = row[field.name];
                        if (value) valueCounts[value] = (valueCounts[value] || 0) + 1;
                    });
                    
                    if (Object.keys(valueCounts).length === 0) return;
                    
                    const labels = Object.keys(valueCounts);
                    const values = Object.values(valueCounts);
                    const total = values.reduce((a, b) => a + b, 0);
                    
                    const barCtx = document.getElementById(`barChart_${idx}`);
                    if (barCtx) {
                        state.chartInstances[`bar_${idx}`] = new Chart(barCtx, {
                            type: 'bar',
                            data: { labels, datasets: [{ label: 'Count', data: values, backgroundColor: colors.slice(0, labels.length) }] },
                            options: {
                                responsive: true,
                                plugins: { legend: { display: false }, title: { display: true, text: 'Bar Chart', font: { family: 'Oswald' } } },
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                    }
                    
                    const pieCtx = document.getElementById(`pieChart_${idx}`);
                    if (pieCtx) {
                        state.chartInstances[`pie_${idx}`] = new Chart(pieCtx, {
                            type: 'pie',
                            data: { 
                                labels: labels.map((l, i) => `${l} (${((values[i] / total) * 100).toFixed(1)}%)`), 
                                datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length) }] 
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { position: 'bottom', labels: { font: { family: 'Oswald', size: 10 } } }, title: { display: true, text: 'Pie Chart', font: { family: 'Oswald' } } }
                            }
                        });
                    }
                });
            }, 100);
        }

        function showTab(tab, btn) {
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            if (btn) btn.classList.add('active');
            
            if (tab === 'data') renderDataContent();
            if (tab === 'dashboard') renderDashboard();
        }

        function goToPage(pageIndex) {
            document.querySelectorAll('.form-page').forEach(p => p.style.display = 'none');
            document.querySelector(`.form-page[data-page="${pageIndex}"]`).style.display = 'block';
        }

        window.captureGPS = function(btn) {
            const container = btn.parentElement;
            const status = container.querySelector('.gps-status');
            const input = container.querySelector('input[type="hidden"]');
            status.innerHTML = '<span class="inline-icon">' + getIcon('loader', 12) + '</span> Getting location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const coords = `[${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}]`;
                        input.value = coords;
                        status.innerHTML = '<span class="inline-icon" style="color:#28a745;">' + getIcon('check-circle', 12) + '</span> ' + coords;
                    },
                    err => { status.innerHTML = '<span class="inline-icon" style="color:#dc3545;">' + getIcon('x-circle', 12) + '</span> ' + err.message; }
                );
            } else {
                status.innerHTML = '<span class="inline-icon" style="color:#dc3545;">' + getIcon('x-circle', 12) + '</span> Not supported';
            }
        };

        window.setRating = function(star, val) {
            const container = star.parentElement;
            container.querySelectorAll('span').forEach((s, i) => s.style.opacity = i < val ? '1' : '0.3');
            container.querySelector('input').value = val;
        };

        // Initialize
        init();
        initIcons();
    </script>
</body>
</html>
