<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL | DHIS2 Integration</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Inline SVG Icons (no external dependency)
        const icons = {
            'clipboard-list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',
            'home': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
            'file-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>',
            'save': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
            'eye': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
            'link': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
            'share-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
            'log-out': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
            'user': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            'user-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            'unlock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
            'calendar': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            'calendar-days': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',
            'type': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',
            'hash': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',
            'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'mail': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
            'phone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
            'align-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>',
            'chevron-down-square': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><polyline points="8 10 12 14 16 10"/></svg>',
            'circle-dot': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg>',
            'check-square': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
            'toggle-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="8" cy="12" r="3"/></svg>',
            'map-pin': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
            'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            'folder': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
            'text-cursor-input': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h1a3 3 0 0 1 3 3 3 3 0 0 1 3-3h1"/><path d="M13 20h-1a3 3 0 0 1-3-3 3 3 0 0 1-3 3H5"/><path d="M5 16H4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1"/><path d="M13 8h7a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-7"/><path d="M9 7v10"/></svg>',
            'sparkles': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
            'layout': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>',
            'download': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
            'settings': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            'mouse-pointer-click': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 9 5 12 1.8-5.2L21 14Z"/><path d="M7.2 2.2 8 5.1"/><path d="m5.1 8-2.9-.8"/><path d="M14 4.1 12 6"/><path d="m6 12-1.9 2"/></svg>',
            'chevron-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',
            'chevron-down': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
            'trash-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
            'globe': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
            'git-branch': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>',
            'flask-conical': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>',
            'rocket': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
            'refresh-cw': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',
            'smartphone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
            'copy': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
            'check-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            'x-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            'loader': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>',
            'database': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
            'building-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>',
            'bar-chart-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>',
            'inbox': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>',
            'plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            'pencil': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
            'file-text': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            'arrow-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>',
            'arrow-right': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
            'table': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',
            'bar-chart-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
            'wifi': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
            'wifi-off': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
            'check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
            'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
            'search': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
            'trending-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
            'edit-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',
            'list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>'
        };
        
        function getIcon(name, size = 16) {
            const svg = icons[name] || icons['file-text'];
            return svg.replace(/width="24"/g, `width="${size}"`).replace(/height="24"/g, `height="${size}"`);
        }
        
        function initIcons() {
            document.querySelectorAll('i[data-lucide]').forEach(el => {
                const name = el.getAttribute('data-lucide');
                const style = el.getAttribute('style') || '';
                const sizeMatch = style.match(/width:\s*(\d+)px/);
                const size = sizeMatch ? parseInt(sizeMatch[1]) : 16;
                el.outerHTML = `<span style="${style};display:inline-flex;align-items:center;">${getIcon(name, size)}</span>`;
            });
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; }
        .header h1 { font-size: 20px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        .header-btn.dhis2 { background: #17a2b8; color: white; }
        
        .main-container { display: none; margin-top: 70px; height: calc(100vh - 100px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        .field-type.special { background: #e8f4fc; border-color: #17a2b8; }
        .field-icon, .sidebar-icon { width: 16px; height: 16px; flex-shrink: 0; }
        .sidebar-title .sidebar-icon { width: 14px; height: 14px; vertical-align: middle; margin-right: 4px; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        .form-field { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field.dhis2-field { background: #e8f4fc; border-color: #17a2b8; }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 6px; }
        .field-action-btn:hover { background: #004080; color: white; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; margin-left: 8px; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        .field-badge.dhis2 { background: #d1ecf1; color: #0c5460; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; }
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 650px; width: 100%; border: 4px double #004080; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-btn { padding: 12px 24px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; border: none; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; }
        .modal-btn.danger { background: #dc3545; color: white; }
        .modal-btn.dhis2 { background: #17a2b8; color: white; }
        .modal-btn.purple { background: #6f42c1; color: white; }
        
        .dhis2-config-section { background: #e8f4fc; border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .dhis2-config-title { font-size: 13px; font-weight: 700; color: #17a2b8; margin-bottom: 12px; }
        .dhis2-input { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; margin-bottom: 10px; }
        .dhis2-input:focus { outline: none; border-color: #17a2b8; }
        .dhis2-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .dhis2-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dhis2-status { padding: 12px 15px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .dhis2-status.connected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .dhis2-status.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .dhis2-status.syncing { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        
        .sync-log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; margin-top: 15px; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        .log-entry.warning { color: #ffd43b; }
        .log-entry.info { color: #74c0fc; }
        
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; max-width: 350px; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        
        .viewer-container { display: none; min-height: 100vh; background: #e9ecef; }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 100; }
        .viewer-back-btn { background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; margin-right: 10px; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
        .viewer-nav-btn.active { box-shadow: 0 0 0 3px rgba(255,255,255,0.5); }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .viewer-radio-option:hover { border-color: #004080; background: #e8f4fc; }
        
        .page-header { background: #e8f4fc; margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; }
        .next-btn { background: #004080; color: white; }
        .submit-btn { background: #28a745; color: white; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; font-size: 10px; position: sticky; top: 0; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e8f4fc; }
        
        .sync-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .sync-badge.synced { background: #d4edda; color: #155724; }
        .sync-badge.pending { background: #fff3cd; color: #856404; }
        .sync-badge.failed { background: #f8d7da; color: #721c24; }
        
        .dhis2-info-bar { background: #17a2b8; color: white; padding: 8px 15px; font-size: 11px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .dhis2-info-item { display: flex; align-items: center; gap: 5px; }
        
        /* Dashboard Styles */
        .dashboard-container { max-width: 1100px; margin: 0 auto; }
        .dashboard-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .dashboard-header img { width: 60px; border-radius: 8px; margin-bottom: 10px; }
        .dashboard-header h2 { font-size: 18px; margin-bottom: 5px; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #000; }
        .stat-card.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; }
        .stat-card .stat-label { font-size: 10px; opacity: 0.9; margin-top: 5px; }
        .chart-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #e9ecef; }
        .chart-container h4 { color: #004080; font-size: 14px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .chart-wrapper { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .chart-box { flex: 1; min-width: 280px; max-width: 400px; }
        
        .filter-bar { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { color: white; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .filter-btn { padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-family: 'Oswald', sans-serif; font-weight: 700; }
        
        .help-text { font-size: 10px; color: #666; margin-top: 3px; font-style: italic; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .form-title-input { width: 100%; }
            .dhis2-row { grid-template-columns: 1fr; }
            .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
            .chart-box { min-width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>Form Builder Pro</h1>
                <p>DHIS2 Integration</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn"><i data-lucide="unlock" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"></i>Login</button>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <button type="submit" class="auth-btn"><i data-lucide="user-plus" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"></i>Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1><i data-lucide="clipboard-list" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;"></i>Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser"><i data-lucide="user" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>User</span>
            <button class="header-btn" onclick="showHome()"><i data-lucide="home" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Home</button>
            <button class="header-btn success" onclick="newForm()"><i data-lucide="file-plus" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>New</button>
            <button class="header-btn" onclick="saveCurrentForm()"><i data-lucide="save" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Save</button>
            <button class="header-btn" onclick="previewForm()"><i data-lucide="eye" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Preview</button>
            <button class="header-btn dhis2" onclick="openDhis2Config()"><i data-lucide="link" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>DHIS2</button>
            <button class="header-btn primary" onclick="shareForm()"><i data-lucide="share-2" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Share</button>
            <button class="header-btn danger" onclick="logout()"><i data-lucide="log-out" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title"><i data-lucide="link" class="sidebar-icon"></i> DHIS2 Fields</h3>
                <div class="field-type special" data-type="period"><i data-lucide="calendar" class="field-icon"></i> Period (YYYYMM)</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><i data-lucide="text-cursor-input" class="sidebar-icon"></i> Basic Fields</h3>
                <div class="field-type" data-type="text"><i data-lucide="type" class="field-icon"></i> Text Input</div>
                <div class="field-type" data-type="number"><i data-lucide="hash" class="field-icon"></i> Number</div>
                <div class="field-type" data-type="date"><i data-lucide="calendar-days" class="field-icon"></i> Date</div>
                <div class="field-type" data-type="time"><i data-lucide="clock" class="field-icon"></i> Time</div>
                <div class="field-type" data-type="email"><i data-lucide="mail" class="field-icon"></i> Email</div>
                <div class="field-type" data-type="phone"><i data-lucide="phone" class="field-icon"></i> Phone</div>
                <div class="field-type" data-type="textarea"><i data-lucide="align-left" class="field-icon"></i> Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><i data-lucide="check-square" class="sidebar-icon"></i> Selection Fields</h3>
                <div class="field-type" data-type="select"><i data-lucide="chevron-down-square" class="field-icon"></i> Dropdown</div>
                <div class="field-type" data-type="radio"><i data-lucide="circle-dot" class="field-icon"></i> Radio Buttons</div>
                <div class="field-type" data-type="checkbox"><i data-lucide="check-square" class="field-icon"></i> Checkboxes</div>
                <div class="field-type" data-type="yesno"><i data-lucide="toggle-left" class="field-icon"></i> Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><i data-lucide="sparkles" class="sidebar-icon"></i> Special Fields</h3>
                <div class="field-type" data-type="gps"><i data-lucide="map-pin" class="field-icon"></i> GPS Location</div>
                <div class="field-type" data-type="rating"><i data-lucide="star" class="field-icon"></i> Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><i data-lucide="layout" class="sidebar-icon"></i> Structure</h3>
                <div class="field-type" data-type="section"><i data-lucide="folder" class="field-icon"></i> Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title (becomes Dataset name)...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount"><i data-lucide="bar-chart-3" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>0 fields</span>
            </div>
            <div id="dhis2InfoBar" class="dhis2-info-bar" style="display:none;">
                <div class="dhis2-info-item"><i data-lucide="link" style="width:14px;height:14px;"></i> <span id="dhis2ServerName">Not connected</span></div>
                <div class="dhis2-info-item"><i data-lucide="database" style="width:14px;height:14px;"></i> Dataset: <span id="dhis2DatasetName">-</span></div>
                <div class="dhis2-info-item"><i data-lucide="building-2" style="width:14px;height:14px;"></i> Org Units: <span id="dhis2OrgUnitCount">0</span></div>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p>ICF-SL Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="margin-bottom:12px;"><i data-lucide="download" style="width:48px;height:48px;color:#adb5bd;"></i></p>
                            <p style="font-weight:600;">Click field types to add them</p>
                            <p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period field for DHIS2 sync</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title"><i data-lucide="settings" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="margin-bottom:12px;"><i data-lucide="mouse-pointer-click" style="width:32px;height:32px;color:#868e96;"></i></p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    
    <!-- Footer -->
    <footer class="footer"> 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | Form Builder Pro</footer>

    <!-- DHIS2 Configuration Modal -->
    <div class="modal-overlay" id="dhis2Modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i data-lucide="link" style="width:18px;height:18px;vertical-align:middle;margin-right:8px;"></i>DHIS2 Configuration</h3>
                <button class="modal-close" onclick="closeModal('dhis2Modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dhis2Status" class="dhis2-status disconnected">
                    <i data-lucide="x-circle" style="width:16px;height:16px;color:#dc3545;"></i> <span>Not Connected</span>
                </div>
                
                <div class="dhis2-config-section">
                    <div class="dhis2-config-title"><i data-lucide="globe" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>Server Connection</div>
                    <label class="dhis2-label">DHIS2 Server URL</label>
                    <input type="url" class="dhis2-input" id="dhis2Url" placeholder="https://your-dhis2-instance.org" autocomplete="off">
                    
                    <div class="dhis2-row">
                        <div>
                            <label class="dhis2-label">Username</label>
                            <input type="text" class="dhis2-input" id="dhis2Username" placeholder="Enter username" autocomplete="off">
                        </div>
                        <div>
                            <label class="dhis2-label">Password</label>
                            <input type="password" class="dhis2-input" id="dhis2Password" placeholder="Enter password" autocomplete="new-password">
                        </div>
                    </div>
                </div>
                
                <div class="dhis2-config-section">
                    <div class="dhis2-config-title"><i data-lucide="git-branch" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>Field Mapping</div>
                    <div class="dhis2-row">
                        <div>
                            <label class="dhis2-label">Org Unit Level</label>
                            <select class="dhis2-input" id="dhis2OrgLevel">
                                <option value="1">Level 1 (National)</option>
                                <option value="2">Level 2 (Region)</option>
                                <option value="3">Level 3 (District)</option>
                                <option value="4">Level 4 (Chiefdom)</option>
                                <option value="5" selected>Level 5 (Facility)</option>
                                <option value="6">Level 6</option>
                            </select>
                        </div>
                        <div>
                            <label class="dhis2-label">Org Unit Column in Form</label>
                            <select class="dhis2-input" id="dhis2OrgUnitColumn">
                                <option value="">-- Select Field --</option>
                            </select>
                            <p class="help-text">Field containing facility names (e.g., "ALIE CHC")</p>
                        </div>
                    </div>
                    <div class="dhis2-row">
                        <div>
                            <label class="dhis2-label">Period Column in Form</label>
                            <select class="dhis2-input" id="dhis2PeriodColumn">
                                <option value="">-- Select Field --</option>
                            </select>
                        </div>
                        <div>
                            <label class="dhis2-label">Period Type</label>
                            <select class="dhis2-input" id="dhis2PeriodType">
                                <option value="Monthly" selected>Monthly</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Daily">Daily</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="modal-btn dhis2" onclick="testConnection()"><i data-lucide="flask-conical" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Test Connection</button>
                    <button class="modal-btn primary" onclick="saveConfig()"><i data-lucide="save" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Save Config</button>
                </div>
                
                <div class="dhis2-config-section">
                    <div class="dhis2-config-title"><i data-lucide="rocket" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>Setup & Sync Actions</div>
                    <p style="font-size:11px;color:#666;margin-bottom:15px;">
                        <strong>Setup DHIS2:</strong> Creates Dataset (from form name) and Data Elements (from fields)<br>
                        <strong>Sync Data:</strong> Pushes collected data to DHIS2 matching org units at selected level
                    </p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="modal-btn success" onclick="setupDhis2()" style="flex:1;">
                            <i data-lucide="settings" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Setup DHIS2
                        </button>
                        <button class="modal-btn purple" onclick="syncDataToDhis2All()" style="flex:1;">
                            <i data-lucide="refresh-cw" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Sync Data
                        </button>
                    </div>
                </div>
                
                <div class="sync-log" id="syncLog">
                    <div class="log-entry info">Ready...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header" style="background:linear-gradient(135deg,#004080,#002855);">
                <h3><i data-lucide="share-2" style="width:18px;height:18px;vertical-align:middle;margin-right:8px;"></i>Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div class="qr-box"><div id="qrCode"></div></div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;"><i data-lucide="smartphone" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"></i>Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()"><i data-lucide="copy" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Copy URL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ==================== GOOGLE APPS SCRIPT PROXY ====================
        const PROXY_URL = 'https://script.google.com/macros/s/AKfycbyRXc68PYSmDSCYPakAS8Gc9R00kRjmsMYoDujPYMItyquXfwMAJUtRqXLiDlNWbSfDQQ/exec';

        // ==================== GENERATE PERIODS ====================
        function generatePeriods() {
            const periods = [];
            for (let year = 2020; year <= 2026; year++) {
                for (let month = 1; month <= 12; month++) {
                    periods.push(`${year}${String(month).padStart(2, '0')}`);
                }
            }
            return periods;
        }
        const PERIODS = generatePeriods();

        // ==================== GLOBAL STATE ====================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            isSharedMode: false,
            settings: {
                title: 'My Data Collection Form',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg'
            },
            dhis2: {
                url: '',
                username: '',
                password: '',
                orgUnitLevel: 5,
                orgUnitColumn: '',
                periodColumn: '',
                periodType: 'Monthly',
                connected: false,
                serverInfo: null,
                datasetId: null,
                datasetName: '',
                dataElements: {},
                orgUnits: [],
                orgUnitMap: {}
            },
            collectedData: [],
            chartInstances: {}
        };

        const fieldDefs = {
            period: { label: 'Period', icon: 'calendar', defaultLabel: 'Reporting Period', valueType: 'TEXT', isDhis2: true },
            text: { label: 'Text', icon: 'type', defaultLabel: 'Text Field', valueType: 'TEXT' },
            number: { label: 'Number', icon: 'hash', defaultLabel: 'Number Field', valueType: 'NUMBER' },
            date: { label: 'Date', icon: 'calendar-days', defaultLabel: 'Date Field', valueType: 'DATE' },
            time: { label: 'Time', icon: 'clock', defaultLabel: 'Time Field', valueType: 'TIME' },
            email: { label: 'Email', icon: 'mail', defaultLabel: 'Email Address', valueType: 'TEXT' },
            phone: { label: 'Phone', icon: 'phone', defaultLabel: 'Phone Number', valueType: 'PHONE_NUMBER' },
            textarea: { label: 'Long Text', icon: 'align-left', defaultLabel: 'Long Text', valueType: 'LONG_TEXT' },
            select: { label: 'Dropdown', icon: 'chevron-down-square', defaultLabel: 'Dropdown', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'circle-dot', defaultLabel: 'Radio Choice', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: 'check-square', defaultLabel: 'Checkbox', valueType: 'TRUE_ONLY', options: ['Option 1', 'Option 2'] },
            yesno: { label: 'Yes/No', icon: 'toggle-left', defaultLabel: 'Yes/No Question', valueType: 'BOOLEAN' },
            gps: { label: 'GPS', icon: 'map-pin', defaultLabel: 'GPS Location', valueType: 'COORDINATE' },
            rating: { label: 'Rating', icon: 'star', defaultLabel: 'Rating', valueType: 'INTEGER', max: 5 },
            section: { label: 'Section', icon: 'folder', defaultLabel: 'New Section', valueType: null }
        };

        // ==================== INITIALIZATION ====================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    state.isSharedMode = true;
                    renderSharedForm(data);
                    return;
                } catch (err) { console.error('Decode error:', err); }
            }
            
            loadFromStorage();
            loadDhis2Config();
            setupEventListeners();
            checkAuth();
        }

        function setupEventListeners() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab)));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.querySelectorAll('.field-type').forEach(el => el.addEventListener('click', () => addField(el.dataset.type)));
            document.getElementById('formTitle').addEventListener('input', (e) => {
                state.settings.title = e.target.value;
                document.getElementById('previewTitle').textContent = e.target.value;
                saveToStorage();
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        // ==================== DHIS2 API WITH PROXY ====================
        function getProxiedUrl(url) {
            return PROXY_URL + '?url=' + encodeURIComponent(url);
        }

        async function dhis2Request(endpoint, method = 'GET', payload = null) {
            const { url, username, password } = state.dhis2;
            if (!url || !username || !password) {
                throw new Error('DHIS2 not configured');
            }

            const serverUrl = url.replace(/\/$/, '');
            const apiUrl = `${serverUrl}/api/${endpoint}`;
            const proxiedUrl = getProxiedUrl(apiUrl);
            
            const options = {
                method: method,
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`),
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            if (payload && method !== 'GET') {
                options.body = JSON.stringify(payload);
            }
            
            try {
                const response = await fetch(proxiedUrl, options);
                const text = await response.text();
                
                let data;
                try { data = JSON.parse(text); } catch (e) { data = text; }
                
                return { success: response.ok, status: response.status, data: data };
            } catch (error) {
                return { success: false, status: 0, error: error.message };
            }
        }

        async function testConnection() {
            const url = document.getElementById('dhis2Url').value.trim();
            const username = document.getElementById('dhis2Username').value.trim();
            const password = document.getElementById('dhis2Password').value;
            
            if (!url || !username || !password) {
                notify('Please fill server URL, username and password', 'error');
                return;
            }
            
            state.dhis2.url = url;
            state.dhis2.username = username;
            state.dhis2.password = password;
            state.dhis2.orgUnitLevel = parseInt(document.getElementById('dhis2OrgLevel').value);
            
            updateStatus('syncing', 'Testing connection...');
            addLog('info', 'Connecting to DHIS2...');
            
            try {
                const result = await dhis2Request('system/info.json');
                
                if (result.success && result.data) {
                    state.dhis2.connected = true;
                    state.dhis2.serverInfo = result.data;
                    updateStatus('connected', `Connected to ${result.data.systemName || 'DHIS2'}`);
                    addLog('success', ` Connected: ${result.data.systemName || 'DHIS2'} v${result.data.version || ''}`);
                    
                    document.getElementById('dhis2ServerName').textContent = result.data.systemName || 'DHIS2';
                    document.getElementById('dhis2InfoBar').style.display = 'flex';
                    
                    // Fetch org units for the selected level
                    await fetchOrgUnitsForLevel();
                    
                    saveConfig();
                    notify('Connected to DHIS2!', 'success');
                } else {
                    state.dhis2.connected = false;
                    updateStatus('disconnected', 'Connection failed');
                    addLog('error', ` Failed: ${result.error || 'Status ' + result.status}`);
                    notify('Connection failed. Check credentials.', 'error');
                }
            } catch (error) {
                state.dhis2.connected = false;
                updateStatus('disconnected', 'Connection error');
                addLog('error', ` Error: ${error.message}`);
                notify('Connection error: ' + error.message, 'error');
            }
        }

        async function fetchOrgUnitsForLevel() {
            const level = state.dhis2.orgUnitLevel;
            addLog('info', `Fetching org units at level ${level}...`);
            
            const result = await dhis2Request(`organisationUnits.json?fields=id,name,displayName,code&filter=level:eq:${level}&paging=false`);
            
            if (result.success && result.data?.organisationUnits) {
                state.dhis2.orgUnits = result.data.organisationUnits;
                state.dhis2.orgUnitMap = {};
                
                result.data.organisationUnits.forEach(ou => {
                    const names = [
                        ou.displayName?.toLowerCase().trim(),
                        ou.name?.toLowerCase().trim(),
                        ou.code?.toLowerCase().trim()
                    ].filter(Boolean);
                    
                    names.forEach(name => {
                        state.dhis2.orgUnitMap[name] = ou.id;
                    });
                });
                
                document.getElementById('dhis2OrgUnitCount').textContent = state.dhis2.orgUnits.length;
                addLog('success', ` Loaded ${state.dhis2.orgUnits.length} org units at level ${level}`);
            } else {
                addLog('warning', `Could not load org units: ${result.error || 'Unknown error'}`);
            }
        }

        function updateStatus(type, message) {
            const el = document.getElementById('dhis2Status');
            el.className = `dhis2-status ${type}`;
            const iconName = type === 'connected' ? 'check-circle' : type === 'syncing' ? 'loader' : 'x-circle';
            const color = type === 'connected' ? '#28a745' : type === 'syncing' ? '#ffc107' : '#dc3545';
            el.innerHTML = `<i data-lucide="${iconName}" style="width:16px;height:16px;color:${color};"></i> <span>${message}</span>`;
            initIcons();
        }

        function addLog(type, message) {
            const log = document.getElementById('syncLog');
            if (!log) return;
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="log-entry ${type}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            const log = document.getElementById('syncLog');
            if (log) log.innerHTML = '';
        }

        function saveConfig() {
            state.dhis2.url = document.getElementById('dhis2Url').value.trim();
            state.dhis2.username = document.getElementById('dhis2Username').value.trim();
            state.dhis2.password = document.getElementById('dhis2Password').value;
            state.dhis2.orgUnitLevel = parseInt(document.getElementById('dhis2OrgLevel').value);
            state.dhis2.orgUnitColumn = document.getElementById('dhis2OrgUnitColumn').value;
            state.dhis2.periodColumn = document.getElementById('dhis2PeriodColumn').value;
            state.dhis2.periodType = document.getElementById('dhis2PeriodType').value;
            
            localStorage.setItem('dhis2Config', JSON.stringify({
                url: state.dhis2.url,
                username: state.dhis2.username,
                password: state.dhis2.password,
                orgUnitLevel: state.dhis2.orgUnitLevel,
                orgUnitColumn: state.dhis2.orgUnitColumn,
                periodColumn: state.dhis2.periodColumn,
                periodType: state.dhis2.periodType
            }));
            
            notify('Config saved!');
        }

        function loadDhis2Config() {
            const saved = localStorage.getItem('dhis2Config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    state.dhis2 = { ...state.dhis2, ...config };
                } catch (e) {}
            }
        }

        function updateFieldDropdowns() {
            const orgUnitSelect = document.getElementById('dhis2OrgUnitColumn');
            const periodSelect = document.getElementById('dhis2PeriodColumn');
            
            if (!orgUnitSelect || !periodSelect) return;
            
            const fields = state.fields.filter(f => f.type !== 'section');
            
            orgUnitSelect.innerHTML = '<option value="">-- Select Field --</option>';
            periodSelect.innerHTML = '<option value="">-- Select Field --</option>';
            
            fields.forEach(f => {
                orgUnitSelect.innerHTML += `<option value="${f.name}" ${state.dhis2.orgUnitColumn === f.name ? 'selected' : ''}>${f.label}</option>`;
                periodSelect.innerHTML += `<option value="${f.name}" ${state.dhis2.periodColumn === f.name ? 'selected' : ''}>${f.label}</option>`;
            });
            
            // Auto-select period field
            const periodField = fields.find(f => f.type === 'period');
            if (periodField && !state.dhis2.periodColumn) {
                state.dhis2.periodColumn = periodField.name;
                periodSelect.value = periodField.name;
            }
        }

        // ==================== SETUP DHIS2 (Dataset & Elements Only) ====================
        async function setupDhis2() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            const dataFields = state.fields.filter(f => f.type !== 'section' && f.type !== 'period');
            if (dataFields.length === 0) {
                notify('Add data fields to your form first', 'error');
                return;
            }
            
            clearLog();
            addLog('info', 'Setting up DHIS2...');
            updateStatus('syncing', 'Setting up...');
            
            try {
                // Step 1: Create Data Elements
                addLog('info', 'Creating Data Elements...');
                const createdElements = [];
                
                for (const field of dataFields) {
                    const def = fieldDefs[field.type];
                    const code = field.name.toUpperCase().replace(/[^A-Z0-9_]/g, '_');
                    
                    // Check if exists
                    const checkResult = await dhis2Request(`dataElements.json?filter=code:eq:${code}&fields=id,name`);
                    
                    if (checkResult.success && checkResult.data?.dataElements?.length > 0) {
                        const existing = checkResult.data.dataElements[0];
                        state.dhis2.dataElements[field.id] = existing.id;
                        createdElements.push({ id: existing.id });
                        addLog('info', `   Exists: ${field.label}`);
                    } else {
                        const payload = {
                            name: field.label,
                            shortName: field.label.substring(0, 50),
                            code: code,
                            domainType: 'AGGREGATE',
                            valueType: def?.valueType || 'TEXT',
                            aggregationType: field.type === 'number' ? 'SUM' : 'NONE'
                        };
                        
                        const createResult = await dhis2Request('dataElements', 'POST', payload);
                        
                        if (createResult.success && createResult.data?.response?.uid) {
                            const newId = createResult.data.response.uid;
                            state.dhis2.dataElements[field.id] = newId;
                            createdElements.push({ id: newId });
                            addLog('success', `   Created: ${field.label}`);
                        } else {
                            addLog('error', `   Failed: ${field.label} - ${JSON.stringify(createResult.data?.message || createResult.error)}`);
                        }
                    }
                    await sleep(200);
                }
                
                addLog('success', ` ${createdElements.length} data elements ready`);
                
                // Step 2: Get org units at selected level (if not already loaded)
                if (state.dhis2.orgUnits.length === 0) {
                    await fetchOrgUnitsForLevel();
                }
                
                // Step 3: Create or Update Dataset
                const datasetName = state.settings.title;
                const datasetCode = datasetName.toUpperCase().replace(/[^A-Z0-9]/g, '_').substring(0, 30);
                
                addLog('info', `Setting up Dataset: ${datasetName}...`);
                
                const dsCheckResult = await dhis2Request(`dataSets.json?filter=code:eq:${datasetCode}&fields=id,name`);
                
                if (dsCheckResult.success && dsCheckResult.data?.dataSets?.length > 0) {
                    const existingDs = dsCheckResult.data.dataSets[0];
                    state.dhis2.datasetId = existingDs.id;
                    state.dhis2.datasetName = existingDs.name;
                    addLog('info', `   Dataset exists: ${existingDs.id}`);
                    
                    // Update dataset
                    const fullDs = await dhis2Request(`dataSets/${existingDs.id}.json?fields=:owner`);
                    if (fullDs.success && fullDs.data) {
                        const merged = {
                            ...fullDs.data,
                            dataSetElements: createdElements.map(de => ({ 
                                dataSet: { id: existingDs.id },
                                dataElement: { id: de.id } 
                            })),
                            organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                        };
                        
                        const updateResult = await dhis2Request(`dataSets/${existingDs.id}`, 'PUT', merged);
                        if (updateResult.success) {
                            addLog('success', `   Dataset updated with ${createdElements.length} elements and ${state.dhis2.orgUnits.length} org units`);
                        } else {
                            addLog('warning', `   Could not update dataset: ${updateResult.error || 'Unknown'}`);
                        }
                    }
                } else {
                    const createPayload = {
                        name: datasetName,
                        shortName: datasetName.substring(0, 50),
                        code: datasetCode,
                        periodType: state.dhis2.periodType,
                        dataSetElements: createdElements.map(de => ({ dataElement: { id: de.id } })),
                        organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                    };
                    
                    const createResult = await dhis2Request('dataSets', 'POST', createPayload);
                    
                    if (createResult.success && createResult.data?.response?.uid) {
                        state.dhis2.datasetId = createResult.data.response.uid;
                        state.dhis2.datasetName = datasetName;
                        addLog('success', `   Dataset created: ${state.dhis2.datasetId}`);
                    } else {
                        addLog('error', `   Failed to create dataset: ${JSON.stringify(createResult.data?.message || createResult.error)}`);
                    }
                }
                
                document.getElementById('dhis2DatasetName').textContent = datasetName;
                
                updateStatus('connected', 'Setup complete!');
                addLog('success', 'DHIS2 SETUP COMPLETE!');
                addLog('info', 'You can now collect data and sync later.');
                saveToStorage();
                notify('DHIS2 setup complete!', 'success');
                
            } catch (error) {
                updateStatus('disconnected', 'Setup failed');
                addLog('error', ` Error: ${error.message}`);
                notify('Setup failed: ' + error.message, 'error');
            }
        }

        // ==================== SYNC DATA TO DHIS2 ====================
        async function syncDataToDhis2All() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            if (!state.dhis2.datasetId) {
                notify('Run Setup DHIS2 first to create the dataset', 'error');
                return;
            }
            
            const pendingData = state.collectedData.filter(d => !d._synced);
            if (pendingData.length === 0) {
                notify('No pending data to sync', 'info');
                addLog('info', 'No pending data to sync');
                return;
            }
            
            clearLog();
            addLog('info', `Syncing ${pendingData.length} records to DHIS2...`);
            updateStatus('syncing', 'Syncing data...');
            
            // Ensure org units are loaded
            if (state.dhis2.orgUnits.length === 0) {
                await fetchOrgUnitsForLevel();
            }
            
            await syncDataRecords(pendingData);
            
            updateStatus('connected', 'Sync complete');
            saveToStorage();
            saveFormToList();
        }

        async function syncDataRecords(dataRecords) {
            const orgUnitColumn = state.dhis2.orgUnitColumn;
            const periodColumn = state.dhis2.periodColumn;
            
            let success = 0, failed = 0;
            
            for (const record of dataRecords) {
                // Get period from form data
                let period = record[periodColumn];
                if (!period) {
                    const ts = new Date(record._timestamp || Date.now());
                    period = `${ts.getFullYear()}${String(ts.getMonth() + 1).padStart(2, '0')}`;
                    addLog('warning', `   No period in record, using: ${period}`);
                }
                
                // Get org unit from form data and match to DHIS2
                const orgUnitValue = record[orgUnitColumn];
                let orgUnitId = null;
                
                if (orgUnitValue) {
                    const searchKey = orgUnitValue.toLowerCase().trim();
                    orgUnitId = state.dhis2.orgUnitMap[searchKey];
                    
                    // Try partial match
                    if (!orgUnitId) {
                        for (const [name, id] of Object.entries(state.dhis2.orgUnitMap)) {
                            if (name.includes(searchKey) || searchKey.includes(name)) {
                                orgUnitId = id;
                                break;
                            }
                        }
                    }
                }
                
                if (!orgUnitId) {
                    addLog('error', `   No matching org unit for: "${orgUnitValue || 'empty'}"`);
                    record._syncError = 'No matching org unit: ' + (orgUnitValue || 'empty');
                    failed++;
                    continue;
                }
                
                // Build data values (exclude period field and non-data fields)
                const dataValues = [];
                const dataFields = state.fields.filter(f => f.type !== 'section' && f.type !== 'period');
                
                dataFields.forEach(field => {
                    const deId = state.dhis2.dataElements[field.id];
                    const value = record[field.name];
                    
                    if (deId && value !== undefined && value !== null && value !== '') {
                        dataValues.push({
                            dataElement: deId,
                            value: String(value),
                            period: period,
                            orgUnit: orgUnitId
                        });
                    }
                });
                
                if (dataValues.length === 0) {
                    addLog('warning', `   No values in record`);
                    failed++;
                    continue;
                }
                
                const payload = { dataValues: dataValues };
                const result = await dhis2Request('dataValueSets', 'POST', payload);
                
                if (result.success) {
                    record._synced = true;
                    record._syncedAt = new Date().toISOString();
                    delete record._syncError;
                    success++;
                    addLog('success', `   Synced: ${orgUnitValue} / ${period} (${dataValues.length} values)`);
                } else {
                    record._syncError = result.error || JSON.stringify(result.data?.message) || 'Unknown error';
                    failed++;
                    addLog('error', `   Failed: ${orgUnitValue} / ${period} - ${record._syncError}`);
                }
                
                await sleep(300);
            }
            
            addLog('info', `Sync complete: ${success} success, ${failed} failed`);
            if (success > 0) notify(`Synced ${success} records!`, 'success');
            if (failed > 0) notify(`${failed} records failed`, 'error');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== UI HELPERS ====================
        function openDhis2Config() {
            loadDhis2Config();
            
            // Populate form fields
            document.getElementById('dhis2Url').value = state.dhis2.url || '';
            document.getElementById('dhis2Username').value = state.dhis2.username || '';
            document.getElementById('dhis2Password').value = state.dhis2.password || '';
            document.getElementById('dhis2OrgLevel').value = state.dhis2.orgUnitLevel || 5;
            document.getElementById('dhis2PeriodType').value = state.dhis2.periodType || 'Monthly';
            
            updateFieldDropdowns();
            document.getElementById('dhis2Modal').classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : type === 'info' ? ' info' : '');
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ==================== AUTH ====================
        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) { state.user = JSON.parse(saved); showBuilder(); }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) { state.user = user; localStorage.setItem('formBuilderUser', JSON.stringify(user)); showBuilder(); }
            else { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Invalid credentials'; }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Email exists'; return; }
            users.push({ id: Date.now().toString(), name, email, password });
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            document.getElementById('authSuccess').style.display = 'block';
            document.getElementById('authSuccess').textContent = 'Account created! Please login.';
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = state.user?.name || 'User';
            renderFields();
            initIcons();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('formBuilderUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ==================== FORM BUILDER ====================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;
            
            // Check if period already exists
            if (type === 'period' && state.fields.find(f => f.type === 'period')) {
                notify('Period field already exists', 'error');
                return;
            }
            
            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                max: def.max || 5
            };
            
            // Set default name for period field
            if (type === 'period') {
                field.name = 'period';
                field.label = 'Reporting Period';
            }
            
            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
        }

        function removeField(id) {
            event?.stopPropagation();
            if (!confirm('Delete field?')) return;
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) { state.selectedFieldId = null; renderProperties(); }
            renderFields();
            saveToStorage();
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) { field[prop] = value; renderFields(); saveToStorage(); }
        }

        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const dataFieldCount = state.fields.filter(f => f.type !== 'section' && f.type !== 'period').length;
            document.getElementById('fieldCount').textContent = dataFieldCount + ' data elements';
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="margin-bottom:12px;"><i data-lucide="download" style="width:48px;height:48px;color:#adb5bd;"></i></p><p style="font-weight:600;">Click field types to add them</p><p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period field for DHIS2 sync</p>';
                initIcons();
                return;
            }
            
            dropZone.classList.add('has-fields');
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') {
                    return `<div class="section-divider ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}">
                        <span><i data-lucide="folder" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"></i>${f.label.toUpperCase()}</span>
                        <div style="display:flex;gap:5px;">
                            <button class="field-action-btn" onclick="moveField('${f.id}','up')"><i data-lucide="chevron-up" style="width:14px;height:14px;"></i></button>
                            <button class="field-action-btn" onclick="moveField('${f.id}','down')"><i data-lucide="chevron-down" style="width:14px;height:14px;"></i></button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')"><i data-lucide="trash-2" style="width:14px;height:14px;"></i></button>
                        </div>
                    </div>`;
                }
                
                const def = fieldDefs[f.type];
                const isDhis2Field = f.type === 'period';
                const iconName = def?.icon || 'file-text';
                
                return `<div class="form-field ${f.id === state.selectedFieldId ? 'selected' : ''} ${isDhis2Field ? 'dhis2-field' : ''}" data-id="${f.id}">
                    <div class="form-field-header">
                        <span class="form-field-label"><i data-lucide="${iconName}" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>${f.label}</span>
                        <div class="form-field-actions">
                            <button class="field-action-btn" onclick="moveField('${f.id}','up')"><i data-lucide="chevron-up" style="width:14px;height:14px;"></i></button>
                            <button class="field-action-btn" onclick="moveField('${f.id}','down')"><i data-lucide="chevron-down" style="width:14px;height:14px;"></i></button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')"><i data-lucide="trash-2" style="width:14px;height:14px;"></i></button>
                        </div>
                    </div>
                    <div style="font-size:10px;color:#868e96;">
                        Code: <code>${f.name}</code>
                        ${f.required ? '<span class="field-badge required">Required</span>' : ''}
                        ${isDhis2Field ? '<span class="field-badge dhis2">DHIS2</span>' : ''}
                    </div>
                </div>`;
            }).join('');
            
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id);
                });
            });
            
            initIcons();
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="margin-bottom:12px;"><i data-lucide="mouse-pointer-click" style="width:32px;height:32px;color:#868e96;"></i></p><p>Select a field to edit</p></div>';
                initIcons();
                return;
            }
            
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `
                <div class="prop-section">
                    <div class="prop-section-title"><i data-lucide="edit-3" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Field Settings</div>
                    <div class="property-group">
                        <label class="property-label">Label</label>
                        <input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Code / Name</label>
                        <input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}">
                    </div>
                    ${field.type !== 'section' ? `
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                                <span>Required Field</span>
                            </label>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `
                    <div class="prop-section">
                        <div class="prop-section-title"><i data-lucide="list" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Options (one per line)</div>
                        <textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            initIcons();
            
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
        }

        // ==================== STORAGE ====================
        function saveToStorage() {
            localStorage.setItem('formBuilderAutoSync', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter,
                collectedData: state.collectedData,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    datasetName: state.dhis2.datasetName,
                    dataElements: state.dhis2.dataElements,
                    orgUnitColumn: state.dhis2.orgUnitColumn,
                    periodColumn: state.dhis2.periodColumn
                }
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderAutoSync');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                    state.collectedData = data.collectedData || [];
                    if (data.dhis2) {
                        state.dhis2.datasetId = data.dhis2.datasetId;
                        state.dhis2.datasetName = data.dhis2.datasetName;
                        state.dhis2.dataElements = data.dhis2.dataElements || {};
                        state.dhis2.orgUnitColumn = data.dhis2.orgUnitColumn || '';
                        state.dhis2.periodColumn = data.dhis2.periodColumn || '';
                    }
                    
                    document.getElementById('formTitle').value = state.settings.title;
                    document.getElementById('previewTitle').textContent = state.settings.title;
                } catch (e) {}
            }
        }

        // ==================== FORM OPERATIONS ====================
        function newForm() {
            if (state.fields.length > 0 && !confirm('Create new form?')) return;
            state.fields = [];
            state.selectedFieldId = null;
            state.fieldCounter = 0;
            state.dhis2.dataElements = {};
            state.dhis2.datasetId = null;
            state.collectedData = [];
            
            const title = prompt('Form/Dataset Name:', 'New Form');
            if (title) {
                state.settings.title = title;
                document.getElementById('formTitle').value = title;
                document.getElementById('previewTitle').textContent = title;
            }
            saveToStorage();
            renderFields();
            renderProperties();
            notify('New form created!');
        }

        function saveCurrentForm() {
            if (state.fields.length === 0) { notify('Add fields first!', 'error'); return; }
            saveToStorage();
            saveFormToList();
            notify('Saved!');
        }

        function saveFormToList() {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const existingIndex = forms.findIndex(f => f.title === state.settings.title);
            const formEntry = {
                id: existingIndex >= 0 ? forms[existingIndex].id : 'form_' + Date.now(),
                title: state.settings.title,
                fieldCount: state.fields.filter(f => f.type !== 'section').length,
                updatedAt: new Date().toISOString(),
                fields: state.fields,
                settings: state.settings,
                collectedData: state.collectedData,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    datasetName: state.dhis2.datasetName,
                    dataElements: state.dhis2.dataElements,
                    orgUnitColumn: state.dhis2.orgUnitColumn,
                    periodColumn: state.dhis2.periodColumn
                }
            };
            if (existingIndex >= 0) forms[existingIndex] = formEntry;
            else forms.push(formEntry);
            localStorage.setItem('formBuilderForms', JSON.stringify(forms));
        }

        function previewForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            state.isSharedMode = false;
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('viewerContainer').classList.add('show');
            renderFormViewer();
        }

        function closeViewer() {
            document.getElementById('viewerContainer').classList.remove('show');
            document.querySelector('.header').style.display = '';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = '';
        }

        function shareForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            
            const formData = {
                s: { t: state.settings.title, l: state.settings.logo },
                f: state.fields.map(f => ({ i: f.id, y: f.type, l: f.label, n: f.name, r: f.required, o: f.options, mx: f.max })),
                d: state.dhis2.datasetId ? { 
                    id: state.dhis2.datasetId, 
                    de: state.dhis2.dataElements,
                    oc: state.dhis2.orgUnitColumn,
                    pc: state.dhis2.periodColumn
                } : null
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                const shareUrl = window.location.origin + window.location.pathname + '?d=' + encodeURIComponent(encoded);
                
                document.getElementById('shareUrl').textContent = shareUrl;
                
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: shareUrl, width: 200, height: 200, colorDark: '#004080' });
                
                saveFormToList();
                document.getElementById('shareModal').classList.add('show');
            } catch (err) { notify('Error: ' + err.message, 'error'); }
        }

        function copyShareUrl() {
            navigator.clipboard.writeText(document.getElementById('shareUrl').textContent)
                .then(() => notify('Copied to clipboard!'))
                .catch(() => notify('Copy failed', 'error'));
        }

        // ==================== HOME ====================
        function showHome() {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            let formsHtml = forms.length === 0 ? `
                <div style="text-align:center;padding:60px;color:#868e96;">
                    <p style="margin-bottom:12px;"><i data-lucide="inbox" style="width:64px;height:64px;color:#adb5bd;"></i></p>
                    <h3 style="color:#004080;">No Forms Yet</h3>
                    <button onclick="closeHome()" style="padding:15px 30px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:20px;font-weight:bold;"><i data-lucide="plus" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Create Form</button>
                </div>
            ` : forms.map((f, i) => `
                <div style="background:#fff;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#004080,#002855);color:#fff;padding:12px 15px;">
                        <h3 style="margin:0;font-size:14px;"><i data-lucide="clipboard-list" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>${escapeHtml(f.title)}</h3>
                    </div>
                    <div style="padding:12px 15px;">
                        <div style="font-size:11px;color:#666;margin-bottom:10px;">
                            <i data-lucide="bar-chart-3" style="width:12px;height:12px;vertical-align:middle;margin-right:2px;"></i> ${f.fieldCount} fields | <i data-lucide="file-text" style="width:12px;height:12px;vertical-align:middle;margin-right:2px;"></i> ${(f.collectedData || []).length} records
                            ${f.dhis2?.datasetId ? '<span style="color:#17a2b8;margin-left:8px;"><i data-lucide="link" style="width:12px;height:12px;vertical-align:middle;"></i> DHIS2</span>' : ''}
                        </div>
                        <div style="display:flex;gap:6px;">
                            <button onclick="editForm(${i})" style="flex:1;padding:8px;background:#004080;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;"><i data-lucide="pencil" style="width:12px;height:12px;vertical-align:middle;margin-right:2px;"></i>Edit</button>
                            <button onclick="deleteForm(${i})" style="padding:8px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;"><i data-lucide="trash-2" style="width:12px;height:12px;vertical-align:middle;"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('homeContainer').innerHTML = `
                <div style="max-width:600px;margin:0 auto;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="color:#004080;"><i data-lucide="home" style="width:20px;height:20px;vertical-align:middle;margin-right:8px;"></i>My Forms</h2>
                        <button onclick="closeHome()" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;"><i data-lucide="plus" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>New</button>
                    </div>
                    ${formsHtml}
                </div>
            `;
            
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('homeContainer').classList.add('show');
            initIcons();
        }

        function closeHome() {
            document.getElementById('homeContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'flex';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = 'block';
        }

        function editForm(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const form = forms[index];
            if (!form) return;
            
            state.fields = form.fields || [];
            state.settings = { ...state.settings, ...form.settings };
            state.fieldCounter = Math.max(...state.fields.map(f => parseInt(f.id.replace('field_', '')) || 0), 0) + 1;
            state.collectedData = form.collectedData || [];
            
            if (form.dhis2) {
                state.dhis2.datasetId = form.dhis2.datasetId;
                state.dhis2.datasetName = form.dhis2.datasetName;
                state.dhis2.dataElements = form.dhis2.dataElements || {};
                state.dhis2.orgUnitColumn = form.dhis2.orgUnitColumn || '';
                state.dhis2.periodColumn = form.dhis2.periodColumn || '';
            }
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            saveToStorage();
            closeHome();
            renderFields();
            renderProperties();
            notify('Form loaded!');
        }

        function deleteForm(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            if (!confirm(`Delete "${forms[index]?.title}"?`)) return;
            forms.splice(index, 1);
            localStorage.setItem('formBuilderForms', JSON.stringify(forms));
            showHome();
            notify('Deleted');
        }

        // ==================== FORM VIEWER ====================
        function renderSharedForm(data) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            state.settings = { title: data.s?.t || 'Form', logo: data.s?.l || state.settings.logo };
            state.fields = (data.f || []).map(f => ({
                id: f.i, type: f.y, label: f.l, name: f.n, required: f.r || false, options: f.o || [], max: f.mx || 5
            }));
            
            if (data.d) {
                state.dhis2.datasetId = data.d.id;
                state.dhis2.dataElements = data.d.de || {};
                state.dhis2.orgUnitColumn = data.d.oc || '';
                state.dhis2.periodColumn = data.d.pc || '';
            }
            
            document.getElementById('viewerContainer').classList.add('show');
            renderFormViewer();
        }

        function renderFormViewer() {
            const s = state.settings;
            let pages = [], currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) pages.push(currentPage);
                    currentPage = { title: field.label, fields: [] };
                } else {
                    currentPage.fields.push(field);
                }
            });
            if (currentPage.fields.length > 0) pages.push(currentPage);
            if (pages.length === 0) pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'period':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}>
                                <option value="">-- Select Period --</option>
                                ${PERIODS.map(p => `<option value="${p}">${p.substring(0,4)}-${p.substring(4)}</option>`).join('')}
                            </select>`;
                            break;
                        case 'text': case 'email': case 'phone': case 'date': case 'time':
                            const type = field.type === 'phone' ? 'tel' : field.type;
                            input = `<input type="${type}" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                            break;
                        case 'number':
                            input = `<input type="number" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                            break;
                        case 'textarea':
                            input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`;
                            break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                            break;
                        case 'radio': case 'yesno':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'gps':
                            input = `<div><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;"><i data-lucide="map-pin" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Get Location</button><input type="hidden" name="${field.name}"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`;
                            break;
                        case 'rating':
                            input = `<div>${Array(field.max || 5).fill().map((_, i) => `<span onclick="setRating(this,${i+1})" class="rating-star" data-index="${i}" style="font-size:24px;cursor:pointer;color:#ffc107;opacity:0.3;"><i data-lucide="star" style="width:24px;height:24px;"></i></span>`).join('')}<input type="hidden" name="${field.name}"></div>`;
                            break;
                        default:
                            input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0, isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        ${pages.length > 1 ? `<div class="page-header"><span class="page-indicator">Page ${pageIndex + 1}/${pages.length}</span><h3 class="page-title">${escapeHtml(page.title)}</h3></div>` : ''}
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})"><i data-lucide="arrow-left" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next<i data-lucide="arrow-right" style="width:14px;height:14px;vertical-align:middle;margin-left:4px;"></i></button>` : ''}
                            ${isLast ? `<button type="submit" class="nav-btn submit-btn"><i data-lucide="check" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            const backBtn = state.isSharedMode ? '' : '<button class="viewer-back-btn" onclick="closeViewer()"><i data-lucide="arrow-left" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Back</button>';
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    ${backBtn}
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showTab('form',this)"><i data-lucide="file-text" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showTab('data',this)"><i data-lucide="table" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Data</button>
                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showTab('dashboard',this)"><i data-lucide="bar-chart-2" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>Dashboard</button>
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}">
                        <i data-lucide="${navigator.onLine ? 'wifi' : 'wifi-off'}" style="width:12px;height:12px;"></i> ${navigator.onLine ? 'Online' : 'Offline'}
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                                <p>ICF-SL Data Collection System</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">${pagesHtml}</form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab">
                    <div style="max-width:1000px;margin:0 auto;">
                        <div style="background:#004080;color:white;padding:15px 20px;border-radius:12px 12px 0 0;">
                            <h3 style="margin:0;font-size:16px;"><i data-lucide="table" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"></i>Collected Data (${state.collectedData.length} records)</h3>
                        </div>
                        <div style="background:white;padding:20px;border-radius:0 0 12px 12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                            <div id="dataTable"></div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDashboard" class="viewer-tab">
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <img src="${s.logo}" alt="Logo">
                            <h2><i data-lucide="bar-chart-2" style="width:20px;height:20px;vertical-align:middle;margin-right:8px;"></i>${escapeHtml(s.title)} - Dashboard</h2>
                            <p>ICF-SL Data Analytics</p>
                        </div>
                        
                        <div class="filter-bar">
                            <div class="filter-group">
                                <label><i data-lucide="calendar" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Period From</label>
                                <select id="filterPeriodFrom">
                                    <option value="">All</option>
                                    ${PERIODS.map(p => `<option value="${p}">${p}</option>`).join('')}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label><i data-lucide="calendar" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Period To</label>
                                <select id="filterPeriodTo">
                                    <option value="">All</option>
                                    ${PERIODS.map(p => `<option value="${p}">${p}</option>`).join('')}
                                </select>
                            </div>
                            <button class="filter-btn" onclick="applyFilters()"><i data-lucide="search" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Apply</button>
                            <button class="filter-btn" style="background:#dc3545;" onclick="clearFilters()"><i data-lucide="x" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Clear</button>
                        </div>
                        
                        <div class="dashboard-stats" id="dashboardStats"></div>
                        <div id="dashboardCharts"></div>
                    </div>
                </div>
            `;
            
            window.totalPages = pages.length;
            setupFormSubmit();
            renderDataTable();
            initIcons();
        }

        function setupFormSubmit() {
            const form = document.getElementById('viewerForm');
            if (!form) return;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString(), _synced: false };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                state.collectedData.push(data);
                saveToStorage();
                saveFormToList();
                
                form.reset();
                goToPage(0);
                
                notify('Data saved locally!');
                renderDataTable();
                renderDashboard();
            };
        }

        function renderDataTable() {
            const container = document.getElementById('dataTable');
            if (!container) return;
            
            if (state.collectedData.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#868e96;padding:30px;">No data collected yet</p>';
                return;
            }
            
            const fields = state.fields.filter(f => f.type !== 'section');
            
            let html = '<div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>#</th><th>Timestamp</th>';
            fields.slice(0, 6).forEach(f => html += `<th>${escapeHtml(f.label)}</th>`);
            html += '<th>Status</th></tr></thead><tbody>';
            
            state.collectedData.slice().reverse().forEach((row, i) => {
                const syncStatus = row._synced ? 
                    '<span class="sync-badge synced"><i data-lucide="check" style="width:10px;height:10px;vertical-align:middle;"></i> Synced</span>' : 
                    (row._syncError ? `<span class="sync-badge failed" title="${escapeHtml(row._syncError)}"><i data-lucide="x" style="width:10px;height:10px;vertical-align:middle;"></i> Failed</span>` : '<span class="sync-badge pending"><i data-lucide="clock" style="width:10px;height:10px;vertical-align:middle;"></i> Pending</span>');
                    
                html += `<tr><td>${state.collectedData.length - i}</td><td style="font-size:10px;">${new Date(row._timestamp).toLocaleString()}</td>`;
                fields.slice(0, 6).forEach(f => html += `<td>${escapeHtml(String(row[f.name] || '-').substring(0, 25))}</td>`);
                html += `<td>${syncStatus}</td></tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            initIcons();
        }

        function applyFilters() {
            renderDashboard();
        }

        function clearFilters() {
            document.getElementById('filterPeriodFrom').value = '';
            document.getElementById('filterPeriodTo').value = '';
            renderDashboard();
        }

        function getFilteredData() {
            let data = [...state.collectedData];
            
            const periodFrom = document.getElementById('filterPeriodFrom')?.value;
            const periodTo = document.getElementById('filterPeriodTo')?.value;
            
            const periodField = state.fields.find(f => f.type === 'period');
            
            if (periodFrom && periodField) {
                data = data.filter(d => d[periodField.name] >= periodFrom);
            }
            if (periodTo && periodField) {
                data = data.filter(d => d[periodField.name] <= periodTo);
            }
            
            return data;
        }

        function renderDashboard() {
            const statsContainer = document.getElementById('dashboardStats');
            const chartsContainer = document.getElementById('dashboardCharts');
            if (!statsContainer || !chartsContainer) return;
            
            const filteredData = getFilteredData();
            
            // Stats
            const synced = filteredData.filter(d => d._synced).length;
            const pending = filteredData.filter(d => !d._synced && !d._syncError).length;
            const failed = filteredData.filter(d => d._syncError).length;
            
            const periodField = state.fields.find(f => f.type === 'period');
            const uniquePeriods = periodField ? [...new Set(filteredData.map(d => d[periodField.name]).filter(Boolean))].length : 0;
            
            statsContainer.innerHTML = `
                <div class="stat-card"><div class="stat-value">${filteredData.length}</div><div class="stat-label">Total Records</div></div>
                <div class="stat-card success"><div class="stat-value">${synced}</div><div class="stat-label">Synced to DHIS2</div></div>
                <div class="stat-card warning"><div class="stat-value">${pending}</div><div class="stat-label">Pending Sync</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#c82333);"><div class="stat-value">${failed}</div><div class="stat-label">Failed</div></div>
                <div class="stat-card info"><div class="stat-value">${uniquePeriods}</div><div class="stat-label">Periods</div></div>
            `;
            
            // Destroy old charts
            Object.values(state.chartInstances).forEach(chart => { if (chart) chart.destroy(); });
            state.chartInstances = {};
            
            if (filteredData.length === 0) {
                chartsContainer.innerHTML = '<div class="chart-container"><p style="text-align:center;color:#868e96;padding:30px;">No data to display</p></div>';
                return;
            }
            
            // Generate charts
            const categoricalTypes = ['select', 'radio', 'yesno', 'checkbox'];
            const categoricalFields = state.fields.filter(f => categoricalTypes.includes(f.type));
            const numericFields = state.fields.filter(f => f.type === 'number');
            
            let chartsHtml = '';
            
            categoricalFields.forEach((field, idx) => {
                const valueCounts = {};
                filteredData.forEach(row => {
                    const value = row[field.name];
                    if (value) valueCounts[value] = (valueCounts[value] || 0) + 1;
                });
                
                if (Object.keys(valueCounts).length > 0) {
                    chartsHtml += `
                        <div class="chart-container">
                            <h4><i data-lucide="bar-chart-3" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>${escapeHtml(field.label)}</h4>
                            <div class="chart-wrapper">
                                <div class="chart-box"><canvas id="barChart_${idx}"></canvas></div>
                                <div class="chart-box"><canvas id="pieChart_${idx}"></canvas></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (numericFields.length > 0) {
                chartsHtml += `
                    <div class="chart-container">
                        <h4><i data-lucide="hash" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>Numeric Summary</h4>
                        <div style="overflow-x:auto;">
                            <table class="data-table">
                                <thead><tr><th>Field</th><th>Sum</th><th>Average</th><th>Min</th><th>Max</th><th>Count</th></tr></thead>
                                <tbody>
                                    ${numericFields.map(field => {
                                        const values = filteredData.map(d => parseFloat(d[field.name]) || 0);
                                        const sum = values.reduce((a, b) => a + b, 0);
                                        const avg = values.length > 0 ? (sum / values.length).toFixed(2) : 0;
                                        const min = values.length > 0 ? Math.min(...values) : 0;
                                        const max = values.length > 0 ? Math.max(...values) : 0;
                                        return `<tr><td><strong>${escapeHtml(field.label)}</strong></td><td>${sum}</td><td>${avg}</td><td>${min}</td><td>${max}</td><td>${values.length}</td></tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            if (periodField && filteredData.length > 1) {
                chartsHtml += `
                    <div class="chart-container">
                        <h4><i data-lucide="trending-up" style="width:14px;height:14px;vertical-align:middle;margin-right:6px;"></i>Records by Period</h4>
                        <div class="chart-box" style="max-width:100%;"><canvas id="trendChart"></canvas></div>
                    </div>
                `;
            }
            
            chartsContainer.innerHTML = chartsHtml || '<div class="chart-container"><p style="text-align:center;color:#868e96;padding:30px;">No categorical data for charts</p></div>';
            initIcons();
            
            // Render charts
            setTimeout(() => {
                const colors = ['#004080', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'];
                
                categoricalFields.forEach((field, idx) => {
                    const valueCounts = {};
                    filteredData.forEach(row => {
                        const value = row[field.name];
                        if (value) valueCounts[value] = (valueCounts[value] || 0) + 1;
                    });
                    
                    if (Object.keys(valueCounts).length === 0) return;
                    
                    const labels = Object.keys(valueCounts);
                    const values = Object.values(valueCounts);
                    const total = values.reduce((a, b) => a + b, 0);
                    
                    const barCtx = document.getElementById(`barChart_${idx}`);
                    if (barCtx) {
                        state.chartInstances[`bar_${idx}`] = new Chart(barCtx, {
                            type: 'bar',
                            data: { labels, datasets: [{ label: 'Count', data: values, backgroundColor: colors.slice(0, labels.length) }] },
                            options: {
                                responsive: true,
                                plugins: { legend: { display: false }, title: { display: true, text: 'Bar Chart', font: { family: 'Oswald' } } },
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                    }
                    
                    const pieCtx = document.getElementById(`pieChart_${idx}`);
                    if (pieCtx) {
                        state.chartInstances[`pie_${idx}`] = new Chart(pieCtx, {
                            type: 'pie',
                            data: { 
                                labels: labels.map((l, i) => `${l} (${((values[i] / total) * 100).toFixed(1)}%)`), 
                                datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length) }] 
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { position: 'bottom', labels: { font: { family: 'Oswald', size: 10 } } }, title: { display: true, text: 'Pie Chart', font: { family: 'Oswald' } } }
                            }
                        });
                    }
                });
                
                if (periodField && document.getElementById('trendChart')) {
                    const periodCounts = {};
                    filteredData.forEach(row => {
                        const period = row[periodField.name];
                        if (period) periodCounts[period] = (periodCounts[period] || 0) + 1;
                    });
                    
                    const sortedPeriods = Object.keys(periodCounts).sort();
                    
                    state.chartInstances['trend'] = new Chart(document.getElementById('trendChart'), {
                        type: 'line',
                        data: {
                            labels: sortedPeriods.map(p => `${p.substring(0,4)}-${p.substring(4)}`),
                            datasets: [{
                                label: 'Records',
                                data: sortedPeriods.map(p => periodCounts[p]),
                                borderColor: '#004080',
                                backgroundColor: 'rgba(0,64,128,0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                        }
                    });
                }
            }, 100);
        }

        function showTab(tab, btn) {
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            if (btn) btn.classList.add('active');
            
            if (tab === 'dashboard') renderDashboard();
        }

        function goToPage(pageIndex) {
            document.querySelectorAll('.form-page').forEach(p => p.style.display = 'none');
            document.querySelector(`.form-page[data-page="${pageIndex}"]`).style.display = 'block';
        }

        window.captureGPS = function(btn) {
            const container = btn.parentElement;
            const status = container.querySelector('.gps-status');
            const input = container.querySelector('input[type="hidden"]');
            status.innerHTML = '<i data-lucide="loader" class="spin" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>Getting location...';
            initIcons();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const coords = `[${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}]`;
                        input.value = coords;
                        status.innerHTML = '<i data-lucide="check-circle" style="width:12px;height:12px;color:#28a745;vertical-align:middle;margin-right:4px;"></i>' + coords;
                        initIcons();
                    },
                    err => { status.innerHTML = '<i data-lucide="x-circle" style="width:12px;height:12px;color:#dc3545;vertical-align:middle;margin-right:4px;"></i>' + err.message; initIcons(); }
                );
            } else {
                status.innerHTML = '<i data-lucide="x-circle" style="width:12px;height:12px;color:#dc3545;vertical-align:middle;margin-right:4px;"></i>Not supported';
                initIcons();
            }
        };

        window.setRating = function(star, val) {
            const container = star.parentElement;
            container.querySelectorAll('span').forEach((s, i) => s.style.opacity = i < val ? '1' : '0.3');
            container.querySelector('input').value = val;
        };

        // Initialize
        init();
        
        // Initialize Lucide icons after DOM load
        document.addEventListener('DOMContentLoaded', () => {
            initIcons();
        });
        
        // Also init icons immediately if DOM already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(initIcons, 100);
        }
    </script>
</body>
</html>
