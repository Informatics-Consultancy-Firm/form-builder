<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder - ICF-SL</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Auth Screens */
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header h1 { font-size: 22px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-tab:hover { background: #f8f9fa; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; transition: border-color 0.2s; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        .auth-btn:hover { background: #003366; }
        .auth-btn:disabled { background: #ccc; cursor: not-allowed; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        /* Dashboard */
        .dashboard-container { display: none; }
        .header { background: #004080; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header h1 { font-size: 18px; }
        .header-user { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .header-username { font-size: 12px; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 8px 14px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; }
        .header-btn:hover { background: #f0f0f0; }
        .header-btn.danger { background: #dc3545; color: white; }
        
        .dashboard { padding: 25px; max-width: 1200px; margin: 0 auto; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .dashboard-title { font-size: 22px; color: #004080; }
        .new-form-btn { background: #28a745; color: white; border: none; padding: 12px 22px; border-radius: 8px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .new-form-btn:hover { background: #218838; }
        
        .forms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .form-card { background: white; border: 3px solid #ddd; border-radius: 12px; overflow: hidden; transition: all 0.2s; }
        .form-card:hover { border-color: #004080; box-shadow: 0 5px 20px rgba(0,64,128,0.15); }
        .form-card-header { background: #004080; color: white; padding: 15px; }
        .form-card-title { font-size: 15px; margin-bottom: 3px; }
        .form-card-date { font-size: 10px; opacity: 0.8; }
        .form-card-body { padding: 15px; }
        .form-card-stat { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .form-card-stat:last-of-type { border-bottom: none; }
        .form-card-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 12px; }
        .card-btn { padding: 8px; border: none; border-radius: 5px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 10px; cursor: pointer; text-transform: uppercase; }
        .card-btn.edit { background: #004080; color: white; }
        .card-btn.share { background: #17a2b8; color: white; }
        .card-btn.view { background: #28a745; color: white; }
        .card-btn.delete { background: #dc3545; color: white; }
        
        .empty-state { text-align: center; padding: 60px 20px; grid-column: 1 / -1; }
        .empty-state-icon { font-size: 50px; margin-bottom: 15px; }
        .empty-state-text { color: #666; font-size: 15px; margin-bottom: 20px; }
        
        /* Form Builder */
        .builder-container { display: none; height: 100vh; }
        .builder-header { background: #004080; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .builder-title-input { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; width: 250px; }
        .builder-title-input::placeholder { color: rgba(255,255,255,0.6); }
        .builder-title-input:focus { outline: none; border-color: white; }
        .builder-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .builder-btn { background: white; color: #004080; border: none; padding: 8px 14px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; }
        .builder-btn:hover { background: #f0f0f0; }
        .builder-btn.save { background: #28a745; color: white; }
        .builder-btn.preview { background: #ffc107; color: #000; }
        
        .builder-main { display: flex; height: calc(100vh - 52px); }
        .builder-sidebar { width: 180px; background: white; border-right: 2px solid #ddd; padding: 12px; overflow-y: auto; }
        .sidebar-title { font-size: 10px; font-weight: 700; color: #004080; margin-bottom: 10px; text-transform: uppercase; border-bottom: 2px solid #004080; padding-bottom: 5px; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 8px 10px; margin-bottom: 5px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        
        .builder-canvas { flex: 1; background: #e9ecef; padding: 15px; overflow-y: auto; }
        .form-preview { max-width: 550px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: #004080; color: white; padding: 18px; text-align: center; }
        .form-preview-header h2 { font-size: 16px; margin-bottom: 4px; }
        .form-preview-header p { font-size: 10px; opacity: 0.9; }
        .form-preview-body { padding: 15px; min-height: 200px; }
        
        .drop-zone { border: 3px dashed #ccc; border-radius: 8px; padding: 35px; text-align: center; color: #999; font-size: 12px; }
        .drop-zone.drag-over { border-color: #004080; background: #e8f4fc; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        .form-field { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .form-field-label { font-weight: 700; font-size: 10px; text-transform: uppercase; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: none; cursor: pointer; font-size: 12px; padding: 4px 6px; border-radius: 4px; }
        .field-action-btn:hover { background: #dee2e6; }
        .field-action-btn.delete:hover { background: #ffebee; color: #dc3545; }
        .form-field-preview { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 6px; font-size: 11px; color: #666; }
        .section-field { background: #004080; color: white; padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; font-size: 12px; font-weight: 700; }
        .section-field.selected { box-shadow: 0 0 0 3px rgba(0,64,128,0.3); }
        
        .builder-properties { width: 260px; background: white; border-left: 2px solid #ddd; padding: 12px; overflow-y: auto; }
        .prop-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 12px; text-transform: uppercase; border-bottom: 2px solid #004080; padding-bottom: 6px; }
        .prop-group { margin-bottom: 10px; }
        .prop-label { display: block; font-size: 9px; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
        .prop-input, .prop-select { width: 100%; padding: 7px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .prop-input:focus, .prop-select:focus { outline: none; border-color: #004080; }
        .prop-textarea { width: 100%; padding: 7px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 10px; min-height: 50px; }
        .prop-checkbox { display: flex; align-items: center; gap: 6px; font-size: 10px; cursor: pointer; }
        .prop-checkbox input { width: 14px; height: 14px; }
        .no-selection { text-align: center; color: #999; padding: 30px 10px; font-size: 11px; }
        
        .skip-logic-box { background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 10px; margin-top: 12px; }
        .skip-logic-title { font-size: 9px; font-weight: 700; color: #856404; margin-bottom: 6px; }
        .skip-row { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; margin-bottom: 5px; font-size: 10px; }
        .skip-row select, .skip-row input { padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 9px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 550px; width: 100%; max-height: 85vh; overflow: hidden; border: 4px double #004080; }
        .modal-header { background: #004080; color: white; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 15px; }
        .modal-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        .modal-body { padding: 18px; max-height: 55vh; overflow-y: auto; }
        .modal-footer { padding: 12px 18px; border-top: 2px solid #ddd; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 9px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; border: none; }
        .modal-btn.cancel { background: #6c757d; color: white; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; }
        
        .settings-group { margin-bottom: 15px; }
        .settings-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .settings-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .settings-input:focus { outline: none; border-color: #004080; }
        .settings-hint { font-size: 10px; color: #666; margin-top: 4px; }
        
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,64,128,0.2); }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCode canvas, #qrCode img { display: block !important; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 11px; word-break: break-all; margin-top: 15px; max-height: 100px; overflow-y: auto; border: 2px solid #ddd; text-align: left; font-family: monospace; }
        .qr-actions { display: flex; gap: 8px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        
        /* Loading & Notification */
        .loading { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 12px 18px; border-radius: 8px; font-size: 12px; font-weight: 700; z-index: 3000; animation: slideIn 0.3s ease; }
        .notification.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Form Viewer */
        .viewer-container { display: none; min-height: 100vh; background: #f5f5f5; }
        .viewer-nav { background: #fff; padding: 12px; text-align: center; border-bottom: 3px solid #004080; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; position: sticky; top: 0; z-index: 100; }
        .viewer-nav-btn { padding: 10px 16px; border: 2px solid transparent; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        .viewer-nav-btn.active { border-color: currentColor; transform: scale(1.05); }
        .viewer-nav-btn:hover { transform: scale(1.05); }
        .viewer-form { max-width: 650px; margin: 20px auto; padding: 0 15px; }
        .viewer-form-box { border: 4px double #004080; border-radius: 12px; overflow: hidden; background: white; }
        .viewer-header { background: #004080; color: white; padding: 20px; text-align: center; }
        .viewer-header h1 { font-size: 18px; margin-bottom: 5px; }
        .viewer-header p { font-size: 11px; opacity: 0.9; }
        .viewer-body { padding: 20px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; }
        .viewer-field-label .required { color: red; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-section { background: #004080; color: white; padding: 12px 15px; margin: 18px -20px; font-weight: 700; font-size: 13px; }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .viewer-radio-option:hover { border-color: #004080; }
        .viewer-radio-option input:checked + span { color: #004080; font-weight: 700; }
        .viewer-submit { width: 100%; padding: 16px; background: #28a745; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .viewer-submit:hover { background: #218838; }
        .viewer-submit:disabled { background: #ccc; }
        .viewer-draft-btn { width: 100%; padding: 12px; background: #ffc107; color: #000; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        
        .viewer-tab { display: none; }
        .viewer-tab.active { display: block; }
        
        /* Data View */
        .data-table-wrapper { overflow-x: auto; margin: -20px; margin-top: 0; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 500px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 10px 8px; text-align: left; }
        .data-table th { background: #004080; color: white; font-size: 10px; text-transform: uppercase; position: sticky; top: 0; }
        .data-table tr:nth-child(even) { background: #f9f9f9; }
        .data-table tr:hover { background: #e8f4fc; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #0066cc 100%); border-radius: 10px; padding: 20px; text-align: center; color: white; }
        .stat-value { font-size: 36px; font-weight: 700; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .chart-bar { height: 24px; background: linear-gradient(90deg, #004080, #0066cc); border-radius: 4px; margin: 6px 0; transition: width 0.5s ease; }
        .chart-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
        
        @media (max-width: 768px) {
            .builder-main { flex-direction: column; }
            .builder-sidebar, .builder-properties { width: 100%; max-height: 200px; }
            .header { padding: 10px; }
            .header h1 { font-size: 14px; }
            .viewer-nav-btn { padding: 8px 12px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" style="width:70px;border-radius:10px;margin-bottom:12px;">
                <h1>Form Builder</h1>
                <p>Create & Manage Data Collection Forms</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required>
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required>
                    </div>
                    <button type="submit" class="auth-btn" id="loginBtn">Login</button>
                </form>
                
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required>
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required>
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Organization</label>
                        <input type="text" class="auth-input" id="signupOrg" value="ICF-SL">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Confirm Password</label>
                        <input type="password" class="auth-input" id="signupConfirm" required>
                    </div>
                    <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="header">
            <div class="header-brand">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" style="width:40px;height:40px;border-radius:6px;">
                <h1>Form Builder</h1>
            </div>
            <div class="header-user">
                <span class="header-username" id="headerUsername">üë§ User</span>
                <button class="header-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
                <button class="header-btn danger" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h2 class="dashboard-title">üìã My Forms</h2>
                <button class="new-form-btn" onclick="createNewForm()">‚ûï New Form</button>
            </div>
            <div class="forms-grid" id="formsGrid"></div>
        </div>
    </div>

    <!-- Form Builder Container -->
    <div class="builder-container" id="builderContainer">
        <div class="builder-header">
            <input type="text" class="builder-title-input" id="formTitleInput" placeholder="Form Title" value="New Form">
            <div class="builder-actions">
                <button class="builder-btn" onclick="backToDashboard()">‚Üê Back</button>
                <button class="builder-btn preview" onclick="previewForm()">üëÅÔ∏è Preview</button>
                <button class="builder-btn save" onclick="saveForm()">üíæ Save</button>
            </div>
        </div>
        <div class="builder-main">
            <div class="builder-sidebar">
                <div class="sidebar-title">üì¶ Field Types</div>
                <div class="field-type" data-type="text">üìù Text</div>
                <div class="field-type" data-type="number">üî¢ Number</div>
                <div class="field-type" data-type="date">üìÖ Date</div>
                <div class="field-type" data-type="textarea">üìÑ Long Text</div>
                <div class="field-type" data-type="select">üìã Dropdown</div>
                <div class="field-type" data-type="radio">üîò Radio</div>
                <div class="field-type" data-type="checkbox">‚òëÔ∏è Checkbox</div>
                <div class="field-type" data-type="yesno">‚úÖ Yes/No</div>
                <div class="field-type" data-type="yesnona">‚ùì Yes/No/NA</div>
                <div class="field-type" data-type="gps">üìç GPS</div>
                <div class="field-type" data-type="signature">‚úçÔ∏è Signature</div>
                <div class="field-type" data-type="section">üìë Section</div>
            </div>
            
            <div class="builder-canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">New Form</h2>
                        <p id="previewSubtitle">Data Collection Form</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <div>üì• Click field types to add</div>
                            <div style="font-size:10px;margin-top:6px;">or drag & drop</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="builder-properties" id="propertiesPanel">
                <div class="prop-title">‚öôÔ∏è Properties</div>
                <div class="no-selection" id="noSelection">
                    <div style="font-size:24px;margin-bottom:8px;">üëÜ</div>
                    Select a field to edit
                </div>
                <div id="fieldProperties" style="display:none;">
                    <div class="prop-group">
                        <label class="prop-label">Label</label>
                        <input type="text" class="prop-input" id="propLabel">
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">Field Name</label>
                        <input type="text" class="prop-input" id="propName">
                    </div>
                    <div class="prop-group">
                        <label class="prop-checkbox">
                            <input type="checkbox" id="propRequired">
                            <span>Required Field</span>
                        </label>
                    </div>
                    <div class="prop-group" id="optionsGroup" style="display:none;">
                        <label class="prop-label">Options (one per line)</label>
                        <textarea class="prop-textarea" id="propOptions"></textarea>
                    </div>
                    
                    <div class="skip-logic-box">
                        <div class="skip-logic-title">üîÄ Skip Logic</div>
                        <div class="skip-row">
                            <label class="prop-checkbox">
                                <input type="checkbox" id="skipEnabled">
                                <span>Enable</span>
                            </label>
                        </div>
                        <div id="skipDetails" style="display:none;">
                            <div class="skip-row">
                                <span>Show when</span>
                                <select id="skipField"></select>
                            </div>
                            <div class="skip-row">
                                <select id="skipOperator">
                                    <option value="equals">equals</option>
                                    <option value="not_equals">not equals</option>
                                </select>
                                <input type="text" id="skipValue" placeholder="value" style="width:80px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è System Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Apps Script Web App URL</label>
                    <input type="text" class="settings-input" id="settingsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                    <div class="settings-hint">This handles users, forms, and creates new files</div>
                </div>
                <div class="settings-group">
                    <label class="settings-label">Google Drive Folder ID</label>
                    <input type="text" class="settings-input" id="settingsFolderId" placeholder="Folder ID from Drive URL">
                    <div class="settings-hint">Each form creates a NEW file in this folder</div>
                </div>
                <div style="background:#e8f4fc;padding:12px;border-radius:8px;margin-top:15px;font-size:11px;">
                    <strong>üìã How it works:</strong>
                    <ul style="margin:8px 0 0 18px;">
                        <li>User credentials ‚Üí "Users" sheet</li>
                        <li>Form definitions ‚Üí "Forms" sheet</li>
                        <li>Each form ‚Üí Creates NEW Google Sheets file</li>
                        <li>Files stored in your Drive folder</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveSystemSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üì§ Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:18px;font-weight:700;color:#004080;" id="shareFormTitle">Form Title</div>
                    <div style="font-size:11px;color:#666;">Share this form with anyone</div>
                </div>
                <div class="qr-container">
                    <div class="qr-box" id="qrBox">
                        <div id="qrCode"></div>
                    </div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;">üì± Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()">üìã Copy URL</button>
                        <button class="modal-btn success" onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Rename Form</h3>
                <button class="modal-close" onclick="closeModal('renameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Form Name</label>
                    <input type="text" class="settings-input" id="renameInput" placeholder="Enter new form name">
                </div>
                <div class="settings-group">
                    <label class="settings-label">Subtitle (Optional)</label>
                    <input type="text" class="settings-input" id="renameSubtitle" placeholder="e.g., Data Collection Form">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('renameModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveRename()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Compression Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        
        // ========================================
        // CONFIGURATION & STATE
        // ========================================
        const CONFIG = {
            LOGO: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
            ORG_NAME: 'ICF-SL',
            DEFAULT_ORG: 'ICF-SL',
            BASE_URL: window.location.origin + window.location.pathname
        };
        
        let state = {
            user: null,
            forms: [],
            currentForm: null,
            currentShareForm: null,
            currentShareUrl: '',
            fields: [],
            selectedFieldId: null,
            renameFormId: null,
            scriptUrl: localStorage.getItem('scriptUrl') || '',
            folderId: localStorage.getItem('folderId') || ''
        };
        
        // ========================================
        // URL ROUTING
        // ========================================
        function getHashParams() {
            const hash = window.location.hash.slice(1);
            const params = {};
            hash.split('&').forEach(part => {
                const [key, value] = part.split('=');
                if (key) params[key] = decodeURIComponent(value || '');
            });
            return params;
        }
        
        function setHashParams(params) {
            const hash = Object.entries(params)
                .filter(([k, v]) => v)
                .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
                .join('&');
            window.location.hash = hash;
        }
        
        function updateHash(tab) {
            const params = getHashParams();
            params.tab = tab;
            setHashParams(params);
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('c');
            const formData = urlParams.get('d');
            const formId = urlParams.get('form');
            
            // Check for compressed form data
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    
                    const form = {
                        id: data.id,
                        title: data.t,
                        subtitle: data.s,
                        fields: data.f.map(f => ({
                            id: f.i, type: f.y, label: f.l, name: f.n, required: f.r,
                            options: f.o, skipLogic: f.k
                        })),
                        sheetId: data.h
                    };
                    
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('viewerContainer').style.display = 'block';
                    renderFormViewer(form);
                    return;
                } catch (err) {
                    console.error('Error decoding compressed form:', err);
                }
            }
            
            // Check for embedded form data (legacy)
            if (formData) {
                try {
                    const json = decodeURIComponent(escape(atob(formData)));
                    const form = JSON.parse(json);
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('viewerContainer').style.display = 'block';
                    renderFormViewer(form);
                    return;
                } catch (err) {
                    console.error('Error decoding form:', err);
                }
            }
            
            // Legacy: check for form ID
            if (formId) {
                loadFormForViewing(formId);
                return;
            }
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.user = JSON.parse(savedUser);
                showDashboard();
            }
            
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.onclick = () => switchAuthTab(tab.dataset.tab);
            });
            
            // Auth forms
            document.getElementById('loginForm').onsubmit = handleLogin;
            document.getElementById('signupForm').onsubmit = handleSignup;
            
            // Field types
            document.querySelectorAll('.field-type').forEach(el => {
                el.onclick = () => addField(el.dataset.type);
            });
            
            // Properties
            document.getElementById('propLabel').oninput = (e) => updateFieldProp('label', e.target.value);
            document.getElementById('propName').oninput = (e) => updateFieldProp('name', e.target.value);
            document.getElementById('propRequired').onchange = (e) => updateFieldProp('required', e.target.checked);
            document.getElementById('propOptions').oninput = (e) => updateFieldProp('options', e.target.value.split('\n').filter(o => o.trim()));
            
            // Skip logic
            document.getElementById('skipEnabled').onchange = (e) => {
                document.getElementById('skipDetails').style.display = e.target.checked ? 'block' : 'none';
                updateSkipLogic();
            };
            document.getElementById('skipField').onchange = updateSkipLogic;
            document.getElementById('skipOperator').onchange = updateSkipLogic;
            document.getElementById('skipValue').oninput = updateSkipLogic;
            
            // Title sync
            document.getElementById('formTitleInput').oninput = (e) => {
                document.getElementById('previewTitle').textContent = e.target.value || 'Untitled Form';
            };
            
            // Handle hash changes for routing
            window.addEventListener('hashchange', handleHashChange);
        });
        
        function handleHashChange() {
            const params = getHashParams();
            if (params.tab && window.currentViewForm) {
                showViewerTab(params.tab, false);
            }
        }
        
        // ========================================
        // AUTH FUNCTIONS
        // ========================================
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
            hideAuthMessages();
        }
        
        function hideAuthMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }
        
        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }
        
        function showAuthSuccess(msg) {
            const el = document.getElementById('authSuccess');
            el.textContent = msg;
            el.style.display = 'block';
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            if (!state.scriptUrl) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    state.user = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showDashboard();
                } else {
                    showAuthError('Invalid email or password');
                }
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                const response = await fetch(state.scriptUrl + '?action=login&email=' + encodeURIComponent(email) + '&password=' + encodeURIComponent(password));
                const result = await response.json();
                
                if (result.success) {
                    state.user = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    showDashboard();
                } else {
                    showAuthError(result.message || 'Login failed');
                }
            } catch (err) {
                showAuthError('Connection error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Login';
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const org = document.getElementById('signupOrg').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const btn = document.getElementById('signupBtn');
            
            if (password !== confirm) {
                showAuthError('Passwords do not match');
                return;
            }
            
            if (!state.scriptUrl) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.find(u => u.email === email)) {
                    showAuthError('Email already registered');
                    return;
                }
                const newUser = { id: Date.now().toString(), name, email, org, password, createdAt: new Date().toISOString() };
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                showAuthSuccess('Account created! Please login.');
                setTimeout(() => switchAuthTab('login'), 1500);
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                const response = await fetch(state.scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'signup', name, email, org, password })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAuthSuccess('Account created! Please login.');
                    setTimeout(() => switchAuthTab('login'), 1500);
                } else {
                    showAuthError(result.message || 'Signup failed');
                }
            } catch (err) {
                showAuthError('Connection error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }
        
        function logout() {
            state.user = null;
            localStorage.removeItem('currentUser');
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('builderContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
        }
        
        // ========================================
        // DASHBOARD
        // ========================================
        function showDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('builderContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            document.getElementById('headerUsername').textContent = 'üë§ ' + state.user.name;
            loadUserForms();
        }
        
        async function loadUserForms() {
            if (!state.scriptUrl) {
                state.forms = JSON.parse(localStorage.getItem('forms_' + state.user.id) || '[]');
                renderFormsGrid();
                return;
            }
            
            try {
                const response = await fetch(state.scriptUrl + '?action=getForms&userId=' + state.user.id);
                const result = await response.json();
                if (result.success) {
                    state.forms = result.forms;
                    renderFormsGrid();
                }
            } catch (err) {
                notify('Error loading forms', 'error');
            }
        }
        
        function renderFormsGrid() {
            const grid = document.getElementById('formsGrid');
            
            if (state.forms.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-text">No forms yet. Create your first!</div>
                        <button class="new-form-btn" onclick="createNewForm()">‚ûï Create Form</button>
                    </div>`;
                return;
            }
            
            grid.innerHTML = state.forms.map(form => `
                <div class="form-card">
                    <div class="form-card-header">
                        <div class="form-card-title">${form.title}</div>
                        <div class="form-card-date">Created: ${new Date(form.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="form-card-body">
                        <div class="form-card-stat"><span>Fields:</span><span>${form.fields?.length || 0}</span></div>
                        <div class="form-card-stat"><span>Submissions:</span><span>${form.submissions || 0}</span></div>
                        <div class="form-card-actions" style="grid-template-columns: 1fr 1fr;">
                            <button class="card-btn edit" onclick="editForm('${form.id}')">‚úèÔ∏è Edit</button>
                            <button class="card-btn" style="background:#6c757d;color:white;" onclick="renameForm('${form.id}')">‚úé Rename</button>
                            <button class="card-btn share" onclick="shareForm('${form.id}')">üì§ Share</button>
                            <button class="card-btn view" onclick="viewData('${form.id}')">üìä Data</button>
                        </div>
                        <button class="card-btn delete" style="width:100%;margin-top:6px;" onclick="deleteForm('${form.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ========================================
        // FORM BUILDER
        // ========================================
        function createNewForm() {
            state.currentForm = {
                id: 'form_' + Date.now(),
                title: 'New Form',
                subtitle: 'Data Collection Form',
                userId: state.user.id,
                createdAt: new Date().toISOString(),
                fields: []
            };
            state.fields = [];
            state.selectedFieldId = null;
            
            document.getElementById('formTitleInput').value = 'New Form';
            document.getElementById('previewTitle').textContent = 'New Form';
            showBuilder();
        }
        
        function editForm(formId) {
            const form = state.forms.find(f => f.id === formId);
            if (!form) return;
            
            state.currentForm = { ...form };
            state.fields = form.fields ? [...form.fields] : [];
            state.selectedFieldId = null;
            
            document.getElementById('formTitleInput').value = form.title;
            document.getElementById('previewTitle').textContent = form.title;
            showBuilder();
        }
        
        function showBuilder() {
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'none';
            document.getElementById('builderContainer').style.display = 'block';
            renderFields();
            hideFieldProperties();
        }
        
        function backToDashboard() {
            if (state.fields.length > 0 && !confirm('Leave without saving?')) return;
            document.getElementById('builderContainer').style.display = 'none';
            showDashboard();
        }
        
        function addField(type) {
            const field = {
                id: 'field_' + Date.now(),
                type,
                label: getDefaultLabel(type),
                name: type + '_' + Date.now(),
                required: false,
                options: getDefaultOptions(type),
                skipLogic: null
            };
            
            state.fields.push(field);
            renderFields();
            selectField(field.id);
        }
        
        function getDefaultLabel(type) {
            const labels = {
                text: 'Text Field', number: 'Number Field', date: 'Date Field',
                textarea: 'Long Text', select: 'Dropdown', radio: 'Radio Choice',
                checkbox: 'Checkboxes', yesno: 'Yes/No', yesnona: 'Yes/No/NA',
                gps: 'GPS Location', signature: 'Signature', section: 'Section Title'
            };
            return labels[type] || 'Field';
        }
        
        function getDefaultOptions(type) {
            return ['select', 'radio', 'checkbox'].includes(type) ? ['Option 1', 'Option 2', 'Option 3'] : [];
        }
        
        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            
            if (state.fields.length === 0) {
                dropZone.className = 'drop-zone';
                dropZone.innerHTML = '<div>üì• Click field types to add</div><div style="font-size:10px;margin-top:6px;">or drag & drop</div>';
                return;
            }
            
            dropZone.className = 'drop-zone has-fields';
            dropZone.innerHTML = state.fields.map(field => {
                if (field.type === 'section') {
                    return `<div class="section-field ${field.id === state.selectedFieldId ? 'selected' : ''}" onclick="selectField('${field.id}')">
                        <span>üìë ${field.label}</span>
                        <button class="field-action-btn delete" style="float:right;background:rgba(255,255,255,0.2);color:white;" onclick="event.stopPropagation();deleteField('${field.id}')">üóëÔ∏è</button>
                    </div>`;
                }
                
                return `<div class="form-field ${field.id === state.selectedFieldId ? 'selected' : ''}" onclick="selectField('${field.id}')">
                    <div class="form-field-header">
                        <span class="form-field-label">${field.label} ${field.required ? '<span style="color:red">*</span>' : ''}</span>
                        <div class="form-field-actions">
                            <button class="field-action-btn" onclick="event.stopPropagation();moveField('${field.id}',-1)">‚¨ÜÔ∏è</button>
                            <button class="field-action-btn" onclick="event.stopPropagation();moveField('${field.id}',1)">‚¨áÔ∏è</button>
                            <button class="field-action-btn delete" onclick="event.stopPropagation();deleteField('${field.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-field-preview">${getFieldPreview(field)}</div>
                    ${field.skipLogic ? '<div style="margin-top:5px;font-size:8px;color:#856404;background:#fff3cd;padding:2px 5px;border-radius:3px;">üîÄ Skip logic</div>' : ''}
                </div>`;
            }).join('');
        }
        
        function getFieldPreview(field) {
            switch (field.type) {
                case 'text': return '<input type="text" disabled style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;">';
                case 'number': return '<input type="number" disabled style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;">';
                case 'date': return '<input type="date" disabled style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;">';
                case 'textarea': return '<textarea disabled style="width:100%;height:35px;padding:5px;border:1px solid #ddd;border-radius:3px;"></textarea>';
                case 'select': return '<select disabled style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;"><option>Select...</option></select>';
                case 'radio': case 'yesno': case 'yesnona':
                    const opts = field.type === 'yesno' ? ['Yes','No'] : field.type === 'yesnona' ? ['Yes','No','N/A'] : field.options;
                    return opts.slice(0,3).map(o => `<label style="margin-right:8px;font-size:10px;"><input type="radio" disabled> ${o}</label>`).join('');
                case 'checkbox':
                    return field.options.slice(0,3).map(o => `<label style="margin-right:8px;font-size:10px;"><input type="checkbox" disabled> ${o}</label>`).join('');
                case 'gps': return 'üìç GPS Button';
                case 'signature': return '‚úçÔ∏è Signature Pad';
                default: return '';
            }
        }
        
        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            showFieldProperties();
        }
        
        function showFieldProperties() {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('fieldProperties').style.display = 'block';
            
            document.getElementById('propLabel').value = field.label;
            document.getElementById('propName').value = field.name;
            document.getElementById('propRequired').checked = field.required;
            
            const showOptions = ['select', 'radio', 'checkbox'].includes(field.type);
            document.getElementById('optionsGroup').style.display = showOptions ? 'block' : 'none';
            if (showOptions) document.getElementById('propOptions').value = (field.options || []).join('\n');
            
            const skipField = document.getElementById('skipField');
            skipField.innerHTML = '<option value="">Select...</option>' + 
                state.fields.filter(f => f.id !== field.id && f.type !== 'section')
                    .map(f => `<option value="${f.id}">${f.label}</option>`).join('');
            
            if (field.skipLogic) {
                document.getElementById('skipEnabled').checked = true;
                document.getElementById('skipDetails').style.display = 'block';
                skipField.value = field.skipLogic.field;
                document.getElementById('skipOperator').value = field.skipLogic.operator;
                document.getElementById('skipValue').value = field.skipLogic.value;
            } else {
                document.getElementById('skipEnabled').checked = false;
                document.getElementById('skipDetails').style.display = 'none';
            }
        }
        
        function hideFieldProperties() {
            document.getElementById('noSelection').style.display = 'block';
            document.getElementById('fieldProperties').style.display = 'none';
        }
        
        function updateFieldProp(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                field[prop] = value;
                if (prop === 'label') {
                    field.name = value.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    document.getElementById('propName').value = field.name;
                }
                renderFields();
            }
        }
        
        function updateSkipLogic() {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            if (document.getElementById('skipEnabled').checked) {
                field.skipLogic = {
                    field: document.getElementById('skipField').value,
                    operator: document.getElementById('skipOperator').value,
                    value: document.getElementById('skipValue').value
                };
            } else {
                field.skipLogic = null;
            }
        }
        
        function moveField(id, dir) {
            const index = state.fields.findIndex(f => f.id === id);
            const newIndex = index + dir;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
        }
        
        function deleteField(id) {
            if (!confirm('Delete this field?')) return;
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) {
                state.selectedFieldId = null;
                hideFieldProperties();
            }
            renderFields();
        }
        
        async function saveForm() {
            if (state.fields.length === 0) {
                notify('Add at least one field', 'error');
                return;
            }
            
            state.currentForm.title = document.getElementById('formTitleInput').value || 'Untitled Form';
            state.currentForm.fields = state.fields;
            state.currentForm.updatedAt = new Date().toISOString();
            
            if (!state.scriptUrl) {
                const existingIndex = state.forms.findIndex(f => f.id === state.currentForm.id);
                if (existingIndex >= 0) state.forms[existingIndex] = state.currentForm;
                else state.forms.push(state.currentForm);
                localStorage.setItem('forms_' + state.user.id, JSON.stringify(state.forms));
                notify('Form saved!');
                return;
            }
            
            try {
                const response = await fetch(state.scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveForm', form: state.currentForm, folderId: state.folderId })
                });
                const result = await response.json();
                
                if (result.success) {
                    if (result.sheetId) state.currentForm.sheetId = result.sheetId;
                    notify('Form saved!');
                    loadUserForms();
                } else {
                    notify(result.message || 'Save failed', 'error');
                }
            } catch (err) {
                notify('Error saving form', 'error');
            }
        }
        
        function shareForm(formId) {
            const form = state.forms.find(f => f.id === formId);
            if (!form) return;
            
            document.getElementById('shareFormTitle').textContent = form.title;
            
            // Create compressed form data
            const formData = {
                id: form.id,
                t: form.title,
                s: form.subtitle || 'Data Collection',
                f: form.fields.map(f => ({
                    i: f.id, y: f.type, l: f.label, n: f.name, r: f.required,
                    o: f.options, k: f.skipLogic
                })),
                h: form.sheetId || ''
            };
            
            const jsonStr = JSON.stringify(formData);
            const compressed = pako.deflate(jsonStr);
            const encoded = btoa(String.fromCharCode.apply(null, compressed));
            const shareUrl = CONFIG.BASE_URL + '?c=' + encodeURIComponent(encoded) + '#tab=form';
            
            document.getElementById('shareUrl').textContent = shareUrl;
            
            // Clear previous QR code
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '';
            
            // Generate QR code using qrcodejs library
            new QRCode(qrContainer, {
                text: shareUrl,
                width: 200,
                height: 200,
                colorDark: '#004080',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
            
            state.currentShareUrl = shareUrl;
            state.currentShareForm = form;
            document.getElementById('shareModal').classList.add('show');
        }
        
        function copyShareUrl() {
            navigator.clipboard.writeText(state.currentShareUrl).then(() => notify('URL copied!'));
        }
        
        function downloadQR() {
            const qrContainer = document.getElementById('qrCode');
            let canvas = qrContainer.querySelector('canvas');
            const img = qrContainer.querySelector('img');
            
            // Create a new canvas with padding and title
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            const padding = 40;
            const titleHeight = 40;
            const qrSize = 200;
            
            newCanvas.width = qrSize + padding * 2;
            newCanvas.height = qrSize + padding * 2 + titleHeight;
            
            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            
            // Add title
            ctx.fillStyle = '#004080';
            ctx.font = 'bold 18px Oswald, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(state.currentShareForm?.title || 'Form', newCanvas.width / 2, 28);
            
            // Draw QR code from canvas or img
            if (canvas) {
                ctx.drawImage(canvas, padding, titleHeight + padding / 2, qrSize, qrSize);
                downloadImage();
            } else if (img) {
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.onload = function() {
                    ctx.drawImage(tempImg, padding, titleHeight + padding / 2, qrSize, qrSize);
                    downloadImage();
                };
                tempImg.src = img.src;
            } else {
                notify('QR code not ready', 'error');
                return;
            }
            
            function downloadImage() {
                const link = document.createElement('a');
                const formTitle = state.currentShareForm?.title || 'form';
                link.download = formTitle.replace(/[^a-zA-Z0-9]/g, '_') + '-QR.png';
                link.href = newCanvas.toDataURL('image/png');
                link.click();
                notify('QR code downloaded!');
            }
        }
        
        async function deleteForm(formId) {
            if (!confirm('Delete this form permanently?')) return;
            
            if (!state.scriptUrl) {
                state.forms = state.forms.filter(f => f.id !== formId);
                localStorage.setItem('forms_' + state.user.id, JSON.stringify(state.forms));
                renderFormsGrid();
                notify('Form deleted');
                return;
            }
            
            try {
                await fetch(state.scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteForm', formId, userId: state.user.id })
                });
                loadUserForms();
                notify('Form deleted');
            } catch (err) {
                notify('Error deleting', 'error');
            }
        }
        
        // ========================================
        // RENAME FORM
        // ========================================
        function renameForm(formId) {
            const form = state.forms.find(f => f.id === formId);
            if (!form) return;
            
            state.renameFormId = formId;
            document.getElementById('renameInput').value = form.title;
            document.getElementById('renameSubtitle').value = form.subtitle || 'Data Collection Form';
            document.getElementById('renameModal').classList.add('show');
            
            // Focus the input
            setTimeout(() => document.getElementById('renameInput').focus(), 100);
        }
        
        async function saveRename() {
            const newTitle = document.getElementById('renameInput').value.trim();
            const newSubtitle = document.getElementById('renameSubtitle').value.trim();
            
            if (!newTitle) {
                notify('Please enter a form name', 'error');
                return;
            }
            
            const form = state.forms.find(f => f.id === state.renameFormId);
            if (!form) return;
            
            form.title = newTitle;
            form.subtitle = newSubtitle || 'Data Collection Form';
            form.updatedAt = new Date().toISOString();
            
            if (!state.scriptUrl) {
                localStorage.setItem('forms_' + state.user.id, JSON.stringify(state.forms));
                renderFormsGrid();
                closeModal('renameModal');
                notify('Form renamed!');
                return;
            }
            
            try {
                const response = await fetch(state.scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveForm', form: form, folderId: state.folderId })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('renameModal');
                    notify('Form renamed!');
                    loadUserForms();
                } else {
                    notify(result.message || 'Rename failed', 'error');
                }
            } catch (err) {
                notify('Error renaming form', 'error');
            }
        }
        
        // ========================================
        // FORM VIEWER
        // ========================================
        async function loadFormForViewing(formId) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('builderContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'block';
            
            const scriptUrl = localStorage.getItem('scriptUrl');
            if (scriptUrl) {
                try {
                    const response = await fetch(scriptUrl + '?action=getForm&formId=' + formId);
                    const result = await response.json();
                    if (result.success) {
                        renderFormViewer(result.form);
                        return;
                    }
                } catch (err) {}
            }
            
            const allUsers = JSON.parse(localStorage.getItem('users') || '[]');
            for (const user of allUsers) {
                const forms = JSON.parse(localStorage.getItem('forms_' + user.id) || '[]');
                const form = forms.find(f => f.id === formId);
                if (form) {
                    renderFormViewer(form);
                    return;
                }
            }
            
            document.getElementById('viewerContainer').innerHTML = `
                <div style="text-align:center;padding:50px;">
                    <h2 style="color:#dc3545;">Form Not Found</h2>
                    <p>This form may have been deleted.</p>
                    <a href="./" style="color:#004080;">‚Üê Go to Form Builder</a>
                </div>`;
        }
        
        function renderFormViewer(form) {
            const hashParams = getHashParams();
            const initialTab = hashParams.tab || 'form';
            
            let fieldsHtml = form.fields.map(field => {
                if (field.type === 'section') return `<div class="viewer-section">${field.label}</div>`;
                
                const req = field.required ? '<span class="required">*</span>' : '';
                const reqAttr = field.required ? 'required' : '';
                let input = '';
                
                switch (field.type) {
                    case 'text': input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                    case 'number': input = `<input type="number" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                    case 'date': input = `<input type="date" name="${field.name}" class="viewer-input" ${reqAttr}>`; break;
                    case 'textarea': input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`; break;
                    case 'select':
                        input = `<select name="${field.name}" class="viewer-input" ${reqAttr}>
                            <option value="">-- Select --</option>
                            ${(field.options||[]).map(o => `<option value="${o}">${o}</option>`).join('')}
                        </select>`; break;
                    case 'radio': case 'yesno': case 'yesnona':
                        const opts = field.type === 'yesno' ? ['Yes','No'] : field.type === 'yesnona' ? ['Yes','No','N/A'] : (field.options||[]);
                        input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${o}" ${reqAttr}><span>${o}</span></label>`).join('')}</div>`; break;
                    case 'checkbox':
                        input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${o}"><span>${o}</span></label>`).join('')}</div>`; break;
                    case 'gps':
                        input = `<div class="gps-container"><input type="hidden" name="${field.name}_lat" class="gps-lat"><input type="hidden" name="${field.name}_lng" class="gps-lng"><button type="button" class="viewer-draft-btn" onclick="captureGPS(this)">üìç Capture GPS</button><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`; break;
                    case 'signature':
                        input = `<div class="sig-container"><canvas class="sig-canvas" width="280" height="100" style="border:2px solid #004080;border-radius:6px;background:#fff;touch-action:none;"></canvas><input type="hidden" name="${field.name}" class="sig-data"><button type="button" onclick="clearSig(this)" style="margin-top:6px;padding:5px 10px;background:#dc3545;color:#fff;border:none;border-radius:4px;font-size:10px;cursor:pointer;">Clear</button></div>`; break;
                }
                
                return `<div class="viewer-field" data-field-id="${field.id}" ${field.skipLogic ? `data-skip='${JSON.stringify(field.skipLogic)}'` : ''}><label class="viewer-field-label">${field.label} ${req}</label>${input}</div>`;
            }).join('');
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    <a href="#tab=form" class="viewer-nav-btn ${initialTab === 'form' ? 'active' : ''}" style="background:#004080;color:#fff;" onclick="showViewerTab('form', true); return false;">üìù Form</a>
                    <a href="#tab=data" class="viewer-nav-btn ${initialTab === 'data' ? 'active' : ''}" style="background:#28a745;color:#fff;" onclick="showViewerTab('data', true); return false;">üìä Data</a>
                    <a href="#tab=dashboard" class="viewer-nav-btn ${initialTab === 'dashboard' ? 'active' : ''}" style="background:#17a2b8;color:#fff;" onclick="showViewerTab('dashboard', true); return false;">üìà Dashboard</a>
                    <a href="#tab=report" class="viewer-nav-btn ${initialTab === 'report' ? 'active' : ''}" style="background:#6c757d;color:#fff;" onclick="showViewerTab('report', true); return false;">üìÑ Report</a>
                    <a href="#tab=drafts" class="viewer-nav-btn ${initialTab === 'drafts' ? 'active' : ''}" style="background:#ffc107;color:#000;" onclick="showViewerTab('drafts', true); return false;">üíæ Drafts</a>
                </div>
                
                <div id="tabForm" class="viewer-tab ${initialTab === 'form' ? 'active' : ''}">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${CONFIG.LOGO}" style="width:60px;border-radius:8px;margin-bottom:8px;">
                                <h1>${form.title}</h1>
                                <p>${form.subtitle || 'Data Collection'}</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">${fieldsHtml}
                                    <button type="button" class="viewer-draft-btn" onclick="saveDraft('${form.id}')">üíæ Save Draft</button>
                                    <button type="submit" class="viewer-submit">‚úÖ Submit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab ${initialTab === 'data' ? 'active' : ''}">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:#28a745;">
                                <h1>üìä Submitted Data</h1>
                                <p>${form.title}</p>
                            </div>
                            <div class="viewer-body" id="dataContainer">
                                <p style="text-align:center;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDashboard" class="viewer-tab ${initialTab === 'dashboard' ? 'active' : ''}">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:#17a2b8;">
                                <h1>üìà Dashboard</h1>
                                <p>${form.title}</p>
                            </div>
                            <div class="viewer-body" id="dashContainer">
                                <p style="text-align:center;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabReport" class="viewer-tab ${initialTab === 'report' ? 'active' : ''}">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:#6c757d;">
                                <h1>üìÑ Report</h1>
                                <button onclick="printReport()" style="background:#fff;color:#6c757d;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:700;margin-top:8px;font-family:Oswald;">üñ®Ô∏è Print Report</button>
                            </div>
                            <div class="viewer-body" id="reportContainer">
                                <p style="text-align:center;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabDrafts" class="viewer-tab ${initialTab === 'drafts' ? 'active' : ''}">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header" style="background:#ffc107;color:#000;">
                                <h1>üíæ Saved Drafts</h1>
                                <p>${form.title}</p>
                            </div>
                            <div class="viewer-body" id="draftsContainer">
                                <p style="text-align:center;">No drafts saved</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            window.currentViewForm = form;
            document.querySelectorAll('.sig-container').forEach(initSignature);
            document.getElementById('viewerForm').onsubmit = (e) => { e.preventDefault(); submitViewerForm(form); };
            applySkipLogic(form);
            
            // Load initial tab content
            if (initialTab !== 'form') {
                showViewerTab(initialTab, false);
            }
        }
        
        function showViewerTab(tab, updateUrl = true) {
            // Hide all tabs
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
            const tabEl = document.getElementById(tabId);
            if (tabEl) tabEl.classList.add('active');
            
            // Highlight nav button
            document.querySelectorAll('.viewer-nav-btn').forEach(btn => {
                if (btn.getAttribute('href') === '#tab=' + tab) {
                    btn.classList.add('active');
                }
            });
            
            // Update URL hash
            if (updateUrl) {
                updateHash(tab);
            }
            
            // Load tab content
            if (tab === 'data') loadViewerData();
            if (tab === 'dashboard') loadViewerDashboard();
            if (tab === 'report') loadViewerReport();
            if (tab === 'drafts') loadDrafts();
        }
        
        async function submitViewerForm(form) {
            const formEl = document.getElementById('viewerForm');
            const formData = new FormData(formEl);
            const data = { _formId: form.id, _formTitle: form.title, _timestamp: new Date().toISOString() };
            formData.forEach((v, k) => data[k] = v);
            
            const btn = formEl.querySelector('.viewer-submit');
            btn.disabled = true;
            btn.textContent = '‚è≥ Submitting...';
            
            const scriptUrl = localStorage.getItem('scriptUrl');
            if (scriptUrl && form.sheetId) {
                try {
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'submitForm', formId: form.id, sheetId: form.sheetId, data })
                    });
                } catch (err) {}
            }
            
            const submissions = JSON.parse(localStorage.getItem('submissions_' + form.id) || '[]');
            submissions.push(data);
            localStorage.setItem('submissions_' + form.id, JSON.stringify(submissions));
            
            alert('‚úÖ Submitted successfully!');
            formEl.reset();
            document.querySelectorAll('.sig-canvas').forEach(c => c.getContext('2d').clearRect(0, 0, c.width, c.height));
            document.querySelectorAll('.gps-status').forEach(s => s.textContent = '');
            btn.disabled = false;
            btn.textContent = '‚úÖ Submit';
        }
        
        async function loadViewerData() {
            const form = window.currentViewForm;
            const container = document.getElementById('dataContainer');
            let data = JSON.parse(localStorage.getItem('submissions_' + form.id) || '[]');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:30px;">üì≠ No submissions yet</p>';
                return;
            }
            
            const headers = Object.keys(data[0]).filter(h => !h.startsWith('_'));
            container.innerHTML = `
                <div style="margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <span style="font-size:13px;color:#28a745;font-weight:700;">‚úÖ ${data.length} submission${data.length > 1 ? 's' : ''}</span>
                    <button onclick="exportData()" style="padding:8px 14px;background:#004080;color:#fff;border:none;border-radius:5px;cursor:pointer;font-family:Oswald;font-size:11px;">üì• Export CSV</button>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>#</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${data.map((row, i) => `<tr><td>${i+1}</td>${headers.map(h => `<td>${row[h] || '-'}</td>`).join('')}</tr>`).join('')}</tbody>
                    </table>
                </div>`;
        }
        
        window.exportData = function() {
            const form = window.currentViewForm;
            const data = JSON.parse(localStorage.getItem('submissions_' + form.id) || '[]');
            if (data.length === 0) return notify('No data to export', 'error');
            
            const headers = Object.keys(data[0]).filter(h => !h.startsWith('_'));
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                csv += headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = form.title.replace(/[^a-zA-Z0-9]/g, '_') + '_data.csv';
            link.click();
            notify('Data exported!');
        };
        
        async function loadViewerDashboard() {
            const form = window.currentViewForm;
            const container = document.getElementById('dashContainer');
            let data = JSON.parse(localStorage.getItem('submissions_' + form.id) || '[]');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:30px;">üìä No data to display</p>';
                return;
            }
            
            const today = new Date().toDateString();
            const todayCount = data.filter(r => new Date(r._timestamp).toDateString() === today).length;
            
            let html = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:15px;margin-bottom:20px;">
                    <div class="stat-card">
                        <div class="stat-value">${data.length}</div>
                        <div class="stat-label">Total Submissions</div>
                    </div>
                    <div class="stat-card" style="background:linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="stat-value">${todayCount}</div>
                        <div class="stat-label">Today</div>
                    </div>
                </div>`;
            
            // Charts for categorical fields
            form.fields.filter(f => ['radio', 'yesno', 'yesnona', 'select'].includes(f.type)).forEach(field => {
                const counts = {};
                data.forEach(row => { 
                    const val = row[field.name] || '(empty)'; 
                    counts[val] = (counts[val] || 0) + 1; 
                });
                const max = Math.max(...Object.values(counts));
                
                html += `
                    <div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:10px;border:2px solid #e9ecef;">
                        <h4 style="margin:0 0 12px;font-size:13px;color:#004080;">${field.label}</h4>
                        ${Object.entries(counts).sort((a,b) => b[1] - a[1]).map(([key, val]) => `
                            <div style="margin:8px 0;">
                                <div class="chart-label">
                                    <span>${key}</span>
                                    <span><strong>${val}</strong> (${(val/data.length*100).toFixed(0)}%)</span>
                                </div>
                                <div class="chart-bar" style="width:${val/max*100}%;"></div>
                            </div>
                        `).join('')}
                    </div>`;
            });
            
            container.innerHTML = html;
        }
        
        async function loadViewerReport() {
            const form = window.currentViewForm;
            const container = document.getElementById('reportContainer');
            let data = JSON.parse(localStorage.getItem('submissions_' + form.id) || '[]');
            
            let html = `<div id="printableReport">
                <div style="text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:3px solid #004080;">
                    <img src="${CONFIG.LOGO}" style="width:60px;border-radius:8px;">
                    <h2 style="color:#004080;margin:10px 0 5px;">${form.title}</h2>
                    <p style="font-size:11px;color:#666;">Report Generated: ${new Date().toLocaleString()}</p>
                </div>
                
                <div style="background:#e8f4fc;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <div style="display:flex;justify-content:space-around;text-align:center;">
                        <div><div style="font-size:24px;font-weight:700;color:#004080;">${data.length}</div><div style="font-size:11px;">Total Submissions</div></div>
                        <div><div style="font-size:24px;font-weight:700;color:#28a745;">${form.fields.filter(f => f.type !== 'section').length}</div><div style="font-size:11px;">Questions</div></div>
                    </div>
                </div>`;
            
            if (data.length > 0) {
                form.fields.filter(f => f.type !== 'section').forEach(field => {
                    html += `<div style="margin:15px 0;padding:12px;background:#f8f9fa;border-radius:8px;border-left:4px solid #004080;">
                        <h4 style="margin:0 0 8px;font-size:12px;color:#004080;">${field.label}</h4>`;
                    
                    if (['radio', 'yesno', 'yesnona', 'select'].includes(field.type)) {
                        const counts = {};
                        data.forEach(row => { 
                            const val = row[field.name] || '(no response)'; 
                            counts[val] = (counts[val] || 0) + 1; 
                        });
                        html += '<table style="width:100%;font-size:11px;border-collapse:collapse;"><tbody>';
                        Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([key, val]) => { 
                            html += `<tr><td style="padding:4px 0;">${key}</td><td style="text-align:right;font-weight:700;">${val} <span style="color:#666;">(${(val/data.length*100).toFixed(1)}%)</span></td></tr>`; 
                        });
                        html += '</tbody></table>';
                    } else if (field.type === 'number') {
                        const nums = data.map(r => parseFloat(r[field.name])).filter(n => !isNaN(n));
                        if (nums.length) {
                            const avg = nums.reduce((a,b) => a+b, 0) / nums.length;
                            html += `<p style="font-size:11px;margin:0;">Average: <strong>${avg.toFixed(2)}</strong> | Min: <strong>${Math.min(...nums)}</strong> | Max: <strong>${Math.max(...nums)}</strong></p>`;
                        }
                    } else {
                        const responseCount = data.filter(r => r[field.name]).length;
                        html += `<p style="font-size:11px;margin:0;">Response rate: <strong>${responseCount}/${data.length}</strong> (${(responseCount/data.length*100).toFixed(0)}%)</p>`;
                    }
                    html += '</div>';
                });
            } else {
                html += '<p style="text-align:center;color:#666;padding:20px;">No submissions to report</p>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function printReport() {
            const content = document.getElementById('printableReport');
            if (!content) return;
            const win = window.open('', '_blank');
            win.document.write(`<html><head><title>Report - ${window.currentViewForm?.title || 'Form'}</title>
                <style>body{font-family:Arial,sans-serif;padding:30px;max-width:800px;margin:0 auto;}</style></head><body>`);
            win.document.write(content.innerHTML);
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }
        
        function saveDraft(formId) {
            const form = document.getElementById('viewerForm');
            const formData = new FormData(form);
            const draft = { timestamp: new Date().toISOString(), data: {} };
            formData.forEach((v, k) => draft.data[k] = v);
            
            const drafts = JSON.parse(localStorage.getItem('drafts_' + formId) || '[]');
            drafts.unshift(draft);
            if (drafts.length > 10) drafts.pop();
            localStorage.setItem('drafts_' + formId, JSON.stringify(drafts));
            notify('Draft saved!');
        }
        
        function loadDrafts() {
            const form = window.currentViewForm;
            const container = document.getElementById('draftsContainer');
            const drafts = JSON.parse(localStorage.getItem('drafts_' + form.id) || '[]');
            
            if (drafts.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:30px;">üíæ No drafts saved yet</p>';
                return;
            }
            
            container.innerHTML = drafts.map((draft, i) => `
                <div style="background:#fffbeb;border:2px solid #ffc107;border-radius:8px;padding:12px;margin:10px 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <div>
                        <strong style="color:#856404;">Draft ${i+1}</strong><br>
                        <small style="color:#666;">${new Date(draft.timestamp).toLocaleString()}</small>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button onclick="loadDraft(${i})" style="padding:8px 14px;background:#004080;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:11px;font-family:Oswald;">üìÇ Load</button>
                        <button onclick="deleteDraft(${i})" style="padding:8px 14px;background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:11px;font-family:Oswald;">üóëÔ∏è</button>
                    </div>
                </div>`).join('');
        }
        
        window.loadDraft = function(index) {
            const form = window.currentViewForm;
            const drafts = JSON.parse(localStorage.getItem('drafts_' + form.id) || '[]');
            if (!drafts[index]) return;
            
            const formEl = document.getElementById('viewerForm');
            Object.entries(drafts[index].data).forEach(([name, value]) => {
                const el = formEl.querySelector(`[name="${name}"]`);
                if (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        formEl.querySelectorAll(`[name="${name}"]`).forEach(inp => inp.checked = inp.value === value);
                    } else {
                        el.value = value;
                    }
                }
            });
            showViewerTab('form', true);
            notify('Draft loaded!');
        };
        
        window.deleteDraft = function(index) {
            if (!confirm('Delete this draft?')) return;
            const form = window.currentViewForm;
            const drafts = JSON.parse(localStorage.getItem('drafts_' + form.id) || '[]');
            drafts.splice(index, 1);
            localStorage.setItem('drafts_' + form.id, JSON.stringify(drafts));
            loadDrafts();
            notify('Draft deleted');
        };
        
        function applySkipLogic(form) {
            document.querySelectorAll('[data-skip]').forEach(fieldEl => {
                const skip = JSON.parse(fieldEl.dataset.skip);
                if (!skip.field) return;
                
                const sourceField = form.fields.find(f => f.id === skip.field);
                if (!sourceField) return;
                
                const checkVisibility = () => {
                    let sourceVal = '';
                    if (['radio', 'yesno', 'yesnona'].includes(sourceField.type)) {
                        const checked = document.querySelector(`[name="${sourceField.name}"]:checked`);
                        sourceVal = checked ? checked.value : '';
                    } else {
                        const el = document.querySelector(`[name="${sourceField.name}"]`);
                        sourceVal = el ? el.value : '';
                    }
                    
                    let show = skip.operator === 'equals' ? sourceVal === skip.value : sourceVal !== skip.value;
                    fieldEl.style.display = show ? 'block' : 'none';
                };
                
                if (['radio', 'yesno', 'yesnona'].includes(sourceField.type)) {
                    document.querySelectorAll(`[name="${sourceField.name}"]`).forEach(r => r.onchange = checkVisibility);
                } else {
                    const el = document.querySelector(`[name="${sourceField.name}"]`);
                    if (el) el.onchange = checkVisibility;
                }
                checkVisibility();
            });
        }
        
        // ========================================
        // GPS & SIGNATURE
        // ========================================
        window.captureGPS = function(btn) {
            const container = btn.closest('.gps-container');
            const status = container.querySelector('.gps-status');
            const latInput = container.querySelector('.gps-lat');
            const lngInput = container.querySelector('.gps-lng');
            
            status.textContent = 'üì° Getting location...';
            status.style.color = '#004080';
            
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    latInput.value = lat;
                    lngInput.value = lng;
                    status.innerHTML = '‚úÖ <strong>' + lat + ', ' + lng + '</strong>';
                    status.style.color = '#28a745';
                    btn.textContent = 'üìç Update GPS';
                },
                err => {
                    status.textContent = '‚ùå ' + (err.code === 1 ? 'Permission denied' : 'Location unavailable');
                    status.style.color = '#dc3545';
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        };
        
        function initSignature(container) {
            const canvas = container.querySelector('.sig-canvas');
            const ctx = canvas.getContext('2d');
            const dataInput = container.querySelector('.sig-data');
            let drawing = false;
            
            const getPos = e => {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
            };
            
            const start = e => { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); };
            const draw = e => { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
            const stop = () => { drawing = false; dataInput.value = canvas.toDataURL(); };
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stop);
            
            ctx.strokeStyle = '#004080';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
        }
        
        window.clearSig = function(btn) {
            const container = btn.closest('.sig-container');
            const canvas = container.querySelector('.sig-canvas');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            container.querySelector('.sig-data').value = '';
        };
        
        // ========================================
        // SETTINGS & UTILITIES
        // ========================================
        function openSettings() {
            document.getElementById('settingsScriptUrl').value = state.scriptUrl;
            document.getElementById('settingsFolderId').value = state.folderId;
            document.getElementById('settingsModal').classList.add('show');
        }
        
        function saveSystemSettings() {
            state.scriptUrl = document.getElementById('settingsScriptUrl').value;
            state.folderId = document.getElementById('settingsFolderId').value;
            localStorage.setItem('scriptUrl', state.scriptUrl);
            localStorage.setItem('folderId', state.folderId);
            closeModal('settingsModal');
            notify('Settings saved!');
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function notify(msg, type = 'success') {
            const el = document.createElement('div');
            el.className = 'notification' + (type === 'error' ? ' error' : '');
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
        
        function previewForm() {
            if (state.fields.length === 0) { notify('Add fields first', 'error'); return; }
            const form = { 
                id: state.currentForm.id, 
                title: document.getElementById('formTitleInput').value, 
                subtitle: 'Data Collection', 
                fields: state.fields,
                sheetId: state.currentForm.sheetId || ''
            };
            window.currentViewForm = form;
            document.getElementById('builderContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'block';
            renderFormViewer(form);
        }
        
        function viewData(formId) {
            const form = state.forms.find(f => f.id === formId);
            if (!form) return;
            window.currentViewForm = form;
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'block';
            window.location.hash = 'tab=data';
            renderFormViewer(form);
        }
        
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.onclick = (e) => { if (e.target === overlay) overlay.classList.remove('show'); };
        });
    </script>
</body>
</html>
