<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL | DHIS2 Integration</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; }
        .header h1 { font-size: 20px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        .header-btn.dhis2 { background: #17a2b8; color: white; }
        
        .main-container { display: none; margin-top: 70px; height: calc(100vh - 100px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        .form-field { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 6px; }
        .field-action-btn:hover { background: #004080; color: white; }
        .field-action-btn.move-up, .field-action-btn.move-down { background: #17a2b8; color: white; border-color: #17a2b8; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; margin-left: 8px; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        .field-badge.dhis2 { background: #d1ecf1; color: #0c5460; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; }
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; }
        .prop-section.dhis2 { background: #e8f4fc; border-color: #17a2b8; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 700px; width: 100%; border: 4px double #004080; max-height: 90vh; overflow-y: auto; }
        .modal.large { max-width: 900px; }
        .modal-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-header.dhis2 { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 2px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 20px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; border: 2px solid; }
        .modal-btn.primary { background: #004080; color: white; border-color: #004080; }
        .modal-btn.success { background: #28a745; color: white; border-color: #28a745; }
        .modal-btn.danger { background: #dc3545; color: white; border-color: #dc3545; }
        .modal-btn.dhis2 { background: #17a2b8; color: white; border-color: #17a2b8; }
        .modal-btn.secondary { background: #6c757d; color: white; border-color: #6c757d; }
        
        /* DHIS2 Specific Styles */
        .dhis2-config-section { background: #f8f9fa; border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .dhis2-config-title { font-size: 13px; font-weight: 700; color: #17a2b8; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .dhis2-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .dhis2-input-group.full { grid-template-columns: 1fr; }
        .dhis2-input { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .dhis2-input:focus { outline: none; border-color: #17a2b8; }
        .dhis2-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .dhis2-status { padding: 10px 15px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .dhis2-status.connected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .dhis2-status.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .dhis2-status.loading { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        
        .mapping-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .mapping-table th, .mapping-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .mapping-table th { background: #17a2b8; color: white; font-weight: 700; font-size: 10px; position: sticky; top: 0; }
        .mapping-table tr:nth-child(even) { background: #f8f9fa; }
        .mapping-table tr:hover { background: #e8f4fc; }
        .mapping-table .status-icon { font-size: 14px; }
        .mapping-table select { width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; }
        
        .org-unit-tree { max-height: 300px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 6px; padding: 10px; background: white; }
        .org-unit-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; margin-bottom: 4px; cursor: pointer; font-size: 12px; }
        .org-unit-item:hover { background: #e8f4fc; }
        .org-unit-item input { width: 16px; height: 16px; }
        .org-unit-level { font-size: 9px; padding: 2px 6px; background: #17a2b8; color: white; border-radius: 10px; }
        
        .progress-modal { text-align: center; padding: 30px; }
        .progress-modal .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #17a2b8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-modal h3 { color: #004080; margin-bottom: 10px; }
        .progress-modal p { color: #666; font-size: 12px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-box.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .stat-box.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #000; }
        .stat-box.danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .stat-box .stat-value { font-size: 24px; font-weight: 700; }
        .stat-box .stat-label { font-size: 10px; opacity: 0.9; margin-top: 4px; }
        
        .log-container { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; margin-top: 15px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #333; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        .log-entry.warning { color: #ffd43b; }
        .log-entry.info { color: #74c0fc; }
        
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        
        .viewer-container { display: none; min-height: 100vh; background: #e9ecef; }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 100; }
        .viewer-back-btn { background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; margin-right: 10px; }
        .viewer-back-btn:hover { background: #c82333; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
        .viewer-nav-btn:hover { transform: translateY(-2px); }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-input.error { border-color: #dc3545 !important; background: #fff5f5 !important; }
        .field-error-msg { color: #dc3545; font-size: 11px; margin-top: 6px; padding: 6px 10px; background: #fff5f5; border-radius: 4px; }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .viewer-radio-option:hover { border-color: #004080; }
        .viewer-section { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 14px 18px; margin: 20px -25px; font-size: 13px; font-weight: 700; }
        
        .page-header { background: #e8f4fc; margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; }
        .next-btn { background: #004080; color: white; }
        .submit-btn { background: #28a745; color: white; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; font-size: 10px; position: sticky; top: 0; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e8f4fc; }
        
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; }
        .stat-card .stat-label { font-size: 10px; opacity: 0.9; margin-top: 5px; }
        
        .chart-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container h4 { color: #004080; font-size: 14px; margin-bottom: 15px; border-bottom: 2px solid #004080; padding-bottom: 8px; }
        
        .tabs-container { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; background: #e9ecef; border: 2px solid #dee2e6; border-radius: 6px 6px 0 0; cursor: pointer; font-family: 'Oswald', sans-serif; font-weight: 600; font-size: 12px; }
        .tab-btn.active { background: #17a2b8; color: white; border-color: #17a2b8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .help-text { font-size: 10px; color: #666; margin-top: 4px; font-style: italic; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .dhis2-input-group { grid-template-columns: 1fr; }
            .modal { max-width: 95%; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>Form Builder Pro</h1>
                <p>DHIS2 Integrated Data Collection</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn">üîì Login</button>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Organization</label>
                        <input type="text" class="auth-input" id="signupOrg" value="ICF-SL">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Confirm Password</label>
                        <input type="password" class="auth-input" id="signupConfirm" required placeholder="Confirm password">
                    </div>
                    <button type="submit" class="auth-btn">üìù Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>üìã Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser">üë§ User</span>
            <button class="header-btn" onclick="showHome()">üè† Home</button>
            <button class="header-btn success" onclick="newForm()">üìÑ New</button>
            <button class="header-btn" onclick="saveCurrentForm()">üíæ Save</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è Preview</button>
            <button class="header-btn dhis2" onclick="openDhis2Config()">üîó DHIS2</button>
            <button class="header-btn primary" onclick="shareForm()">üì§ Share</button>
            <button class="header-btn danger" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic Fields</h3>
                <div class="field-type" data-type="text">üìÑ Text Input</div>
                <div class="field-type" data-type="number">üî¢ Number</div>
                <div class="field-type" data-type="date">üìÖ Date</div>
                <div class="field-type" data-type="time">üïê Time</div>
                <div class="field-type" data-type="email">üìß Email</div>
                <div class="field-type" data-type="phone">üì± Phone</div>
                <div class="field-type" data-type="textarea">üìù Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection Fields</h3>
                <div class="field-type" data-type="select">üìã Dropdown</div>
                <div class="field-type" data-type="radio">üîò Radio Buttons</div>
                <div class="field-type" data-type="checkbox">‚òëÔ∏è Checkboxes</div>
                <div class="field-type" data-type="yesno">‚úÖ Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special Fields</h3>
                <div class="field-type" data-type="gps">üìç GPS Location</div>
                <div class="field-type" data-type="signature">‚úçÔ∏è Signature</div>
                <div class="field-type" data-type="rating">‚≠ê Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section">üìÅ Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount">üìä 0 fields | 1 page</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p id="previewSubtitle">Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:36px;margin-bottom:12px;">üì•</p>
                            <p style="font-weight:600;">Click field types on the left to add them</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title">‚öôÔ∏è Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;">üëÜ</p>
                    <p>Select a field to edit its properties</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    
    <!-- Footer -->
    <footer class="footer">¬© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | Form Builder Pro with DHIS2 Integration</footer>

    <!-- DHIS2 Configuration Modal -->
    <div class="modal-overlay" id="dhis2Modal">
        <div class="modal large">
            <div class="modal-header dhis2">
                <h3>üîó DHIS2 Configuration</h3>
                <button class="modal-close" onclick="closeModal('dhis2Modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchDhis2Tab('connection')">üîå Connection</button>
                    <button class="tab-btn" onclick="switchDhis2Tab('mapping')">üîÑ Data Element Mapping</button>
                    <button class="tab-btn" onclick="switchDhis2Tab('orgunits')">üè• Org Units</button>
                    <button class="tab-btn" onclick="switchDhis2Tab('dataset')">üìä Dataset</button>
                    <button class="tab-btn" onclick="switchDhis2Tab('submit')">üì§ Submit Data</button>
                </div>
                
                <!-- Connection Tab -->
                <div class="tab-content active" id="tabConnection">
                    <div id="dhis2ConnectionStatus" class="dhis2-status disconnected">
                        <span>üî¥</span> <span>Not Connected</span>
                    </div>
                    
                    <div class="dhis2-config-section">
                        <div class="dhis2-config-title">üåê Server Settings</div>
                        <div class="dhis2-input-group full">
                            <div>
                                <label class="dhis2-label">DHIS2 Server URL</label>
                                <input type="url" class="dhis2-input" id="dhis2Url" placeholder="https://your-dhis2-instance.org">
                                <p class="help-text">Enter the full URL without trailing slash</p>
                            </div>
                        </div>
                        <div class="dhis2-input-group" style="margin-top:12px;">
                            <div>
                                <label class="dhis2-label">Username</label>
                                <input type="text" class="dhis2-input" id="dhis2Username" placeholder="admin">
                            </div>
                            <div>
                                <label class="dhis2-label">Password</label>
                                <input type="password" class="dhis2-input" id="dhis2Password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                        <div class="dhis2-input-group" style="margin-top:12px;">
                            <div>
                                <label class="dhis2-label">Organization Unit Level</label>
                                <select class="dhis2-input" id="dhis2OrgLevel">
                                    <option value="1">Level 1 (National)</option>
                                    <option value="2">Level 2 (Region)</option>
                                    <option value="3">Level 3 (District)</option>
                                    <option value="4">Level 4 (Chiefdom/Sub-district)</option>
                                    <option value="5" selected>Level 5 (Facility)</option>
                                    <option value="6">Level 6</option>
                                    <option value="7">Level 7</option>
                                </select>
                            </div>
                            <div>
                                <label class="dhis2-label">Period Type</label>
                                <select class="dhis2-input" id="dhis2PeriodType">
                                    <option value="Monthly" selected>Monthly</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Daily">Daily</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="modal-btn dhis2" onclick="testDhis2Connection()">üß™ Test Connection</button>
                        <button class="modal-btn success" onclick="saveDhis2Config()">üíæ Save Configuration</button>
                        <button class="modal-btn secondary" onclick="loadDhis2Config()">üìÇ Load Saved</button>
                    </div>
                    
                    <div id="dhis2ServerInfo" style="margin-top:20px;display:none;">
                        <div class="dhis2-config-section">
                            <div class="dhis2-config-title">üìä Server Information</div>
                            <div id="serverInfoContent"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Mapping Tab -->
                <div class="tab-content" id="tabMapping">
                    <div class="stats-grid" id="mappingStats">
                        <div class="stat-box"><div class="stat-value" id="statTotalFields">0</div><div class="stat-label">Form Fields</div></div>
                        <div class="stat-box success"><div class="stat-value" id="statMapped">0</div><div class="stat-label">Mapped</div></div>
                        <div class="stat-box warning"><div class="stat-value" id="statUnmapped">0</div><div class="stat-label">Unmapped</div></div>
                        <div class="stat-box"><div class="stat-value" id="statDhis2Elements">0</div><div class="stat-label">DHIS2 Elements</div></div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                        <button class="modal-btn dhis2" onclick="fetchDataElements()">üîÑ Fetch DHIS2 Data Elements</button>
                        <button class="modal-btn success" onclick="autoMapFields()">üéØ Auto-Map Fields</button>
                        <button class="modal-btn primary" onclick="createDataElementsInDhis2()">‚ûï Create Missing in DHIS2</button>
                    </div>
                    
                    <div id="mappingTableContainer" style="max-height:400px;overflow:auto;">
                        <table class="mapping-table" id="mappingTable">
                            <thead>
                                <tr>
                                    <th>Form Field</th>
                                    <th>Field Name/Code</th>
                                    <th>Type</th>
                                    <th>DHIS2 Data Element</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="mappingTableBody">
                                <tr><td colspan="5" style="text-align:center;padding:30px;color:#868e96;">Add fields to your form first</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Org Units Tab -->
                <div class="tab-content" id="tabOrgunits">
                    <div class="stats-grid" id="orgUnitStats">
                        <div class="stat-box"><div class="stat-value" id="statTotalOrgUnits">0</div><div class="stat-label">Total Org Units</div></div>
                        <div class="stat-box success"><div class="stat-value" id="statSelectedOrgUnits">0</div><div class="stat-label">Selected</div></div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                        <button class="modal-btn dhis2" onclick="fetchOrgUnits()">üîÑ Fetch Org Units</button>
                        <button class="modal-btn success" onclick="selectAllOrgUnits()">‚úÖ Select All</button>
                        <button class="modal-btn danger" onclick="deselectAllOrgUnits()">‚ùå Deselect All</button>
                    </div>
                    
                    <div class="dhis2-input-group" style="margin-bottom:15px;">
                        <div>
                            <label class="dhis2-label">Filter Org Units</label>
                            <input type="text" class="dhis2-input" id="orgUnitFilter" placeholder="Type to filter..." oninput="filterOrgUnits()">
                        </div>
                        <div>
                            <label class="dhis2-label">Filter by Level</label>
                            <select class="dhis2-input" id="orgUnitLevelFilter" onchange="filterOrgUnits()">
                                <option value="">All Levels</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="org-unit-tree" id="orgUnitTree">
                        <p style="text-align:center;padding:30px;color:#868e96;">Click "Fetch Org Units" to load</p>
                    </div>
                </div>
                
                <!-- Dataset Tab -->
                <div class="tab-content" id="tabDataset">
                    <div class="dhis2-config-section">
                        <div class="dhis2-config-title">üìä Dataset Configuration</div>
                        
                        <div class="dhis2-input-group full">
                            <div>
                                <label class="dhis2-label">Dataset Name</label>
                                <input type="text" class="dhis2-input" id="datasetName" placeholder="e.g., Monthly Health Facility Report">
                            </div>
                        </div>
                        <div class="dhis2-input-group" style="margin-top:12px;">
                            <div>
                                <label class="dhis2-label">Short Name</label>
                                <input type="text" class="dhis2-input" id="datasetShortName" placeholder="e.g., MHFR">
                            </div>
                            <div>
                                <label class="dhis2-label">Code</label>
                                <input type="text" class="dhis2-input" id="datasetCode" placeholder="e.g., DS_MHFR_001">
                            </div>
                        </div>
                        <div class="dhis2-input-group full" style="margin-top:12px;">
                            <div>
                                <label class="dhis2-label">Description</label>
                                <textarea class="dhis2-input" id="datasetDescription" rows="2" placeholder="Dataset description..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div id="existingDatasetInfo" style="display:none;margin-bottom:15px;">
                        <div class="dhis2-status connected">
                            <span>üìä</span>
                            <span id="existingDatasetText">Using existing dataset</span>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="modal-btn dhis2" onclick="fetchExistingDatasets()">üîç Find Existing Datasets</button>
                        <button class="modal-btn success" onclick="createDataset()">‚ûï Create New Dataset</button>
                        <button class="modal-btn primary" onclick="updateDataset()">üìù Update Dataset</button>
                    </div>
                    
                    <div id="existingDatasets" style="margin-top:15px;display:none;">
                        <div class="dhis2-config-section">
                            <div class="dhis2-config-title">üìã Existing Datasets</div>
                            <div id="datasetsList" style="max-height:200px;overflow:auto;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Tab -->
                <div class="tab-content" id="tabSubmit">
                    <div class="stats-grid" id="submitStats">
                        <div class="stat-box"><div class="stat-value" id="statTotalRecords">0</div><div class="stat-label">Total Records</div></div>
                        <div class="stat-box success"><div class="stat-value" id="statSubmitted">0</div><div class="stat-label">Submitted</div></div>
                        <div class="stat-box danger"><div class="stat-value" id="statPending">0</div><div class="stat-label">Pending</div></div>
                        <div class="stat-box warning"><div class="stat-value" id="statFailed">0</div><div class="stat-label">Failed</div></div>
                    </div>
                    
                    <div class="dhis2-config-section">
                        <div class="dhis2-config-title">üì§ Submission Settings</div>
                        <div class="dhis2-input-group">
                            <div>
                                <label class="dhis2-label">Period (YYYYMM)</label>
                                <input type="text" class="dhis2-input" id="submitPeriod" placeholder="e.g., 202501">
                            </div>
                            <div>
                                <label class="dhis2-label">Batch Size</label>
                                <select class="dhis2-input" id="submitBatchSize">
                                    <option value="10">10 records</option>
                                    <option value="25" selected>25 records</option>
                                    <option value="50">50 records</option>
                                    <option value="100">100 records</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                        <button class="modal-btn success" onclick="submitDataToDhis2()">üöÄ Submit All Pending</button>
                        <button class="modal-btn dhis2" onclick="dryRunSubmission()">üß™ Dry Run (Test)</button>
                        <button class="modal-btn secondary" onclick="exportForDhis2()">üì• Export JSON</button>
                    </div>
                    
                    <div class="log-container" id="submitLog">
                        <div class="log-entry info">Ready for submission...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üîó Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:20px;font-weight:700;color:#004080;" id="shareFormTitle">Form Title</div>
                </div>
                <div class="qr-container">
                    <div class="qr-box"><div id="qrCode"></div></div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;">üì± Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()">üìã Copy URL</button>
                        <button class="modal-btn success" onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal-overlay" id="progressModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-body">
                <div class="progress-modal">
                    <div class="spinner"></div>
                    <h3 id="progressTitle">Processing...</h3>
                    <p id="progressText">Please wait...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ==================== GLOBAL STATE ====================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            isSharedMode: false,
            settings: {
                title: 'My Data Collection Form',
                subtitle: 'Data Collection System',
                organization: 'ICF-SL',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg'
            },
            dhis2: {
                url: '',
                username: '',
                password: '',
                orgUnitLevel: 5,
                periodType: 'Monthly',
                connected: false,
                serverInfo: null,
                dataElements: [],
                orgUnits: [],
                selectedOrgUnits: [],
                datasetId: null,
                datasetName: ''
            },
            fieldMappings: {},
            collectedData: []
        };

        const fieldDefs = {
            text: { label: 'Text', icon: 'üìÑ', defaultLabel: 'Text Field', valueType: 'TEXT' },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field', valueType: 'NUMBER' },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field', valueType: 'DATE' },
            time: { label: 'Time', icon: 'üïê', defaultLabel: 'Time Field', valueType: 'TIME' },
            email: { label: 'Email', icon: 'üìß', defaultLabel: 'Email Address', valueType: 'EMAIL' },
            phone: { label: 'Phone', icon: 'üì±', defaultLabel: 'Phone Number', valueType: 'PHONE_NUMBER' },
            textarea: { label: 'Long Text', icon: 'üìù', defaultLabel: 'Long Text', valueType: 'LONG_TEXT' },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Choice', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkbox', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question', valueType: 'BOOLEAN' },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location', valueType: 'COORDINATE' },
            signature: { label: 'Signature', icon: '‚úçÔ∏è', defaultLabel: 'Signature', valueType: 'IMAGE' },
            rating: { label: 'Rating', icon: '‚≠ê', defaultLabel: 'Rating', valueType: 'INTEGER', max: 5 },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section', valueType: null }
        };

        // ==================== INITIALIZATION ====================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    state.isSharedMode = true;
                    renderSharedForm(data);
                    return;
                } catch (err) { console.error('Error decoding:', err); }
            }
            
            loadFromStorage();
            loadDhis2Config();
            setupEventListeners();
            checkAuth();
        }

        function setupEventListeners() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab)));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.querySelectorAll('.field-type').forEach(el => el.addEventListener('click', () => addField(el.dataset.type)));
            document.getElementById('formTitle').addEventListener('input', (e) => {
                state.settings.title = e.target.value;
                document.getElementById('previewTitle').textContent = e.target.value;
                document.getElementById('datasetName').value = e.target.value;
                saveToStorage();
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        // ==================== DHIS2 API ====================
        async function dhis2Request(endpoint, method = 'GET', payload = null) {
            const { url, username, password } = state.dhis2;
            if (!url || !username || !password) {
                throw new Error('DHIS2 not configured');
            }

            const serverUrl = url.replace(/\/$/, '');
            const apiUrl = `${serverUrl}/api/${endpoint}`;
            
            const options = {
                method: method,
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`),
                    'Content-Type': 'application/json'
                }
            };
            
            if (payload && method !== 'GET') {
                options.body = JSON.stringify(payload);
            }
            
            console.log(`DHIS2 ${method}: ${apiUrl}`);
            
            try {
                const response = await fetch(apiUrl, options);
                const text = await response.text();
                
                let data;
                try { data = JSON.parse(text); } catch (e) { data = text; }
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                console.error('DHIS2 Request Error:', error);
                return {
                    success: false,
                    status: 0,
                    error: error.message
                };
            }
        }

        async function testDhis2Connection() {
            const url = document.getElementById('dhis2Url').value.trim();
            const username = document.getElementById('dhis2Username').value.trim();
            const password = document.getElementById('dhis2Password').value;
            
            if (!url || !username || !password) {
                notify('Please fill in all connection fields', 'error');
                return;
            }
            
            state.dhis2.url = url;
            state.dhis2.username = username;
            state.dhis2.password = password;
            
            showProgress('Testing Connection', 'Connecting to DHIS2 server...');
            updateConnectionStatus('loading', 'Testing...');
            
            try {
                const result = await dhis2Request('system/info.json');
                
                if (result.success && result.data) {
                    state.dhis2.connected = true;
                    state.dhis2.serverInfo = result.data;
                    updateConnectionStatus('connected', `Connected to ${result.data.systemName}`);
                    
                    document.getElementById('dhis2ServerInfo').style.display = 'block';
                    document.getElementById('serverInfoContent').innerHTML = `
                        <p><strong>System:</strong> ${result.data.systemName}</p>
                        <p><strong>Version:</strong> ${result.data.version}</p>
                        <p><strong>Calendar:</strong> ${result.data.calendar || 'ISO'}</p>
                        <p><strong>Date Format:</strong> ${result.data.dateFormat || 'yyyy-MM-dd'}</p>
                    `;
                    
                    notify('‚úÖ Connected to DHIS2!', 'success');
                } else {
                    state.dhis2.connected = false;
                    updateConnectionStatus('disconnected', `Failed: ${result.error || result.status}`);
                    notify('‚ùå Connection failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                state.dhis2.connected = false;
                updateConnectionStatus('disconnected', 'Connection error');
                notify('‚ùå Connection error: ' + error.message, 'error');
            }
            
            hideProgress();
        }

        function updateConnectionStatus(type, message) {
            const statusEl = document.getElementById('dhis2ConnectionStatus');
            statusEl.className = `dhis2-status ${type}`;
            const icon = type === 'connected' ? 'üü¢' : type === 'loading' ? 'üü°' : 'üî¥';
            statusEl.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
        }

        function saveDhis2Config() {
            state.dhis2.url = document.getElementById('dhis2Url').value.trim();
            state.dhis2.username = document.getElementById('dhis2Username').value.trim();
            state.dhis2.password = document.getElementById('dhis2Password').value;
            state.dhis2.orgUnitLevel = parseInt(document.getElementById('dhis2OrgLevel').value);
            state.dhis2.periodType = document.getElementById('dhis2PeriodType').value;
            
            localStorage.setItem('dhis2Config', JSON.stringify({
                url: state.dhis2.url,
                username: state.dhis2.username,
                password: state.dhis2.password,
                orgUnitLevel: state.dhis2.orgUnitLevel,
                periodType: state.dhis2.periodType
            }));
            
            notify('üíæ DHIS2 configuration saved!', 'success');
        }

        function loadDhis2Config() {
            const saved = localStorage.getItem('dhis2Config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    state.dhis2.url = config.url || '';
                    state.dhis2.username = config.username || '';
                    state.dhis2.password = config.password || '';
                    state.dhis2.orgUnitLevel = config.orgUnitLevel || 5;
                    state.dhis2.periodType = config.periodType || 'Monthly';
                    
                    // Update form fields
                    if (document.getElementById('dhis2Url')) {
                        document.getElementById('dhis2Url').value = state.dhis2.url;
                        document.getElementById('dhis2Username').value = state.dhis2.username;
                        document.getElementById('dhis2Password').value = state.dhis2.password;
                        document.getElementById('dhis2OrgLevel').value = state.dhis2.orgUnitLevel;
                        document.getElementById('dhis2PeriodType').value = state.dhis2.periodType;
                    }
                } catch (e) { console.error('Error loading DHIS2 config:', e); }
            }
        }

        // ==================== DATA ELEMENTS ====================
        async function fetchDataElements() {
            if (!state.dhis2.connected) {
                notify('Please connect to DHIS2 first', 'error');
                return;
            }
            
            showProgress('Fetching Data Elements', 'Loading from DHIS2...');
            
            try {
                const result = await dhis2Request('dataElements.json?fields=id,code,name,shortName,displayName,valueType&paging=false');
                
                if (result.success && result.data && result.data.dataElements) {
                    state.dhis2.dataElements = result.data.dataElements;
                    document.getElementById('statDhis2Elements').textContent = state.dhis2.dataElements.length;
                    updateMappingTable();
                    notify(`‚úÖ Loaded ${state.dhis2.dataElements.length} data elements`, 'success');
                } else {
                    notify('Failed to fetch data elements', 'error');
                }
            } catch (error) {
                notify('Error: ' + error.message, 'error');
            }
            
            hideProgress();
        }

        function findDataElementMatch(fieldName, fieldCode) {
            const searchTerms = [
                fieldCode?.toLowerCase().trim(),
                fieldName?.toLowerCase().trim(),
                fieldCode?.toLowerCase().replace(/_/g, ' ').trim(),
                fieldName?.toLowerCase().replace(/_/g, ' ').trim()
            ].filter(Boolean);
            
            for (const de of state.dhis2.dataElements) {
                const deName = de.name?.toLowerCase();
                const deCode = de.code?.toLowerCase();
                const deShort = de.shortName?.toLowerCase();
                
                for (const term of searchTerms) {
                    if (deCode === term || deName === term || deShort === term) {
                        return de;
                    }
                }
            }
            
            // Fuzzy match
            for (const de of state.dhis2.dataElements) {
                const deName = de.name?.toLowerCase() || '';
                const deCode = de.code?.toLowerCase() || '';
                
                for (const term of searchTerms) {
                    if (deName.includes(term) || term.includes(deName) ||
                        deCode.includes(term) || term.includes(deCode)) {
                        return de;
                    }
                }
            }
            
            return null;
        }

        function autoMapFields() {
            if (state.dhis2.dataElements.length === 0) {
                notify('Fetch data elements first', 'error');
                return;
            }
            
            let mapped = 0;
            state.fields.filter(f => f.type !== 'section').forEach(field => {
                const match = findDataElementMatch(field.label, field.name);
                if (match) {
                    state.fieldMappings[field.id] = match.id;
                    mapped++;
                }
            });
            
            updateMappingTable();
            saveToStorage();
            notify(`‚úÖ Auto-mapped ${mapped} fields`, 'success');
        }

        function updateMappingTable() {
            const tbody = document.getElementById('mappingTableBody');
            const formFields = state.fields.filter(f => f.type !== 'section');
            
            document.getElementById('statTotalFields').textContent = formFields.length;
            
            if (formFields.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#868e96;">Add fields to your form first</td></tr>';
                document.getElementById('statMapped').textContent = '0';
                document.getElementById('statUnmapped').textContent = '0';
                return;
            }
            
            let mapped = 0;
            let html = '';
            
            formFields.forEach(field => {
                const def = fieldDefs[field.type];
                const mappedDeId = state.fieldMappings[field.id];
                const isMapped = !!mappedDeId;
                if (isMapped) mapped++;
                
                let selectHtml = `<select onchange="updateFieldMapping('${field.id}', this.value)">
                    <option value="">-- Select Data Element --</option>`;
                
                state.dhis2.dataElements.forEach(de => {
                    const selected = mappedDeId === de.id ? 'selected' : '';
                    selectHtml += `<option value="${de.id}" ${selected}>${escapeHtml(de.name)} [${de.code || 'no code'}]</option>`;
                });
                selectHtml += '</select>';
                
                html += `
                    <tr>
                        <td><strong>${escapeHtml(field.label)}</strong></td>
                        <td><code>${escapeHtml(field.name)}</code></td>
                        <td>${def?.icon || 'üìÑ'} ${def?.label || field.type}</td>
                        <td>${selectHtml}</td>
                        <td class="status-icon">${isMapped ? '‚úÖ' : '‚ö†Ô∏è'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            document.getElementById('statMapped').textContent = mapped;
            document.getElementById('statUnmapped').textContent = formFields.length - mapped;
        }

        function updateFieldMapping(fieldId, dataElementId) {
            if (dataElementId) {
                state.fieldMappings[fieldId] = dataElementId;
            } else {
                delete state.fieldMappings[fieldId];
            }
            updateMappingTable();
            saveToStorage();
        }

        async function createDataElementsInDhis2() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            const unmappedFields = state.fields.filter(f => 
                f.type !== 'section' && !state.fieldMappings[f.id]
            );
            
            if (unmappedFields.length === 0) {
                notify('All fields are already mapped!', 'info');
                return;
            }
            
            if (!confirm(`Create ${unmappedFields.length} data elements in DHIS2?`)) return;
            
            showProgress('Creating Data Elements', 'Please wait...');
            
            let created = 0;
            let errors = [];
            
            for (const field of unmappedFields) {
                const def = fieldDefs[field.type];
                const payload = {
                    name: field.label,
                    shortName: field.label.substring(0, 50),
                    code: field.name.toUpperCase(),
                    domainType: 'AGGREGATE',
                    valueType: def?.valueType || 'TEXT',
                    aggregationType: 'SUM',
                    categoryCombo: { id: 'bjDvmb4bfuf' } // Default category combo
                };
                
                try {
                    const result = await dhis2Request('dataElements', 'POST', payload);
                    if (result.success) {
                        created++;
                        // Get the created element ID
                        if (result.data && result.data.response && result.data.response.uid) {
                            state.fieldMappings[field.id] = result.data.response.uid;
                        }
                    } else {
                        errors.push(`${field.label}: ${result.error || 'Failed'}`);
                    }
                } catch (e) {
                    errors.push(`${field.label}: ${e.message}`);
                }
            }
            
            hideProgress();
            
            if (created > 0) {
                await fetchDataElements(); // Refresh list
            }
            
            if (errors.length > 0) {
                notify(`Created ${created}, Failed ${errors.length}`, 'warning');
                console.error('Creation errors:', errors);
            } else {
                notify(`‚úÖ Created ${created} data elements!`, 'success');
            }
        }

        // ==================== ORG UNITS ====================
        async function fetchOrgUnits() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            showProgress('Fetching Org Units', 'Loading from DHIS2...');
            
            const level = state.dhis2.orgUnitLevel;
            
            try {
                const result = await dhis2Request(`organisationUnits.json?fields=id,code,displayName,name,shortName,level,parent[id,name]&filter=level:eq:${level}&paging=false`);
                
                if (result.success && result.data && result.data.organisationUnits) {
                    state.dhis2.orgUnits = result.data.organisationUnits;
                    document.getElementById('statTotalOrgUnits').textContent = state.dhis2.orgUnits.length;
                    renderOrgUnitTree();
                    updateOrgLevelFilter();
                    notify(`‚úÖ Loaded ${state.dhis2.orgUnits.length} org units`, 'success');
                } else {
                    // Try all levels if specific level returns empty
                    const allResult = await dhis2Request('organisationUnits.json?fields=id,code,displayName,name,shortName,level,parent[id,name]&paging=false');
                    if (allResult.success && allResult.data && allResult.data.organisationUnits) {
                        state.dhis2.orgUnits = allResult.data.organisationUnits;
                        document.getElementById('statTotalOrgUnits').textContent = state.dhis2.orgUnits.length;
                        renderOrgUnitTree();
                        updateOrgLevelFilter();
                        notify(`‚úÖ Loaded ${state.dhis2.orgUnits.length} org units (all levels)`, 'success');
                    }
                }
            } catch (error) {
                notify('Error: ' + error.message, 'error');
            }
            
            hideProgress();
        }

        function updateOrgLevelFilter() {
            const levels = [...new Set(state.dhis2.orgUnits.map(ou => ou.level))].sort((a, b) => a - b);
            const select = document.getElementById('orgUnitLevelFilter');
            select.innerHTML = '<option value="">All Levels</option>';
            levels.forEach(level => {
                select.innerHTML += `<option value="${level}">Level ${level}</option>`;
            });
        }

        function renderOrgUnitTree() {
            const container = document.getElementById('orgUnitTree');
            const filter = document.getElementById('orgUnitFilter').value.toLowerCase();
            const levelFilter = document.getElementById('orgUnitLevelFilter').value;
            
            let filtered = state.dhis2.orgUnits;
            
            if (filter) {
                filtered = filtered.filter(ou => 
                    ou.displayName?.toLowerCase().includes(filter) ||
                    ou.name?.toLowerCase().includes(filter) ||
                    ou.code?.toLowerCase().includes(filter)
                );
            }
            
            if (levelFilter) {
                filtered = filtered.filter(ou => ou.level === parseInt(levelFilter));
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:20px;color:#868e96;">No org units found</p>';
                return;
            }
            
            container.innerHTML = filtered.slice(0, 500).map(ou => {
                const isSelected = state.dhis2.selectedOrgUnits.includes(ou.id);
                return `
                    <div class="org-unit-item" onclick="toggleOrgUnit('${ou.id}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrgUnit('${ou.id}')">
                        <span>${escapeHtml(ou.displayName || ou.name)}</span>
                        <span class="org-unit-level">L${ou.level}</span>
                    </div>
                `;
            }).join('');
            
            if (filtered.length > 500) {
                container.innerHTML += `<p style="text-align:center;padding:10px;color:#868e96;font-size:11px;">Showing 500 of ${filtered.length}. Use filter to narrow down.</p>`;
            }
            
            updateSelectedCount();
        }

        function toggleOrgUnit(id) {
            const index = state.dhis2.selectedOrgUnits.indexOf(id);
            if (index === -1) {
                state.dhis2.selectedOrgUnits.push(id);
            } else {
                state.dhis2.selectedOrgUnits.splice(index, 1);
            }
            renderOrgUnitTree();
        }

        function selectAllOrgUnits() {
            state.dhis2.selectedOrgUnits = state.dhis2.orgUnits.map(ou => ou.id);
            renderOrgUnitTree();
            notify(`‚úÖ Selected all ${state.dhis2.selectedOrgUnits.length} org units`);
        }

        function deselectAllOrgUnits() {
            state.dhis2.selectedOrgUnits = [];
            renderOrgUnitTree();
            notify('Deselected all org units');
        }

        function filterOrgUnits() {
            renderOrgUnitTree();
        }

        function updateSelectedCount() {
            document.getElementById('statSelectedOrgUnits').textContent = state.dhis2.selectedOrgUnits.length;
        }

        // ==================== DATASET ====================
        async function fetchExistingDatasets() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            showProgress('Fetching Datasets', 'Loading...');
            
            try {
                const result = await dhis2Request('dataSets.json?fields=id,name,shortName,code,periodType&paging=false');
                
                if (result.success && result.data && result.data.dataSets) {
                    const datasets = result.data.dataSets;
                    document.getElementById('existingDatasets').style.display = 'block';
                    
                    document.getElementById('datasetsList').innerHTML = datasets.map(ds => `
                        <div class="org-unit-item" onclick="selectDataset('${ds.id}', '${escapeHtml(ds.name)}')">
                            <span>üìä ${escapeHtml(ds.name)}</span>
                            <span class="org-unit-level">${ds.periodType}</span>
                        </div>
                    `).join('');
                    
                    notify(`Found ${datasets.length} datasets`);
                }
            } catch (error) {
                notify('Error: ' + error.message, 'error');
            }
            
            hideProgress();
        }

        function selectDataset(id, name) {
            state.dhis2.datasetId = id;
            state.dhis2.datasetName = name;
            document.getElementById('existingDatasetInfo').style.display = 'block';
            document.getElementById('existingDatasetText').textContent = `Using: ${name}`;
            notify(`Selected dataset: ${name}`);
        }

        async function createDataset() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            const name = document.getElementById('datasetName').value.trim();
            const shortName = document.getElementById('datasetShortName').value.trim();
            const code = document.getElementById('datasetCode').value.trim();
            const description = document.getElementById('datasetDescription').value.trim();
            
            if (!name) {
                notify('Please enter a dataset name', 'error');
                return;
            }
            
            // Collect mapped data element IDs
            const dataElementIds = Object.values(state.fieldMappings).filter(Boolean);
            
            if (dataElementIds.length === 0) {
                notify('No data elements mapped. Map fields first.', 'error');
                return;
            }
            
            if (state.dhis2.selectedOrgUnits.length === 0) {
                notify('No org units selected. Select org units first.', 'error');
                return;
            }
            
            showProgress('Creating Dataset', 'Please wait...');
            
            const payload = {
                name: name,
                shortName: shortName || name.substring(0, 50),
                code: code || name.toUpperCase().replace(/\s+/g, '_').substring(0, 30),
                description: description,
                periodType: state.dhis2.periodType,
                dataSetElements: dataElementIds.map(deId => ({
                    dataElement: { id: deId }
                })),
                organisationUnits: state.dhis2.selectedOrgUnits.map(ouId => ({
                    id: ouId
                }))
            };
            
            try {
                const result = await dhis2Request('dataSets', 'POST', payload);
                
                if (result.success) {
                    const newId = result.data?.response?.uid;
                    if (newId) {
                        state.dhis2.datasetId = newId;
                        state.dhis2.datasetName = name;
                    }
                    document.getElementById('existingDatasetInfo').style.display = 'block';
                    document.getElementById('existingDatasetText').textContent = `Created: ${name}`;
                    notify('‚úÖ Dataset created successfully!', 'success');
                } else {
                    notify('Failed: ' + (result.error || JSON.stringify(result.data)), 'error');
                }
            } catch (error) {
                notify('Error: ' + error.message, 'error');
            }
            
            hideProgress();
        }

        async function updateDataset() {
            if (!state.dhis2.datasetId) {
                notify('No dataset selected', 'error');
                return;
            }
            
            showProgress('Updating Dataset', 'Please wait...');
            
            const dataElementIds = Object.values(state.fieldMappings).filter(Boolean);
            
            const payload = {
                dataSetElements: dataElementIds.map(deId => ({
                    dataElement: { id: deId }
                })),
                organisationUnits: state.dhis2.selectedOrgUnits.map(ouId => ({
                    id: ouId
                }))
            };
            
            try {
                const result = await dhis2Request(`dataSets/${state.dhis2.datasetId}`, 'PATCH', payload);
                
                if (result.success) {
                    notify('‚úÖ Dataset updated!', 'success');
                } else {
                    notify('Failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                notify('Error: ' + error.message, 'error');
            }
            
            hideProgress();
        }

        // ==================== DATA SUBMISSION ====================
        async function submitDataToDhis2() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            if (!state.dhis2.datasetId) {
                notify('Select or create a dataset first', 'error');
                return;
            }
            
            const period = document.getElementById('submitPeriod').value.trim();
            if (!period) {
                notify('Enter a period (YYYYMM format)', 'error');
                return;
            }
            
            const data = state.collectedData.filter(d => !d._submitted);
            if (data.length === 0) {
                notify('No pending data to submit', 'info');
                return;
            }
            
            const log = document.getElementById('submitLog');
            log.innerHTML = '';
            addLog('info', `Starting submission of ${data.length} records...`);
            
            let success = 0, failed = 0;
            
            for (const record of data) {
                const orgUnitId = findOrgUnitIdForRecord(record);
                if (!orgUnitId) {
                    addLog('error', `No org unit found for record`);
                    failed++;
                    continue;
                }
                
                const dataValues = [];
                state.fields.filter(f => f.type !== 'section').forEach(field => {
                    const deId = state.fieldMappings[field.id];
                    const value = record[field.name];
                    
                    if (deId && value !== undefined && value !== null && value !== '') {
                        dataValues.push({
                            dataElement: deId,
                            value: String(value)
                        });
                    }
                });
                
                if (dataValues.length === 0) {
                    addLog('warning', `No mapped values in record`);
                    failed++;
                    continue;
                }
                
                try {
                    const payload = {
                        dataSet: state.dhis2.datasetId,
                        completeDate: new Date().toISOString().split('T')[0],
                        period: period,
                        orgUnit: orgUnitId,
                        dataValues: dataValues
                    };
                    
                    const result = await dhis2Request('dataValueSets', 'POST', payload);
                    
                    if (result.success) {
                        record._submitted = true;
                        success++;
                        addLog('success', `Submitted: ${dataValues.length} values`);
                    } else {
                        failed++;
                        addLog('error', `Failed: ${result.error || 'Unknown error'}`);
                    }
                } catch (e) {
                    failed++;
                    addLog('error', `Error: ${e.message}`);
                }
                
                await new Promise(r => setTimeout(r, 200));
            }
            
            document.getElementById('statSubmitted').textContent = state.collectedData.filter(d => d._submitted).length;
            document.getElementById('statPending').textContent = state.collectedData.filter(d => !d._submitted).length;
            
            addLog('info', `Completed: ${success} success, ${failed} failed`);
            notify(`Submitted: ${success} success, ${failed} failed`);
        }

        function findOrgUnitIdForRecord(record) {
            // Try to match facility name
            const facilityFields = ['facility', 'facility_name', 'org_unit', 'health_facility'];
            for (const fieldName of facilityFields) {
                const value = record[fieldName];
                if (value) {
                    const match = state.dhis2.orgUnits.find(ou => 
                        ou.displayName?.toLowerCase() === value.toLowerCase() ||
                        ou.name?.toLowerCase() === value.toLowerCase()
                    );
                    if (match) return match.id;
                }
            }
            
            // If only one org unit selected, use it
            if (state.dhis2.selectedOrgUnits.length === 1) {
                return state.dhis2.selectedOrgUnits[0];
            }
            
            return null;
        }

        async function dryRunSubmission() {
            const data = state.collectedData.filter(d => !d._submitted);
            const log = document.getElementById('submitLog');
            log.innerHTML = '';
            
            addLog('info', '=== DRY RUN ===');
            addLog('info', `Records to submit: ${data.length}`);
            addLog('info', `Dataset: ${state.dhis2.datasetName || 'Not selected'}`);
            addLog('info', `Mapped fields: ${Object.keys(state.fieldMappings).length}`);
            addLog('info', `Selected org units: ${state.dhis2.selectedOrgUnits.length}`);
            
            if (data.length > 0) {
                const sample = data[0];
                let valueCount = 0;
                state.fields.filter(f => f.type !== 'section').forEach(field => {
                    if (state.fieldMappings[field.id] && sample[field.name]) {
                        valueCount++;
                    }
                });
                addLog('info', `Values per record: ~${valueCount}`);
            }
            
            if (!state.dhis2.datasetId) addLog('warning', 'No dataset selected!');
            if (Object.keys(state.fieldMappings).length === 0) addLog('warning', 'No fields mapped!');
            if (state.dhis2.selectedOrgUnits.length === 0) addLog('warning', 'No org units selected!');
            
            addLog('info', '=== END DRY RUN ===');
        }

        function exportForDhis2() {
            const data = state.collectedData;
            if (data.length === 0) {
                notify('No data to export', 'error');
                return;
            }
            
            const period = document.getElementById('submitPeriod').value.trim() || new Date().toISOString().slice(0, 7).replace('-', '');
            
            const dataValueSets = {
                dataSet: state.dhis2.datasetId,
                period: period,
                dataValues: []
            };
            
            data.forEach(record => {
                const orgUnitId = findOrgUnitIdForRecord(record) || state.dhis2.selectedOrgUnits[0];
                
                state.fields.filter(f => f.type !== 'section').forEach(field => {
                    const deId = state.fieldMappings[field.id];
                    const value = record[field.name];
                    
                    if (deId && value !== undefined && value !== null && value !== '') {
                        dataValueSets.dataValues.push({
                            dataElement: deId,
                            orgUnit: orgUnitId,
                            period: period,
                            value: String(value)
                        });
                    }
                });
            });
            
            const blob = new Blob([JSON.stringify(dataValueSets, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dhis2_export_${period}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            notify('‚úÖ JSON exported!', 'success');
        }

        function addLog(type, message) {
            const log = document.getElementById('submitLog');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="log-entry ${type}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // ==================== UI HELPERS ====================
        function openDhis2Config() {
            loadDhis2Config();
            document.getElementById('datasetName').value = state.settings.title;
            updateMappingTable();
            document.getElementById('dhis2Modal').classList.add('show');
        }

        function switchDhis2Tab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        }

        function showProgress(title, text) {
            document.getElementById('progressTitle').textContent = title;
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressModal').classList.add('show');
        }

        function hideProgress() {
            document.getElementById('progressModal').classList.remove('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : type === 'info' ? ' info' : '');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // ==================== AUTH ====================
        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) { state.user = JSON.parse(saved); showBuilder(); }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => (u.email === email || u.username === email) && u.password === password);
            if (user) { state.user = user; localStorage.setItem('formBuilderUser', JSON.stringify(user)); showBuilder(); }
            else { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Invalid credentials'; }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const org = document.getElementById('signupOrg').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            if (password !== confirm) { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Passwords do not match'; return; }
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Email exists'; return; }
            users.push({ id: Date.now().toString(), name, email, org, password, createdAt: new Date().toISOString() });
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            document.getElementById('authSuccess').style.display = 'block'; document.getElementById('authSuccess').textContent = 'Account created! Please login.';
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = `üë§ ${state.user?.name || 'User'}`;
            renderFields();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('formBuilderUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ==================== FORM BUILDER ====================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;
            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                max: def.max || 5,
                placeholder: ''
            };
            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
            notify('‚úÖ Added!');
        }

        function removeField(id) {
            event?.stopPropagation();
            if (!confirm('Delete?')) return;
            state.fields = state.fields.filter(f => f.id !== id);
            delete state.fieldMappings[id];
            if (state.selectedFieldId === id) { state.selectedFieldId = null; renderProperties(); }
            renderFields();
            saveToStorage();
            notify('üóëÔ∏è Deleted');
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) { field[prop] = value; renderFields(); saveToStorage(); }
        }

        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const sectionCount = state.fields.filter(f => f.type === 'section').length;
            document.getElementById('fieldCount').textContent = `üìä ${state.fields.length} fields | ${sectionCount + 1} page${sectionCount > 0 ? 's' : ''}`;
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:36px;margin-bottom:12px;">üì•</p><p style="font-weight:600;">Click field types to add</p>';
                return;
            }
            
            dropZone.classList.add('has-fields');
            let currentPage = 1;
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') {
                    currentPage++;
                    return `<div class="section-divider ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}">
                        <span>üìÅ ${f.label.toUpperCase()}</span>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:10px;">PAGE ${currentPage}</span>
                            <div class="form-field-actions">
                                <button class="field-action-btn move-up" onclick="moveField('${f.id}','up')">‚ñ≤</button>
                                <button class="field-action-btn move-down" onclick="moveField('${f.id}','down')">‚ñº</button>
                                <button class="field-action-btn delete" onclick="removeField('${f.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
                }
                
                const def = fieldDefs[f.type];
                const isMapped = !!state.fieldMappings[f.id];
                
                return `<div class="form-field ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}">
                    <div class="form-field-header">
                        <span class="form-field-label">${def?.icon || 'üìÑ'} ${f.label}</span>
                        <div class="form-field-actions">
                            <button class="field-action-btn move-up" onclick="moveField('${f.id}','up')">‚ñ≤</button>
                            <button class="field-action-btn move-down" onclick="moveField('${f.id}','down')">‚ñº</button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size:10px;color:#868e96;">
                        ${f.name}
                        ${f.required ? '<span class="field-badge required">Required</span>' : ''}
                        ${isMapped ? '<span class="field-badge dhis2">DHIS2 ‚úì</span>' : ''}
                    </div>
                </div>`;
            }).join('');
            
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id);
                });
            });
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:32px;margin-bottom:12px;">üëÜ</p><p>Select a field</p></div>';
                return;
            }
            
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `
                <div class="prop-section">
                    <div class="prop-section-title">üìù Basic</div>
                    <div class="property-group">
                        <label class="property-label">Label</label>
                        <input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Name/Code</label>
                        <input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}">
                        <p class="help-text">Used for DHIS2 mapping</p>
                    </div>
                    ${field.type !== 'section' ? `
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                                <span>Required</span>
                            </label>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `
                    <div class="prop-section">
                        <div class="prop-section-title">üìã Options</div>
                        <div class="property-group">
                            <label class="property-label">One per line</label>
                            <textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea>
                        </div>
                    </div>
                `;
            }
            
            if (field.type === 'rating') {
                html += `
                    <div class="prop-section">
                        <div class="prop-section-title">‚≠ê Rating</div>
                        <div class="property-group">
                            <label class="property-label">Max</label>
                            <select class="property-select" id="propMax">
                                ${[3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${field.max === n ? 'selected' : ''}>${n}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
            }
            
            // DHIS2 Mapping Info
            if (field.type !== 'section') {
                const mappedDeId = state.fieldMappings[field.id];
                const mappedDe = mappedDeId ? state.dhis2.dataElements.find(de => de.id === mappedDeId) : null;
                
                html += `
                    <div class="prop-section dhis2">
                        <div class="prop-section-title">üîó DHIS2 Mapping</div>
                        ${mappedDe ? `
                            <p style="font-size:11px;color:#155724;margin-bottom:8px;">‚úÖ Mapped to: <strong>${escapeHtml(mappedDe.name)}</strong></p>
                            <p style="font-size:10px;color:#666;">ID: ${mappedDe.id}</p>
                        ` : `
                            <p style="font-size:11px;color:#856404;">‚ö†Ô∏è Not mapped to DHIS2</p>
                            <p style="font-size:10px;color:#666;margin-top:4px;">Click "DHIS2" button to configure</p>
                        `}
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
            document.getElementById('propMax')?.addEventListener('change', (e) => updateField('max', parseInt(e.target.value) || 5));
        }

        // ==================== STORAGE ====================
        function saveToStorage() {
            localStorage.setItem('formBuilderDhis2', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter,
                fieldMappings: state.fieldMappings,
                collectedData: state.collectedData
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderDhis2');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                    state.fieldMappings = data.fieldMappings || {};
                    state.collectedData = data.collectedData || [];
                } catch (e) { console.error('Load error:', e); }
            }
        }

        // ==================== FORM OPERATIONS ====================
        function newForm() {
            if (state.fields.length > 0 && !confirm('Create new?')) return;
            state.fields = [];
            state.selectedFieldId = null;
            state.fieldCounter = 0;
            state.fieldMappings = {};
            const title = prompt('Title:', 'New Form');
            if (title) {
                state.settings.title = title;
                document.getElementById('formTitle').value = title;
                document.getElementById('previewTitle').textContent = title;
            }
            saveToStorage();
            renderFields();
            renderProperties();
            notify('üìÑ New form created!');
        }

        function saveCurrentForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            saveToStorage();
            saveFormToList();
            notify('üíæ Saved!');
        }

        function saveFormToList() {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const existingIndex = forms.findIndex(f => f.title === state.settings.title);
            const formEntry = {
                id: existingIndex >= 0 ? forms[existingIndex].id : 'form_' + Date.now(),
                title: state.settings.title,
                subtitle: state.settings.subtitle,
                organization: state.settings.organization,
                logo: state.settings.logo,
                fieldCount: state.fields.length,
                updatedAt: new Date().toISOString(),
                fields: state.fields,
                settings: state.settings,
                fieldMappings: state.fieldMappings,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    datasetName: state.dhis2.datasetName
                }
            };
            if (existingIndex >= 0) forms[existingIndex] = formEntry;
            else forms.push(formEntry);
            localStorage.setItem('formBuilderForms', JSON.stringify(forms));
        }

        function previewForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            state.isSharedMode = false;
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('viewerContainer').classList.add('show');
            renderSharedFormViewer();
        }

        function closeViewer() {
            document.getElementById('viewerContainer').classList.remove('show');
            document.querySelector('.header').style.display = '';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = '';
        }

        function shareForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            
            const formData = {
                s: {
                    t: state.settings.title,
                    st: state.settings.subtitle,
                    o: state.settings.organization,
                    l: state.settings.logo
                },
                f: state.fields.map(f => {
                    const field = { i: f.id, y: f.type, l: f.label, n: f.name, r: f.required };
                    if (f.placeholder) field.p = f.placeholder;
                    if (f.options?.length) field.o = f.options;
                    if (f.max !== 5) field.mx = f.max;
                    return field;
                }),
                m: state.fieldMappings,
                d: state.dhis2.datasetId ? {
                    id: state.dhis2.datasetId,
                    name: state.dhis2.datasetName
                } : null
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                const shareUrl = window.location.origin + window.location.pathname + '?d=' + encodeURIComponent(encoded);
                
                document.getElementById('shareFormTitle').textContent = state.settings.title;
                document.getElementById('shareUrl').textContent = shareUrl;
                
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: shareUrl, width: 200, height: 200, colorDark: '#004080', colorLight: '#ffffff' });
                
                saveFormToList();
                document.getElementById('shareModal').classList.add('show');
            } catch (err) { notify('Error: ' + err.message, 'error'); }
        }

        function copyShareUrl() {
            const urlText = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(urlText).then(() => notify('üìã Copied!')).catch(() => notify('Copy failed', 'error'));
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrCode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = state.settings.title.replace(/[^a-z0-9]/gi, '_') + '_QR.png';
                link.href = canvas.toDataURL();
                link.click();
                notify('‚¨áÔ∏è Downloaded!');
            }
        }

        // ==================== HOME ====================
        function showHome() {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            let formsHtml = forms.length === 0 ? `
                <div style="text-align:center;padding:60px;color:#868e96;">
                    <p style="font-size:64px;">üì≠</p>
                    <h3 style="color:#004080;">No Forms</h3>
                    <button onclick="closeHome()" style="padding:15px 30px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:20px;">‚ûï Create</button>
                </div>
            ` : forms.map((f, i) => `
                <div style="background:#fff;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#004080,#002855);color:#fff;padding:15px 20px;">
                        <h3 style="margin:0;">üìã ${escapeHtml(f.title)}</h3>
                    </div>
                    <div style="padding:15px 20px;">
                        <div style="font-size:11px;color:#666;margin-bottom:15px;">
                            üìä ${f.fieldCount} fields
                            ${f.dhis2?.datasetId ? '<span style="color:#17a2b8;margin-left:10px;">üîó DHIS2</span>' : ''}
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="editForm(${i})" style="flex:1;padding:10px;background:#004080;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">‚úèÔ∏è Edit</button>
                            <button onclick="shareFormFromHome(${i})" style="flex:1;padding:10px;background:#17a2b8;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üîó Share</button>
                            <button onclick="deleteForm(${i})" style="padding:10px 15px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('homeContainer').innerHTML = `
                <div style="max-width:900px;margin:0 auto;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;">
                        <h2 style="color:#004080;">üè† My Forms</h2>
                        <button onclick="closeHome()" style="padding:12px 25px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">‚ûï New</button>
                    </div>
                    ${formsHtml}
                </div>
            `;
            
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('homeContainer').classList.add('show');
        }

        function closeHome() {
            document.getElementById('homeContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'flex';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = 'block';
        }

        function editForm(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const form = forms[index];
            if (!form) return;
            
            state.fields = form.fields || [];
            state.settings = { ...state.settings, ...form.settings };
            state.fieldCounter = Math.max(...state.fields.map(f => parseInt(f.id.replace('field_', '')) || 0), 0) + 1;
            state.fieldMappings = form.fieldMappings || {};
            
            if (form.dhis2) {
                state.dhis2.datasetId = form.dhis2.datasetId;
                state.dhis2.datasetName = form.dhis2.datasetName;
            }
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            saveToStorage();
            closeHome();
            renderFields();
            renderProperties();
            notify('üìÇ Loaded!');
        }

        function shareFormFromHome(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const form = forms[index];
            if (!form) return;
            
            const tempFields = state.fields, tempSettings = state.settings, tempMappings = state.fieldMappings;
            state.fields = form.fields;
            state.settings = form.settings;
            state.fieldMappings = form.fieldMappings || {};
            shareForm();
            state.fields = tempFields;
            state.settings = tempSettings;
            state.fieldMappings = tempMappings;
        }

        function deleteForm(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            if (!confirm(`Delete "${forms[index]?.title}"?`)) return;
            forms.splice(index, 1);
            localStorage.setItem('formBuilderForms', JSON.stringify(forms));
            showHome();
            notify('üóëÔ∏è Deleted');
        }

        // ==================== SHARED FORM VIEWER ====================
        function renderSharedForm(data) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            state.settings = {
                title: data.s?.t || 'Form',
                subtitle: data.s?.st || 'Data Collection',
                organization: data.s?.o || 'ICF-SL',
                logo: data.s?.l || 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg'
            };
            
            state.fields = (data.f || []).map(f => ({
                id: f.i, type: f.y, label: f.l, name: f.n, required: f.r || false,
                placeholder: f.p || '', options: f.o || [], max: f.mx || 5
            }));
            
            state.fieldMappings = data.m || {};
            
            if (data.d) {
                state.dhis2.datasetId = data.d.id;
                state.dhis2.datasetName = data.d.name;
            }
            
            document.getElementById('viewerContainer').classList.add('show');
            renderSharedFormViewer();
        }

        function renderSharedFormViewer() {
            const s = state.settings;
            let pages = [], currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) pages.push(currentPage);
                    currentPage = { title: field.label, fields: [] };
                } else {
                    currentPage.fields.push(field);
                }
            });
            if (currentPage.fields.length > 0) pages.push(currentPage);
            if (pages.length === 0) pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'text': case 'email': case 'phone': case 'number': case 'date': case 'time':
                            const type = field.type === 'phone' ? 'tel' : field.type;
                            input = `<input type="${type}" name="${field.name}" class="viewer-input" placeholder="${escapeHtml(field.placeholder || '')}" ${reqAttr}>`;
                            break;
                        case 'textarea':
                            input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`;
                            break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                            break;
                        case 'radio': case 'yesno':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'gps':
                            input = `<div style="text-align:center;"><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;">üìç Capture GPS</button><input type="hidden" name="${field.name}_lat"><input type="hidden" name="${field.name}_lng"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`;
                            break;
                        case 'rating':
                            input = `<div class="rating-container">${Array(field.max || 5).fill().map((_, i) => `<span class="rating-star" onclick="setRating(this,${i+1})" style="font-size:24px;cursor:pointer;opacity:0.3;">‚≠ê</span>`).join('')}<input type="hidden" name="${field.name}"></div>`;
                            break;
                        default:
                            input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0, isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        <div class="page-header">
                            <span class="page-indicator">Page ${pageIndex + 1} of ${pages.length}</span>
                            <h3 class="page-title">${escapeHtml(page.title)}</h3>
                        </div>
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})">‚¨ÖÔ∏è Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next ‚û°Ô∏è</button>` : ''}
                            ${isLast ? `<button type="submit" class="nav-btn submit-btn">‚úÖ Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            const backBtnHtml = state.isSharedMode ? '' : '<button class="viewer-back-btn" onclick="closeViewer()">‚¨ÖÔ∏è Back to Builder</button>';
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    ${backBtnHtml}
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showViewerTab('form',this)">üìù Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showViewerTab('data',this)">üìä Data</button>
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}" id="connectionStatus">
                        <span>${navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                                <p>${escapeHtml(s.subtitle)}</p>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">
                                    ${pagesHtml}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab">
                    <div style="max-width:900px;margin:0 auto;">
                        <h3 style="color:#004080;margin-bottom:15px;">üìä Collected Data</h3>
                        <div id="collectedDataTable"></div>
                    </div>
                </div>
            `;
            
            window.totalPages = pages.length;
            window.currentPageIndex = 0;
            setupFormSubmit();
            renderCollectedData();
        }

        function setupFormSubmit() {
            const form = document.getElementById('viewerForm');
            if (!form) return;
            
            form.onsubmit = function(e) {
                e.preventDefault();
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString(), _submitted: false };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                state.collectedData.push(data);
                saveToStorage();
                
                form.reset();
                window.currentPageIndex = 0;
                goToPage(0);
                
                notify('‚úÖ Data saved!');
                renderCollectedData();
                
                // Update submit stats
                document.getElementById('statTotalRecords').textContent = state.collectedData.length;
                document.getElementById('statPending').textContent = state.collectedData.filter(d => !d._submitted).length;
            };
        }

        function renderCollectedData() {
            const container = document.getElementById('collectedDataTable');
            if (!container) return;
            
            if (state.collectedData.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#868e96;padding:30px;">No data collected yet</p>';
                return;
            }
            
            const fields = state.fields.filter(f => f.type !== 'section');
            
            let html = '<table class="data-table"><thead><tr><th>#</th><th>Timestamp</th>';
            fields.forEach(f => html += `<th>${escapeHtml(f.label)}</th>`);
            html += '<th>Status</th></tr></thead><tbody>';
            
            state.collectedData.forEach((row, i) => {
                html += `<tr><td>${i + 1}</td><td>${new Date(row._timestamp).toLocaleString()}</td>`;
                fields.forEach(f => html += `<td>${escapeHtml(row[f.name] || '-')}</td>`);
                html += `<td>${row._submitted ? '‚úÖ' : '‚è≥'}</td></tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showViewerTab(tab, btn) {
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function goToPage(pageIndex) {
            document.querySelectorAll('.form-page').forEach(p => p.style.display = 'none');
            const targetPage = document.querySelector(`.form-page[data-page="${pageIndex}"]`);
            if (targetPage) {
                targetPage.style.display = 'block';
                window.currentPageIndex = pageIndex;
            }
        }

        // GPS & Rating helpers
        window.captureGPS = function(btn) {
            const container = btn.parentElement;
            const status = container.querySelector('.gps-status');
            status.textContent = 'üìç Getting location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        container.querySelector('[name$="_lat"]').value = pos.coords.latitude.toFixed(6);
                        container.querySelector('[name$="_lng"]').value = pos.coords.longitude.toFixed(6);
                        status.textContent = '‚úÖ ' + pos.coords.latitude.toFixed(6) + ', ' + pos.coords.longitude.toFixed(6);
                    },
                    err => { status.textContent = '‚ùå ' + err.message; }
                );
            } else { status.textContent = '‚ùå Not supported'; }
        };

        window.setRating = function(star, val) {
            const container = star.parentElement;
            container.querySelectorAll('.rating-star').forEach((s, i) => s.style.opacity = i < val ? '1' : '0.3');
            container.querySelector('input').value = val;
        };

        // Initialize
        init();
    </script>
</body>
</html>
