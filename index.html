<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Auth Screens */
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header h1 { font-size: 22px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-tab:hover { background: #f8f9fa; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; transition: border-color 0.2s; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        .auth-btn:hover { background: #003366; }
        .auth-btn:disabled { background: #ccc; cursor: not-allowed; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-link { text-align: center; margin-top: 15px; font-size: 12px; }
        .auth-link a { color: #004080; cursor: pointer; text-decoration: underline; }
        
        /* Header */
        .header { background: #004080; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 40px; height: 40px; border-radius: 6px; }
        .header h1 { font-size: 18px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .header-btn { background: white; color: #004080; border: none; padding: 8px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; }
        .header-btn:hover { background: #f0f0f0; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        
        /* Main Layout */
        .main-container { display: none; margin-top: 60px; height: calc(100vh - 90px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        /* Sidebar */
        .sidebar { width: 200px; background: white; border-right: 2px solid #004080; overflow-y: auto; padding: 12px; }
        .sidebar-section { margin-bottom: 12px; }
        .sidebar-title { font-size: 10px; font-weight: 700; color: #004080; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 8px 10px; margin-bottom: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; transform: translateX(2px); }
        .field-type-icon { font-size: 14px; }
        
        /* Canvas */
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 10px 20px; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 15px; font-weight: 700; border: 2px solid transparent; padding: 6px 10px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 280px; }
        .form-title-input:focus { outline: none; border-color: #004080; background: #f8f9fa; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 600px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 300px; }
        .form-preview-header { background: #004080; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-header h2 { font-size: 16px; margin-bottom: 3px; }
        .form-preview-header p { font-size: 10px; opacity: 0.9; }
        .form-preview-body { padding: 15px; min-height: 200px; }
        
        /* Drop Zone */
        .drop-zone { border: 3px dashed #ccc; border-radius: 8px; padding: 30px; text-align: center; color: #999; font-size: 12px; min-height: 150px; display: flex; flex-direction: column; justify-content: center; }
        .drop-zone.drag-over { border-color: #004080; background: #e8f4fc; }
        .drop-zone.has-fields { border: none; padding: 0; display: block; min-height: auto; }
        
        /* Form Fields */
        .form-field { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .form-field-label { font-weight: 700; font-size: 10px; color: #333; text-transform: uppercase; }
        .form-field-actions { display: flex; gap: 3px; }
        .field-action-btn { background: #e9ecef; border: none; cursor: pointer; font-size: 11px; padding: 3px 5px; border-radius: 4px; }
        .field-action-btn:hover { background: #dee2e6; }
        .field-action-btn.delete:hover { background: #ffebee; color: #dc3545; }
        .form-field-preview { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 6px; font-size: 10px; color: #666; }
        .form-field-meta { margin-top: 5px; font-size: 9px; color: #999; display: flex; gap: 8px; flex-wrap: wrap; }
        .field-badge { padding: 2px 5px; border-radius: 3px; font-size: 8px; }
        .field-badge.skip { background: #fff3cd; color: #856404; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        .field-badge.validation { background: #d1ecf1; color: #0c5460; }
        
        .section-divider { background: #004080; color: white; padding: 10px 14px; margin: 12px 0; border-radius: 6px; font-weight: 700; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-divider.selected { box-shadow: 0 0 0 3px rgba(0,64,128,0.3); }
        .section-divider .page-badge { background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 9px; }
        
        /* Properties Panel */
        .properties-panel { width: 300px; background: white; border-left: 2px solid #004080; overflow-y: auto; padding: 12px; }
        .properties-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .property-group { margin-bottom: 10px; }
        .property-label { display: block; font-size: 9px; font-weight: 700; color: #333; margin-bottom: 4px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 7px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .property-input:focus, .property-select:focus { outline: none; border-color: #004080; }
        .property-textarea { width: 100%; padding: 7px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 10px; min-height: 50px; resize: vertical; }
        .property-checkbox { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 10px; }
        .property-checkbox input { width: 14px; height: 14px; }
        .no-selection { text-align: center; color: #999; padding: 30px 10px; font-size: 11px; }
        
        /* Property Sections */
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 6px; padding: 10px; margin-bottom: 12px; }
        .prop-section-title { font-size: 10px; font-weight: 700; color: #004080; margin-bottom: 8px; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .prop-section.skip-logic { background: #fff3cd; border-color: #ffc107; }
        .prop-section.validation { background: #d1ecf1; border-color: #17a2b8; }
        
        /* Inline Fields */
        .prop-row { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; }
        .prop-row .property-input, .prop-row .property-select { flex: 1; }
        .prop-row span { font-size: 9px; color: #666; white-space: nowrap; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; border: 4px double #004080; }
        .modal-header { background: #004080; color: white; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 15px; }
        .modal-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        .modal-body { padding: 18px; max-height: 65vh; overflow-y: auto; }
        .modal-footer { padding: 12px 18px; border-top: 2px solid #ddd; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 8px 16px; border-radius: 5px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; border: 2px solid #004080; }
        .modal-btn.secondary { background: white; color: #004080; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; border-color: #28a745; }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; cursor: pointer; font-weight: 700; font-size: 11px; border-bottom: 3px solid transparent; margin-bottom: -2px; text-transform: uppercase; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #004080; color: #004080; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Settings */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .settings-group { margin-bottom: 12px; }
        .settings-group.full-width { grid-column: span 2; }
        .settings-label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .settings-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .settings-input:focus { outline: none; border-color: #004080; }
        .settings-hint { font-size: 9px; color: #666; margin-top: 4px; }
        
        .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .toggle-slider { width: 40px; height: 20px; background: #ccc; border-radius: 10px; position: relative; transition: background 0.3s; }
        .toggle-slider::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle-switch input { display: none; }
        .toggle-switch input:checked + .toggle-slider { background: #28a745; }
        .toggle-switch input:checked + .toggle-slider::after { left: 22px; }
        
        /* Code Preview */
        .code-preview { background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 10px; white-space: pre-wrap; max-height: 300px; overflow: auto; }
        
        /* Info Box */
        .info-box { background: #e8f4fc; border: 2px solid #004080; border-radius: 6px; padding: 10px; font-size: 11px; margin: 10px 0; }
        .info-box h4 { color: #004080; margin-bottom: 5px; font-size: 11px; }
        
        /* QR Code */
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 20px; background: white; border: 3px solid #004080; border-radius: 12px; }
        
        /* Notification */
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        
        /* Dynamic Table Builder */
        .table-builder { border: 2px solid #ddd; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .table-builder-header { background: #004080; color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
        .table-builder-header span { font-size: 11px; font-weight: 700; }
        .table-builder-body { max-height: 200px; overflow: auto; }
        .table-builder table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .table-builder th, .table-builder td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .table-builder th { background: #f8f9fa; font-weight: 700; }
        .table-builder input, .table-builder select { width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 9px; }
        .add-row-btn, .add-col-btn { background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 9px; cursor: pointer; margin: 2px; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer; }
        
        /* File Upload */
        .file-upload-area { border: 3px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 12px; transition: all 0.2s; }
        .file-upload-area:hover { border-color: #004080; background: #f8f9fa; }
        .file-upload-area.has-file { border-color: #28a745; background: #d4edda; }
        
        /* Preview Iframe */
        .preview-frame { width: 100%; height: 500px; border: none; background: white; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 180px; }
            .settings-grid { grid-template-columns: 1fr; }
            .settings-group.full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" style="width:70px;border-radius:10px;margin-bottom:12px;">
                <h1>Form Builder Pro</h1>
                <p>Create & Manage Data Collection Forms</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn" id="loginBtn">Login</button>
                    <div class="auth-link">
                        <a onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                </form>
                
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Organization</label>
                        <input type="text" class="auth-input" id="signupOrg" value="ICF-SL" placeholder="Your organization">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Confirm Password</label>
                        <input type="password" class="auth-input" id="signupConfirm" required placeholder="Confirm password">
                    </div>
                    <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
                </form>
                
                <form class="auth-form" id="forgotForm">
                    <div class="auth-group">
                        <label class="auth-label">Email Address</label>
                        <input type="email" class="auth-input" id="forgotEmail" required placeholder="Enter your registered email">
                    </div>
                    <button type="submit" class="auth-btn" id="forgotBtn">Send Password</button>
                    <div class="auth-link">
                        <a onclick="showLogin()">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Builder -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span id="headerUser" style="font-size:11px;margin-right:10px;"></span>
            <button class="header-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è Preview</button>
            <button class="header-btn" onclick="shareForm()">üîó Share</button>
            <button class="header-btn success" onclick="generateForm()">‚¨áÔ∏è Generate</button>
            <button class="header-btn danger" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic</h3>
                <div class="field-type" data-type="text"><span class="field-type-icon">üìÑ</span>Text</div>
                <div class="field-type" data-type="number"><span class="field-type-icon">üî¢</span>Number</div>
                <div class="field-type" data-type="date"><span class="field-type-icon">üìÖ</span>Date</div>
                <div class="field-type" data-type="time"><span class="field-type-icon">üïê</span>Time</div>
                <div class="field-type" data-type="email"><span class="field-type-icon">üìß</span>Email</div>
                <div class="field-type" data-type="phone"><span class="field-type-icon">üì±</span>Phone</div>
                <div class="field-type" data-type="textarea"><span class="field-type-icon">üìù</span>Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection</h3>
                <div class="field-type" data-type="select"><span class="field-type-icon">üìã</span>Dropdown</div>
                <div class="field-type" data-type="radio"><span class="field-type-icon">üîò</span>Radio</div>
                <div class="field-type" data-type="checkbox"><span class="field-type-icon">‚òëÔ∏è</span>Checkbox</div>
                <div class="field-type" data-type="yesno"><span class="field-type-icon">‚úÖ</span>Yes/No</div>
                <div class="field-type" data-type="yesnona"><span class="field-type-icon">‚ùì</span>Yes/No/NA</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìä Tables</h3>
                <div class="field-type" data-type="table"><span class="field-type-icon">üìã</span>Static Table</div>
                <div class="field-type" data-type="dynamicTable"><span class="field-type-icon">‚ûï</span>Dynamic Table</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üîó Location</h3>
                <div class="field-type" data-type="cascading"><span class="field-type-icon">üè¢</span>Cascading</div>
                <div class="field-type" data-type="gps"><span class="field-type-icon">üìç</span>GPS</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special</h3>
                <div class="field-type" data-type="signature"><span class="field-type-icon">‚úçÔ∏è</span>Signature</div>
                <div class="field-type" data-type="rating"><span class="field-type-icon">‚≠ê</span>Rating</div>
                <div class="field-type" data-type="file"><span class="field-type-icon">üìé</span>File Upload</div>
                <div class="field-type" data-type="calculated"><span class="field-type-icon">üî¢</span>Calculated</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section"><span class="field-type-icon">üìÅ</span>Section/Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:11px;" id="fieldCount">0 fields | 1 page</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p id="previewSubtitle">Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:24px;margin-bottom:10px;">üì•</p>
                            <p>Click field types on the left to add them</p>
                            <p style="margin-top:5px;font-size:10px;color:#aaa;">Or drag and drop here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel">
            <h3 class="properties-title">‚öôÔ∏è Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:24px;margin-bottom:10px;">üëÜ</p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">¬© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL)</footer>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è Form Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="pages">Pages</div>
                    <div class="tab" data-tab="cascading">Cascading</div>
                    <div class="tab" data-tab="google">Google Sheets</div>
                </div>

                <div class="tab-content active" id="tab-general">
                    <div class="settings-grid">
                        <div class="settings-group">
                            <label class="settings-label">Form Title</label>
                            <input type="text" class="settings-input" id="settingsTitle">
                        </div>
                        <div class="settings-group">
                            <label class="settings-label">Subtitle</label>
                            <input type="text" class="settings-input" id="settingsSubtitle">
                        </div>
                        <div class="settings-group full-width">
                            <label class="settings-label">Organization</label>
                            <input type="text" class="settings-input" id="settingsOrg">
                        </div>
                        <div class="settings-group full-width">
                            <label class="settings-label">Logo URL</label>
                            <input type="text" class="settings-input" id="settingsLogo">
                        </div>
                        <div class="settings-group full-width">
                            <label class="toggle-switch">
                                <input type="checkbox" id="settingsMultiPage" checked>
                                <span class="toggle-slider"></span>
                                <span style="font-size:11px;">Enable Multi-Page Navigation</span>
                            </label>
                            <div class="settings-hint">Each section becomes a separate page</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-pages">
                    <div class="info-box">
                        <h4>üìÑ Multi-Page Forms</h4>
                        <p>Add "Section" fields to create page breaks. Each section becomes a separate page with navigation buttons.</p>
                    </div>
                    <div id="pagesList" style="margin-top:15px;"></div>
                </div>

                <div class="tab-content" id="tab-cascading">
                    <p style="font-size:11px;color:#666;margin-bottom:12px;">Upload Excel/CSV with location hierarchy</p>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div style="font-size:28px;margin-bottom:8px;">üìÅ</div>
                        <div id="fileUploadText" style="font-size:12px;">Click to upload Excel or CSV</div>
                        <input type="file" id="cascadingFile" accept=".xlsx,.xls,.csv" style="display:none;">
                    </div>
                    <button class="modal-btn secondary" onclick="downloadSampleFile()" style="margin-bottom:10px;">‚¨áÔ∏è Download Template</button>
                    <div class="info-box">
                        <h4>üìã Required Columns:</h4>
                        <p>Region | District | Chiefdom | Facility | UID</p>
                    </div>
                    <div class="settings-group" style="margin-top:12px;">
                        <label class="settings-label">Or Enter Manually</label>
                        <textarea class="property-textarea" id="cascadingData" style="height:100px;font-family:monospace;font-size:9px;"></textarea>
                    </div>
                </div>

                <div class="tab-content" id="tab-google">
                    <div class="settings-group">
                        <label class="settings-label">Apps Script Web App URL</label>
                        <input type="text" class="settings-input" id="settingsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <div class="settings-hint">For data submission and user authentication</div>
                    </div>
                    <div class="info-box" style="background:#fff3cd;border-color:#ffc107;">
                        <h4 style="color:#856404;">üìã Setup Instructions:</h4>
                        <ol style="margin-left:15px;font-size:10px;line-height:1.8;color:#856404;">
                            <li>Create a Google Sheet with sheets: "Users", "Forms", "Submissions"</li>
                            <li>Go to Extensions ‚Üí Apps Script</li>
                            <li>Paste the generated Apps Script code</li>
                            <li>Deploy as Web App (Anyone can access)</li>
                            <li>Copy the URL here</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Generate Modal -->
    <div class="modal-overlay" id="generateModal">
        <div class="modal" style="max-width:850px;">
            <div class="modal-header">
                <h3>üì• Generated Form</h3>
                <button class="modal-close" onclick="closeModal('generateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="html-code">HTML Form</div>
                    <div class="tab" data-tab="apps-script">Apps Script</div>
                </div>
                
                <div class="tab-content active" id="tab-html-code">
                    <div style="margin-bottom:10px;">
                        <button class="modal-btn primary" onclick="downloadHTML()">‚¨áÔ∏è Download HTML</button>
                        <button class="modal-btn secondary" onclick="copyCode('htmlCode')" style="margin-left:5px;">üìã Copy</button>
                    </div>
                    <div class="code-preview" id="htmlCode"></div>
                </div>
                
                <div class="tab-content" id="tab-apps-script">
                    <div style="margin-bottom:10px;">
                        <button class="modal-btn primary" onclick="downloadScript()">‚¨áÔ∏è Download .gs</button>
                        <button class="modal-btn secondary" onclick="copyCode('scriptCode')" style="margin-left:5px;">üìã Copy</button>
                    </div>
                    <div class="code-preview" id="scriptCode"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('generateModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>üëÅÔ∏è Form Preview</h3>
                <button class="modal-close" onclick="closeModal('previewModal')">&times;</button>
            </div>
            <div class="modal-body" id="previewBody" style="padding:0;"></div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('previewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>üîó Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:18px;font-weight:700;color:#004080;" id="shareFormTitle">Form Title</div>
                </div>
                
                <div style="text-align:center;padding:15px;background:#f8f9fa;border-radius:8px;margin-bottom:15px;">
                    <img id="qrCodeImg" src="" style="width:220px;height:220px;border:4px solid #004080;border-radius:8px;background:white;">
                    <div style="margin-top:10px;font-size:12px;color:#004080;font-weight:700;">üì± Scan to open form</div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Form URL</label>
                    <textarea id="shareUrlArea" rows="3" style="width:100%;font-size:9px;font-family:monospace;padding:8px;border:2px solid #ddd;border-radius:6px;resize:none;" readonly></textarea>
                </div>
                
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <button class="modal-btn primary" onclick="copyShareUrl()" style="flex:1;">üìã Copy URL</button>
                    <button class="modal-btn success" onclick="downloadQRImg()" style="flex:1;">‚¨áÔ∏è Download QR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Table Config Modal -->
    <div class="modal-overlay" id="tableConfigModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>üìä Configure Table Columns</h3>
                <button class="modal-close" onclick="closeModal('tableConfigModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="tableColumnsConfig"></div>
                <button class="modal-btn success" onclick="addTableColumn()" style="margin-top:10px;">‚ûï Add Column</button>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('tableConfigModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveTableConfig()">Save</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            editingTableFieldId: null,
            settings: {
                title: 'My Data Collection Form',
                subtitle: 'Data Collection System',
                organization: 'ICF-SL',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                scriptUrl: '',
                multiPage: true,
                cascadingData: 'Eastern Region||Kailahun District\nKailahun District||Luawa Chiefdom\nLuawa Chiefdom||Kailahun Hospital||abc123'
            }
        };

        const fieldDefs = {
            text: { label: 'Text', icon: 'üìÑ', defaultLabel: 'Text Field' },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field' },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field' },
            time: { label: 'Time', icon: 'üïê', defaultLabel: 'Time Field' },
            email: { label: 'Email', icon: 'üìß', defaultLabel: 'Email Address' },
            phone: { label: 'Phone', icon: 'üì±', defaultLabel: 'Phone Number' },
            textarea: { label: 'Long Text', icon: 'üìù', defaultLabel: 'Long Text' },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Choice', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkbox', options: ['Option 1', 'Option 2', 'Option 3'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question' },
            yesnona: { label: 'Yes/No/NA', icon: '‚ùì', defaultLabel: 'Yes/No/NA' },
            table: { label: 'Table', icon: 'üìã', defaultLabel: 'Data Table', columns: [{ name: 'Column 1', type: 'text' }, { name: 'Column 2', type: 'text' }], rows: 3 },
            dynamicTable: { label: 'Dynamic Table', icon: '‚ûï', defaultLabel: 'Dynamic Table', columns: [{ name: 'Item', type: 'text' }, { name: 'Quantity', type: 'number' }] },
            cascading: { label: 'Cascading', icon: 'üè¢', defaultLabel: 'Location', levels: ['Region', 'District', 'Chiefdom', 'Facility'] },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location' },
            signature: { label: 'Signature', icon: '‚úçÔ∏è', defaultLabel: 'Signature' },
            rating: { label: 'Rating', icon: '‚≠ê', defaultLabel: 'Rating', max: 5 },
            file: { label: 'File', icon: 'üìé', defaultLabel: 'File Upload', accept: '.pdf,.jpg,.png' },
            calculated: { label: 'Calculated', icon: 'üî¢', defaultLabel: 'Calculated Field', formula: '' },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section' }
        };

        const validationRules = {
            text: ['required', 'minLength', 'maxLength', 'pattern', 'noSpaces'],
            number: ['required', 'min', 'max', 'integer', 'positive'],
            email: ['required'],
            phone: ['required', 'pattern'],
            date: ['required', 'minDate', 'maxDate', 'notFuture', 'notPast'],
            time: ['required'],
            textarea: ['required', 'minLength', 'maxLength'],
            select: ['required'],
            radio: ['required'],
            checkbox: ['required', 'minSelect', 'maxSelect'],
            yesno: ['required'],
            yesnona: ['required']
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            // Check for shared form URL first
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('c');
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    
                    // Render the shared form
                    renderSharedForm(data);
                    return;
                } catch (err) {
                    console.error('Error decoding shared form:', err);
                }
            }
            
            loadFromStorage();
            setupEventListeners();
            checkAuth();
        }
        
        function renderSharedForm(data) {
            // Hide auth and builder, show form viewer
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            
            // Reconstruct form data
            const formSettings = {
                title: data.t || 'Form',
                subtitle: data.s || 'Data Collection',
                organization: data.o || 'ICF-SL',
                logo: data.l || 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                multiPage: data.m !== false,
                cascadingData: data.c || '',
                scriptUrl: data.u || ''
            };
            
            const formFields = (data.f || []).map(f => ({
                id: f.i,
                type: f.y,
                label: f.l,
                name: f.n,
                required: f.r,
                options: f.o || [],
                levels: f.v || [],
                columns: f.c || [],
                rows: f.w || 3,
                max: f.x || 5,
                accept: f.a || '',
                formula: f.m || '',
                skipLogic: f.k || { enabled: false },
                validation: f.d || { enabled: false }
            }));
            
            // Generate and display the form HTML
            state.settings = formSettings;
            state.fields = formFields;
            
            const html = generateHTMLCode();
            
            // Create viewer container
            const viewerContainer = document.createElement('div');
            viewerContainer.id = 'formViewer';
            viewerContainer.innerHTML = html;
            document.body.innerHTML = '';
            document.body.appendChild(viewerContainer);
            
            // Execute scripts in the generated HTML
            const scripts = viewerContainer.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
            });
        }

        function setupEventListeners() {
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab));
            });

            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('forgotForm').addEventListener('submit', handleForgotPassword);

            // Field types
            document.querySelectorAll('.field-type').forEach(el => {
                el.addEventListener('click', () => addField(el.dataset.type));
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('fieldType', el.dataset.type);
                    el.style.opacity = '0.5';
                });
                el.addEventListener('dragend', () => el.style.opacity = '1');
            });

            // Drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const type = e.dataTransfer.getData('fieldType');
                if (type) addField(type);
            });

            // Form title
            const titleInput = document.getElementById('formTitle');
            titleInput.value = state.settings.title;
            titleInput.addEventListener('input', () => {
                state.settings.title = titleInput.value;
                document.getElementById('previewTitle').textContent = titleInput.value;
                saveToStorage();
            });

            // Modal tabs
            setupTabs();

            // File upload
            document.getElementById('fileUploadArea').addEventListener('click', () => document.getElementById('cascadingFile').click());
            document.getElementById('cascadingFile').addEventListener('change', handleFileUpload);

            // Close modals on outside click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        function setupTabs() {
            document.querySelectorAll('.tabs').forEach(tabContainer => {
                tabContainer.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const parent = this.closest('.modal-body') || document;
                        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById('tab-' + this.dataset.tab)?.classList.add('active');
                    });
                });
            });
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) {
                state.user = JSON.parse(saved);
                showBuilder();
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
            hideAuthMessages();
        }

        function showForgotPassword() {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('forgotForm').classList.add('active');
            hideAuthMessages();
        }

        function showLogin() {
            switchAuthTab('login');
        }

        function hideAuthMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function showAuthSuccess(msg) {
            const el = document.getElementById('authSuccess');
            el.textContent = msg;
            el.style.display = 'block';
        }

        async function handleLogin(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            
            if (state.settings.scriptUrl) {
                try {
                    const response = await fetch(`${state.settings.scriptUrl}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        state.user = result.user;
                        localStorage.setItem('formBuilderUser', JSON.stringify(result.user));
                        showBuilder();
                    } else {
                        showAuthError(result.message || 'Invalid credentials');
                    }
                } catch (err) {
                    // Fallback to local
                    loginLocal(email, password);
                }
            } else {
                loginLocal(email, password);
            }
            
            btn.disabled = false;
            btn.textContent = 'Login';
        }

        function loginLocal(email, password) {
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                state.user = user;
                localStorage.setItem('formBuilderUser', JSON.stringify(user));
                showBuilder();
            } else {
                showAuthError('Invalid email or password');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const org = document.getElementById('signupOrg').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const btn = document.getElementById('signupBtn');
            
            if (password !== confirm) {
                showAuthError('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            if (state.settings.scriptUrl) {
                try {
                    const response = await fetch(state.settings.scriptUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'signup', name, email, org, password })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showAuthSuccess('Account created! Please login.');
                        setTimeout(() => switchAuthTab('login'), 1500);
                    } else {
                        showAuthError(result.message || 'Signup failed');
                    }
                } catch (err) {
                    signupLocal(name, email, org, password);
                }
            } else {
                signupLocal(name, email, org, password);
            }
            
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }

        function signupLocal(name, email, org, password) {
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) {
                showAuthError('Email already registered');
                return;
            }
            const newUser = { id: Date.now().toString(), name, email, org, password, createdAt: new Date().toISOString() };
            users.push(newUser);
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            showAuthSuccess('Account created! Please login.');
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const email = document.getElementById('forgotEmail').value;
            const btn = document.getElementById('forgotBtn');
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            if (state.settings.scriptUrl) {
                try {
                    const response = await fetch(`${state.settings.scriptUrl}?action=forgotPassword&email=${encodeURIComponent(email)}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        showAuthSuccess('Password sent to your email!');
                    } else {
                        showAuthError(result.message || 'Email not found');
                    }
                } catch (err) {
                    forgotPasswordLocal(email);
                }
            } else {
                forgotPasswordLocal(email);
            }
            
            btn.disabled = false;
            btn.textContent = 'Send Password';
        }

        function forgotPasswordLocal(email) {
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email);
            if (user) {
                showAuthSuccess(`Password reminder: ${user.password.substring(0, 2)}${'*'.repeat(user.password.length - 2)}`);
                notify('In production, password would be emailed');
            } else {
                showAuthError('Email not found');
            }
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = `üë§ ${state.user?.name || 'User'}`;
            renderFields();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('formBuilderUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ============================================
        // FIELD MANAGEMENT
        // ============================================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;

            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                levels: def.levels ? [...def.levels] : [],
                columns: def.columns ? JSON.parse(JSON.stringify(def.columns)) : [],
                rows: def.rows || 3,
                max: def.max || 5,
                accept: def.accept || '',
                formula: def.formula || '',
                validation: { enabled: false, rules: {} },
                skipLogic: { enabled: false, action: 'show', sourceField: '', condition: 'equals', sourceValue: '' }
            };

            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
            notify('Field added!');
        }

        function removeField(id) {
            event?.stopPropagation();
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) {
                state.selectedFieldId = null;
                renderProperties();
            }
            renderFields();
            saveToStorage();
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (prop.includes('.')) {
                    const [parent, child] = prop.split('.');
                    if (!field[parent]) field[parent] = {};
                    field[parent][child] = value;
                } else {
                    field[prop] = value;
                }
                renderFields();
                saveToStorage();
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const sectionCount = state.fields.filter(f => f.type === 'section').length;
            const pageCount = sectionCount + 1;
            
            document.getElementById('fieldCount').textContent = `${state.fields.length} fields | ${pageCount} page${pageCount > 1 ? 's' : ''}`;
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:24px;margin-bottom:10px;">üì•</p><p>Click field types on the left to add them</p>';
                return;
            }
            
            dropZone.classList.add('has-fields');
            let currentPage = 1;
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') {
                    currentPage++;
                    return renderSectionHTML(f, currentPage);
                }
                return renderFieldHTML(f);
            }).join('');
            
            // Attach click listeners
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) {
                        selectField(el.dataset.id);
                    }
                });
            });
        }

        function renderSectionHTML(field, pageNum) {
            const selected = field.id === state.selectedFieldId;
            return `<div class="section-divider ${selected ? 'selected' : ''}" data-id="${field.id}">
                <span>üìÅ ${field.label.toUpperCase()}</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="page-badge">Page ${pageNum}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn" onclick="moveField('${field.id}','up')" style="background:rgba(255,255,255,0.2);color:white;">‚¨Ü</button>
                        <button class="field-action-btn" onclick="moveField('${field.id}','down')" style="background:rgba(255,255,255,0.2);color:white;">‚¨á</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')" style="background:rgba(255,255,255,0.2);color:white;">üóë</button>
                    </div>
                </div>
            </div>`;
        }

        function renderFieldHTML(field) {
            const def = fieldDefs[field.type];
            const selected = field.id === state.selectedFieldId;
            
            let badges = '';
            if (field.required) badges += '<span class="field-badge required">Required</span>';
            if (field.skipLogic?.enabled) badges += '<span class="field-badge skip">Skip Logic</span>';
            if (field.validation?.enabled) badges += '<span class="field-badge validation">Validation</span>';
            
            return `<div class="form-field ${selected ? 'selected' : ''}" data-id="${field.id}">
                <div class="form-field-header">
                    <span class="form-field-label">${def?.icon || ''} ${field.label}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn" onclick="moveField('${field.id}','up')">‚¨Ü</button>
                        <button class="field-action-btn" onclick="moveField('${field.id}','down')">‚¨á</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')">üóë</button>
                    </div>
                </div>
                <div class="form-field-preview">${renderFieldPreview(field)}</div>
                <div class="form-field-meta">${field.name} ${badges}</div>
            </div>`;
        }

        function renderFieldPreview(field) {
            const inputStyle = 'width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:10px;';
            
            switch (field.type) {
                case 'text':
                case 'email':
                case 'phone':
                    return `<input type="text" style="${inputStyle}" placeholder="${field.label}" disabled>`;
                case 'number':
                    return `<input type="number" style="${inputStyle}" placeholder="0" disabled>`;
                case 'date':
                    return `<input type="date" style="${inputStyle}" disabled>`;
                case 'time':
                    return `<input type="time" style="${inputStyle}" disabled>`;
                case 'textarea':
                    return `<textarea style="${inputStyle}height:40px;" disabled></textarea>`;
                case 'select':
                    return `<select style="${inputStyle}" disabled><option>-- Select --</option></select>`;
                case 'radio':
                case 'yesno':
                case 'yesnona':
                    const opts = field.type === 'yesno' ? ['Yes', 'No'] : field.type === 'yesnona' ? ['Yes', 'No', 'N/A'] : field.options;
                    return opts.slice(0, 3).map(o => `<label style="margin-right:8px;font-size:9px;"><input type="radio" disabled> ${o}</label>`).join('');
                case 'checkbox':
                    return field.options.slice(0, 3).map(o => `<label style="display:inline;margin-right:8px;font-size:9px;"><input type="checkbox" disabled> ${o}</label>`).join('');
                case 'table':
                case 'dynamicTable':
                    return `<table style="width:100%;border-collapse:collapse;font-size:9px;"><tr>${field.columns.map(c => `<th style="border:1px solid #ddd;padding:3px;background:#f8f9fa;">${c.name}</th>`).join('')}</tr><tr>${field.columns.map(c => `<td style="border:1px solid #ddd;padding:3px;">[${c.type}]</td>`).join('')}</tr></table>`;
                case 'cascading':
                    return field.levels.map(l => `<select style="${inputStyle}margin-bottom:3px;" disabled><option>-- ${l} --</option></select>`).join('');
                case 'gps':
                    return `<button style="padding:5px 10px;background:#004080;color:white;border:none;border-radius:3px;font-size:9px;" disabled>üìç Capture GPS</button>`;
                case 'signature':
                    return `<div style="border:2px dashed #ddd;height:40px;display:flex;align-items:center;justify-content:center;color:#999;font-size:9px;">‚úçÔ∏è Signature Pad</div>`;
                case 'rating':
                    return '‚≠ê'.repeat(field.max || 5);
                case 'file':
                    return `<input type="file" style="${inputStyle}" disabled>`;
                case 'calculated':
                    return `<div style="background:#e9ecef;padding:5px;border-radius:3px;font-size:9px;">üî¢ = ${field.formula || 'formula'}</div>`;
                default:
                    return '';
            }
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:24px;margin-bottom:10px;">üëÜ</p><p>Select a field to edit</p></div>';
                return;
            }
            
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `
                <div class="property-group">
                    <label class="property-label">Label</label>
                    <input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}">
                </div>
                <div class="property-group">
                    <label class="property-label">Field Name</label>
                    <input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}">
                </div>`;
            
            if (field.type !== 'section') {
                html += `<div class="property-group">
                    <label class="property-checkbox">
                        <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                        <span>Required Field</span>
                    </label>
                </div>`;
            }
            
            // Options for select/radio/checkbox
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `<div class="property-group">
                    <label class="property-label">Options (one per line)</label>
                    <textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea>
                </div>`;
            }
            
            // Table configuration
            if (['table', 'dynamicTable'].includes(field.type)) {
                html += `<div class="property-group">
                    <label class="property-label">Table Columns</label>
                    <button class="modal-btn primary" onclick="openTableConfig('${field.id}')" style="width:100%;">‚öôÔ∏è Configure Columns</button>
                </div>`;
                if (field.type === 'table') {
                    html += `<div class="property-group">
                        <label class="property-label">Number of Rows</label>
                        <input type="number" class="property-input" id="propRows" value="${field.rows || 3}" min="1" max="50">
                    </div>`;
                }
            }
            
            // Cascading levels
            if (field.type === 'cascading') {
                html += `<div class="property-group">
                    <label class="property-label">Levels (one per line)</label>
                    <textarea class="property-textarea" id="propLevels">${(field.levels || []).join('\n')}</textarea>
                </div>`;
            }
            
            // Rating max
            if (field.type === 'rating') {
                html += `<div class="property-group">
                    <label class="property-label">Max Stars</label>
                    <input type="number" class="property-input" id="propMax" value="${field.max || 5}" min="3" max="10">
                </div>`;
            }
            
            // File accept
            if (field.type === 'file') {
                html += `<div class="property-group">
                    <label class="property-label">Accepted File Types</label>
                    <input type="text" class="property-input" id="propAccept" value="${field.accept || '.pdf,.jpg,.png'}" placeholder=".pdf,.jpg,.png">
                </div>`;
            }
            
            // Calculated formula
            if (field.type === 'calculated') {
                html += `<div class="property-group">
                    <label class="property-label">Formula</label>
                    <input type="text" class="property-input" id="propFormula" value="${escapeHtml(field.formula || '')}" placeholder="e.g., field1 + field2">
                    <div style="font-size:9px;color:#666;margin-top:3px;">Use field names like: number_1 + number_2</div>
                </div>`;
            }
            
            // Validation Rules
            if (field.type !== 'section' && validationRules[field.type]) {
                html += renderValidationSection(field);
            }
            
            // Skip Logic
            if (field.type !== 'section') {
                html += renderSkipLogicSection(field);
            }
            
            container.innerHTML = html;
            attachPropertyListeners(field);
        }

        function renderValidationSection(field) {
            const rules = validationRules[field.type] || [];
            if (rules.length === 0) return '';
            
            const v = field.validation || { enabled: false, rules: {} };
            
            let html = `<div class="prop-section validation">
                <div class="prop-section-title">‚úì Validation Rules</div>
                <div class="property-group">
                    <label class="property-checkbox">
                        <input type="checkbox" id="validationEnabled" ${v.enabled ? 'checked' : ''}>
                        <span>Enable Validation</span>
                    </label>
                </div>
                <div id="validationRulesContainer" style="display:${v.enabled ? 'block' : 'none'};">`;
            
            rules.forEach(rule => {
                const ruleValue = v.rules?.[rule] || '';
                switch (rule) {
                    case 'minLength':
                        html += `<div class="prop-row"><span>Min Length:</span><input type="number" class="property-input" data-rule="minLength" value="${ruleValue}" min="0"></div>`;
                        break;
                    case 'maxLength':
                        html += `<div class="prop-row"><span>Max Length:</span><input type="number" class="property-input" data-rule="maxLength" value="${ruleValue}" min="0"></div>`;
                        break;
                    case 'min':
                        html += `<div class="prop-row"><span>Min Value:</span><input type="number" class="property-input" data-rule="min" value="${ruleValue}"></div>`;
                        break;
                    case 'max':
                        html += `<div class="prop-row"><span>Max Value:</span><input type="number" class="property-input" data-rule="max" value="${ruleValue}"></div>`;
                        break;
                    case 'pattern':
                        html += `<div class="property-group"><label class="property-label">Pattern (RegEx)</label><input type="text" class="property-input" data-rule="pattern" value="${escapeHtml(ruleValue)}" placeholder="e.g., ^[0-9]{10}$"></div>`;
                        break;
                    case 'minDate':
                        html += `<div class="prop-row"><span>Min Date:</span><input type="date" class="property-input" data-rule="minDate" value="${ruleValue}"></div>`;
                        break;
                    case 'maxDate':
                        html += `<div class="prop-row"><span>Max Date:</span><input type="date" class="property-input" data-rule="maxDate" value="${ruleValue}"></div>`;
                        break;
                    case 'notFuture':
                        html += `<div class="property-group"><label class="property-checkbox"><input type="checkbox" data-rule="notFuture" ${ruleValue ? 'checked' : ''}><span>Cannot be future date</span></label></div>`;
                        break;
                    case 'notPast':
                        html += `<div class="property-group"><label class="property-checkbox"><input type="checkbox" data-rule="notPast" ${ruleValue ? 'checked' : ''}><span>Cannot be past date</span></label></div>`;
                        break;
                    case 'integer':
                        html += `<div class="property-group"><label class="property-checkbox"><input type="checkbox" data-rule="integer" ${ruleValue ? 'checked' : ''}><span>Integer only</span></label></div>`;
                        break;
                    case 'positive':
                        html += `<div class="property-group"><label class="property-checkbox"><input type="checkbox" data-rule="positive" ${ruleValue ? 'checked' : ''}><span>Positive only</span></label></div>`;
                        break;
                    case 'noSpaces':
                        html += `<div class="property-group"><label class="property-checkbox"><input type="checkbox" data-rule="noSpaces" ${ruleValue ? 'checked' : ''}><span>No spaces allowed</span></label></div>`;
                        break;
                    case 'minSelect':
                        html += `<div class="prop-row"><span>Min Selections:</span><input type="number" class="property-input" data-rule="minSelect" value="${ruleValue}" min="0"></div>`;
                        break;
                    case 'maxSelect':
                        html += `<div class="prop-row"><span>Max Selections:</span><input type="number" class="property-input" data-rule="maxSelect" value="${ruleValue}" min="0"></div>`;
                        break;
                }
            });
            
            html += `</div></div>`;
            return html;
        }

        function renderSkipLogicSection(field) {
            const skip = field.skipLogic || { enabled: false, action: 'show', sourceField: '', condition: 'equals', sourceValue: '' };
            const sourceFields = state.fields.filter(f => f.id !== field.id && ['yesno', 'yesnona', 'radio', 'select', 'checkbox'].includes(f.type));
            
            // Get options for selected source field
            const selectedSource = state.fields.find(f => f.id === skip.sourceField);
            let sourceOptions = [];
            if (selectedSource) {
                if (selectedSource.type === 'yesno') sourceOptions = ['Yes', 'No'];
                else if (selectedSource.type === 'yesnona') sourceOptions = ['Yes', 'No', 'N/A'];
                else sourceOptions = selectedSource.options || [];
            }
            
            let html = `<div class="prop-section skip-logic">
                <div class="prop-section-title">‚ö° Skip Logic</div>
                <div class="property-group">
                    <label class="property-checkbox">
                        <input type="checkbox" id="skipEnabled" ${skip.enabled ? 'checked' : ''}>
                        <span>Enable Skip Logic</span>
                    </label>
                </div>
                <div id="skipOptionsContainer" style="display:${skip.enabled ? 'block' : 'none'};">
                    <div class="prop-row">
                        <select id="skipAction" class="property-select">
                            <option value="show" ${skip.action === 'show' ? 'selected' : ''}>Show</option>
                            <option value="hide" ${skip.action === 'hide' ? 'selected' : ''}>Hide</option>
                        </select>
                        <span>this field when</span>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Source Field</label>
                        <select id="skipSourceField" class="property-select">
                            <option value="">-- Select field --</option>
                            ${sourceFields.map(f => `<option value="${f.id}" ${skip.sourceField === f.id ? 'selected' : ''}>${f.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="prop-row">
                        <select id="skipCondition" class="property-select">
                            <option value="equals" ${skip.condition === 'equals' ? 'selected' : ''}>equals</option>
                            <option value="not_equals" ${skip.condition === 'not_equals' ? 'selected' : ''}>not equals</option>
                            <option value="contains" ${skip.condition === 'contains' ? 'selected' : ''}>contains</option>
                        </select>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Value</label>
                        ${sourceOptions.length > 0 
                            ? `<select id="skipValue" class="property-select">
                                <option value="">-- Select value --</option>
                                ${sourceOptions.map(o => `<option value="${escapeHtml(o)}" ${skip.sourceValue === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('')}
                            </select>`
                            : `<input type="text" id="skipValue" class="property-input" value="${escapeHtml(skip.sourceValue || '')}" placeholder="Enter value">`
                        }
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        function attachPropertyListeners(field) {
            // Basic properties
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
            document.getElementById('propLevels')?.addEventListener('change', (e) => updateField('levels', e.target.value.split('\n').filter(l => l.trim())));
            document.getElementById('propRows')?.addEventListener('change', (e) => updateField('rows', parseInt(e.target.value)));
            document.getElementById('propMax')?.addEventListener('change', (e) => updateField('max', parseInt(e.target.value)));
            document.getElementById('propAccept')?.addEventListener('change', (e) => updateField('accept', e.target.value));
            document.getElementById('propFormula')?.addEventListener('change', (e) => updateField('formula', e.target.value));
            
            // Validation
            document.getElementById('validationEnabled')?.addEventListener('change', (e) => {
                updateField('validation.enabled', e.target.checked);
                document.getElementById('validationRulesContainer').style.display = e.target.checked ? 'block' : 'none';
            });
            
            document.querySelectorAll('[data-rule]').forEach(el => {
                el.addEventListener('change', (e) => {
                    const rule = e.target.dataset.rule;
                    const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                    const f = state.fields.find(f => f.id === state.selectedFieldId);
                    if (f) {
                        if (!f.validation) f.validation = { enabled: true, rules: {} };
                        if (!f.validation.rules) f.validation.rules = {};
                        f.validation.rules[rule] = value;
                        saveToStorage();
                    }
                });
            });
            
            // Skip Logic
            document.getElementById('skipEnabled')?.addEventListener('change', (e) => {
                updateField('skipLogic.enabled', e.target.checked);
                document.getElementById('skipOptionsContainer').style.display = e.target.checked ? 'block' : 'none';
            });
            
            document.getElementById('skipAction')?.addEventListener('change', (e) => updateField('skipLogic.action', e.target.value));
            document.getElementById('skipSourceField')?.addEventListener('change', (e) => {
                updateField('skipLogic.sourceField', e.target.value);
                // Re-render to update value dropdown
                renderProperties();
            });
            document.getElementById('skipCondition')?.addEventListener('change', (e) => updateField('skipLogic.condition', e.target.value));
            document.getElementById('skipValue')?.addEventListener('change', (e) => updateField('skipLogic.sourceValue', e.target.value));
        }

        // ============================================
        // TABLE CONFIGURATION
        // ============================================
        function openTableConfig(fieldId) {
            state.editingTableFieldId = fieldId;
            const field = state.fields.find(f => f.id === fieldId);
            if (!field) return;
            
            renderTableColumnsConfig(field);
            document.getElementById('tableConfigModal').classList.add('show');
        }

        function renderTableColumnsConfig(field) {
            const container = document.getElementById('tableColumnsConfig');
            const columnTypes = ['text', 'number', 'date', 'select', 'radio', 'checkbox', 'yesno'];
            
            container.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px;">
                <thead><tr>
                    <th style="border:1px solid #ddd;padding:8px;background:#004080;color:white;">Column Name</th>
                    <th style="border:1px solid #ddd;padding:8px;background:#004080;color:white;">Type</th>
                    <th style="border:1px solid #ddd;padding:8px;background:#004080;color:white;">Options</th>
                    <th style="border:1px solid #ddd;padding:8px;background:#004080;color:white;">Required</th>
                    <th style="border:1px solid #ddd;padding:8px;background:#004080;color:white;width:50px;"></th>
                </tr></thead>
                <tbody id="tableColumnsBody">
                    ${field.columns.map((col, i) => `<tr data-index="${i}">
                        <td style="border:1px solid #ddd;padding:6px;"><input type="text" value="${escapeHtml(col.name)}" class="col-name" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;"></td>
                        <td style="border:1px solid #ddd;padding:6px;"><select class="col-type" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;">
                            ${columnTypes.map(t => `<option value="${t}" ${col.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select></td>
                        <td style="border:1px solid #ddd;padding:6px;"><input type="text" value="${escapeHtml((col.options || []).join(','))}" class="col-options" placeholder="opt1,opt2,opt3" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:9px;"></td>
                        <td style="border:1px solid #ddd;padding:6px;text-align:center;"><input type="checkbox" class="col-required" ${col.required ? 'checked' : ''}></td>
                        <td style="border:1px solid #ddd;padding:6px;text-align:center;"><button class="remove-btn" onclick="removeTableColumn(${i})">‚úï</button></td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
        }

        function addTableColumn() {
            const field = state.fields.find(f => f.id === state.editingTableFieldId);
            if (!field) return;
            
            field.columns.push({ name: 'New Column', type: 'text', options: [], required: false });
            renderTableColumnsConfig(field);
        }

        function removeTableColumn(index) {
            const field = state.fields.find(f => f.id === state.editingTableFieldId);
            if (!field || field.columns.length <= 1) return;
            
            field.columns.splice(index, 1);
            renderTableColumnsConfig(field);
        }

        function saveTableConfig() {
            const field = state.fields.find(f => f.id === state.editingTableFieldId);
            if (!field) return;
            
            const rows = document.querySelectorAll('#tableColumnsBody tr');
            field.columns = Array.from(rows).map(row => ({
                name: row.querySelector('.col-name').value || 'Column',
                type: row.querySelector('.col-type').value || 'text',
                options: row.querySelector('.col-options').value.split(',').filter(o => o.trim()),
                required: row.querySelector('.col-required').checked
            }));
            
            renderFields();
            saveToStorage();
            closeModal('tableConfigModal');
            notify('Table configuration saved!');
        }

        // ============================================
        // SETTINGS
        // ============================================
        function openSettings() {
            document.getElementById('settingsTitle').value = state.settings.title;
            document.getElementById('settingsSubtitle').value = state.settings.subtitle;
            document.getElementById('settingsOrg').value = state.settings.organization;
            document.getElementById('settingsLogo').value = state.settings.logo;
            document.getElementById('settingsMultiPage').checked = state.settings.multiPage;
            document.getElementById('settingsScriptUrl').value = state.settings.scriptUrl;
            document.getElementById('cascadingData').value = state.settings.cascadingData;
            
            renderPagesList();
            document.getElementById('settingsModal').classList.add('show');
        }

        function renderPagesList() {
            const sections = state.fields.filter(f => f.type === 'section');
            const container = document.getElementById('pagesList');
            
            if (sections.length === 0) {
                container.innerHTML = '<p style="color:#666;font-size:11px;">No sections added. Add "Section" fields to create multi-page forms.</p>';
                return;
            }
            
            container.innerHTML = `<div style="font-size:11px;">
                <div style="padding:8px;background:#004080;color:white;border-radius:4px 4px 0 0;">Page 1: Introduction</div>
                ${sections.map((s, i) => `<div style="padding:8px;background:#f8f9fa;border:1px solid #ddd;border-top:none;">Page ${i + 2}: ${s.label}</div>`).join('')}
            </div>`;
        }

        function saveSettings() {
            state.settings.title = document.getElementById('settingsTitle').value;
            state.settings.subtitle = document.getElementById('settingsSubtitle').value;
            state.settings.organization = document.getElementById('settingsOrg').value;
            state.settings.logo = document.getElementById('settingsLogo').value;
            state.settings.multiPage = document.getElementById('settingsMultiPage').checked;
            state.settings.scriptUrl = document.getElementById('settingsScriptUrl').value;
            state.settings.cascadingData = document.getElementById('cascadingData').value;
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            document.getElementById('previewSubtitle').textContent = state.settings.subtitle;
            
            saveToStorage();
            closeModal('settingsModal');
            notify('Settings saved!');
        }

        // ============================================
        // FILE UPLOAD
        // ============================================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    const lines = [];
                    json.forEach(row => {
                        const reg = row.Region || row.region || '';
                        const dis = row.District || row.district || '';
                        const chi = row.Chiefdom || row.chiefdom || '';
                        const fac = row.Facility || row.facility || '';
                        const uid = row.UID || row.uid || '';
                        
                        if (reg && dis) lines.push(`${reg}||${dis}`);
                        if (dis && chi) lines.push(`${dis}||${chi}`);
                        if (chi && fac) lines.push(uid ? `${chi}||${fac}||${uid}` : `${chi}||${fac}`);
                    });
                    
                    document.getElementById('cascadingData').value = [...new Set(lines)].join('\n');
                    document.getElementById('fileUploadArea').classList.add('has-file');
                    document.getElementById('fileUploadText').textContent = `‚úÖ Loaded ${json.length} rows`;
                    
                    notify('File loaded successfully!');
                } catch (err) {
                    notify('Error reading file: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadSampleFile() {
            const data = [
                { Region: 'Eastern Region', District: 'Kailahun District', Chiefdom: 'Luawa Chiefdom', Facility: 'Kailahun Hospital', UID: 'abc123' },
                { Region: 'Southern Region', District: 'Bo District', Chiefdom: 'Badjia Chiefdom', Facility: 'Ngelehun CHC', UID: 'def456' }
            ];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Locations');
            XLSX.writeFile(wb, 'cascading-template.xlsx');
            notify('Template downloaded!');
        }

        // ============================================
        // PREVIEW
        // ============================================
        function previewForm() {
            if (state.fields.length === 0) {
                notify('Add some fields first!', 'error');
                return;
            }
            
            const html = generateHTMLCode();
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '<iframe class="preview-frame"></iframe>';
            
            const iframe = previewBody.querySelector('iframe');
            const doc = iframe.contentDocument;
            doc.open();
            doc.write(html);
            doc.close();
            
            document.getElementById('previewModal').classList.add('show');
        }

        // ============================================
        // GENERATE FORM
        // ============================================
        function generateForm() {
            if (state.fields.length === 0) {
                notify('Add some fields first!', 'error');
                return;
            }
            
            const htmlCode = generateHTMLCode();
            const scriptCode = generateAppsScriptCode();
            
            document.getElementById('htmlCode').textContent = htmlCode;
            document.getElementById('scriptCode').textContent = scriptCode;
            document.getElementById('generateModal').classList.add('show');
        }

        function generateHTMLCode() {
            const s = state.settings;
            const fields = state.fields;
            
            // Split fields into pages
            const pages = [{ title: 'Page 1', fields: [] }];
            let currentPage = 0;
            
            fields.forEach(f => {
                if (f.type === 'section') {
                    currentPage++;
                    pages.push({ title: f.label, fields: [] });
                } else {
                    pages[currentPage].fields.push(f);
                }
            });
            
            const multiPage = s.multiPage && pages.length > 1;
            
            let fieldsHTML = '';
            pages.forEach((page, pageIndex) => {
                if (multiPage) {
                    fieldsHTML += `<div class="form-page ${pageIndex === 0 ? 'active' : ''}" data-page="${pageIndex}">`;
                    if (pageIndex > 0) {
                        fieldsHTML += `<div class="section-header">${page.title.toUpperCase()}</div>`;
                    }
                }
                
                page.fields.forEach(f => {
                    fieldsHTML += generateFieldHTML(f);
                });
                
                if (multiPage) {
                    fieldsHTML += `<div class="page-nav">`;
                    if (pageIndex > 0) {
                        fieldsHTML += `<button type="button" class="nav-btn prev" onclick="prevPage()">‚Üê Previous</button>`;
                    }
                    if (pageIndex < pages.length - 1) {
                        fieldsHTML += `<button type="button" class="nav-btn next" onclick="nextPage()">Next ‚Üí</button>`;
                    } else {
                        fieldsHTML += `<button type="submit" class="btn-submit">SUBMIT</button>`;
                    }
                    fieldsHTML += `</div></div>`;
                }
            });
            
            if (!multiPage) {
                fieldsHTML += `<button type="submit" class="btn-submit">SUBMIT</button>`;
            }
            
            const skipLogicJS = generateSkipLogicJS();
            const validationJS = generateValidationJS();
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${s.title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"><\/script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Oswald',sans-serif;background:#f5f5f5;padding:20px}
        .container{max-width:650px;margin:0 auto}
        .header{background:#004080;color:#fff;padding:20px;text-align:center;border-radius:12px 12px 0 0}
        .header img{width:70px;border-radius:8px;margin-bottom:10px}
        .header h1{font-size:18px;margin-bottom:3px}
        .header p{font-size:11px;opacity:0.9}
        .form-card{border:4px double #004080;border-radius:12px;background:#fff}
        .form-body{padding:20px}
        .form-group{margin-bottom:16px}
        .form-group.hidden{display:none}
        .form-label{display:block;font-size:11px;font-weight:700;margin-bottom:5px;text-transform:uppercase}
        .required{color:red}
        .form-input,.form-select,.form-textarea{width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(0,64,128,0.2)}
        .form-input.error,.form-select.error{border-color:#dc3545}
        .error-msg{color:#dc3545;font-size:10px;margin-top:3px;display:none}
        .radio-group,.checkbox-group{display:flex;flex-wrap:wrap;gap:10px}
        .radio-option,.checkbox-option{display:flex;align-items:center;gap:5px;padding:8px 12px;border:2px solid #ddd;border-radius:6px;cursor:pointer;font-size:11px}
        .radio-option:hover,.checkbox-option:hover{border-color:#004080}
        .section-header{background:#004080;color:#fff;padding:12px 15px;margin:20px -20px;font-size:13px;font-weight:700}
        .btn-submit{width:100%;padding:14px;background:#28a745;color:#fff;border:none;border-radius:6px;font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;cursor:pointer;text-transform:uppercase}
        .btn-submit:hover{background:#218838}
        .btn-submit:disabled{background:#ccc;cursor:not-allowed}
        .page-nav{display:flex;justify-content:space-between;gap:10px;margin-top:20px}
        .nav-btn{padding:12px 24px;border:2px solid #004080;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase}
        .nav-btn.prev{background:#fff;color:#004080}
        .nav-btn.next{background:#004080;color:#fff}
        .form-page{display:none}
        .form-page.active{display:block}
        .page-indicator{text-align:center;margin-bottom:15px;font-size:11px;color:#666}
        .signature-container{border:2px solid #004080;border-radius:6px;overflow:hidden}
        .signature-canvas{width:100%;height:100px;background:#fff}
        .signature-controls{padding:6px;background:#f8f9fa;text-align:right}
        .signature-btn{padding:5px 10px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:10px}
        .gps-btn{padding:10px 14px;background:#004080;color:#fff;border:none;border-radius:6px;cursor:pointer;font-family:'Oswald',sans-serif;font-weight:700;font-size:11px}
        .gps-status{margin-top:8px;font-size:10px}
        .rating-container{display:flex;gap:5px}
        .rating-star{font-size:24px;cursor:pointer;color:#ddd;transition:color 0.2s}
        .rating-star.active,.rating-star:hover{color:#ffc107}
        .data-table{width:100%;border-collapse:collapse;font-size:11px}
        .data-table th,.data-table td{border:1px solid #ddd;padding:8px}
        .data-table th{background:#004080;color:#fff;font-size:10px;text-transform:uppercase}
        .data-table input,.data-table select{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:10px}
        .add-row-btn{margin-top:10px;padding:8px 14px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px}
        .remove-row-btn{background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px}
        .footer{text-align:center;padding:15px;font-size:10px;color:#666;margin-top:15px}
        .notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:#fff;font-weight:700;font-size:12px;z-index:1000;display:none}
        .notification.show{display:block}
        .notification.success{background:#28a745}
        .notification.error{background:#dc3545}
    </style>
</head>
<body>
    <div class="container">
        <div class="form-card">
            <div class="header">
                <img src="${s.logo}" alt="Logo">
                <h1>${s.title}</h1>
                <p>${s.subtitle}</p>
            </div>
            <div class="form-body">
                ${multiPage ? `<div class="page-indicator">Page <span id="currentPage">1</span> of ${pages.length}</div>` : ''}
                <form id="dataForm">
${fieldsHTML}
                </form>
            </div>
        </div>
        <div class="footer">¬© 2025 ${s.organization}</div>
    </div>
    <div class="notification" id="notification"></div>
    <script>
        const CONFIG = { SCRIPT_URL: '${s.scriptUrl || ''}' };
        const CASCADING_DATA = \`${s.cascadingData}\`;
        const signaturePads = {};
        let currentPage = 0;
        const totalPages = ${pages.length};

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dataForm').addEventListener('submit', handleSubmit);
            setupCascading();
            setupSignatures();
            setupRatings();
            setupDynamicTables();
            setupSkipLogic();
        });

        ${multiPage ? `
        function nextPage() {
            if (!validateCurrentPage()) return;
            if (currentPage < totalPages - 1) {
                document.querySelector('.form-page.active').classList.remove('active');
                currentPage++;
                document.querySelector('[data-page="' + currentPage + '"]').classList.add('active');
                document.getElementById('currentPage').textContent = currentPage + 1;
                window.scrollTo(0, 0);
            }
        }
        function prevPage() {
            if (currentPage > 0) {
                document.querySelector('.form-page.active').classList.remove('active');
                currentPage--;
                document.querySelector('[data-page="' + currentPage + '"]').classList.add('active');
                document.getElementById('currentPage').textContent = currentPage + 1;
                window.scrollTo(0, 0);
            }
        }
        function validateCurrentPage() {
            const page = document.querySelector('.form-page.active');
            const requiredFields = page.querySelectorAll('[required]');
            let valid = true;
            requiredFields.forEach(f => {
                if (!f.value) {
                    f.classList.add('error');
                    valid = false;
                } else {
                    f.classList.remove('error');
                }
            });
            if (!valid) showNotification('Please fill all required fields', 'error');
            return valid;
        }
        ` : ''}

        function handleSubmit(e) {
            e.preventDefault();
            if (!validateForm()) return;
            
            const fd = new FormData(e.target);
            const data = { _timestamp: new Date().toISOString() };
            fd.forEach((v, k) => { 
                if (data[k]) {
                    data[k] = Array.isArray(data[k]) ? [...data[k], v] : [data[k], v];
                } else {
                    data[k] = v;
                }
            });
            Object.keys(signaturePads).forEach(k => {
                if (!signaturePads[k].isEmpty()) data[k] = signaturePads[k].toDataURL();
            });
            
            // Collect dynamic table data
            document.querySelectorAll('.dynamic-table').forEach(table => {
                const name = table.dataset.name;
                const rows = [];
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const row = {};
                    tr.querySelectorAll('input, select').forEach(inp => {
                        row[inp.dataset.col] = inp.type === 'checkbox' ? inp.checked : inp.value;
                    });
                    rows.push(row);
                });
                data[name] = JSON.stringify(rows);
            });
            
            if (CONFIG.SCRIPT_URL) {
                fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    showNotification('Submitted successfully!', 'success');
                    e.target.reset();
                    Object.values(signaturePads).forEach(sp => sp.clear());
                }).catch(() => showNotification('Error submitting', 'error'));
            } else {
                console.log('Form data:', data);
                showNotification('Submitted successfully!', 'success');
                e.target.reset();
            }
        }

        function validateForm() {
            let valid = true;
            ${validationJS}
            return valid;
        }

        function parseCascading() {
            const m = { r: {}, d: {}, c: {}, u: {} };
            CASCADING_DATA.trim().split('\\n').forEach(l => {
                const p = l.split('||').map(s => s.trim());
                if (p.length >= 2) {
                    const key = p[0], val = p[1];
                    if (key.includes('Region') || key === 'Western Area') {
                        if (!m.r[key]) m.r[key] = [];
                        m.r[key].push(val);
                    } else if (key.includes('District')) {
                        if (!m.d[key]) m.d[key] = [];
                        m.d[key].push(val);
                    } else {
                        if (!m.c[key]) m.c[key] = [];
                        m.c[key].push(val);
                        if (p.length === 3) m.u[val] = p[2];
                    }
                }
            });
            return m;
        }

        function setupCascading() {
            const m = parseCascading();
            document.querySelectorAll('.cascading-region').forEach(s => {
                Object.keys(m.r).sort().forEach(r => s.innerHTML += '<option value="' + r + '">' + r + '</option>');
                s.addEventListener('change', function() {
                    const d = this.closest('.cascading-group').querySelector('.cascading-district');
                    d.innerHTML = '<option value="">-- District --</option>';
                    if (this.value && m.r[this.value]) m.r[this.value].forEach(x => d.innerHTML += '<option value="' + x + '">' + x + '</option>');
                    d.dispatchEvent(new Event('change'));
                });
            });
            document.querySelectorAll('.cascading-district').forEach(s => {
                s.addEventListener('change', function() {
                    const c = this.closest('.cascading-group').querySelector('.cascading-chiefdom');
                    if (c) {
                        c.innerHTML = '<option value="">-- Chiefdom --</option>';
                        if (this.value && m.d[this.value]) m.d[this.value].forEach(x => c.innerHTML += '<option value="' + x + '">' + x + '</option>');
                        c.dispatchEvent(new Event('change'));
                    }
                });
            });
            document.querySelectorAll('.cascading-chiefdom').forEach(s => {
                s.addEventListener('change', function() {
                    const f = this.closest('.cascading-group').querySelector('.cascading-facility');
                    if (f) {
                        f.innerHTML = '<option value="">-- Facility --</option>';
                        if (this.value && m.c[this.value]) m.c[this.value].forEach(x => f.innerHTML += '<option value="' + x + '">' + x + '</option>');
                    }
                });
            });
            document.querySelectorAll('.cascading-facility').forEach(s => {
                s.addEventListener('change', function() {
                    const u = this.closest('.cascading-group').querySelector('.facility-uid');
                    if (u && this.value && m.u[this.value]) u.value = m.u[this.value];
                });
            });
        }

        function setupSignatures() {
            document.querySelectorAll('.signature-canvas').forEach(c => {
                signaturePads[c.dataset.field] = new SignaturePad(c, { penColor: '#004080' });
            });
        }
        function clearSignature(f) { if (signaturePads[f]) signaturePads[f].clear(); }

        function captureGPS(btn) {
            const c = btn.closest('.gps-container');
            const s = c.querySelector('.gps-status');
            s.textContent = 'üì° Capturing...';
            s.style.color = '#004080';
            navigator.geolocation.getCurrentPosition(
                p => {
                    c.querySelector('.gps-lat').value = p.coords.latitude.toFixed(6);
                    c.querySelector('.gps-lng').value = p.coords.longitude.toFixed(6);
                    s.textContent = '‚úÖ ' + p.coords.latitude.toFixed(5) + ', ' + p.coords.longitude.toFixed(5);
                    s.style.color = '#28a745';
                },
                err => { s.textContent = '‚ùå ' + err.message; s.style.color = '#dc3545'; },
                { enableHighAccuracy: true, timeout: 60000 }
            );
        }

        function setupRatings() {
            document.querySelectorAll('.rating-container').forEach(c => {
                const stars = c.querySelectorAll('.rating-star');
                const input = c.querySelector('input[type="hidden"]');
                stars.forEach((star, i) => {
                    star.addEventListener('click', () => {
                        input.value = i + 1;
                        stars.forEach((s, j) => s.classList.toggle('active', j <= i));
                    });
                    star.addEventListener('mouseenter', () => {
                        stars.forEach((s, j) => s.style.color = j <= i ? '#ffc107' : '#ddd');
                    });
                });
                c.addEventListener('mouseleave', () => {
                    const val = parseInt(input.value) || 0;
                    stars.forEach((s, j) => s.style.color = j < val ? '#ffc107' : '#ddd');
                });
            });
        }

        function setupDynamicTables() {
            document.querySelectorAll('.add-row-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const table = this.previousElementSibling;
                    const tbody = table.querySelector('tbody');
                    const template = tbody.querySelector('tr').cloneNode(true);
                    template.querySelectorAll('input, select').forEach(inp => { inp.value = ''; if (inp.type === 'checkbox') inp.checked = false; });
                    tbody.appendChild(template);
                });
            });
        }

        function removeTableRow(btn) {
            const tbody = btn.closest('tbody');
            if (tbody.querySelectorAll('tr').length > 1) btn.closest('tr').remove();
        }

        ${skipLogicJS}

        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = 'notification show ' + type;
            setTimeout(() => n.classList.remove('show'), 3000);
        }
    <\/script>
</body>
</html>`;
        }

        function generateFieldHTML(field) {
            const req = field.required ? '<span class="required">*</span>' : '';
            const reqAttr = field.required ? 'required' : '';
            const hiddenClass = field.skipLogic?.enabled ? ' hidden' : '';
            
            let inner = '';
            switch (field.type) {
                case 'text':
                    inner = `<input type="text" class="form-input" name="${field.name}" ${reqAttr}>`;
                    break;
                case 'email':
                    inner = `<input type="email" class="form-input" name="${field.name}" ${reqAttr}>`;
                    break;
                case 'phone':
                    inner = `<input type="tel" class="form-input" name="${field.name}" ${reqAttr} pattern="[0-9+\\-\\s()]+">`;
                    break;
                case 'number':
                    inner = `<input type="number" class="form-input" name="${field.name}" ${reqAttr}>`;
                    break;
                case 'date':
                    inner = `<input type="date" class="form-input" name="${field.name}" ${reqAttr}>`;
                    break;
                case 'time':
                    inner = `<input type="time" class="form-input" name="${field.name}" ${reqAttr}>`;
                    break;
                case 'textarea':
                    inner = `<textarea class="form-textarea" name="${field.name}" rows="3" ${reqAttr}></textarea>`;
                    break;
                case 'select':
                    inner = `<select class="form-select" name="${field.name}" ${reqAttr}><option value="">-- Select --</option>${(field.options || []).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                    break;
                case 'radio':
                    inner = `<div class="radio-group">${(field.options || []).map(o => `<label class="radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                    break;
                case 'yesno':
                    inner = `<div class="radio-group"><label class="radio-option"><input type="radio" name="${field.name}" value="Yes" ${reqAttr}><span>Yes</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="No" ${reqAttr}><span>No</span></label></div>`;
                    break;
                case 'yesnona':
                    inner = `<div class="radio-group"><label class="radio-option"><input type="radio" name="${field.name}" value="Yes" ${reqAttr}><span>Yes</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="No" ${reqAttr}><span>No</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="N/A" ${reqAttr}><span>N/A</span></label></div>`;
                    break;
                case 'checkbox':
                    inner = `<div class="checkbox-group">${(field.options || []).map(o => `<label class="checkbox-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                    break;
                case 'table':
                    inner = generateStaticTableHTML(field);
                    break;
                case 'dynamicTable':
                    inner = generateDynamicTableHTML(field);
                    break;
                case 'cascading':
                    inner = `<div class="cascading-group">${(field.levels || []).map((l, i) => `<select class="form-select cascading-${i === 0 ? 'region' : i === 1 ? 'district' : i === 2 ? 'chiefdom' : 'facility'}" name="${field.name}_${l.toLowerCase().replace(/\s+/g, '_')}" ${reqAttr} style="margin-bottom:8px;"><option value="">-- ${l} --</option></select>`).join('')}<input type="hidden" class="facility-uid" name="${field.name}_uid"></div>`;
                    break;
                case 'gps':
                    inner = `<div class="gps-container"><input type="hidden" class="gps-lat" name="${field.name}_lat"><input type="hidden" class="gps-lng" name="${field.name}_lng"><button type="button" class="gps-btn" onclick="captureGPS(this)">üìç Capture GPS Location</button><div class="gps-status"></div></div>`;
                    break;
                case 'signature':
                    inner = `<div class="signature-container"><canvas class="signature-canvas" data-field="${field.name}" width="300" height="100"></canvas><div class="signature-controls"><button type="button" class="signature-btn" onclick="clearSignature('${field.name}')">Clear</button></div></div>`;
                    break;
                case 'rating':
                    const max = field.max || 5;
                    inner = `<div class="rating-container">${Array(max).fill(0).map((_, i) => `<span class="rating-star" data-value="${i + 1}">‚òÖ</span>`).join('')}<input type="hidden" name="${field.name}" value=""></div>`;
                    break;
                case 'file':
                    inner = `<input type="file" class="form-input" name="${field.name}" accept="${field.accept || ''}" ${reqAttr}>`;
                    break;
                case 'calculated':
                    inner = `<input type="text" class="form-input" name="${field.name}" readonly style="background:#e9ecef;">`;
                    break;
                default:
                    return '';
            }
            
            return `                        <div class="form-group${hiddenClass}" id="group_${field.id}">
                            <label class="form-label">${escapeHtml(field.label)} ${req}</label>
                            ${inner}
                            <div class="error-msg" id="error_${field.id}"></div>
                        </div>\n`;
        }

        function generateStaticTableHTML(field) {
            const cols = field.columns || [];
            const rows = field.rows || 3;
            
            let html = `<table class="data-table"><thead><tr>${cols.map(c => `<th>${escapeHtml(c.name)}</th>`).join('')}</tr></thead><tbody>`;
            
            for (let r = 0; r < rows; r++) {
                html += '<tr>';
                cols.forEach((col, ci) => {
                    html += `<td>${generateTableCellInput(field.name, r, col)}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            return html;
        }

        function generateDynamicTableHTML(field) {
            const cols = field.columns || [];
            
            let html = `<table class="data-table dynamic-table" data-name="${field.name}"><thead><tr>${cols.map(c => `<th>${escapeHtml(c.name)}</th>`).join('')}<th style="width:40px;"></th></tr></thead><tbody>`;
            html += '<tr>';
            cols.forEach((col, ci) => {
                html += `<td>${generateTableCellInput(field.name, 0, col)}</td>`;
            });
            html += '<td><button type="button" class="remove-row-btn" onclick="removeTableRow(this)">‚úï</button></td></tr>';
            html += '</tbody></table>';
            html += `<button type="button" class="add-row-btn">‚ûï Add Row</button>`;
            
            return html;
        }

        function generateTableCellInput(tableName, rowIndex, col) {
            const name = `${tableName}_${rowIndex}_${col.name.replace(/\s+/g, '_')}`;
            const dataCol = col.name.replace(/\s+/g, '_');
            
            switch (col.type) {
                case 'number':
                    return `<input type="number" name="${name}" data-col="${dataCol}" ${col.required ? 'required' : ''}>`;
                case 'date':
                    return `<input type="date" name="${name}" data-col="${dataCol}" ${col.required ? 'required' : ''}>`;
                case 'select':
                    return `<select name="${name}" data-col="${dataCol}" ${col.required ? 'required' : ''}><option value="">--</option>${(col.options || []).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                case 'radio':
                    return (col.options || []).map(o => `<label style="font-size:9px;"><input type="radio" name="${name}" value="${escapeHtml(o)}" data-col="${dataCol}"> ${escapeHtml(o)}</label>`).join(' ');
                case 'checkbox':
                    return `<input type="checkbox" name="${name}" data-col="${dataCol}">`;
                case 'yesno':
                    return `<select name="${name}" data-col="${dataCol}"><option value="">--</option><option value="Yes">Yes</option><option value="No">No</option></select>`;
                default:
                    return `<input type="text" name="${name}" data-col="${dataCol}" ${col.required ? 'required' : ''}>`;
            }
        }

        function generateSkipLogicJS() {
            const fieldsWithSkip = state.fields.filter(f => f.skipLogic?.enabled && f.skipLogic?.sourceField);
            if (fieldsWithSkip.length === 0) return 'function setupSkipLogic() {}';
            
            let js = 'function setupSkipLogic() {\n';
            fieldsWithSkip.forEach(f => {
                const src = state.fields.find(x => x.id === f.skipLogic.sourceField);
                if (!src) return;
                
                const condition = f.skipLogic.condition === 'equals' 
                    ? `val === '${f.skipLogic.sourceValue}'`
                    : f.skipLogic.condition === 'not_equals'
                    ? `val !== '${f.skipLogic.sourceValue}'`
                    : `val.includes('${f.skipLogic.sourceValue}')`;
                
                js += `    document.querySelectorAll('[name="${src.name}"]').forEach(el => {
        el.addEventListener('change', function() {
            const container = document.getElementById('group_${f.id}');
            let val = this.type === 'radio' ? (document.querySelector('[name="${src.name}"]:checked')?.value || '') : this.value;
            const cond = ${condition};
            container.classList.toggle('hidden', ${f.skipLogic.action === 'show' ? '!cond' : 'cond'});
        });
    });\n`;
            });
            js += '}';
            return js;
        }

        function generateValidationJS() {
            const fieldsWithValidation = state.fields.filter(f => f.validation?.enabled);
            if (fieldsWithValidation.length === 0) return '';
            
            let js = '';
            fieldsWithValidation.forEach(f => {
                const rules = f.validation.rules || {};
                
                Object.entries(rules).forEach(([rule, value]) => {
                    if (!value && value !== 0) return;
                    
                    switch (rule) {
                        case 'minLength':
                            js += `    if (document.querySelector('[name="${f.name}"]')?.value.length < ${value}) { document.getElementById('error_${f.id}').textContent = 'Minimum ${value} characters required'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'maxLength':
                            js += `    if (document.querySelector('[name="${f.name}"]')?.value.length > ${value}) { document.getElementById('error_${f.id}').textContent = 'Maximum ${value} characters allowed'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'min':
                            js += `    if (parseFloat(document.querySelector('[name="${f.name}"]')?.value) < ${value}) { document.getElementById('error_${f.id}').textContent = 'Minimum value is ${value}'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'max':
                            js += `    if (parseFloat(document.querySelector('[name="${f.name}"]')?.value) > ${value}) { document.getElementById('error_${f.id}').textContent = 'Maximum value is ${value}'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'pattern':
                            js += `    if (document.querySelector('[name="${f.name}"]')?.value && !new RegExp('${value}').test(document.querySelector('[name="${f.name}"]').value)) { document.getElementById('error_${f.id}').textContent = 'Invalid format'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'notFuture':
                            if (value) js += `    if (document.querySelector('[name="${f.name}"]')?.value && new Date(document.querySelector('[name="${f.name}"]').value) > new Date()) { document.getElementById('error_${f.id}').textContent = 'Date cannot be in the future'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'notPast':
                            if (value) js += `    if (document.querySelector('[name="${f.name}"]')?.value && new Date(document.querySelector('[name="${f.name}"]').value) < new Date().setHours(0,0,0,0)) { document.getElementById('error_${f.id}').textContent = 'Date cannot be in the past'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'positive':
                            if (value) js += `    if (parseFloat(document.querySelector('[name="${f.name}"]')?.value) < 0) { document.getElementById('error_${f.id}').textContent = 'Value must be positive'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                        case 'integer':
                            if (value) js += `    if (document.querySelector('[name="${f.name}"]')?.value && !Number.isInteger(parseFloat(document.querySelector('[name="${f.name}"]').value))) { document.getElementById('error_${f.id}').textContent = 'Value must be an integer'; document.getElementById('error_${f.id}').style.display = 'block'; valid = false; }\n`;
                            break;
                    }
                });
            });
            
            return js;
        }

        function generateAppsScriptCode() {
            const fields = state.fields.filter(f => f.type !== 'section');
            const s = state.settings;
            
            let headers = ['Timestamp'];
            fields.forEach(f => {
                if (f.type === 'cascading') {
                    (f.levels || []).forEach(l => headers.push(l));
                    headers.push('UID');
                } else if (f.type === 'gps') {
                    headers.push(f.label + ' Lat', f.label + ' Lng');
                } else {
                    headers.push(f.label);
                }
            });
            
            return `// ============================================
// AUTO-GENERATED APPS SCRIPT
// Form: ${s.title}
// Generated: ${new Date().toLocaleString()}
// ============================================

const SHEET_NAME = 'Submissions';
const USERS_SHEET = 'Users';
const HEADERS = ${JSON.stringify(headers, null, 2)};

function doPost(e) {
    try {
        const data = JSON.parse(e.postData.contents);
        
        if (data.action === 'signup') {
            return handleSignup(data);
        }
        
        // Handle form submission
        const sheet = getOrCreateSheet(SHEET_NAME, HEADERS);
        const row = [data._timestamp || new Date().toISOString()];
        
        HEADERS.slice(1).forEach(h => {
            const key = Object.keys(data).find(k => data[k] !== undefined && h.toLowerCase().includes(k.toLowerCase().split('_')[0]));
            row.push(data[key] || '');
        });
        
        sheet.appendRow(row);
        return jsonResponse({ success: true });
    } catch (err) {
        return jsonResponse({ success: false, error: err.toString() });
    }
}

function doGet(e) {
    const action = e.parameter.action;
    
    if (action === 'login') {
        return handleLogin(e.parameter.email, e.parameter.password);
    }
    
    if (action === 'forgotPassword') {
        return handleForgotPassword(e.parameter.email);
    }
    
    if (action === 'getData') {
        return getData();
    }
    
    return jsonResponse({ status: 'OK', message: 'Form Builder API' });
}

function handleSignup(data) {
    const sheet = getOrCreateSheet(USERS_SHEET, ['ID', 'Name', 'Email', 'Organization', 'Password', 'Created']);
    const emails = sheet.getRange(2, 3, Math.max(1, sheet.getLastRow() - 1), 1).getValues().flat();
    
    if (emails.includes(data.email)) {
        return jsonResponse({ success: false, message: 'Email already registered' });
    }
    
    sheet.appendRow([
        Utilities.getUuid(),
        data.name,
        data.email,
        data.org || '',
        data.password,
        new Date().toISOString()
    ]);
    
    return jsonResponse({ success: true });
}

function handleLogin(email, password) {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USERS_SHEET);
    if (!sheet) return jsonResponse({ success: false, message: 'User not found' });
    
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
        if (data[i][2] === email && data[i][4] === password) {
            return jsonResponse({
                success: true,
                user: { id: data[i][0], name: data[i][1], email: data[i][2], org: data[i][3] }
            });
        }
    }
    
    return jsonResponse({ success: false, message: 'Invalid credentials' });
}

function handleForgotPassword(email) {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USERS_SHEET);
    if (!sheet) return jsonResponse({ success: false, message: 'Email not found' });
    
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
        if (data[i][2] === email) {
            const password = data[i][4];
            const name = data[i][1];
            
            try {
                MailApp.sendEmail({
                    to: email,
                    subject: 'Password Recovery - ${s.title}',
                    htmlBody: \`
                        <div style="font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px;">
                            <h2 style="color: #004080;">Password Recovery</h2>
                            <p>Hello \${name},</p>
                            <p>Your password is: <strong>\${password}</strong></p>
                            <p>Please keep this information secure.</p>
                            <hr style="margin: 20px 0;">
                            <p style="font-size: 12px; color: #666;">¬© 2025 ${s.organization}</p>
                        </div>
                    \`
                });
                return jsonResponse({ success: true, message: 'Password sent to your email' });
            } catch (err) {
                return jsonResponse({ success: false, message: 'Failed to send email: ' + err.toString() });
            }
        }
    }
    
    return jsonResponse({ success: false, message: 'Email not found' });
}

function getData() {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet || sheet.getLastRow() < 2) return jsonResponse({ data: [] });
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const result = data.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = row[i]);
        return obj;
    });
    
    return jsonResponse({ data: result });
}

function getOrCreateSheet(name, headers) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(name);
    
    if (!sheet) {
        sheet = ss.insertSheet(name);
        sheet.appendRow(headers);
        sheet.getRange(1, 1, 1, headers.length)
            .setFontWeight('bold')
            .setBackground('#004080')
            .setFontColor('#ffffff');
        sheet.setFrozenRows(1);
    }
    
    return sheet;
}

function jsonResponse(data) {
    return ContentService.createTextOutput(JSON.stringify(data))
        .setMimeType(ContentService.MimeType.JSON);
}

function onOpen() {
    SpreadsheetApp.getUi()
        .createMenu('üìã ${s.title}')
        .addItem('üìä View Stats', 'viewStats')
        .addItem('üóëÔ∏è Clear Submissions', 'clearData')
        .addToUi();
}

function viewStats() {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    const count = sheet ? sheet.getLastRow() - 1 : 0;
    SpreadsheetApp.getUi().alert('Total Submissions: ' + count);
}

function clearData() {
    const ui = SpreadsheetApp.getUi();
    if (ui.alert('Clear all submissions?', ui.ButtonSet.YES_NO) === ui.Button.YES) {
        const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
        if (sheet && sheet.getLastRow() > 1) {
            sheet.deleteRows(2, sheet.getLastRow() - 1);
        }
        ui.alert('Data cleared!');
    }
}`;
        }

        // ============================================
        // SHARE - Auto Generate URL and QR Code
        // ============================================
        let currentShareUrl = '';

        function shareForm() {
            if (state.fields.length === 0) {
                notify('Add some fields first!', 'error');
                return;
            }
            
            // Set form title
            document.getElementById('shareFormTitle').textContent = state.settings.title;
            
            // Create compressed form data
            const formData = {
                id: 'form_' + Date.now(),
                t: state.settings.title,
                s: state.settings.subtitle,
                o: state.settings.organization,
                l: state.settings.logo,
                m: state.settings.multiPage,
                c: state.settings.cascadingData,
                u: state.settings.scriptUrl,
                f: state.fields.map(f => ({
                    i: f.id, y: f.type, l: f.label, n: f.name, r: f.required,
                    o: f.options, v: f.levels, c: f.columns, w: f.rows,
                    x: f.max, a: f.accept, m: f.formula, k: f.skipLogic, d: f.validation
                }))
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                
                // Use proper web URL - if on file://, use placeholder base
                let baseUrl;
                if (window.location.protocol === 'file:') {
                    // Create a clean filename-based URL
                    const filename = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.html';
                    baseUrl = 'https://yourdomain.com/' + filename;
                } else {
                    baseUrl = window.location.origin + window.location.pathname;
                }
                
                currentShareUrl = baseUrl + '?c=' + encodeURIComponent(encoded);
                
                // Set URL in textarea
                document.getElementById('shareUrlArea').value = currentShareUrl;
                
                // Generate QR code
                const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(currentShareUrl) + '&color=004080';
                document.getElementById('qrCodeImg').src = qrUrl;
                
                // Show modal
                document.getElementById('shareModal').classList.add('show');
                
            } catch (err) {
                console.error('Share error:', err);
                notify('Error creating share link', 'error');
            }
        }

        function copyShareUrl() {
            const url = document.getElementById('shareUrlArea').value || currentShareUrl;
            if (url) {
                navigator.clipboard.writeText(url).then(() => notify('URL copied!'));
            }
        }

        function downloadQRImg() {
            const img = document.getElementById('qrCodeImg');
            if (!img.src) {
                notify('No QR code to download', 'error');
                return;
            }
            
            // Create canvas with title
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const padding = 30;
            const titleHeight = 50;
            const qrSize = 220;
            
            canvas.width = qrSize + padding * 2;
            canvas.height = qrSize + padding * 2 + titleHeight;
            
            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Title
            ctx.fillStyle = '#004080';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(state.settings.title, canvas.width / 2, 30);
            
            // Subtitle
            ctx.font = '11px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Scan to open form', canvas.width / 2, 45);
            
            // Draw QR image
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';
            tempImg.onload = function() {
                ctx.drawImage(tempImg, padding, titleHeight + 10, qrSize, qrSize);
                
                // Download
                const link = document.createElement('a');
                link.download = state.settings.title.replace(/[^a-z0-9]/gi, '-') + '-QR.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                notify('QR Code downloaded!');
            };
            tempImg.onerror = function() {
                window.open(img.src, '_blank');
                notify('Opening QR in new tab - right-click to save');
            };
            tempImg.src = img.src;
        }

        // ============================================
        // UTILITIES
        // ============================================
        function downloadHTML() {
            const code = document.getElementById('htmlCode').textContent;
            const blob = new Blob([code], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.html';
            a.click();
            notify('HTML downloaded!');
        }

        function downloadScript() {
            const code = document.getElementById('scriptCode').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'apps-script.gs';
            a.click();
            notify('Script downloaded!');
        }

        function copyCode(id) {
            const code = document.getElementById(id).textContent;
            navigator.clipboard.writeText(code);
            notify('Copied to clipboard!');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : '');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function saveToStorage() {
            localStorage.setItem('formBuilderPro', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderPro');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
