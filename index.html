<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Auth Screens */
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header h1 { font-size: 22px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-tab:hover { background: #f8f9fa; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; transition: border-color 0.2s; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        .auth-btn:hover { background: #003366; }
        .auth-btn:disabled { background: #ccc; cursor: not-allowed; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-link { text-align: center; margin-top: 15px; font-size: 12px; }
        .auth-link a { color: #004080; cursor: pointer; text-decoration: underline; }
        
        /* Header */
        .header { background: #004080; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 40px; height: 40px; border-radius: 6px; }
        .header h1 { font-size: 18px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .header-btn { background: white; color: #004080; border: none; padding: 8px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; }
        .header-btn:hover { background: #f0f0f0; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        
        /* Main Layout */
        .main-container { display: none; margin-top: 60px; height: calc(100vh - 90px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        /* Sidebar */
        .sidebar { width: 200px; background: white; border-right: 2px solid #004080; overflow-y: auto; padding: 12px; }
        .sidebar-section { margin-bottom: 12px; }
        .sidebar-title { font-size: 10px; font-weight: 700; color: #004080; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 8px 10px; margin-bottom: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; transform: translateX(2px); }
        .field-type-icon { font-size: 14px; }
        
        /* Canvas */
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 10px 20px; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 15px; font-weight: 700; border: 2px solid transparent; padding: 6px 10px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 280px; }
        .form-title-input:focus { outline: none; border-color: #004080; background: #f8f9fa; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 600px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 300px; }
        .form-preview-header { background: #004080; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-header h2 { font-size: 16px; margin-bottom: 3px; }
        .form-preview-header p { font-size: 10px; opacity: 0.9; }
        .form-preview-body { padding: 15px; min-height: 200px; }
        
        /* Drop Zone */
        .drop-zone { border: 3px dashed #ccc; border-radius: 8px; padding: 30px; text-align: center; color: #999; font-size: 12px; min-height: 150px; display: flex; flex-direction: column; justify-content: center; }
        .drop-zone.drag-over { border-color: #004080; background: #e8f4fc; }
        .drop-zone.has-fields { border: none; padding: 0; display: block; min-height: auto; }
        
        /* Form Fields */
        .form-field { background: #f8f9fa; border: 2px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .form-field-label { font-weight: 700; font-size: 10px; color: #333; text-transform: uppercase; }
        .form-field-actions { display: flex; gap: 3px; }
        .field-action-btn { background: #e9ecef; border: none; cursor: pointer; font-size: 11px; padding: 3px 5px; border-radius: 4px; }
        .field-action-btn:hover { background: #dee2e6; }
        .field-action-btn.delete:hover { background: #ffebee; color: #dc3545; }
        .form-field-preview { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 6px; font-size: 10px; color: #666; }
        .form-field-meta { margin-top: 5px; font-size: 9px; color: #999; display: flex; gap: 8px; flex-wrap: wrap; }
        .field-badge { padding: 2px 5px; border-radius: 3px; font-size: 8px; }
        .field-badge.skip { background: #fff3cd; color: #856404; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        .field-badge.validation { background: #d1ecf1; color: #0c5460; }
        
        .section-divider { background: #004080; color: white; padding: 10px 14px; margin: 12px 0; border-radius: 6px; font-weight: 700; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-divider.selected { box-shadow: 0 0 0 3px rgba(0,64,128,0.3); }
        .section-divider .page-badge { background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 9px; }
        
        /* Properties Panel */
        .properties-panel { width: 300px; background: white; border-left: 2px solid #004080; overflow-y: auto; padding: 12px; }
        .properties-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .property-group { margin-bottom: 10px; }
        .property-label { display: block; font-size: 9px; font-weight: 700; color: #333; margin-bottom: 4px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 7px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .property-input:focus, .property-select:focus { outline: none; border-color: #004080; }
        .property-textarea { width: 100%; padding: 7px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 10px; min-height: 50px; resize: vertical; }
        .property-checkbox { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 10px; }
        .property-checkbox input { width: 14px; height: 14px; }
        .no-selection { text-align: center; color: #999; padding: 30px 10px; font-size: 11px; }
        
        /* Property Sections */
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 6px; padding: 10px; margin-bottom: 12px; }
        .prop-section-title { font-size: 10px; font-weight: 700; color: #004080; margin-bottom: 8px; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .prop-section.skip-logic { background: #fff3cd; border-color: #ffc107; }
        .prop-section.validation { background: #d1ecf1; border-color: #17a2b8; }
        
        /* Inline Fields */
        .prop-row { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; }
        .prop-row .property-input, .prop-row .property-select { flex: 1; }
        .prop-row span { font-size: 9px; color: #666; white-space: nowrap; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; border: 4px double #004080; }
        .modal-header { background: #004080; color: white; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 15px; }
        .modal-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        .modal-body { padding: 18px; max-height: 65vh; overflow-y: auto; }
        .modal-footer { padding: 12px 18px; border-top: 2px solid #ddd; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 8px 16px; border-radius: 5px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; border: 2px solid #004080; }
        .modal-btn.secondary { background: white; color: #004080; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; border-color: #28a745; }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; cursor: pointer; font-weight: 700; font-size: 11px; border-bottom: 3px solid transparent; margin-bottom: -2px; text-transform: uppercase; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #004080; color: #004080; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Settings */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .settings-group { margin-bottom: 12px; }
        .settings-group.full-width { grid-column: span 2; }
        .settings-label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .settings-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .settings-input:focus { outline: none; border-color: #004080; }
        .settings-hint { font-size: 9px; color: #666; margin-top: 4px; }
        
        .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .toggle-slider { width: 40px; height: 20px; background: #ccc; border-radius: 10px; position: relative; transition: background 0.3s; }
        .toggle-slider::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle-switch input { display: none; }
        .toggle-switch input:checked + .toggle-slider { background: #28a745; }
        .toggle-switch input:checked + .toggle-slider::after { left: 22px; }
        
        /* Code Preview */
        .code-preview { background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 10px; white-space: pre-wrap; max-height: 300px; overflow: auto; }
        
        /* Info Box */
        .info-box { background: #e8f4fc; border: 2px solid #004080; border-radius: 6px; padding: 10px; font-size: 11px; margin: 10px 0; }
        .info-box h4 { color: #004080; margin-bottom: 5px; font-size: 11px; }
        
        /* QR Code Container */
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,64,128,0.2); }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCode canvas, #qrCode img { display: block !important; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 11px; word-break: break-all; margin-top: 15px; max-height: 100px; overflow-y: auto; border: 2px solid #ddd; text-align: left; font-family: monospace; }
        .qr-actions { display: flex; gap: 8px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        
        /* Notification */
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        
        /* Dynamic Table Builder */
        .table-builder { border: 2px solid #ddd; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .table-builder-header { background: #004080; color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
        .table-builder-header span { font-size: 11px; font-weight: 700; }
        .table-builder-body { max-height: 200px; overflow: auto; }
        .table-builder table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .table-builder th, .table-builder td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .table-builder th { background: #f8f9fa; font-weight: 700; }
        .table-builder input, .table-builder select { width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 9px; }
        .add-row-btn, .add-col-btn { background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 9px; cursor: pointer; margin: 2px; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer; }
        
        /* File Upload */
        .file-upload-area { border: 3px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 12px; transition: all 0.2s; }
        .file-upload-area:hover { border-color: #004080; background: #f8f9fa; }
        .file-upload-area.has-file { border-color: #28a745; background: #d4edda; }
        
        /* Preview Iframe */
        .preview-frame { width: 100%; height: 500px; border: none; background: white; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 180px; }
            .settings-grid { grid-template-columns: 1fr; }
            .settings-group.full-width { grid-column: span 1; }
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" style="width:70px;border-radius:10px;margin-bottom:12px;">
                <h1>Form Builder Pro</h1>
                <p>Create & Manage Data Collection Forms</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn" id="loginBtn">Login</button>
                    <div class="auth-link">
                        <a onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                </form>
                
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Organization</label>
                        <input type="text" class="auth-input" id="signupOrg" value="ICF-SL" placeholder="Your organization">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Confirm Password</label>
                        <input type="password" class="auth-input" id="signupConfirm" required placeholder="Confirm password">
                    </div>
                    <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
                </form>
                
                <form class="auth-form" id="forgotForm">
                    <div class="auth-group">
                        <label class="auth-label">Email Address</label>
                        <input type="email" class="auth-input" id="forgotEmail" required placeholder="Enter your registered email">
                    </div>
                    <button type="submit" class="auth-btn" id="forgotBtn">Send Password</button>
                    <div class="auth-link">
                        <a onclick="showLogin()">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Builder -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span id="headerUser" style="font-size:11px;margin-right:10px;"></span>
            <button class="header-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è Preview</button>
            <button class="header-btn" onclick="shareForm()">üîó Share</button>
            <button class="header-btn success" onclick="generateForm()">‚¨áÔ∏è Generate</button>
            <button class="header-btn danger" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic</h3>
                <div class="field-type" data-type="text"><span class="field-type-icon">üìÑ</span>Text</div>
                <div class="field-type" data-type="number"><span class="field-type-icon">üî¢</span>Number</div>
                <div class="field-type" data-type="date"><span class="field-type-icon">üìÖ</span>Date</div>
                <div class="field-type" data-type="time"><span class="field-type-icon">üïê</span>Time</div>
                <div class="field-type" data-type="email"><span class="field-type-icon">üìß</span>Email</div>
                <div class="field-type" data-type="phone"><span class="field-type-icon">üì±</span>Phone</div>
                <div class="field-type" data-type="textarea"><span class="field-type-icon">üìù</span>Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection</h3>
                <div class="field-type" data-type="select"><span class="field-type-icon">üìã</span>Dropdown</div>
                <div class="field-type" data-type="radio"><span class="field-type-icon">üîò</span>Radio</div>
                <div class="field-type" data-type="checkbox"><span class="field-type-icon">‚òëÔ∏è</span>Checkbox</div>
                <div class="field-type" data-type="yesno"><span class="field-type-icon">‚úÖ</span>Yes/No</div>
                <div class="field-type" data-type="yesnona"><span class="field-type-icon">‚ùì</span>Yes/No/NA</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìä Tables</h3>
                <div class="field-type" data-type="table"><span class="field-type-icon">üìã</span>Static Table</div>
                <div class="field-type" data-type="dynamicTable"><span class="field-type-icon">‚ûï</span>Dynamic Table</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üîó Location</h3>
                <div class="field-type" data-type="cascading"><span class="field-type-icon">üè¢</span>Cascading</div>
                <div class="field-type" data-type="gps"><span class="field-type-icon">üìç</span>GPS</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special</h3>
                <div class="field-type" data-type="signature"><span class="field-type-icon">‚úçÔ∏è</span>Signature</div>
                <div class="field-type" data-type="rating"><span class="field-type-icon">‚≠ê</span>Rating</div>
                <div class="field-type" data-type="file"><span class="field-type-icon">üìé</span>File Upload</div>
                <div class="field-type" data-type="calculated"><span class="field-type-icon">üî¢</span>Calculated</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section"><span class="field-type-icon">üìÅ</span>Section/Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:11px;" id="fieldCount">0 fields | 1 page</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p id="previewSubtitle">Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:24px;margin-bottom:10px;">üì•</p>
                            <p>Click field types on the left to add them</p>
                            <p style="margin-top:5px;font-size:10px;color:#aaa;">Or drag and drop here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel">
            <h3 class="properties-title">‚öôÔ∏è Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:24px;margin-bottom:10px;">üëÜ</p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">¬© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL)</footer>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è Form Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="pages">Pages</div>
                    <div class="tab" data-tab="cascading">Cascading</div>
                    <div class="tab" data-tab="google">Google Sheets</div>
                </div>

                <div class="tab-content active" id="tab-general">
                    <div class="settings-grid">
                        <div class="settings-group">
                            <label class="settings-label">Form Title</label>
                            <input type="text" class="settings-input" id="settingsTitle">
                        </div>
                        <div class="settings-group">
                            <label class="settings-label">Subtitle</label>
                            <input type="text" class="settings-input" id="settingsSubtitle">
                        </div>
                        <div class="settings-group full-width">
                            <label class="settings-label">Organization</label>
                            <input type="text" class="settings-input" id="settingsOrg">
                        </div>
                        <div class="settings-group full-width">
                            <label class="settings-label">Logo URL</label>
                            <input type="text" class="settings-input" id="settingsLogo">
                        </div>
                        <div class="settings-group full-width">
                            <label class="toggle-switch">
                                <input type="checkbox" id="settingsMultiPage" checked>
                                <span class="toggle-slider"></span>
                                <span style="font-size:11px;">Enable Multi-Page Navigation</span>
                            </label>
                            <div class="settings-hint">Each section becomes a separate page</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-pages">
                    <div class="info-box">
                        <h4>üìÑ Multi-Page Forms</h4>
                        <p>Add "Section" fields to create page breaks. Each section becomes a separate page with navigation buttons.</p>
                    </div>
                    <div id="pagesList" style="margin-top:15px;"></div>
                </div>

                <div class="tab-content" id="tab-cascading">
                    <p style="font-size:11px;color:#666;margin-bottom:12px;">Upload Excel/CSV with location hierarchy</p>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div style="font-size:28px;margin-bottom:8px;">üìÅ</div>
                        <div id="fileUploadText" style="font-size:12px;">Click to upload Excel or CSV</div>
                        <input type="file" id="cascadingFile" accept=".xlsx,.xls,.csv" style="display:none;">
                    </div>
                    <button class="modal-btn secondary" onclick="downloadSampleFile()" style="margin-bottom:10px;">‚¨áÔ∏è Download Template</button>
                    <div class="info-box">
                        <h4>üìã Required Columns:</h4>
                        <p>Region | District | Chiefdom | Facility | UID</p>
                    </div>
                    <div class="settings-group" style="margin-top:12px;">
                        <label class="settings-label">Or Enter Manually</label>
                        <textarea class="property-textarea" id="cascadingData" style="height:100px;font-family:monospace;font-size:9px;"></textarea>
                    </div>
                </div>

                <div class="tab-content" id="tab-google">
                    <div class="settings-group">
                        <label class="settings-label">Apps Script Web App URL</label>
                        <input type="text" class="settings-input" id="settingsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <div class="settings-hint">For data submission and user authentication</div>
                    </div>
                    <div class="info-box" style="background:#fff3cd;border-color:#ffc107;">
                        <h4 style="color:#856404;">üìã Setup Instructions:</h4>
                        <ol style="margin-left:15px;font-size:10px;line-height:1.8;color:#856404;">
                            <li>Create a Google Sheet with sheets: "Users", "Forms", "Submissions"</li>
                            <li>Go to Extensions ‚Üí Apps Script</li>
                            <li>Paste the generated Apps Script code</li>
                            <li>Deploy as Web App (Anyone can access)</li>
                            <li>Copy the URL here</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Generate Modal -->
    <div class="modal-overlay" id="generateModal">
        <div class="modal" style="max-width:850px;">
            <div class="modal-header">
                <h3>üì• Generated Form</h3>
                <button class="modal-close" onclick="closeModal('generateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="html-code">HTML Form</div>
                    <div class="tab" data-tab="apps-script">Apps Script</div>
                </div>
                
                <div class="tab-content active" id="tab-html-code">
                    <div style="margin-bottom:10px;">
                        <button class="modal-btn primary" onclick="downloadHTML()">‚¨áÔ∏è Download HTML</button>
                        <button class="modal-btn secondary" onclick="copyCode('htmlCode')" style="margin-left:5px;">üìã Copy</button>
                    </div>
                    <div class="code-preview" id="htmlCode"></div>
                </div>
                
                <div class="tab-content" id="tab-apps-script">
                    <div style="margin-bottom:10px;">
                        <button class="modal-btn primary" onclick="downloadScript()">‚¨áÔ∏è Download .gs</button>
                        <button class="modal-btn secondary" onclick="copyCode('scriptCode')" style="margin-left:5px;">üìã Copy</button>
                    </div>
                    <div class="code-preview" id="scriptCode"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('generateModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>üëÅÔ∏è Form Preview</h3>
                <button class="modal-close" onclick="closeModal('previewModal')">&times;</button>
            </div>
            <div class="modal-body" id="previewBody" style="padding:0;"></div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('previewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üì§ Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:18px;font-weight:700;color:#004080;" id="shareFormTitle">Form Title</div>
                    <div style="font-size:11px;color:#666;">Share this form with anyone</div>
                </div>
                <div class="qr-container">
                    <div class="qr-box" id="qrBox">
                        <div id="qrCode"></div>
                    </div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;">üì± Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()">üìã Copy URL</button>
                        <button class="modal-btn success" onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Table Config Modal -->
    <div class="modal-overlay" id="tableConfigModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>üìä Configure Table Columns</h3>
                <button class="modal-close" onclick="closeModal('tableConfigModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="tableColumnsConfig"></div>
                <button class="modal-btn success" onclick="addTableColumn()" style="margin-top:10px;">‚ûï Add Column</button>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('tableConfigModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveTableConfig()">Save</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            editingTableFieldId: null,
            settings: {
                title: 'My Data Collection Form',
                subtitle: 'Data Collection System',
                organization: 'ICF-SL',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                scriptUrl: '',
                multiPage: true,
                cascadingData: 'Eastern Region||Kailahun District\nKailahun District||Luawa Chiefdom\nLuawa Chiefdom||Kailahun Hospital||abc123'
            }
        };

        const fieldDefs = {
            text: { label: 'Text', icon: 'üìÑ', defaultLabel: 'Text Field' },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field' },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field' },
            time: { label: 'Time', icon: 'üïê', defaultLabel: 'Time Field' },
            email: { label: 'Email', icon: 'üìß', defaultLabel: 'Email Address' },
            phone: { label: 'Phone', icon: 'üì±', defaultLabel: 'Phone Number' },
            textarea: { label: 'Long Text', icon: 'üìù', defaultLabel: 'Long Text' },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Choice', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkbox', options: ['Option 1', 'Option 2', 'Option 3'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question' },
            yesnona: { label: 'Yes/No/NA', icon: '‚ùì', defaultLabel: 'Yes/No/NA' },
            table: { label: 'Table', icon: 'üìã', defaultLabel: 'Data Table', columns: [{ name: 'Column 1', type: 'text' }, { name: 'Column 2', type: 'text' }], rows: 3 },
            dynamicTable: { label: 'Dynamic Table', icon: '‚ûï', defaultLabel: 'Dynamic Table', columns: [{ name: 'Item', type: 'text' }, { name: 'Quantity', type: 'number' }] },
            cascading: { label: 'Cascading', icon: 'üè¢', defaultLabel: 'Location', levels: ['Region', 'District', 'Chiefdom', 'Facility'] },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location' },
            signature: { label: 'Signature', icon: '‚úçÔ∏è', defaultLabel: 'Signature' },
            rating: { label: 'Rating', icon: '‚≠ê', defaultLabel: 'Rating', max: 5 },
            file: { label: 'File', icon: 'üìé', defaultLabel: 'File Upload', accept: '.pdf,.jpg,.png' },
            calculated: { label: 'Calculated', icon: 'üî¢', defaultLabel: 'Calculated Field', formula: '' },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section' }
        };

        const validationRules = {
            text: ['required', 'minLength', 'maxLength', 'pattern', 'noSpaces'],
            number: ['required', 'min', 'max', 'integer', 'positive'],
            email: ['required'],
            phone: ['required', 'pattern'],
            date: ['required', 'minDate', 'maxDate', 'notFuture', 'notPast'],
            time: ['required'],
            textarea: ['required', 'minLength', 'maxLength'],
            select: ['required'],
            radio: ['required'],
            checkbox: ['required', 'minSelect', 'maxSelect'],
            yesno: ['required'],
            yesnona: ['required']
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('c');
            
            // Check for compressed form data - direct approach like working version
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    renderSharedForm(data);
                    return;
                } catch (err) {
                    console.error('Error decoding shared form:', err);
                }
            }
            
            loadFromStorage();
            setupEventListeners();
            checkAuth();
        }
        
        function renderSharedForm(data) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            
            const formSettings = {
                title: data.t || 'Form',
                subtitle: data.s || 'Data Collection',
                organization: data.o || 'ICF-SL',
                logo: data.l || 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg',
                multiPage: data.m !== false,
                cascadingData: data.c || '',
                scriptUrl: data.u || ''
            };
            
            const formFields = (data.f || []).map(f => ({
                id: f.i,
                type: f.y,
                label: f.l,
                name: f.n,
                required: f.r,
                options: f.o || [],
                levels: f.v || [],
                columns: f.c || [],
                rows: f.w || 3,
                max: f.x || 5,
                accept: f.a || '',
                formula: f.m || '',
                skipLogic: f.k || { enabled: false },
                validation: f.d || { enabled: false }
            }));
            
            state.settings = formSettings;
            state.fields = formFields;
            
            const html = generateHTMLCode();
            
            const viewerContainer = document.createElement('div');
            viewerContainer.id = 'formViewer';
            viewerContainer.innerHTML = html;
            document.body.innerHTML = '';
            document.body.appendChild(viewerContainer);
            
            const scripts = viewerContainer.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
            });
        }

        function setupEventListeners() {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab));
            });

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('forgotForm').addEventListener('submit', handleForgotPassword);

            document.querySelectorAll('.field-type').forEach(el => {
                el.addEventListener('click', () => addField(el.dataset.type));
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('fieldType', el.dataset.type);
                    el.style.opacity = '0.5';
                });
                el.addEventListener('dragend', () => el.style.opacity = '1');
            });

            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const type = e.dataTransfer.getData('fieldType');
                if (type) addField(type);
            });

            const titleInput = document.getElementById('formTitle');
            titleInput.value = state.settings.title;
            titleInput.addEventListener('input', () => {
                state.settings.title = titleInput.value;
                document.getElementById('previewTitle').textContent = titleInput.value;
                saveToStorage();
            });

            setupTabs();

            document.getElementById('fileUploadArea').addEventListener('click', () => document.getElementById('cascadingFile').click());
            document.getElementById('cascadingFile').addEventListener('change', handleFileUpload);

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        function setupTabs() {
            document.querySelectorAll('.tabs').forEach(tabContainer => {
                tabContainer.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const parent = this.closest('.modal-body') || document;
                        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById('tab-' + this.dataset.tab)?.classList.add('active');
                    });
                });
            });
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) {
                state.user = JSON.parse(saved);
                showBuilder();
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
            hideAuthMessages();
        }

        function showForgotPassword() {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('forgotForm').classList.add('active');
            hideAuthMessages();
        }

        function showLogin() { switchAuthTab('login'); }

        function hideAuthMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function showAuthSuccess(msg) {
            const el = document.getElementById('authSuccess');
            el.textContent = msg;
            el.style.display = 'block';
        }

        async function handleLogin(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            
            if (state.settings.scriptUrl) {
                try {
                    const response = await fetch(`${state.settings.scriptUrl}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        state.user = result.user;
                        localStorage.setItem('formBuilderUser', JSON.stringify(result.user));
                        showBuilder();
                    } else {
                        showAuthError(result.message || 'Invalid credentials');
                    }
                } catch (err) {
                    loginLocal(email, password);
                }
            } else {
                loginLocal(email, password);
            }
            
            btn.disabled = false;
            btn.textContent = 'Login';
        }

        function loginLocal(email, password) {
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                state.user = user;
                localStorage.setItem('formBuilderUser', JSON.stringify(user));
                showBuilder();
            } else {
                showAuthError('Invalid email or password');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            hideAuthMessages();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const org = document.getElementById('signupOrg').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const btn = document.getElementById('signupBtn');
            
            if (password !== confirm) { showAuthError('Passwords do not match'); return; }
            if (password.length < 6) { showAuthError('Password must be at least 6 characters'); return; }
            
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            signupLocal(name, email, org, password);
            
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }

        function signupLocal(name, email, org, password) {
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) { showAuthError('Email already registered'); return; }
            const newUser = { id: Date.now().toString(), name, email, org, password, createdAt: new Date().toISOString() };
            users.push(newUser);
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            showAuthSuccess('Account created! Please login.');
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            hideAuthMessages();
            const email = document.getElementById('forgotEmail').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email);
            if (user) {
                showAuthSuccess(`Password reminder: ${user.password.substring(0, 2)}${'*'.repeat(user.password.length - 2)}`);
            } else {
                showAuthError('Email not found');
            }
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = `üë§ ${state.user?.name || 'User'}`;
            renderFields();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('formBuilderUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ============================================
        // FIELD MANAGEMENT
        // ============================================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;

            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                levels: def.levels ? [...def.levels] : [],
                columns: def.columns ? JSON.parse(JSON.stringify(def.columns)) : [],
                rows: def.rows || 3,
                max: def.max || 5,
                accept: def.accept || '',
                formula: def.formula || '',
                validation: { enabled: false, rules: {} },
                skipLogic: { enabled: false, action: 'show', sourceField: '', condition: 'equals', sourceValue: '' }
            };

            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
            notify('Field added!');
        }

        function removeField(id) {
            event?.stopPropagation();
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) {
                state.selectedFieldId = null;
                renderProperties();
            }
            renderFields();
            saveToStorage();
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) {
                if (prop.includes('.')) {
                    const [parent, child] = prop.split('.');
                    if (!field[parent]) field[parent] = {};
                    field[parent][child] = value;
                } else {
                    field[prop] = value;
                }
                renderFields();
                saveToStorage();
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const sectionCount = state.fields.filter(f => f.type === 'section').length;
            const pageCount = sectionCount + 1;
            
            document.getElementById('fieldCount').textContent = `${state.fields.length} fields | ${pageCount} page${pageCount > 1 ? 's' : ''}`;
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:24px;margin-bottom:10px;">üì•</p><p>Click field types on the left to add them</p>';
                return;
            }
            
            dropZone.classList.add('has-fields');
            let currentPage = 1;
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') { currentPage++; return renderSectionHTML(f, currentPage); }
                return renderFieldHTML(f);
            }).join('');
            
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id);
                });
            });
        }

        function renderSectionHTML(field, pageNum) {
            const selected = field.id === state.selectedFieldId;
            return `<div class="section-divider ${selected ? 'selected' : ''}" data-id="${field.id}">
                <span>üìÅ ${field.label.toUpperCase()}</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="page-badge">Page ${pageNum}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn" onclick="moveField('${field.id}','up')" style="background:rgba(255,255,255,0.2);color:white;">‚¨Ü</button>
                        <button class="field-action-btn" onclick="moveField('${field.id}','down')" style="background:rgba(255,255,255,0.2);color:white;">‚¨á</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')" style="background:rgba(255,255,255,0.2);color:white;">üóë</button>
                    </div>
                </div>
            </div>`;
        }

        function renderFieldHTML(field) {
            const def = fieldDefs[field.type];
            const selected = field.id === state.selectedFieldId;
            let badges = '';
            if (field.required) badges += '<span class="field-badge required">Required</span>';
            if (field.skipLogic?.enabled) badges += '<span class="field-badge skip">Skip Logic</span>';
            if (field.validation?.enabled) badges += '<span class="field-badge validation">Validation</span>';
            
            return `<div class="form-field ${selected ? 'selected' : ''}" data-id="${field.id}">
                <div class="form-field-header">
                    <span class="form-field-label">${def?.icon || ''} ${field.label}</span>
                    <div class="form-field-actions">
                        <button class="field-action-btn" onclick="moveField('${field.id}','up')">‚¨Ü</button>
                        <button class="field-action-btn" onclick="moveField('${field.id}','down')">‚¨á</button>
                        <button class="field-action-btn delete" onclick="removeField('${field.id}')">üóë</button>
                    </div>
                </div>
                <div class="form-field-preview">${renderFieldPreview(field)}</div>
                <div class="form-field-meta">${field.name} ${badges}</div>
            </div>`;
        }

        function renderFieldPreview(field) {
            const inputStyle = 'width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:10px;';
            switch (field.type) {
                case 'text': case 'email': case 'phone': return `<input type="text" style="${inputStyle}" placeholder="${field.label}" disabled>`;
                case 'number': return `<input type="number" style="${inputStyle}" placeholder="0" disabled>`;
                case 'date': return `<input type="date" style="${inputStyle}" disabled>`;
                case 'time': return `<input type="time" style="${inputStyle}" disabled>`;
                case 'textarea': return `<textarea style="${inputStyle}height:40px;" disabled></textarea>`;
                case 'select': return `<select style="${inputStyle}" disabled><option>-- Select --</option></select>`;
                case 'radio': case 'yesno': case 'yesnona':
                    const opts = field.type === 'yesno' ? ['Yes', 'No'] : field.type === 'yesnona' ? ['Yes', 'No', 'N/A'] : field.options;
                    return opts.slice(0, 3).map(o => `<label style="margin-right:8px;font-size:9px;"><input type="radio" disabled> ${o}</label>`).join('');
                case 'checkbox': return field.options.slice(0, 3).map(o => `<label style="display:inline;margin-right:8px;font-size:9px;"><input type="checkbox" disabled> ${o}</label>`).join('');
                case 'gps': return `<button style="padding:5px 10px;background:#004080;color:white;border:none;border-radius:3px;font-size:9px;" disabled>üìç Capture GPS</button>`;
                case 'signature': return `<div style="border:2px dashed #ddd;height:40px;display:flex;align-items:center;justify-content:center;color:#999;font-size:9px;">‚úçÔ∏è Signature Pad</div>`;
                case 'rating': return '‚≠ê'.repeat(field.max || 5);
                case 'file': return `<input type="file" style="${inputStyle}" disabled>`;
                case 'calculated': return `<div style="background:#e9ecef;padding:5px;border-radius:3px;font-size:9px;">üî¢ = ${field.formula || 'formula'}</div>`;
                default: return '';
            }
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:24px;margin-bottom:10px;">üëÜ</p><p>Select a field to edit</p></div>';
                return;
            }
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `<div class="property-group"><label class="property-label">Label</label><input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}"></div>
                <div class="property-group"><label class="property-label">Field Name</label><input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}"></div>`;
            
            if (field.type !== 'section') {
                html += `<div class="property-group"><label class="property-checkbox"><input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}><span>Required Field</span></label></div>`;
            }
            
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `<div class="property-group"><label class="property-label">Options (one per line)</label><textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea></div>`;
            }
            
            container.innerHTML = html;
            attachPropertyListeners(field);
        }

        function attachPropertyListeners(field) {
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
        }

        // ============================================
        // SETTINGS
        // ============================================
        function openSettings() {
            document.getElementById('settingsTitle').value = state.settings.title;
            document.getElementById('settingsSubtitle').value = state.settings.subtitle;
            document.getElementById('settingsOrg').value = state.settings.organization;
            document.getElementById('settingsLogo').value = state.settings.logo;
            document.getElementById('settingsMultiPage').checked = state.settings.multiPage;
            document.getElementById('settingsScriptUrl').value = state.settings.scriptUrl;
            document.getElementById('cascadingData').value = state.settings.cascadingData;
            document.getElementById('settingsModal').classList.add('show');
        }

        function saveSettings() {
            state.settings.title = document.getElementById('settingsTitle').value;
            state.settings.subtitle = document.getElementById('settingsSubtitle').value;
            state.settings.organization = document.getElementById('settingsOrg').value;
            state.settings.logo = document.getElementById('settingsLogo').value;
            state.settings.multiPage = document.getElementById('settingsMultiPage').checked;
            state.settings.scriptUrl = document.getElementById('settingsScriptUrl').value;
            state.settings.cascadingData = document.getElementById('cascadingData').value;
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            document.getElementById('previewSubtitle').textContent = state.settings.subtitle;
            
            saveToStorage();
            closeModal('settingsModal');
            notify('Settings saved!');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    const lines = [];
                    json.forEach(row => {
                        const reg = row.Region || row.region || '';
                        const dis = row.District || row.district || '';
                        const chi = row.Chiefdom || row.chiefdom || '';
                        const fac = row.Facility || row.facility || '';
                        const uid = row.UID || row.uid || '';
                        if (reg && dis) lines.push(`${reg}||${dis}`);
                        if (dis && chi) lines.push(`${dis}||${chi}`);
                        if (chi && fac) lines.push(uid ? `${chi}||${fac}||${uid}` : `${chi}||${fac}`);
                    });
                    document.getElementById('cascadingData').value = [...new Set(lines)].join('\n');
                    document.getElementById('fileUploadArea').classList.add('has-file');
                    document.getElementById('fileUploadText').textContent = `‚úÖ Loaded ${json.length} rows`;
                    notify('File loaded successfully!');
                } catch (err) { notify('Error reading file: ' + err.message, 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadSampleFile() {
            const data = [
                { Region: 'Eastern Region', District: 'Kailahun District', Chiefdom: 'Luawa Chiefdom', Facility: 'Kailahun Hospital', UID: 'abc123' },
                { Region: 'Southern Region', District: 'Bo District', Chiefdom: 'Badjia Chiefdom', Facility: 'Ngelehun CHC', UID: 'def456' }
            ];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Locations');
            XLSX.writeFile(wb, 'cascading-template.xlsx');
            notify('Template downloaded!');
        }

        // ============================================
        // PREVIEW
        // ============================================
        function previewForm() {
            if (state.fields.length === 0) { notify('Add some fields first!', 'error'); return; }
            const html = generateHTMLCode();
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '<iframe class="preview-frame"></iframe>';
            const iframe = previewBody.querySelector('iframe');
            const doc = iframe.contentDocument;
            doc.open();
            doc.write(html);
            doc.close();
            document.getElementById('previewModal').classList.add('show');
        }

        // ============================================
        // GENERATE FORM
        // ============================================
        function generateForm() {
            if (state.fields.length === 0) { notify('Add some fields first!', 'error'); return; }
            const htmlCode = generateHTMLCode();
            const scriptCode = generateAppsScriptCode();
            document.getElementById('htmlCode').textContent = htmlCode;
            document.getElementById('scriptCode').textContent = scriptCode;
            document.getElementById('generateModal').classList.add('show');
        }

        function generateHTMLCode() {
            const s = state.settings;
            const fields = state.fields;
            
            let fieldsHTML = '';
            fields.forEach(f => {
                if (f.type === 'section') {
                    fieldsHTML += `<div class="section-header">${f.label.toUpperCase()}</div>`;
                } else {
                    fieldsHTML += generateFieldHTML(f);
                }
            });
            
            fieldsHTML += `<button type="submit" class="btn-submit">SUBMIT</button>`;
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${s.title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Oswald',sans-serif;background:#f5f5f5;padding:20px}
        .container{max-width:650px;margin:0 auto}
        .header{background:#004080;color:#fff;padding:20px;text-align:center;border-radius:12px 12px 0 0}
        .header img{width:70px;border-radius:8px;margin-bottom:10px}
        .header h1{font-size:18px;margin-bottom:3px}
        .header p{font-size:11px;opacity:0.9}
        .form-card{border:4px double #004080;border-radius:12px;background:#fff}
        .form-body{padding:20px}
        .form-group{margin-bottom:16px}
        .form-label{display:block;font-size:11px;font-weight:700;margin-bottom:5px;text-transform:uppercase}
        .required{color:red}
        .form-input,.form-select,.form-textarea{width:100%;padding:10px;border:2px solid #004080;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(0,64,128,0.2)}
        .radio-group{display:flex;flex-wrap:wrap;gap:10px}
        .radio-option{display:flex;align-items:center;gap:5px;padding:8px 12px;border:2px solid #ddd;border-radius:6px;cursor:pointer;font-size:11px}
        .radio-option:hover{border-color:#004080}
        .section-header{background:#004080;color:#fff;padding:12px 15px;margin:20px -20px;font-size:13px;font-weight:700}
        .btn-submit{width:100%;padding:14px;background:#28a745;color:#fff;border:none;border-radius:6px;font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;cursor:pointer;text-transform:uppercase}
        .btn-submit:hover{background:#218838}
        .footer{text-align:center;padding:15px;font-size:10px;color:#666;margin-top:15px}
        .notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:#fff;font-weight:700;font-size:12px;z-index:1000;display:none}
        .notification.show{display:block}
        .notification.success{background:#28a745}
        .notification.error{background:#dc3545}
    </style>
</head>
<body>
    <div class="container">
        <div class="form-card">
            <div class="header">
                <img src="${s.logo}" alt="Logo">
                <h1>${s.title}</h1>
                <p>${s.subtitle}</p>
            </div>
            <div class="form-body">
                <form id="dataForm">
${fieldsHTML}
                </form>
            </div>
        </div>
        <div class="footer">¬© 2025 ${s.organization}</div>
    </div>
    <div class="notification" id="notification"></div>
    <script>
        document.getElementById('dataForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {};
            new FormData(this).forEach((v, k) => data[k] = v);
            data._timestamp = new Date().toISOString();
            console.log('Form data:', data);
            showNotification('Submitted successfully!', 'success');
            this.reset();
        });
        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = 'notification show ' + type;
            setTimeout(() => n.classList.remove('show'), 3000);
        }
    <\/script>
</body>
</html>`;
        }

        function generateFieldHTML(field) {
            const req = field.required ? '<span class="required">*</span>' : '';
            const reqAttr = field.required ? 'required' : '';
            let inner = '';
            switch (field.type) {
                case 'text': inner = `<input type="text" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'email': inner = `<input type="email" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'phone': inner = `<input type="tel" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'number': inner = `<input type="number" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'date': inner = `<input type="date" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'time': inner = `<input type="time" class="form-input" name="${field.name}" ${reqAttr}>`; break;
                case 'textarea': inner = `<textarea class="form-textarea" name="${field.name}" rows="3" ${reqAttr}></textarea>`; break;
                case 'select': inner = `<select class="form-select" name="${field.name}" ${reqAttr}><option value="">-- Select --</option>${(field.options || []).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`; break;
                case 'radio': inner = `<div class="radio-group">${(field.options || []).map(o => `<label class="radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                case 'yesno': inner = `<div class="radio-group"><label class="radio-option"><input type="radio" name="${field.name}" value="Yes" ${reqAttr}><span>Yes</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="No" ${reqAttr}><span>No</span></label></div>`; break;
                case 'yesnona': inner = `<div class="radio-group"><label class="radio-option"><input type="radio" name="${field.name}" value="Yes" ${reqAttr}><span>Yes</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="No" ${reqAttr}><span>No</span></label><label class="radio-option"><input type="radio" name="${field.name}" value="N/A" ${reqAttr}><span>N/A</span></label></div>`; break;
                case 'checkbox': inner = `<div class="radio-group">${(field.options || []).map(o => `<label class="radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`; break;
                default: return '';
            }
            return `                        <div class="form-group"><label class="form-label">${escapeHtml(field.label)} ${req}</label>${inner}</div>\n`;
        }

        function generateAppsScriptCode() {
            return `// Apps Script for ${state.settings.title}
function doPost(e) {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    sheet.appendRow(Object.values(data));
    return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
}`;
        }

        // ============================================
        // SHARE - FIXED QR CODE GENERATION
        // ============================================
        let currentShareUrl = '';
        let qrCodeInstance = null;

        function shareForm() {
            if (state.fields.length === 0) { notify('Add some fields first!', 'error'); return; }
            
            document.getElementById('shareFormTitle').textContent = state.settings.title;
            
            const formData = {
                id: 'form_' + Date.now(),
                t: state.settings.title,
                s: state.settings.subtitle,
                o: state.settings.organization,
                l: state.settings.logo,
                m: state.settings.multiPage,
                c: state.settings.cascadingData,
                u: state.settings.scriptUrl,
                f: state.fields.map(f => ({
                    i: f.id, y: f.type, l: f.label, n: f.name, r: f.required,
                    o: f.options, v: f.levels, c: f.columns, w: f.rows,
                    x: f.max, a: f.accept, m: f.formula, k: f.skipLogic, d: f.validation
                }))
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                
                let baseUrl;
                if (window.location.protocol === 'file:') {
                    const filename = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.html';
                    baseUrl = 'https://yourdomain.com/' + filename;
                } else {
                    baseUrl = window.location.origin + window.location.pathname;
                }
                
                currentShareUrl = baseUrl + '?c=' + encodeURIComponent(encoded);
                document.getElementById('shareUrl').textContent = currentShareUrl;
                
                // Clear previous QR code
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                
                // Generate QR code using QRCode.js library
                qrCodeInstance = new QRCode(qrContainer, {
                    text: currentShareUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#004080',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                document.getElementById('shareModal').classList.add('show');
            } catch (err) {
                console.error('Share error:', err);
                notify('Error creating share link', 'error');
            }
        }

        function copyShareUrl() {
            navigator.clipboard.writeText(currentShareUrl).then(() => notify('URL copied!'));
        }

        function downloadQR() {
            const qrContainer = document.getElementById('qrCode');
            let canvas = qrContainer.querySelector('canvas');
            const img = qrContainer.querySelector('img');
            
            if (!canvas && !img) { notify('No QR code to download', 'error'); return; }
            
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            const padding = 30;
            const titleHeight = 50;
            const qrSize = 200;
            
            newCanvas.width = qrSize + padding * 2;
            newCanvas.height = qrSize + padding * 2 + titleHeight;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            
            ctx.fillStyle = '#004080';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(state.settings.title, newCanvas.width / 2, 28);
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Scan to open form', newCanvas.width / 2, 45);
            
            if (canvas) {
                ctx.drawImage(canvas, padding, titleHeight + 10, qrSize, qrSize);
                downloadImage();
            } else if (img) {
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.onload = function() {
                    ctx.drawImage(tempImg, padding, titleHeight + 10, qrSize, qrSize);
                    downloadImage();
                };
                tempImg.src = img.src;
            }
            
            function downloadImage() {
                const link = document.createElement('a');
                link.download = state.settings.title.replace(/[^a-z0-9]/gi, '-') + '-QR.png';
                link.href = newCanvas.toDataURL('image/png');
                link.click();
                notify('QR Code downloaded!');
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function downloadHTML() {
            const code = document.getElementById('htmlCode').textContent;
            const blob = new Blob([code], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = state.settings.title.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.html';
            a.click();
            notify('HTML downloaded!');
        }

        function downloadScript() {
            const code = document.getElementById('scriptCode').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'apps-script.gs';
            a.click();
            notify('Script downloaded!');
        }

        function copyCode(id) {
            const code = document.getElementById(id).textContent;
            navigator.clipboard.writeText(code);
            notify('Copied to clipboard!');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : '');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function saveToStorage() {
            localStorage.setItem('formBuilderPro', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderPro');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                } catch (e) { console.error('Error loading state:', e); }
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
