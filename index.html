<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder Pro - ICF-SL | Auto DHIS2 Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; }
        .header h1 { font-size: 20px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        .header-btn.dhis2 { background: #17a2b8; color: white; }
        
        .main-container { display: none; margin-top: 70px; height: calc(100vh - 100px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        .form-field { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 6px; }
        .field-action-btn:hover { background: #004080; color: white; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; margin-left: 8px; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; }
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 600px; width: 100%; border: 4px double #004080; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-btn { padding: 12px 24px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; border: none; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; }
        .modal-btn.danger { background: #dc3545; color: white; }
        .modal-btn.dhis2 { background: #17a2b8; color: white; }
        
        .dhis2-config-section { background: #e8f4fc; border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .dhis2-config-title { font-size: 13px; font-weight: 700; color: #17a2b8; margin-bottom: 12px; }
        .dhis2-input { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; margin-bottom: 10px; }
        .dhis2-input:focus { outline: none; border-color: #17a2b8; }
        .dhis2-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .dhis2-status { padding: 12px 15px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .dhis2-status.connected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .dhis2-status.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .dhis2-status.syncing { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        
        .sync-log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 250px; overflow-y: auto; margin-top: 15px; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        .log-entry.warning { color: #ffd43b; }
        .log-entry.info { color: #74c0fc; }
        
        .qr-container { text-align: center; padding: 20px; }
        .qr-box { display: inline-block; padding: 25px; background: white; border: 4px solid #004080; border-radius: 12px; }
        #qrCode { min-width: 200px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; max-width: 350px; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        
        .viewer-container { display: none; min-height: 100vh; background: #e9ecef; }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 100; }
        .viewer-back-btn { background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; margin-right: 10px; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-radio-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .viewer-radio-option:hover { border-color: #004080; }
        
        .page-header { background: #e8f4fc; margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; }
        .next-btn { background: #004080; color: white; }
        .submit-btn { background: #28a745; color: white; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; font-size: 10px; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        
        .sync-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .sync-badge.synced { background: #d4edda; color: #155724; }
        .sync-badge.pending { background: #fff3cd; color: #856404; }
        .sync-badge.failed { background: #f8d7da; color: #721c24; }
        
        .dhis2-info-bar { background: #17a2b8; color: white; padding: 8px 15px; font-size: 11px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .dhis2-info-item { display: flex; align-items: center; gap: 5px; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .form-title-input { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>Form Builder Pro</h1>
                <p>Auto DHIS2 Sync</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn">üîì Login</button>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <button type="submit" class="auth-btn">üìù Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1>üìã Form Builder Pro</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser">üë§ User</span>
            <button class="header-btn" onclick="showHome()">üè† Home</button>
            <button class="header-btn success" onclick="newForm()">üìÑ New</button>
            <button class="header-btn" onclick="saveCurrentForm()">üíæ Save</button>
            <button class="header-btn" onclick="previewForm()">üëÅÔ∏è Preview</button>
            <button class="header-btn dhis2" onclick="openDhis2Config()">üîó DHIS2</button>
            <button class="header-btn primary" onclick="shareForm()">üì§ Share</button>
            <button class="header-btn danger" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìù Basic Fields</h3>
                <div class="field-type" data-type="text">üìÑ Text Input</div>
                <div class="field-type" data-type="number">üî¢ Number</div>
                <div class="field-type" data-type="date">üìÖ Date</div>
                <div class="field-type" data-type="time">üïê Time</div>
                <div class="field-type" data-type="email">üìß Email</div>
                <div class="field-type" data-type="phone">üì± Phone</div>
                <div class="field-type" data-type="textarea">üìù Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">‚òëÔ∏è Selection Fields</h3>
                <div class="field-type" data-type="select">üìã Dropdown</div>
                <div class="field-type" data-type="radio">üîò Radio Buttons</div>
                <div class="field-type" data-type="checkbox">‚òëÔ∏è Checkboxes</div>
                <div class="field-type" data-type="yesno">‚úÖ Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üéØ Special Fields</h3>
                <div class="field-type" data-type="gps">üìç GPS Location</div>
                <div class="field-type" data-type="rating">‚≠ê Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìë Structure</h3>
                <div class="field-type" data-type="section">üìÅ Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title (becomes Dataset name)...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount">üìä 0 fields</span>
            </div>
            <div id="dhis2InfoBar" class="dhis2-info-bar" style="display:none;">
                <div class="dhis2-info-item">üîó <span id="dhis2ServerName">Not connected</span></div>
                <div class="dhis2-info-item">üìä Dataset: <span id="dhis2DatasetName">-</span></div>
                <div class="dhis2-info-item">üè• Org Units: <span id="dhis2OrgUnitCount">0</span></div>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p>Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:36px;margin-bottom:12px;">üì•</p>
                            <p style="font-weight:600;">Click field types to add them</p>
                            <p style="font-size:11px;color:#868e96;margin-top:10px;">Fields become DHIS2 Data Elements</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title">‚öôÔ∏è Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;">üëÜ</p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    
    <!-- Footer -->
    <footer class="footer">¬© 2025 ICF-SL | Form Builder Pro with Auto DHIS2 Sync</footer>

    <!-- DHIS2 Configuration Modal -->
    <div class="modal-overlay" id="dhis2Modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üîó DHIS2 Configuration</h3>
                <button class="modal-close" onclick="closeModal('dhis2Modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dhis2Status" class="dhis2-status disconnected">
                    <span>üî¥</span> <span>Not Connected</span>
                </div>
                
                <div class="dhis2-config-section" autocomplete="off">
                    <div class="dhis2-config-title">üåê Server Connection</div>
                    <label class="dhis2-label">DHIS2 Server URL</label>
                    <input type="url" class="dhis2-input" id="dhis2Url" placeholder="https://your-dhis2-instance.org" autocomplete="off">
                    
                    <label class="dhis2-label">Username</label>
                    <input type="text" class="dhis2-input" id="dhis2Username" placeholder="Enter username" autocomplete="off">
                    
                    <label class="dhis2-label">Password</label>
                    <input type="password" class="dhis2-input" id="dhis2Password" placeholder="Enter password" autocomplete="new-password">
                    
                    <label class="dhis2-label">Org Unit Level for Data Entry</label>
                    <select class="dhis2-input" id="dhis2OrgLevel">
                        <option value="1">Level 1 (National)</option>
                        <option value="2">Level 2 (Region)</option>
                        <option value="3">Level 3 (District)</option>
                        <option value="4">Level 4 (Chiefdom)</option>
                        <option value="5" selected>Level 5 (Facility)</option>
                        <option value="6">Level 6</option>
                    </select>
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="modal-btn dhis2" onclick="testConnection()">üß™ Test Connection</button>
                    <button class="modal-btn primary" onclick="saveConfig()">üíæ Save Config</button>
                </div>
                
                <div class="dhis2-config-section">
                    <div class="dhis2-config-title">üöÄ Auto Setup & Sync</div>
                    <p style="font-size:11px;color:#666;margin-bottom:15px;">
                        This will automatically:<br>
                        ‚úì Create Dataset using Form Name<br>
                        ‚úì Create Data Elements from Form Fields<br>
                        ‚úì Assign ALL org units to the Dataset<br>
                        ‚úì Sync collected data to DHIS2
                    </p>
                    <button class="modal-btn success" onclick="autoSetupAndSync()" style="width:100%;">
                        üöÄ Auto Setup & Sync to DHIS2
                    </button>
                </div>
                
                <div class="sync-log" id="syncLog">
                    <div class="log-entry info">Ready for setup...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header" style="background:linear-gradient(135deg,#004080,#002855);">
                <h3>üîó Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div class="qr-box"><div id="qrCode"></div></div>
                    <div style="margin-top:15px;font-weight:700;color:#004080;">üì± Scan to open form</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()">üìã Copy URL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ==================== CORS PROXIES ====================
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/'
        ];
        let currentProxyIndex = 0;

        // ==================== GLOBAL STATE ====================
        const state = {
            user: null,
            fields: [],
            selectedFieldId: null,
            fieldCounter: 0,
            isSharedMode: false,
            settings: {
                title: 'My Data Collection Form',
                logo: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg'
            },
            dhis2: {
                url: '',
                username: '',
                password: '',
                orgUnitLevel: 5,
                connected: false,
                serverInfo: null,
                datasetId: null,
                datasetName: '',
                dataElements: {},
                orgUnits: []
            },
            collectedData: []
        };

        const fieldDefs = {
            text: { label: 'Text', icon: 'üìÑ', defaultLabel: 'Text Field', valueType: 'TEXT' },
            number: { label: 'Number', icon: 'üî¢', defaultLabel: 'Number Field', valueType: 'NUMBER' },
            date: { label: 'Date', icon: 'üìÖ', defaultLabel: 'Date Field', valueType: 'DATE' },
            time: { label: 'Time', icon: 'üïê', defaultLabel: 'Time Field', valueType: 'TIME' },
            email: { label: 'Email', icon: 'üìß', defaultLabel: 'Email Address', valueType: 'TEXT' },
            phone: { label: 'Phone', icon: 'üì±', defaultLabel: 'Phone Number', valueType: 'PHONE_NUMBER' },
            textarea: { label: 'Long Text', icon: 'üìù', defaultLabel: 'Long Text', valueType: 'LONG_TEXT' },
            select: { label: 'Dropdown', icon: 'üìã', defaultLabel: 'Dropdown', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            radio: { label: 'Radio', icon: 'üîò', defaultLabel: 'Radio Choice', valueType: 'TEXT', options: ['Option 1', 'Option 2', 'Option 3'] },
            checkbox: { label: 'Checkbox', icon: '‚òëÔ∏è', defaultLabel: 'Checkbox', valueType: 'TRUE_ONLY', options: ['Option 1', 'Option 2'] },
            yesno: { label: 'Yes/No', icon: '‚úÖ', defaultLabel: 'Yes/No Question', valueType: 'BOOLEAN' },
            gps: { label: 'GPS', icon: 'üìç', defaultLabel: 'GPS Location', valueType: 'COORDINATE' },
            rating: { label: 'Rating', icon: '‚≠ê', defaultLabel: 'Rating', valueType: 'INTEGER', max: 5 },
            section: { label: 'Section', icon: 'üìÅ', defaultLabel: 'New Section', valueType: null }
        };

        // ==================== INITIALIZATION ====================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    const decoded = atob(decodeURIComponent(compressedData));
                    const charData = decoded.split('').map(c => c.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const decompressed = pako.inflate(binData, { to: 'string' });
                    const data = JSON.parse(decompressed);
                    state.isSharedMode = true;
                    renderSharedForm(data);
                    return;
                } catch (err) { console.error('Decode error:', err); }
            }
            
            loadFromStorage();
            loadDhis2Config();
            setupEventListeners();
            checkAuth();
        }

        function setupEventListeners() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab)));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.querySelectorAll('.field-type').forEach(el => el.addEventListener('click', () => addField(el.dataset.type)));
            document.getElementById('formTitle').addEventListener('input', (e) => {
                state.settings.title = e.target.value;
                document.getElementById('previewTitle').textContent = e.target.value;
                saveToStorage();
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
            });
        }

        // ==================== DHIS2 API WITH CORS PROXY ====================
        function getProxiedUrl(url) {
            return CORS_PROXIES[currentProxyIndex] + encodeURIComponent(url);
        }

        async function dhis2Request(endpoint, method = 'GET', payload = null, retryCount = 0) {
            const { url, username, password } = state.dhis2;
            if (!url || !username || !password) {
                throw new Error('DHIS2 not configured');
            }

            const serverUrl = url.replace(/\/$/, '');
            const apiUrl = `${serverUrl}/api/${endpoint}`;
            const proxiedUrl = getProxiedUrl(apiUrl);
            
            const options = {
                method: method,
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`),
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            if (payload && method !== 'GET') {
                options.body = JSON.stringify(payload);
            }
            
            try {
                const response = await fetch(proxiedUrl, options);
                const text = await response.text();
                
                let data;
                try { data = JSON.parse(text); } catch (e) { data = text; }
                
                if (!response.ok && retryCount < CORS_PROXIES.length - 1) {
                    currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
                    addLog('warning', `Trying alternate proxy...`);
                    return dhis2Request(endpoint, method, payload, retryCount + 1);
                }
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                if (retryCount < CORS_PROXIES.length - 1) {
                    currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
                    addLog('warning', `Proxy failed, trying next...`);
                    return dhis2Request(endpoint, method, payload, retryCount + 1);
                }
                return {
                    success: false,
                    status: 0,
                    error: error.message
                };
            }
        }

        async function testConnection() {
            const url = document.getElementById('dhis2Url').value.trim();
            const username = document.getElementById('dhis2Username').value.trim();
            const password = document.getElementById('dhis2Password').value;
            
            if (!url || !username || !password) {
                notify('Please fill all fields', 'error');
                return;
            }
            
            state.dhis2.url = url;
            state.dhis2.username = username;
            state.dhis2.password = password;
            state.dhis2.orgUnitLevel = parseInt(document.getElementById('dhis2OrgLevel').value);
            
            updateStatus('syncing', 'Testing connection...');
            addLog('info', 'Connecting to DHIS2...');
            
            try {
                const result = await dhis2Request('system/info.json');
                
                if (result.success && result.data) {
                    state.dhis2.connected = true;
                    state.dhis2.serverInfo = result.data;
                    updateStatus('connected', `Connected to ${result.data.systemName}`);
                    addLog('success', `‚úì Connected: ${result.data.systemName} v${result.data.version}`);
                    
                    document.getElementById('dhis2ServerName').textContent = result.data.systemName;
                    document.getElementById('dhis2InfoBar').style.display = 'flex';
                    
                    saveConfig();
                    notify('‚úÖ Connected to DHIS2!', 'success');
                } else {
                    state.dhis2.connected = false;
                    updateStatus('disconnected', 'Connection failed');
                    addLog('error', `‚úó Failed: ${result.error || result.status}`);
                    notify('Connection failed', 'error');
                }
            } catch (error) {
                state.dhis2.connected = false;
                updateStatus('disconnected', 'Connection error');
                addLog('error', `‚úó Error: ${error.message}`);
                notify('Connection error', 'error');
            }
        }

        function updateStatus(type, message) {
            const el = document.getElementById('dhis2Status');
            el.className = `dhis2-status ${type}`;
            const icon = type === 'connected' ? 'üü¢' : type === 'syncing' ? 'üü°' : 'üî¥';
            el.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
        }

        function addLog(type, message) {
            const log = document.getElementById('syncLog');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="log-entry ${type}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('syncLog').innerHTML = '';
        }

        function saveConfig() {
            state.dhis2.url = document.getElementById('dhis2Url').value.trim();
            state.dhis2.username = document.getElementById('dhis2Username').value.trim();
            state.dhis2.password = document.getElementById('dhis2Password').value;
            state.dhis2.orgUnitLevel = parseInt(document.getElementById('dhis2OrgLevel').value);
            
            localStorage.setItem('dhis2Config', JSON.stringify({
                url: state.dhis2.url,
                username: state.dhis2.username,
                password: state.dhis2.password,
                orgUnitLevel: state.dhis2.orgUnitLevel
            }));
            
            notify('üíæ Config saved!');
        }

        function loadDhis2Config() {
            const saved = localStorage.getItem('dhis2Config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    state.dhis2 = { ...state.dhis2, ...config };
                    
                    if (document.getElementById('dhis2Url')) {
                        document.getElementById('dhis2Url').value = state.dhis2.url || '';
                        document.getElementById('dhis2Username').value = state.dhis2.username || '';
                        document.getElementById('dhis2Password').value = state.dhis2.password || '';
                        document.getElementById('dhis2OrgLevel').value = state.dhis2.orgUnitLevel || 5;
                    }
                } catch (e) {}
            }
        }

        // ==================== AUTO SETUP & SYNC ====================
        async function autoSetupAndSync() {
            if (!state.dhis2.connected) {
                notify('Connect to DHIS2 first', 'error');
                return;
            }
            
            if (state.fields.filter(f => f.type !== 'section').length === 0) {
                notify('Add fields to your form first', 'error');
                return;
            }
            
            clearLog();
            addLog('info', 'üöÄ Starting Auto Setup...');
            updateStatus('syncing', 'Setting up...');
            
            try {
                // Step 1: Get default category combo
                addLog('info', 'üìã Getting default category combo...');
                const catResult = await dhis2Request('categoryOptionCombos.json?filter=name:eq:default&fields=id');
                let categoryComboId = 'bjDvmb4bfuf';
                if (catResult.success && catResult.data?.categoryOptionCombos?.length > 0) {
                    categoryComboId = catResult.data.categoryOptionCombos[0].id;
                }
                addLog('success', `‚úì Category combo: ${categoryComboId}`);
                
                // Step 2: Create Data Elements
                addLog('info', 'üìù Creating Data Elements from form fields...');
                const formFields = state.fields.filter(f => f.type !== 'section');
                const createdElements = [];
                
                for (const field of formFields) {
                    const def = fieldDefs[field.type];
                    const code = field.name.toUpperCase().replace(/[^A-Z0-9_]/g, '_');
                    
                    // Check if exists
                    const checkResult = await dhis2Request(`dataElements.json?filter=code:eq:${code}&fields=id,name`);
                    
                    if (checkResult.success && checkResult.data?.dataElements?.length > 0) {
                        const existing = checkResult.data.dataElements[0];
                        state.dhis2.dataElements[field.id] = existing.id;
                        createdElements.push({ id: existing.id });
                        addLog('info', `  ‚Ü≥ Exists: ${field.label} (${existing.id})`);
                    } else {
                        // Create new
                        const payload = {
                            name: field.label,
                            shortName: field.label.substring(0, 50),
                            code: code,
                            domainType: 'AGGREGATE',
                            valueType: def?.valueType || 'TEXT',
                            aggregationType: 'SUM'
                        };
                        
                        const createResult = await dhis2Request('dataElements', 'POST', payload);
                        
                        if (createResult.success && createResult.data?.response?.uid) {
                            const newId = createResult.data.response.uid;
                            state.dhis2.dataElements[field.id] = newId;
                            createdElements.push({ id: newId });
                            addLog('success', `  ‚úì Created: ${field.label} (${newId})`);
                        } else {
                            addLog('error', `  ‚úó Failed: ${field.label}`);
                        }
                    }
                    
                    await sleep(200);
                }
                
                addLog('success', `‚úì ${createdElements.length} data elements ready`);
                
                // Step 3: Get ALL org units
                addLog('info', 'üè• Fetching ALL organization units...');
                const orgResult = await dhis2Request('organisationUnits.json?fields=id&paging=false');
                
                if (!orgResult.success || !orgResult.data?.organisationUnits) {
                    throw new Error('Failed to fetch org units');
                }
                
                state.dhis2.orgUnits = orgResult.data.organisationUnits;
                addLog('success', `‚úì Found ${state.dhis2.orgUnits.length} org units`);
                document.getElementById('dhis2OrgUnitCount').textContent = state.dhis2.orgUnits.length;
                
                // Step 4: Create or Update Dataset
                const datasetName = state.settings.title;
                const datasetCode = datasetName.toUpperCase().replace(/[^A-Z0-9]/g, '_').substring(0, 30);
                
                addLog('info', `üìä Setting up Dataset: ${datasetName}...`);
                
                // Check if dataset exists
                const dsCheckResult = await dhis2Request(`dataSets.json?filter=code:eq:${datasetCode}&fields=id,name`);
                
                if (dsCheckResult.success && dsCheckResult.data?.dataSets?.length > 0) {
                    // Update existing
                    const existingDs = dsCheckResult.data.dataSets[0];
                    state.dhis2.datasetId = existingDs.id;
                    state.dhis2.datasetName = existingDs.name;
                    addLog('info', `  ‚Ü≥ Dataset exists: ${existingDs.id}`);
                    
                    // Update with new elements and all org units
                    const updatePayload = {
                        dataSetElements: createdElements.map(de => ({ dataElement: { id: de.id } })),
                        organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                    };
                    
                    // Use metadata import for update
                    const fullDs = await dhis2Request(`dataSets/${existingDs.id}.json?fields=:owner`);
                    if (fullDs.success && fullDs.data) {
                        const merged = {
                            ...fullDs.data,
                            dataSetElements: createdElements.map(de => ({ 
                                dataSet: { id: existingDs.id },
                                dataElement: { id: de.id } 
                            })),
                            organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                        };
                        
                        const updateResult = await dhis2Request(`dataSets/${existingDs.id}`, 'PUT', merged);
                        if (updateResult.success) {
                            addLog('success', `  ‚úì Dataset updated with ${createdElements.length} elements`);
                        } else {
                            addLog('warning', `  ‚ö† Could not update dataset`);
                        }
                    }
                } else {
                    // Create new dataset
                    const createPayload = {
                        name: datasetName,
                        shortName: datasetName.substring(0, 50),
                        code: datasetCode,
                        periodType: 'Monthly',
                        dataSetElements: createdElements.map(de => ({ dataElement: { id: de.id } })),
                        organisationUnits: state.dhis2.orgUnits.map(ou => ({ id: ou.id }))
                    };
                    
                    const createResult = await dhis2Request('dataSets', 'POST', createPayload);
                    
                    if (createResult.success && createResult.data?.response?.uid) {
                        state.dhis2.datasetId = createResult.data.response.uid;
                        state.dhis2.datasetName = datasetName;
                        addLog('success', `  ‚úì Dataset created: ${state.dhis2.datasetId}`);
                    } else {
                        addLog('error', `  ‚úó Failed to create dataset: ${JSON.stringify(createResult.data)}`);
                    }
                }
                
                document.getElementById('dhis2DatasetName').textContent = datasetName;
                
                // Step 5: Sync collected data
                const pendingData = state.collectedData.filter(d => !d._synced);
                if (pendingData.length > 0) {
                    addLog('info', `üì§ Syncing ${pendingData.length} records...`);
                    await syncDataToDhis2(pendingData);
                } else {
                    addLog('info', 'üì§ No pending data to sync');
                }
                
                // Done
                updateStatus('connected', 'Setup complete!');
                addLog('success', '‚úÖ AUTO SETUP COMPLETE!');
                saveToStorage();
                notify('‚úÖ DHIS2 setup complete!', 'success');
                
            } catch (error) {
                updateStatus('disconnected', 'Setup failed');
                addLog('error', `‚úó Error: ${error.message}`);
                notify('Setup failed: ' + error.message, 'error');
            }
        }

        async function syncDataToDhis2(dataRecords) {
            if (!state.dhis2.datasetId) {
                addLog('error', 'No dataset configured');
                return;
            }
            
            let success = 0, failed = 0;
            
            for (const record of dataRecords) {
                // Get org unit - try to find facility or use first selected
                let orgUnitId = null;
                
                // Look for facility field
                const facilityField = state.fields.find(f => 
                    f.name.toLowerCase().includes('facility') || 
                    f.label.toLowerCase().includes('facility') ||
                    f.name.toLowerCase().includes('org_unit')
                );
                
                if (facilityField && record[facilityField.name]) {
                    const facilityName = record[facilityField.name].toLowerCase();
                    const match = state.dhis2.orgUnits.find(ou => 
                        ou.displayName?.toLowerCase() === facilityName ||
                        ou.name?.toLowerCase() === facilityName
                    );
                    if (match) orgUnitId = match.id;
                }
                
                // If no match, use first org unit (for demo)
                if (!orgUnitId && state.dhis2.orgUnits.length > 0) {
                    orgUnitId = state.dhis2.orgUnits[0].id;
                }
                
                if (!orgUnitId) {
                    addLog('warning', `  ‚ö† No org unit for record`);
                    failed++;
                    continue;
                }
                
                // Build period from timestamp
                const ts = new Date(record._timestamp || Date.now());
                const period = `${ts.getFullYear()}${String(ts.getMonth() + 1).padStart(2, '0')}`;
                
                // Build data values
                const dataValues = [];
                state.fields.filter(f => f.type !== 'section').forEach(field => {
                    const deId = state.dhis2.dataElements[field.id];
                    const value = record[field.name];
                    
                    if (deId && value !== undefined && value !== null && value !== '') {
                        dataValues.push({
                            dataElement: deId,
                            value: String(value),
                            period: period,
                            orgUnit: orgUnitId
                        });
                    }
                });
                
                if (dataValues.length === 0) {
                    addLog('warning', `  ‚ö† No values in record`);
                    failed++;
                    continue;
                }
                
                // Submit
                const payload = {
                    dataValues: dataValues
                };
                
                const result = await dhis2Request('dataValueSets', 'POST', payload);
                
                if (result.success) {
                    record._synced = true;
                    record._syncedAt = new Date().toISOString();
                    success++;
                    addLog('success', `  ‚úì Synced ${dataValues.length} values`);
                } else {
                    record._syncError = result.error || 'Unknown error';
                    failed++;
                    addLog('error', `  ‚úó Failed: ${result.error || 'Unknown'}`);
                }
                
                await sleep(300);
            }
            
            addLog('info', `üìä Sync complete: ${success} success, ${failed} failed`);
            saveToStorage();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== UI HELPERS ====================
        function openDhis2Config() {
            loadDhis2Config();
            document.getElementById('dhis2Modal').classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = 'notification show' + (type === 'error' ? ' error' : type === 'info' ? ' info' : '');
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ==================== AUTH ====================
        function checkAuth() {
            const saved = localStorage.getItem('formBuilderUser');
            if (saved) { state.user = JSON.parse(saved); showBuilder(); }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(tab + 'Form')?.classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) { state.user = user; localStorage.setItem('formBuilderUser', JSON.stringify(user)); showBuilder(); }
            else { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Invalid credentials'; }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const users = JSON.parse(localStorage.getItem('formBuilderUsers') || '[]');
            if (users.find(u => u.email === email)) { document.getElementById('authError').style.display = 'block'; document.getElementById('authError').textContent = 'Email exists'; return; }
            users.push({ id: Date.now().toString(), name, email, password });
            localStorage.setItem('formBuilderUsers', JSON.stringify(users));
            document.getElementById('authSuccess').style.display = 'block';
            document.getElementById('authSuccess').textContent = 'Account created! Please login.';
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function showBuilder() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('headerUser').textContent = `üë§ ${state.user?.name || 'User'}`;
            renderFields();
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('formBuilderUser');
            document.getElementById('mainContainer').classList.remove('show');
            document.getElementById('authContainer').style.display = 'flex';
        }

        // ==================== FORM BUILDER ====================
        function addField(type) {
            const def = fieldDefs[type];
            if (!def) return;
            state.fieldCounter++;
            const field = {
                id: 'field_' + state.fieldCounter,
                type: type,
                label: def.defaultLabel,
                name: type + '_' + state.fieldCounter,
                required: true,
                options: def.options ? [...def.options] : [],
                max: def.max || 5
            };
            state.fields.push(field);
            renderFields();
            selectField(field.id);
            saveToStorage();
        }

        function removeField(id) {
            event?.stopPropagation();
            if (!confirm('Delete field?')) return;
            state.fields = state.fields.filter(f => f.id !== id);
            if (state.selectedFieldId === id) { state.selectedFieldId = null; renderProperties(); }
            renderFields();
            saveToStorage();
        }

        function moveField(id, direction) {
            event?.stopPropagation();
            const index = state.fields.findIndex(f => f.id === id);
            if (index < 0) return;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.fields.length) return;
            [state.fields[index], state.fields[newIndex]] = [state.fields[newIndex], state.fields[index]];
            renderFields();
            saveToStorage();
        }

        function selectField(id) {
            state.selectedFieldId = id;
            renderFields();
            renderProperties();
        }

        function updateField(prop, value) {
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (field) { field[prop] = value; renderFields(); saveToStorage(); }
        }

        function renderFields() {
            const dropZone = document.getElementById('dropZone');
            const fieldCount = state.fields.filter(f => f.type !== 'section').length;
            document.getElementById('fieldCount').textContent = `üìä ${fieldCount} data elements`;
            
            if (state.fields.length === 0) {
                dropZone.classList.remove('has-fields');
                dropZone.innerHTML = '<p style="font-size:36px;margin-bottom:12px;">üì•</p><p style="font-weight:600;">Click field types to add</p><p style="font-size:11px;color:#868e96;margin-top:10px;">Fields become DHIS2 Data Elements</p>';
                return;
            }
            
            dropZone.classList.add('has-fields');
            let currentPage = 1;
            
            dropZone.innerHTML = state.fields.map(f => {
                if (f.type === 'section') {
                    currentPage++;
                    return `<div class="section-divider ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}">
                        <span>üìÅ ${f.label.toUpperCase()}</span>
                        <div style="display:flex;gap:5px;">
                            <button class="field-action-btn" onclick="moveField('${f.id}','up')">‚ñ≤</button>
                            <button class="field-action-btn" onclick="moveField('${f.id}','down')">‚ñº</button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
                }
                
                const def = fieldDefs[f.type];
                
                return `<div class="form-field ${f.id === state.selectedFieldId ? 'selected' : ''}" data-id="${f.id}">
                    <div class="form-field-header">
                        <span class="form-field-label">${def?.icon || 'üìÑ'} ${f.label}</span>
                        <div class="form-field-actions">
                            <button class="field-action-btn" onclick="moveField('${f.id}','up')">‚ñ≤</button>
                            <button class="field-action-btn" onclick="moveField('${f.id}','down')">‚ñº</button>
                            <button class="field-action-btn delete" onclick="removeField('${f.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size:10px;color:#868e96;">
                        Code: <code>${f.name}</code>
                        ${f.required ? '<span class="field-badge required">Required</span>' : ''}
                    </div>
                </div>`;
            }).join('');
            
            dropZone.querySelectorAll('.form-field, .section-divider').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.field-action-btn')) selectField(el.dataset.id);
                });
            });
        }

        function renderProperties() {
            const container = document.getElementById('propertiesContent');
            if (!state.selectedFieldId) {
                container.innerHTML = '<div class="no-selection"><p style="font-size:32px;margin-bottom:12px;">üëÜ</p><p>Select a field</p></div>';
                return;
            }
            
            const field = state.fields.find(f => f.id === state.selectedFieldId);
            if (!field) return;
            
            let html = `
                <div class="prop-section">
                    <div class="prop-section-title">üìù Field Settings</div>
                    <div class="property-group">
                        <label class="property-label">Label (Data Element Name)</label>
                        <input type="text" class="property-input" id="propLabel" value="${escapeHtml(field.label)}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Code (Data Element Code)</label>
                        <input type="text" class="property-input" id="propName" value="${escapeHtml(field.name)}">
                    </div>
                    ${field.type !== 'section' ? `
                        <div class="property-group">
                            <label class="property-checkbox">
                                <input type="checkbox" id="propRequired" ${field.required ? 'checked' : ''}>
                                <span>Required Field</span>
                            </label>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (['select', 'radio', 'checkbox'].includes(field.type)) {
                html += `
                    <div class="prop-section">
                        <div class="prop-section-title">üìã Options (one per line)</div>
                        <textarea class="property-textarea" id="propOptions">${(field.options || []).join('\n')}</textarea>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            document.getElementById('propLabel')?.addEventListener('change', (e) => updateField('label', e.target.value));
            document.getElementById('propName')?.addEventListener('change', (e) => updateField('name', e.target.value));
            document.getElementById('propRequired')?.addEventListener('change', (e) => updateField('required', e.target.checked));
            document.getElementById('propOptions')?.addEventListener('change', (e) => updateField('options', e.target.value.split('\n').filter(o => o.trim())));
        }

        // ==================== STORAGE ====================
        function saveToStorage() {
            localStorage.setItem('formBuilderAutoSync', JSON.stringify({
                fields: state.fields,
                settings: state.settings,
                fieldCounter: state.fieldCounter,
                collectedData: state.collectedData,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    datasetName: state.dhis2.datasetName,
                    dataElements: state.dhis2.dataElements
                }
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('formBuilderAutoSync');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.fields = data.fields || [];
                    state.settings = { ...state.settings, ...data.settings };
                    state.fieldCounter = data.fieldCounter || 0;
                    state.collectedData = data.collectedData || [];
                    if (data.dhis2) {
                        state.dhis2.datasetId = data.dhis2.datasetId;
                        state.dhis2.datasetName = data.dhis2.datasetName;
                        state.dhis2.dataElements = data.dhis2.dataElements || {};
                    }
                    
                    document.getElementById('formTitle').value = state.settings.title;
                    document.getElementById('previewTitle').textContent = state.settings.title;
                } catch (e) {}
            }
        }

        // ==================== FORM OPERATIONS ====================
        function newForm() {
            if (state.fields.length > 0 && !confirm('Create new form?')) return;
            state.fields = [];
            state.selectedFieldId = null;
            state.fieldCounter = 0;
            state.dhis2.dataElements = {};
            state.dhis2.datasetId = null;
            state.collectedData = [];
            
            const title = prompt('Form/Dataset Name:', 'New Form');
            if (title) {
                state.settings.title = title;
                document.getElementById('formTitle').value = title;
                document.getElementById('previewTitle').textContent = title;
            }
            saveToStorage();
            renderFields();
            renderProperties();
            notify('üìÑ New form created!');
        }

        function saveCurrentForm() {
            if (state.fields.length === 0) { notify('Add fields first!', 'error'); return; }
            saveToStorage();
            saveFormToList();
            notify('üíæ Saved!');
        }

        function saveFormToList() {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const existingIndex = forms.findIndex(f => f.title === state.settings.title);
            const formEntry = {
                id: existingIndex >= 0 ? forms[existingIndex].id : 'form_' + Date.now(),
                title: state.settings.title,
                fieldCount: state.fields.filter(f => f.type !== 'section').length,
                updatedAt: new Date().toISOString(),
                fields: state.fields,
                settings: state.settings,
                dhis2: {
                    datasetId: state.dhis2.datasetId,
                    datasetName: state.dhis2.datasetName,
                    dataElements: state.dhis2.dataElements
                }
            };
            if (existingIndex >= 0) forms[existingIndex] = formEntry;
            else forms.push(formEntry);
            localStorage.setItem('formBuilderForms', JSON.stringify(forms));
        }

        function previewForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            state.isSharedMode = false;
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('viewerContainer').classList.add('show');
            renderFormViewer();
        }

        function closeViewer() {
            document.getElementById('viewerContainer').classList.remove('show');
            document.querySelector('.header').style.display = '';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = '';
        }

        function shareForm() {
            if (state.fields.length === 0) { notify('Add fields!', 'error'); return; }
            
            const formData = {
                s: { t: state.settings.title, l: state.settings.logo },
                f: state.fields.map(f => ({ i: f.id, y: f.type, l: f.label, n: f.name, r: f.required, o: f.options, mx: f.max })),
                d: state.dhis2.datasetId ? { id: state.dhis2.datasetId, de: state.dhis2.dataElements } : null
            };
            
            try {
                const jsonStr = JSON.stringify(formData);
                const compressed = pako.deflate(jsonStr);
                const encoded = btoa(String.fromCharCode.apply(null, compressed));
                const shareUrl = window.location.origin + window.location.pathname + '?d=' + encodeURIComponent(encoded);
                
                document.getElementById('shareUrl').textContent = shareUrl;
                
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: shareUrl, width: 200, height: 200, colorDark: '#004080' });
                
                saveFormToList();
                document.getElementById('shareModal').classList.add('show');
            } catch (err) { notify('Error: ' + err.message, 'error'); }
        }

        function copyShareUrl() {
            navigator.clipboard.writeText(document.getElementById('shareUrl').textContent)
                .then(() => notify('üìã Copied!'))
                .catch(() => notify('Copy failed', 'error'));
        }

        // ==================== HOME ====================
        function showHome() {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            let formsHtml = forms.length === 0 ? `
                <div style="text-align:center;padding:60px;color:#868e96;">
                    <p style="font-size:64px;">üì≠</p>
                    <h3 style="color:#004080;">No Forms Yet</h3>
                    <button onclick="closeHome()" style="padding:15px 30px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:20px;font-weight:bold;">‚ûï Create Form</button>
                </div>
            ` : forms.map((f, i) => `
                <div style="background:#fff;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#004080,#002855);color:#fff;padding:12px 15px;">
                        <h3 style="margin:0;font-size:14px;">üìã ${escapeHtml(f.title)}</h3>
                    </div>
                    <div style="padding:12px 15px;">
                        <div style="font-size:11px;color:#666;margin-bottom:10px;">
                            üìä ${f.fieldCount} elements
                            ${f.dhis2?.datasetId ? '<span style="color:#17a2b8;margin-left:8px;">üîó DHIS2</span>' : ''}
                        </div>
                        <div style="display:flex;gap:6px;">
                            <button onclick="editForm(${i})" style="flex:1;padding:8px;background:#004080;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteForm(${i})" style="padding:8px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('homeContainer').innerHTML = `
                <div style="max-width:600px;margin:0 auto;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="color:#004080;">üè† My Forms</h2>
                        <button onclick="closeHome()" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">‚ûï New</button>
                    </div>
                    ${formsHtml}
                </div>
            `;
            
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('homeContainer').classList.add('show');
        }

        function closeHome() {
            document.getElementById('homeContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'flex';
            document.getElementById('mainContainer').classList.add('show');
            document.querySelector('.footer').style.display = 'block';
        }

        function editForm(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            const form = forms[index];
            if (!form) return;
            
            state.fields = form.fields || [];
            state.settings = { ...state.settings, ...form.settings };
            state.fieldCounter = Math.max(...state.fields.map(f => parseInt(f.id.replace('field_', '')) || 0), 0) + 1;
            
            if (form.dhis2) {
                state.dhis2.datasetId = form.dhis2.datasetId;
                state.dhis2.datasetName = form.dhis2.datasetName;
                state.dhis2.dataElements = form.dhis2.dataElements || {};
            }
            
            document.getElementById('formTitle').value = state.settings.title;
            document.getElementById('previewTitle').textContent = state.settings.title;
            saveToStorage();
            closeHome();
            renderFields();
            renderProperties();
            notify('üìÇ Form loaded!');
        }

        function deleteForm(index) {
            const forms = JSON.parse(localStorage.getItem('formBuilderForms') || '[]');
            if (!confirm(`Delete "${forms[index]?.title}"?`)) return;
            forms.splice(index, 1);
            localStorage.setItem('formBuilderForms', JSON.stringify(forms));
            showHome();
            notify('üóëÔ∏è Deleted');
        }

        // ==================== FORM VIEWER ====================
        function renderSharedForm(data) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('show');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            state.settings = { title: data.s?.t || 'Form', logo: data.s?.l || state.settings.logo };
            state.fields = (data.f || []).map(f => ({
                id: f.i, type: f.y, label: f.l, name: f.n, required: f.r || false, options: f.o || [], max: f.mx || 5
            }));
            
            if (data.d) {
                state.dhis2.datasetId = data.d.id;
                state.dhis2.dataElements = data.d.de || {};
            }
            
            document.getElementById('viewerContainer').classList.add('show');
            renderFormViewer();
        }

        function renderFormViewer() {
            const s = state.settings;
            let pages = [], currentPage = { title: 'Page 1', fields: [] };
            
            state.fields.forEach(field => {
                if (field.type === 'section') {
                    if (currentPage.fields.length > 0) pages.push(currentPage);
                    currentPage = { title: field.label, fields: [] };
                } else {
                    currentPage.fields.push(field);
                }
            });
            if (currentPage.fields.length > 0) pages.push(currentPage);
            if (pages.length === 0) pages = [{ title: s.title, fields: state.fields.filter(f => f.type !== 'section') }];
            
            let pagesHtml = pages.map((page, pageIndex) => {
                let fieldsHtml = page.fields.map(field => {
                    const req = field.required ? '<span style="color:#dc3545;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';
                    let input = '';
                    
                    switch (field.type) {
                        case 'text': case 'email': case 'phone': case 'date': case 'time':
                            const type = field.type === 'phone' ? 'tel' : field.type;
                            input = `<input type="${type}" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                            break;
                        case 'number':
                            input = `<input type="number" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                            break;
                        case 'textarea':
                            input = `<textarea name="${field.name}" class="viewer-input" rows="3" ${reqAttr}></textarea>`;
                            break;
                        case 'select':
                            input = `<select name="${field.name}" class="viewer-input" ${reqAttr}><option value="">-- Select --</option>${(field.options||[]).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}</select>`;
                            break;
                        case 'radio': case 'yesno':
                            const opts = field.type === 'yesno' ? ['Yes','No'] : (field.options||[]);
                            input = `<div class="viewer-radio-group">${opts.map(o => `<label class="viewer-radio-option"><input type="radio" name="${field.name}" value="${escapeHtml(o)}" ${reqAttr}><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'checkbox':
                            input = `<div class="viewer-radio-group">${(field.options||[]).map(o => `<label class="viewer-radio-option"><input type="checkbox" name="${field.name}" value="${escapeHtml(o)}"><span>${escapeHtml(o)}</span></label>`).join('')}</div>`;
                            break;
                        case 'gps':
                            input = `<div><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;">üìç Get Location</button><input type="hidden" name="${field.name}"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div></div>`;
                            break;
                        case 'rating':
                            input = `<div>${Array(field.max || 5).fill().map((_, i) => `<span onclick="setRating(this,${i+1})" style="font-size:24px;cursor:pointer;opacity:0.3;">‚≠ê</span>`).join('')}<input type="hidden" name="${field.name}"></div>`;
                            break;
                        default:
                            input = `<input type="text" name="${field.name}" class="viewer-input" ${reqAttr}>`;
                    }
                    
                    return `<div class="viewer-field"><label class="viewer-field-label">${escapeHtml(field.label)} ${req}</label>${input}</div>`;
                }).join('');
                
                const isFirst = pageIndex === 0, isLast = pageIndex === pages.length - 1;
                
                return `
                    <div class="form-page" data-page="${pageIndex}" style="${pageIndex === 0 ? '' : 'display:none;'}">
                        ${pages.length > 1 ? `<div class="page-header"><span class="page-indicator">Page ${pageIndex + 1}/${pages.length}</span><h3 class="page-title">${escapeHtml(page.title)}</h3></div>` : ''}
                        ${fieldsHtml}
                        <div class="page-navigation">
                            ${!isFirst ? `<button type="button" class="nav-btn back-btn" onclick="goToPage(${pageIndex - 1})">‚¨ÖÔ∏è Back</button>` : '<div></div>'}
                            ${!isLast ? `<button type="button" class="nav-btn next-btn" onclick="goToPage(${pageIndex + 1})">Next ‚û°Ô∏è</button>` : ''}
                            ${isLast ? `<button type="submit" class="nav-btn submit-btn">‚úÖ Submit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            const backBtn = state.isSharedMode ? '' : '<button class="viewer-back-btn" onclick="closeViewer()">‚¨ÖÔ∏è Back</button>';
            
            document.getElementById('viewerContainer').innerHTML = `
                <div class="viewer-nav">
                    ${backBtn}
                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showTab('form',this)">üìù Form</button>
                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showTab('data',this)">üìä Data</button>
                    ${state.dhis2.connected ? `<button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="syncNow()">üîÑ Sync</button>` : ''}
                    <div class="connection-status ${navigator.onLine ? 'online' : 'offline'}">
                        ${navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'}
                    </div>
                </div>
                
                <div id="tabForm" class="viewer-tab active">
                    <div class="viewer-form">
                        <div class="viewer-form-box">
                            <div class="viewer-header">
                                <img src="${s.logo}" alt="Logo">
                                <h1>${escapeHtml(s.title)}</h1>
                            </div>
                            <div class="viewer-body">
                                <form id="viewerForm">${pagesHtml}</form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tabData" class="viewer-tab">
                    <div style="max-width:900px;margin:0 auto;">
                        <h3 style="color:#004080;margin-bottom:15px;">üìä Collected Data (${state.collectedData.length} records)</h3>
                        <div id="dataTable"></div>
                    </div>
                </div>
            `;
            
            window.totalPages = pages.length;
            setupFormSubmit();
            renderDataTable();
        }

        function setupFormSubmit() {
            const form = document.getElementById('viewerForm');
            if (!form) return;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const data = { _id: Date.now(), _timestamp: new Date().toISOString(), _synced: false };
                new FormData(form).forEach((v, k) => data[k] = v);
                
                state.collectedData.push(data);
                saveToStorage();
                
                form.reset();
                goToPage(0);
                
                notify('‚úÖ Data saved!');
                renderDataTable();
                
                // Auto-sync if connected
                if (state.dhis2.connected && state.dhis2.datasetId) {
                    notify('üîÑ Syncing to DHIS2...', 'info');
                    await syncDataToDhis2([data]);
                }
            };
        }

        function renderDataTable() {
            const container = document.getElementById('dataTable');
            if (!container) return;
            
            if (state.collectedData.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#868e96;padding:30px;">No data yet</p>';
                return;
            }
            
            const fields = state.fields.filter(f => f.type !== 'section');
            
            let html = '<div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>#</th><th>Time</th>';
            fields.slice(0, 5).forEach(f => html += `<th>${escapeHtml(f.label)}</th>`);
            html += '<th>Status</th></tr></thead><tbody>';
            
            state.collectedData.slice(-20).reverse().forEach((row, i) => {
                const syncStatus = row._synced ? 
                    '<span class="sync-badge synced">Synced</span>' : 
                    '<span class="sync-badge pending">Pending</span>';
                    
                html += `<tr><td>${state.collectedData.length - i}</td><td>${new Date(row._timestamp).toLocaleString()}</td>`;
                fields.slice(0, 5).forEach(f => html += `<td>${escapeHtml(String(row[f.name] || '-').substring(0, 20))}</td>`);
                html += `<td>${syncStatus}</td></tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function showTab(tab, btn) {
            document.querySelectorAll('.viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.viewer-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function goToPage(pageIndex) {
            document.querySelectorAll('.form-page').forEach(p => p.style.display = 'none');
            document.querySelector(`.form-page[data-page="${pageIndex}"]`).style.display = 'block';
        }

        async function syncNow() {
            const pending = state.collectedData.filter(d => !d._synced);
            if (pending.length === 0) {
                notify('No pending data to sync', 'info');
                return;
            }
            notify(`üîÑ Syncing ${pending.length} records...`, 'info');
            await syncDataToDhis2(pending);
            renderDataTable();
        }

        window.captureGPS = function(btn) {
            const container = btn.parentElement;
            const status = container.querySelector('.gps-status');
            const input = container.querySelector('input[type="hidden"]');
            status.textContent = 'üìç Getting location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const coords = `[${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}]`;
                        input.value = coords;
                        status.textContent = '‚úÖ ' + coords;
                    },
                    err => { status.textContent = '‚ùå ' + err.message; }
                );
            } else {
                status.textContent = '‚ùå Not supported';
            }
        };

        window.setRating = function(star, val) {
            const container = star.parentElement;
            container.querySelectorAll('span').forEach((s, i) => s.style.opacity = i < val ? '1' : '0.3');
            container.querySelector('input').value = val;
        };

        // Init
        init();
    </script>
</body>
</html>
